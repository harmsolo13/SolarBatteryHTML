<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Battery ROI Calculator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
<script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0f1a; }
  #root { min-height: 100vh; }
  input[type="range"] { -webkit-appearance: none; height: 6px; background: #1e293b; border-radius: 3px; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #f59e0b; cursor: pointer; }
  input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #f59e0b; cursor: pointer; border: none; }
  input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { opacity: 0.5; }
  select option { background: #0f172a; color: #e2e8f0; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #0a0f1a; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
/* ══════════════════════════════════════════════════════════════
   Battery ROI Calculator — Shared Config & Constants
   ══════════════════════════════════════════════════════════════ */

/* ── Weather Forecast Configuration ── */
const WEATHER_API_KEY = '4c5098037db74b3f980113023260602'; // WeatherAPI.com key
const WEATHER_API_URL = 'https://api.weatherapi.com/v1/forecast.json';
const ADELAIDE_LOCATION = '-34.8481,138.5597'; // Ferryden Park, SA (precise coordinates)

// Weather to solar generation correlation (based on historical data analysis)
const WEATHER_SOLAR_CORRELATION = {
  // cloud_cover % -> solar generation multiplier
  getSolarMultiplier: (cloudCover, uvIndex) => {
    // Base on cloud cover
    let multiplier = 1.0;
    if (cloudCover <= 10) multiplier = 1.0;      // Clear
    else if (cloudCover <= 30) multiplier = 0.9; // Mostly clear
    else if (cloudCover <= 50) multiplier = 0.7; // Partly cloudy
    else if (cloudCover <= 70) multiplier = 0.5; // Mostly cloudy
    else if (cloudCover <= 90) multiplier = 0.3; // Overcast
    else multiplier = 0.15;                       // Heavy cloud/rain

    // Adjust by UV index (0-11+ scale)
    const uvMultiplier = Math.min(uvIndex / 8, 1.0);
    return multiplier * (0.7 + 0.3 * uvMultiplier);
  }
};



/* ═══════════════════════════════════════════════════════════════════════
   HOME ASSISTANT BOM WEATHER INTEGRATION
   Fetches BOM weather data from Home Assistant's weather-au integration
   ═══════════════════════════════════════════════════════════════════════ */

// Solar API Configuration (Nexus server with Solax collector)
// Use relative path when served from Nexus, absolute when opened as file://
const SOLAR_API_URL = (window.location.port === '5000') ? '/api/solar' : 'http://192.168.68.60:5000/api/solar';
const SOLAR_POLL_INTERVAL = 30000; // 30 seconds

// Home Assistant Configuration
const HA_CONFIG = {
  url: 'http://192.168.68.60:8123',
  weatherEntity: 'weather.forecast_home', // Your BOM weather entity
  // Long-Lived Access Token (hardcoded for convenience)
  token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJlNzdjOWRmODQwNjQ0NmIxOGMxMmNkYjAwOGQ5OTA3MSIsImlhdCI6MTc3MDM4MTU2NywiZXhwIjoyMDg1NzQxNTY3fQ.j_MRtPHcysiCzbPv3ZD2DZW-p20ZAeZEyJzlUSexCLg'
};

// Weather condition to solar multiplier mapping (from BOM data)
const BOM_CONDITION_TO_SOLAR = {
  // Clear conditions (90-100% solar)
  'clear': 1.0,
  'sunny': 1.0,
  'clear-night': 1.0,

  // Mostly clear (80-90% solar)
  'partlycloudy': 0.85,
  'partly-cloudy': 0.85,

  // Partly cloudy (65-75% solar)
  'cloudy': 0.7,
  'mostlycloudy': 0.65,
  'mostly-cloudy': 0.65,

  // Overcast (40-55% solar)
  'overcast': 0.5,

  // Light rain/showers (25-35% solar)
  'rainy': 0.3,
  'light-rain': 0.35,
  'shower': 0.3,
  'showers': 0.3,

  // Heavy rain/storms (10-20% solar)
  'pouring': 0.15,
  'heavy-rain': 0.15,
  'lightning': 0.1,
  'lightning-rainy': 0.1,
  'thunderstorm': 0.1,

  // Other conditions
  'fog': 0.4,
  'hail': 0.2,
  'snowy': 0.2,
  'snowy-rainy': 0.2,
  'windy': 0.85,
  'windy-variant': 0.8,
  'exceptional': 0.5,
};

async function fetchHAWeatherForecast() {
  // Check if token is set
  if (!HA_CONFIG.token) {
    const token = prompt(
      'Enter your Home Assistant Long-Lived Access Token:\n\n' +
      '(You only need to do this once per session)\n\n' +
      'Get it from: Settings → People → [Your Name] → Security → Long-Lived Access Tokens'
    );

    if (!token) {
      throw new Error('Home Assistant access token required');
    }

    HA_CONFIG.token = token;
  }

  const authHeaders = {
    'Authorization': `Bearer ${HA_CONFIG.token}`,
    'Content-Type': 'application/json'
  };

  try {
    // Step 1: Get current weather state (temp, humidity, condition)
    const stateResponse = await fetch(
      `${HA_CONFIG.url}/api/states/${HA_CONFIG.weatherEntity}`,
      { method: 'GET', headers: authHeaders }
    );

    if (!stateResponse.ok) {
      if (stateResponse.status === 401) {
        HA_CONFIG.token = null;
        throw new Error('Invalid Home Assistant token. Please check your token and try again.');
      }
      throw new Error(`Home Assistant API error: ${stateResponse.status}`);
    }

    const stateData = await stateResponse.json();

    // Step 2: Get forecast via weather.get_forecasts service call
    // (HA 2024.3+ moved forecasts out of entity attributes into a service)
    const forecastResponse = await fetch(
      `${HA_CONFIG.url}/api/services/weather/get_forecasts?return_response`,
      {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify({
          entity_id: HA_CONFIG.weatherEntity,
          type: 'daily'
        })
      }
    );

    if (!forecastResponse.ok) {
      throw new Error(`Home Assistant forecast service error: ${forecastResponse.status}`);
    }

    const forecastData = await forecastResponse.json();

    // Extract forecast array from service response
    const forecast = forecastData?.service_response?.[HA_CONFIG.weatherEntity]?.forecast || [];

    if (forecast.length === 0) {
      throw new Error('No forecast data available from Home Assistant');
    }

    return {
      location: stateData.attributes?.friendly_name || 'Unknown',
      current: {
        temp: stateData.attributes?.temperature,
        condition: stateData.state,
        humidity: stateData.attributes?.humidity,
        pressure: stateData.attributes?.pressure
      },
      forecast: forecast.map(day => ({
        datetime: day.datetime,
        date: day.datetime.split('T')[0],
        condition: day.condition,
        temperature: day.temperature,
        templow: day.templow,
        precipitation: day.precipitation,
        precipitation_probability: day.precipitation_probability,
        wind_speed: day.wind_speed,
        // Calculate solar multiplier based on condition
        solar_multiplier: BOM_CONDITION_TO_SOLAR[day.condition] || 0.5
      }))
    };

  } catch (error) {
    console.error('Home Assistant fetch error:', error);
    throw error;
  }
}

// Get icon for condition
function getConditionIcon(condition) {
  const iconMap = {
    'clear': '\u2600\uFE0F',
    'sunny': '\u2600\uFE0F',
    'partlycloudy': '\u26C5',
    'partly-cloudy': '\u26C5',
    'cloudy': '\u2601\uFE0F',
    'overcast': '\u2601\uFE0F',
    'rainy': '\uD83C\uDF27\uFE0F',
    'pouring': '\uD83C\uDF27\uFE0F',
    'lightning': '\u26C8\uFE0F',
    'thunderstorm': '\u26C8\uFE0F',
    'fog': '\uD83C\uDF2B\uFE0F',
    'windy': '\uD83D\uDCA8',
    'snowy': '\uD83C\uDF28\uFE0F',
  };

  return iconMap[condition] || '\uD83C\uDF24\uFE0F';
}

// loadForecastFromHA removed — now uses server-side proxy via /api/solar/weather

const { BarChart, Bar, AreaChart, Area, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } = Recharts;

const MO = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const MD = [31,28,31,30,31,30,31,31,30,31,30,31];

const SEA = {
  sponge: [0.50,0.50,0.60,0.80,1.50,2.00,2.00,1.60,1.10,0.80,1.00,0.50],
  peak:   [1.15,1.20,1.00,0.85,0.90,1.00,1.00,0.95,0.85,0.90,1.00,1.15],
  offPk:  [0.75,0.75,0.85,1.00,1.25,1.40,1.40,1.30,1.10,0.95,1.00,0.75],
  feedIn: [1.35,1.25,1.05,0.70,0.35,0.25,0.28,0.40,0.65,0.85,1.00,1.35],
};

const BAT = {
  peakR:   [0.80,0.78,0.68,0.52,0.32,0.25,0.28,0.35,0.48,0.58,0.70,0.78],
  offPkR:  [0.55,0.52,0.42,0.32,0.20,0.15,0.18,0.22,0.32,0.40,0.48,0.55],
  spongeR: [0.10,0.10,0.05,0.00,-0.10,-0.15,-0.15,-0.10,0.00,0.05,0.10,0.10],
  feedInR: [0.65,0.62,0.55,0.45,0.30,0.25,0.28,0.35,0.42,0.50,0.60,0.65],
  amberSpike: [150,120,60,30,20,40,40,30,20,30,50,100],
};

const fmt = v => `$${Math.round(v).toLocaleString("en-AU")}`;
const fmt2 = v => `$${v.toFixed(2)}`;
const pct = (v, d = 0) => `${v.toFixed(d)}%`;

/* ── Historical ROI Data (embedded) ── */
const HISTORICAL_ROI_DATA = {"battery_spec":{"capacity_kwh":33.28,"usable_kwh":32,"cost":10700,"rebate":1500,"net_cost":9200},"annual_no_sharer":{"cost_no_battery":3124.47,"cost_with_battery":1552.09,"savings":1572.38,"payback_years":5.85},"annual_with_sharer":{"cost_no_battery":3124.47,"cost_with_battery":1552.09,"savings":1572.38,"payback_years":5.85},"monthly_results":[{"month":"2024-10","solar_total":798.15,"consumption":454.38,"cost_no_battery":100.62,"cost_with_battery":5.5,"savings":95.13,"savings_with_sharer":95.13},{"month":"2024-11","solar_total":393.59,"consumption":106.92,"cost_no_battery":124.6,"cost_with_battery":-32.23,"savings":156.82,"savings_with_sharer":156.82},{"month":"2024-12","solar_total":973.95,"consumption":733.1,"cost_no_battery":151.49,"cost_with_battery":23.91,"savings":127.58,"savings_with_sharer":127.58},{"month":"2025-1","solar_total":981.01,"consumption":960.79,"cost_no_battery":208.45,"cost_with_battery":65.92,"savings":142.53,"savings_with_sharer":142.53},{"month":"2025-2","solar_total":824.45,"consumption":820.25,"cost_no_battery":181.83,"cost_with_battery":63.7,"savings":118.12,"savings_with_sharer":118.12},{"month":"2025-3","solar_total":712.69,"consumption":731.91,"cost_no_battery":193.81,"cost_with_battery":69.55,"savings":124.26,"savings_with_sharer":124.26},{"month":"2025-4","solar_total":488.66,"consumption":648.84,"cost_no_battery":194.92,"cost_with_battery":81.5,"savings":113.42,"savings_with_sharer":113.42},{"month":"2025-5","solar_total":399.25,"consumption":1033.06,"cost_no_battery":409.96,"cost_with_battery":296.94,"savings":113.01,"savings_with_sharer":113.01},{"month":"2025-6","solar_total":288.4,"consumption":1021.72,"cost_no_battery":446.58,"cost_with_battery":346.07,"savings":100.51,"savings_with_sharer":100.51},{"month":"2025-7","solar_total":314.06,"consumption":1051.1,"cost_no_battery":472.33,"cost_with_battery":345.39,"savings":126.94,"savings_with_sharer":126.94},{"month":"2025-8","solar_total":435.97,"consumption":910.71,"cost_no_battery":380.93,"cost_with_battery":216.13,"savings":164.8,"savings_with_sharer":164.8},{"month":"2025-9","solar_total":613.99,"consumption":701.57,"cost_no_battery":258.95,"cost_with_battery":69.71,"savings":189.25,"savings_with_sharer":189.25}],"daily_charging":{"total_days":381,"days_full":103,"pct_days_full":27.0,"avg_time_to_full":"15:46","earliest_full":"14:49","latest_full":"18:57","hourly_soc":{"4":0,"5":0.01,"6":0.08,"7":0.28,"8":0.84,"9":1.98,"10":3.88,"11":6.43,"12":9.35,"13":12.42,"14":15.4,"15":17.61,"16":18.56,"17":18.81,"18":21.33,"19":25.03,"20":26.49},"seasons":{"Summer":{"total_days":90,"days_full":74,"pct_days_full":82.2,"avg_solar":30.88,"avg_max_soc":26.02,"avg_time_to_full":"15:46"},"Autumn":{"total_days":92,"days_full":0,"pct_days_full":0.0,"avg_solar":17.4,"avg_max_soc":16.6,"avg_time_to_full":null},"Winter":{"total_days":92,"days_full":0,"pct_days_full":0.0,"avg_solar":11.29,"avg_max_soc":10.83,"avg_time_to_full":null},"Spring":{"total_days":107,"days_full":29,"pct_days_full":27.1,"avg_solar":23.68,"avg_max_soc":21.59,"avg_time_to_full":"15:45"}}},"daily_results":[{"date":"2024-10-01","day_of_week":"Tuesday","total_solar_kwh":24.08,"max_battery_soc_kwh":22.02,"battery_filled_pct":80.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.37,"8":1.11,"9":2.52,"10":4.36,"11":6.98,"12":10.19,"13":13.71,"14":17.8,"15":20.48,"16":21.76,"17":21.97,"18":22.01}},{"date":"2024-10-02","day_of_week":"Wednesday","total_solar_kwh":26.52,"max_battery_soc_kwh":24.9,"battery_filled_pct":91.0,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.05,"7":0.26,"8":0.78,"9":2.29,"10":4.98,"11":8.5,"12":12.54,"13":16.66,"14":20.75,"15":23.39,"16":24.64,"17":24.86,"18":24.9}},{"date":"2024-10-03","day_of_week":"Thursday","total_solar_kwh":19.84,"max_battery_soc_kwh":18.56,"battery_filled_pct":67.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.06,"7":0.35,"8":0.99,"9":2.45,"10":4.8,"11":7.29,"12":10.85,"13":14.09,"14":15.96,"15":17.46,"16":18.32,"17":18.54,"18":18.56}},{"date":"2024-10-04","day_of_week":"Friday","total_solar_kwh":27.53,"max_battery_soc_kwh":25.4,"battery_filled_pct":92.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.07,"7":0.49,"8":1.53,"9":3.47,"10":6.4,"11":9.74,"12":13.35,"13":17.21,"14":20.65,"15":23.06,"16":24.82,"17":25.33,"18":25.4}},{"date":"2024-10-05","day_of_week":"Saturday","total_solar_kwh":23.01,"max_battery_soc_kwh":21.15,"battery_filled_pct":77.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.13,"7":0.64,"8":1.34,"9":2.39,"10":4.08,"11":6.86,"12":9.52,"13":13.09,"14":16.54,"15":19.19,"16":20.52,"17":21.06,"18":21.14}},{"date":"2024-10-06","day_of_week":"Sunday","total_solar_kwh":20.66,"max_battery_soc_kwh":19.52,"battery_filled_pct":71.4,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.06,"7":0.36,"8":0.98,"9":2.31,"10":3.99,"11":6.11,"12":8.93,"13":11.95,"14":15.21,"15":17.76,"16":19.18,"17":19.46,"18":19.52}},{"date":"2024-10-07","day_of_week":"Monday","total_solar_kwh":23.96,"max_battery_soc_kwh":22.38,"battery_filled_pct":81.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.08,"7":0.5,"8":1.33,"9":2.88,"10":5.71,"11":8.35,"12":11.14,"13":14.28,"14":17.91,"15":20.65,"16":22.04,"17":22.31,"18":22.38}},{"date":"2024-10-08","day_of_week":"Tuesday","total_solar_kwh":28.93,"max_battery_soc_kwh":26.48,"battery_filled_pct":96.8,"time_to_full":"16:05","hourly_soc":{"5":0.0,"6":0.07,"7":0.37,"8":1.07,"9":2.78,"10":5.81,"11":9.7,"12":13.8,"13":17.93,"14":22.03,"15":24.84,"16":26.23,"17":26.43,"18":26.47}},{"date":"2024-10-09","day_of_week":"Wednesday","total_solar_kwh":28.42,"max_battery_soc_kwh":26.11,"battery_filled_pct":95.4,"time_to_full":"17:01","hourly_soc":{"5":0.0,"6":0.07,"7":0.32,"8":0.96,"9":2.7,"10":5.63,"11":9.39,"12":13.5,"13":17.63,"14":21.73,"15":24.48,"16":25.83,"17":26.06,"18":26.1}},{"date":"2024-10-10","day_of_week":"Thursday","total_solar_kwh":29.14,"max_battery_soc_kwh":26.56,"battery_filled_pct":97.1,"time_to_full":"16:11","hourly_soc":{"5":0.0,"6":0.06,"7":0.34,"8":1.04,"9":2.81,"10":5.76,"11":9.52,"12":13.63,"13":17.76,"14":21.86,"15":24.72,"16":26.18,"17":26.48,"18":26.55}},{"date":"2024-10-11","day_of_week":"Friday","total_solar_kwh":28.5,"max_battery_soc_kwh":26.34,"battery_filled_pct":96.3,"time_to_full":"16:21","hourly_soc":{"5":0.0,"6":0.07,"7":0.37,"8":1.08,"9":2.87,"10":5.8,"11":9.55,"12":13.67,"13":17.79,"14":21.8,"15":24.54,"16":26.01,"17":26.28,"18":26.34}},{"date":"2024-10-12","day_of_week":"Saturday","total_solar_kwh":26.54,"max_battery_soc_kwh":24.99,"battery_filled_pct":91.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.09,"7":0.44,"8":1.25,"9":3.12,"10":6.12,"11":9.88,"12":13.73,"13":17.08,"14":20.86,"15":23.18,"16":24.27,"17":24.85,"18":24.98}},{"date":"2024-10-13","day_of_week":"Sunday","total_solar_kwh":14.88,"max_battery_soc_kwh":14.22,"battery_filled_pct":52.0,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.22,"8":0.9,"9":2.01,"10":3.84,"11":6.48,"12":9.03,"13":10.93,"14":12.21,"15":12.94,"16":13.62,"17":14.13,"18":14.22}},{"date":"2024-10-14","day_of_week":"Monday","total_solar_kwh":25.19,"max_battery_soc_kwh":23.27,"battery_filled_pct":85.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.1,"7":0.49,"8":1.24,"9":2.48,"10":4.67,"11":7.4,"12":11.43,"13":15.52,"14":19.31,"15":21.3,"16":22.78,"17":23.16,"18":23.27}},{"date":"2024-10-15","day_of_week":"Tuesday","total_solar_kwh":24.88,"max_battery_soc_kwh":23.55,"battery_filled_pct":86.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.08,"7":0.3,"8":1.22,"9":3.05,"10":5.78,"11":9.36,"12":13.01,"13":16.19,"14":19.32,"15":21.57,"16":23.17,"17":23.45,"18":23.55}},{"date":"2024-10-16","day_of_week":"Wednesday","total_solar_kwh":20.51,"max_battery_soc_kwh":19.22,"battery_filled_pct":70.2,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.09,"7":0.51,"8":1.22,"9":2.31,"10":4.09,"11":6.29,"12":9.98,"13":12.97,"14":15.35,"15":17.35,"16":18.6,"17":19.1,"18":19.21}},{"date":"2024-10-17","day_of_week":"Thursday","total_solar_kwh":12.64,"max_battery_soc_kwh":11.78,"battery_filled_pct":43.1,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.1,"7":0.39,"8":0.91,"9":2.22,"10":3.82,"11":4.8,"12":5.75,"13":8.56,"14":10.63,"15":11.2,"16":11.56,"17":11.72,"18":11.78}},{"date":"2024-10-18","day_of_week":"Friday","total_solar_kwh":13.44,"max_battery_soc_kwh":12.71,"battery_filled_pct":46.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.36,"8":0.81,"9":1.54,"10":2.32,"11":3.07,"12":4.47,"13":6.67,"14":9.15,"15":10.88,"16":12.27,"17":12.63,"18":12.7,"19":12.71}},{"date":"2024-10-19","day_of_week":"Saturday","total_solar_kwh":30.54,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:42","hourly_soc":{"5":0.01,"6":0.15,"7":0.49,"8":1.32,"9":3.32,"10":6.45,"11":10.34,"12":14.47,"13":18.6,"14":22.71,"15":25.63,"16":27.18,"17":27.36,"18":27.36}},{"date":"2024-10-20","day_of_week":"Sunday","total_solar_kwh":28.31,"max_battery_soc_kwh":26.07,"battery_filled_pct":95.3,"time_to_full":"17:27","hourly_soc":{"5":0.01,"6":0.11,"7":0.44,"8":1.34,"9":3.28,"10":6.36,"11":10.02,"12":13.97,"13":17.36,"14":21.32,"15":24.16,"16":25.66,"17":26.0,"18":26.07}},{"date":"2024-10-21","day_of_week":"Monday","total_solar_kwh":27.38,"max_battery_soc_kwh":25.73,"battery_filled_pct":94.0,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.27,"7":0.76,"8":1.77,"9":3.76,"10":6.58,"11":10.36,"12":13.91,"13":17.52,"14":20.97,"15":23.65,"16":25.23,"17":25.64,"18":25.72}},{"date":"2024-10-22","day_of_week":"Tuesday","total_solar_kwh":18.87,"max_battery_soc_kwh":18.07,"battery_filled_pct":66.1,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.16,"7":0.79,"8":1.88,"9":3.41,"10":5.37,"11":7.64,"12":10.45,"13":12.67,"14":14.71,"15":16.38,"16":17.56,"17":18.01,"18":18.07}},{"date":"2024-10-23","day_of_week":"Wednesday","total_solar_kwh":32.9,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:03","hourly_soc":{"5":0.01,"6":0.16,"7":0.75,"8":2.15,"9":4.72,"10":8.0,"11":12.01,"12":16.14,"13":20.27,"14":24.26,"15":26.97,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-10-24","day_of_week":"Thursday","total_solar_kwh":31.47,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:38","hourly_soc":{"5":0.01,"6":0.21,"7":0.73,"8":1.65,"9":3.37,"10":6.46,"11":10.32,"12":14.45,"13":18.58,"14":22.69,"15":25.71,"16":27.27,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-10-25","day_of_week":"Friday","total_solar_kwh":29.48,"max_battery_soc_kwh":27.07,"battery_filled_pct":98.9,"time_to_full":"16:13","hourly_soc":{"5":0.01,"6":0.13,"7":0.56,"8":1.63,"9":3.73,"10":6.97,"11":10.8,"12":14.16,"13":17.91,"14":21.86,"15":24.76,"16":26.3,"17":26.87,"18":27.06,"19":27.07}},{"date":"2024-10-26","day_of_week":"Saturday","total_solar_kwh":27.22,"max_battery_soc_kwh":24.77,"battery_filled_pct":90.5,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.18,"7":0.82,"8":1.86,"9":3.37,"10":5.74,"11":9.27,"12":12.57,"13":16.44,"14":20.52,"15":23.19,"16":24.27,"17":24.66,"18":24.77,"19":24.77}},{"date":"2024-10-27","day_of_week":"Sunday","total_solar_kwh":30.89,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:44","hourly_soc":{"5":0.01,"6":0.18,"7":0.53,"8":1.36,"9":3.45,"10":6.54,"11":10.4,"12":14.39,"13":18.51,"14":22.63,"15":25.63,"16":27.23,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-10-28","day_of_week":"Monday","total_solar_kwh":32.85,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:04","hourly_soc":{"5":0.02,"6":0.28,"7":0.96,"8":2.31,"9":4.51,"10":7.8,"11":11.78,"12":15.9,"13":20.03,"14":24.15,"15":27.0,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-10-29","day_of_week":"Tuesday","total_solar_kwh":31.68,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:24","hourly_soc":{"4":0.0,"5":0.01,"6":0.16,"7":0.52,"8":1.53,"9":3.73,"10":6.95,"11":10.9,"12":15.03,"13":19.16,"14":23.28,"15":26.28,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-10-30","day_of_week":"Wednesday","total_solar_kwh":26.04,"max_battery_soc_kwh":24.37,"battery_filled_pct":89.1,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.01,"6":0.15,"7":0.46,"8":1.46,"9":3.64,"10":6.82,"11":10.56,"12":14.59,"13":17.99,"14":20.15,"15":22.02,"16":23.66,"17":24.21,"18":24.37,"19":24.37}},{"date":"2024-10-31","day_of_week":"Thursday","total_solar_kwh":31.84,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:29","hourly_soc":{"4":0.0,"5":0.01,"6":0.16,"7":0.54,"8":1.62,"9":3.77,"10":6.82,"11":10.78,"12":14.91,"13":19.03,"14":23.16,"15":26.23,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-01","day_of_week":"Friday","total_solar_kwh":32.21,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:14","hourly_soc":{"4":0.0,"5":0.01,"6":0.16,"7":0.5,"8":1.59,"9":3.9,"10":7.2,"11":11.22,"12":15.35,"13":19.48,"14":23.61,"15":26.63,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-02","day_of_week":"Saturday","total_solar_kwh":30.3,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:44","hourly_soc":{"4":0.0,"5":0.02,"6":0.27,"7":1.09,"8":2.4,"9":4.51,"10":7.51,"11":11.11,"12":15.04,"13":19.07,"14":22.95,"15":25.68,"16":27.22,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-03","day_of_week":"Sunday","total_solar_kwh":32.73,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:00","hourly_soc":{"4":0.0,"5":0.03,"6":0.29,"7":1.08,"8":2.49,"9":4.72,"10":8.0,"11":12.0,"12":15.92,"13":19.92,"14":24.03,"15":27.04,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-04","day_of_week":"Monday","total_solar_kwh":31.87,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:25","hourly_soc":{"4":0.0,"5":0.01,"6":0.15,"7":0.77,"8":1.87,"9":3.68,"10":6.66,"11":10.55,"12":14.64,"13":18.71,"14":22.84,"15":26.08,"16":27.35,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-05","day_of_week":"Tuesday","total_solar_kwh":14.86,"max_battery_soc_kwh":14.14,"battery_filled_pct":51.7,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.03,"6":0.33,"7":0.91,"8":2.11,"9":3.37,"10":4.13,"11":5.54,"12":6.08,"13":7.23,"14":9.22,"15":11.57,"16":13.24,"17":13.86,"18":14.13,"19":14.14}},{"date":"2024-11-06","day_of_week":"Wednesday","total_solar_kwh":26.97,"max_battery_soc_kwh":24.74,"battery_filled_pct":90.4,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.01,"6":0.23,"7":0.9,"8":1.94,"9":3.46,"10":5.32,"11":8.16,"12":11.67,"13":15.34,"14":19.24,"15":22.3,"16":23.81,"17":24.48,"18":24.72,"19":24.73}},{"date":"2024-11-07","day_of_week":"Thursday","total_solar_kwh":28.13,"max_battery_soc_kwh":25.72,"battery_filled_pct":94.0,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.01,"6":0.15,"7":0.84,"8":1.97,"9":3.63,"10":6.25,"11":9.87,"12":13.16,"13":16.58,"14":20.0,"15":23.13,"16":25.04,"17":25.6,"18":25.7,"19":25.72}},{"date":"2024-11-08","day_of_week":"Friday","total_solar_kwh":32.61,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:30","hourly_soc":{"4":0.0,"5":0.01,"6":0.21,"7":0.76,"8":1.97,"9":4.01,"10":7.46,"11":11.28,"12":14.46,"13":18.53,"14":22.66,"15":26.01,"16":27.35,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-09","day_of_week":"Saturday","total_solar_kwh":17.56,"max_battery_soc_kwh":16.74,"battery_filled_pct":61.2,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.01,"6":0.17,"7":0.63,"8":1.34,"9":2.39,"10":3.49,"11":4.68,"12":6.87,"13":9.68,"14":11.61,"15":14.12,"16":16.02,"17":16.58,"18":16.72,"19":16.74}},{"date":"2024-11-10","day_of_week":"Sunday","total_solar_kwh":32.84,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:06","hourly_soc":{"4":0.0,"5":0.03,"6":0.2,"7":0.65,"8":1.82,"9":3.93,"10":7.17,"11":11.17,"12":15.3,"13":19.43,"14":23.55,"15":26.78,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-11","day_of_week":"Monday","total_solar_kwh":24.97,"max_battery_soc_kwh":23.37,"battery_filled_pct":85.4,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.04,"6":0.31,"7":0.94,"8":2.38,"9":4.65,"10":7.74,"11":10.77,"12":13.53,"13":15.83,"14":19.24,"15":21.41,"16":22.62,"17":23.07,"18":23.34,"19":23.37}},{"date":"2024-11-12","day_of_week":"Tuesday","total_solar_kwh":33.28,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:04","hourly_soc":{"4":0.0,"5":0.03,"6":0.23,"7":0.63,"8":1.8,"9":4.11,"10":7.44,"11":11.44,"12":15.56,"13":19.69,"14":23.82,"15":26.93,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-13","day_of_week":"Wednesday","total_solar_kwh":33.63,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:15","hourly_soc":{"4":0.0,"5":0.03,"6":0.34,"7":0.88,"8":2.06,"9":3.8,"10":6.69,"11":10.69,"12":14.81,"13":18.94,"14":23.07,"15":26.52,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-11-14","day_of_week":"Thursday","total_solar_kwh":10.15,"max_battery_soc_kwh":9.46,"battery_filled_pct":34.6,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.04,"6":0.4,"7":1.19,"8":2.33,"9":4.15,"10":6.88,"11":8.91}},{"date":"2024-11-30","day_of_week":"Saturday","total_solar_kwh":11.47,"max_battery_soc_kwh":10.01,"battery_filled_pct":36.6,"time_to_full":null,"hourly_soc":{"13":0.69,"14":3.23,"15":6.82,"16":9.01,"17":9.86,"18":9.98,"19":10.01}},{"date":"2024-12-01","day_of_week":"Sunday","total_solar_kwh":35.82,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:54","hourly_soc":{"4":0.0,"5":0.04,"6":0.29,"7":0.78,"8":2.06,"9":4.71,"10":8.37,"11":12.42,"12":16.48,"13":20.6,"14":24.73,"15":27.32,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-02","day_of_week":"Monday","total_solar_kwh":20.73,"max_battery_soc_kwh":19.84,"battery_filled_pct":72.5,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.1,"6":0.47,"7":1.12,"8":2.46,"9":4.86,"10":8.26,"11":11.78,"12":14.72,"13":17.41,"14":18.72,"15":19.23,"16":19.45,"17":19.73,"18":19.82,"19":19.84}},{"date":"2024-12-03","day_of_week":"Tuesday","total_solar_kwh":32.02,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:19","hourly_soc":{"4":0.0,"5":0.01,"6":0.13,"7":0.32,"8":0.74,"9":1.51,"10":4.5,"11":8.35,"12":12.33,"13":16.46,"14":20.58,"15":24.25,"16":26.48,"17":27.35,"18":27.36,"19":27.36}},{"date":"2024-12-04","day_of_week":"Wednesday","total_solar_kwh":33.97,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:10","hourly_soc":{"4":0.0,"5":0.03,"6":0.22,"7":0.61,"8":1.88,"9":4.35,"10":7.85,"11":11.91,"12":16.04,"13":19.82,"14":23.44,"15":26.82,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-05","day_of_week":"Thursday","total_solar_kwh":6.56,"max_battery_soc_kwh":6.17,"battery_filled_pct":22.5,"time_to_full":null,"hourly_soc":{"4":0.0,"14":0.55,"15":2.99,"16":5.07,"17":6.02,"18":6.14,"19":6.16}},{"date":"2024-12-06","day_of_week":"Friday","total_solar_kwh":19.4,"max_battery_soc_kwh":18.6,"battery_filled_pct":68.0,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.01,"6":0.25,"7":0.92,"8":1.91,"9":3.38,"10":5.41,"11":8.39,"12":10.64,"13":12.24,"14":14.57,"15":16.13,"16":17.15,"17":18.01,"18":18.51,"19":18.59}},{"date":"2024-12-07","day_of_week":"Saturday","total_solar_kwh":36.2,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:51","hourly_soc":{"4":0.0,"5":0.04,"6":0.3,"7":0.9,"8":2.17,"9":4.6,"10":8.08,"11":12.14,"12":16.27,"13":20.39,"14":24.52,"15":27.29,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-08","day_of_week":"Sunday","total_solar_kwh":34.08,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:16","hourly_soc":{"4":0.0,"5":0.04,"6":0.42,"7":1.0,"8":2.56,"9":4.91,"10":8.38,"11":12.43,"12":16.26,"13":19.51,"14":23.31,"15":26.74,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-09","day_of_week":"Monday","total_solar_kwh":32.97,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:26","hourly_soc":{"4":0.0,"5":0.01,"6":0.14,"7":0.72,"8":1.88,"9":3.88,"10":6.41,"11":10.23,"12":14.2,"13":18.2,"14":22.33,"15":26.07,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-10","day_of_week":"Tuesday","total_solar_kwh":36.48,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:49","hourly_soc":{"4":0.0,"5":0.05,"6":0.37,"7":1.05,"8":2.4,"9":4.78,"10":8.23,"11":12.27,"12":16.4,"13":20.53,"14":24.83,"15":27.35,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-11","day_of_week":"Wednesday","total_solar_kwh":36.37,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:54","hourly_soc":{"4":0.0,"5":0.05,"6":0.34,"7":0.83,"8":2.14,"9":4.63,"10":8.2,"11":12.29,"12":16.42,"13":20.55,"14":24.68,"15":27.31,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-12","day_of_week":"Thursday","total_solar_kwh":35.75,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:59","hourly_soc":{"4":0.0,"5":0.05,"6":0.29,"7":0.73,"8":1.99,"9":4.42,"10":7.9,"11":11.97,"12":16.1,"13":20.23,"14":24.36,"15":27.25,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-13","day_of_week":"Friday","total_solar_kwh":36.0,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:59","hourly_soc":{"4":0.0,"5":0.03,"6":0.22,"7":0.74,"8":2.03,"9":4.45,"10":7.96,"11":12.03,"12":16.16,"13":20.29,"14":24.42,"15":27.27,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-14","day_of_week":"Saturday","total_solar_kwh":23.27,"max_battery_soc_kwh":22.22,"battery_filled_pct":81.2,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.07,"6":0.46,"7":1.18,"8":2.51,"9":4.75,"10":7.63,"11":9.7,"12":11.67,"13":14.28,"14":17.1,"15":19.13,"16":20.73,"17":21.66,"18":22.15,"19":22.21}},{"date":"2024-12-15","day_of_week":"Sunday","total_solar_kwh":29.59,"max_battery_soc_kwh":27.13,"battery_filled_pct":99.2,"time_to_full":"16:54","hourly_soc":{"4":0.0,"5":0.05,"6":0.27,"7":0.78,"8":2.05,"9":4.38,"10":7.09,"11":9.94,"12":13.88,"13":17.88,"14":21.19,"15":23.29,"16":25.47,"17":26.59,"18":27.03,"19":27.13}},{"date":"2024-12-16","day_of_week":"Monday","total_solar_kwh":30.01,"max_battery_soc_kwh":27.24,"battery_filled_pct":99.6,"time_to_full":"16:54","hourly_soc":{"4":0.0,"5":0.04,"6":0.23,"7":0.62,"8":1.79,"9":3.62,"10":6.0,"11":9.53,"12":13.49,"13":17.4,"14":20.25,"15":23.45,"16":25.34,"17":26.75,"18":27.18,"19":27.23}},{"date":"2024-12-17","day_of_week":"Tuesday","total_solar_kwh":36.66,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"14:54","hourly_soc":{"4":0.0,"5":0.05,"6":0.38,"7":0.88,"8":1.94,"9":4.5,"10":8.06,"11":12.17,"12":16.29,"13":20.42,"14":24.55,"15":27.29,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-18","day_of_week":"Wednesday","total_solar_kwh":35.49,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:00","hourly_soc":{"4":0.0,"5":0.03,"6":0.21,"7":0.58,"8":1.78,"9":4.16,"10":7.6,"11":11.65,"12":15.78,"13":19.91,"14":24.03,"15":27.17,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-19","day_of_week":"Thursday","total_solar_kwh":35.66,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:05","hourly_soc":{"4":0.0,"5":0.03,"6":0.19,"7":0.56,"8":1.72,"9":4.02,"10":7.33,"11":11.31,"12":15.44,"13":19.57,"14":23.7,"15":27.05,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-20","day_of_week":"Friday","total_solar_kwh":36.04,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:00","hourly_soc":{"4":0.0,"5":0.04,"6":0.21,"7":0.57,"8":1.69,"9":3.96,"10":7.38,"11":11.44,"12":15.56,"13":19.69,"14":23.82,"15":27.1,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-21","day_of_week":"Saturday","total_solar_kwh":36.28,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:00","hourly_soc":{"4":0.0,"5":0.03,"6":0.21,"7":0.61,"8":1.79,"9":4.15,"10":7.58,"11":11.64,"12":15.77,"13":19.9,"14":24.03,"15":27.17,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-22","day_of_week":"Sunday","total_solar_kwh":35.86,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:00","hourly_soc":{"4":0.0,"5":0.03,"6":0.2,"7":0.59,"8":1.83,"9":4.19,"10":7.66,"11":11.72,"12":15.78,"13":19.91,"14":24.03,"15":27.17,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-23","day_of_week":"Monday","total_solar_kwh":33.95,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:40","hourly_soc":{"4":0.0,"5":0.04,"6":0.31,"7":0.85,"8":1.68,"9":3.3,"10":6.14,"11":9.05,"12":13.16,"13":17.28,"14":21.38,"15":25.33,"16":27.29,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-24","day_of_week":"Tuesday","total_solar_kwh":35.81,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:01","hourly_soc":{"4":0.0,"5":0.03,"6":0.2,"7":0.57,"8":1.71,"9":4.01,"10":7.37,"11":11.39,"12":15.51,"13":19.64,"14":23.77,"15":27.08,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-25","day_of_week":"Wednesday","total_solar_kwh":35.14,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:06","hourly_soc":{"4":0.0,"5":0.03,"6":0.19,"7":0.52,"8":1.61,"9":3.84,"10":7.12,"11":11.09,"12":15.22,"13":19.35,"14":23.48,"15":26.96,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2024-12-26","day_of_week":"Thursday","total_solar_kwh":16.65,"max_battery_soc_kwh":15.37,"battery_filled_pct":56.2,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.02,"6":0.16,"7":0.27,"8":0.66,"9":1.35,"10":2.91,"11":4.71,"12":6.5,"13":8.69,"14":11.61,"15":13.03,"16":14.02,"17":14.77,"18":15.24,"19":15.37,"20":15.37}},{"date":"2024-12-27","day_of_week":"Friday","total_solar_kwh":30.21,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:45","hourly_soc":{"4":0.0,"5":0.03,"6":0.3,"7":1.02,"8":2.46,"9":4.54,"10":7.16,"11":10.83,"12":14.95,"13":18.32,"14":20.78,"15":23.8,"16":25.66,"17":27.07,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-28","day_of_week":"Saturday","total_solar_kwh":25.44,"max_battery_soc_kwh":23.24,"battery_filled_pct":84.9,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.02,"6":0.18,"7":0.76,"8":1.72,"9":2.79,"10":4.22,"11":7.07,"12":11.05,"13":13.82,"14":16.31,"15":19.68,"16":21.78,"17":22.95,"18":23.17,"19":23.24,"20":23.24}},{"date":"2024-12-29","day_of_week":"Sunday","total_solar_kwh":34.16,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:34","hourly_soc":{"4":0.0,"5":0.06,"6":0.33,"7":0.87,"8":2.19,"9":3.66,"10":5.89,"11":9.44,"12":13.57,"13":17.7,"14":21.83,"15":25.73,"16":27.35,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-30","day_of_week":"Monday","total_solar_kwh":32.02,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:35","hourly_soc":{"4":0.0,"5":0.04,"6":0.37,"7":0.98,"8":2.26,"9":4.37,"10":7.35,"11":11.15,"12":14.59,"13":18.32,"14":22.32,"15":25.71,"16":27.29,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2024-12-31","day_of_week":"Tuesday","total_solar_kwh":35.35,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:10","hourly_soc":{"4":0.0,"5":0.03,"6":0.22,"7":0.6,"8":1.64,"9":3.84,"10":7.14,"11":11.13,"12":15.08,"13":19.04,"14":23.17,"15":26.81,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-01","day_of_week":"Wednesday","total_solar_kwh":36.18,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:06","hourly_soc":{"4":0.0,"5":0.02,"6":0.18,"7":0.52,"8":1.59,"9":3.86,"10":7.23,"11":11.27,"12":15.39,"13":19.52,"14":23.64,"15":27.0,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-02","day_of_week":"Thursday","total_solar_kwh":35.94,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:05","hourly_soc":{"4":0.0,"5":0.03,"6":0.23,"7":0.63,"8":1.69,"9":3.93,"10":7.24,"11":11.24,"12":15.37,"13":19.5,"14":23.63,"15":27.02,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-03","day_of_week":"Friday","total_solar_kwh":35.25,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:10","hourly_soc":{"4":0.0,"5":0.02,"6":0.21,"7":0.58,"8":1.59,"9":3.76,"10":7.02,"11":10.98,"12":15.11,"13":19.24,"14":23.37,"15":26.91,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-04","day_of_week":"Saturday","total_solar_kwh":18.97,"max_battery_soc_kwh":18.17,"battery_filled_pct":66.4,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.02,"6":0.25,"7":0.95,"8":2.33,"9":4.13,"10":6.54,"11":8.98,"12":11.02,"13":13.7,"14":15.33,"15":16.45,"16":17.22,"17":17.76,"18":18.08,"19":18.17}},{"date":"2025-01-05","day_of_week":"Sunday","total_solar_kwh":14.69,"max_battery_soc_kwh":14.05,"battery_filled_pct":51.3,"time_to_full":null,"hourly_soc":{"4":0.0,"5":0.02,"6":0.24,"7":0.96,"8":2.21,"9":3.07,"10":4.61,"11":6.0,"12":7.69,"13":9.67,"14":11.65,"15":12.71,"16":13.39,"17":13.8,"18":14.0,"19":14.04}},{"date":"2025-01-06","day_of_week":"Monday","total_solar_kwh":25.14,"max_battery_soc_kwh":23.18,"battery_filled_pct":84.7,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.16,"7":0.66,"8":1.71,"9":3.43,"10":6.19,"11":9.07,"12":11.84,"13":14.66,"14":16.93,"15":19.55,"16":21.3,"17":22.55,"18":23.09,"19":23.17,"20":23.18}},{"date":"2025-01-07","day_of_week":"Tuesday","total_solar_kwh":36.04,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:06","hourly_soc":{"4":0.0,"5":0.02,"6":0.18,"7":0.5,"8":1.52,"9":3.78,"10":7.17,"11":11.2,"12":15.33,"13":19.46,"14":23.59,"15":27.01,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-08","day_of_week":"Wednesday","total_solar_kwh":34.09,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:21","hourly_soc":{"4":0.0,"5":0.01,"6":0.16,"7":0.46,"8":1.42,"9":3.52,"10":6.7,"11":10.58,"12":14.66,"13":18.77,"14":22.85,"15":26.53,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-09","day_of_week":"Thursday","total_solar_kwh":33.12,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:41","hourly_soc":{"5":0.01,"6":0.08,"7":0.34,"8":0.92,"9":2.05,"10":4.96,"11":8.96,"12":13.08,"13":17.21,"14":21.34,"15":25.32,"16":27.29,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-10","day_of_week":"Friday","total_solar_kwh":34.59,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:16","hourly_soc":{"4":0.0,"5":0.02,"6":0.16,"7":0.48,"8":1.45,"9":3.48,"10":6.55,"11":10.45,"12":14.58,"13":18.71,"14":22.84,"15":26.63,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-11","day_of_week":"Saturday","total_solar_kwh":34.94,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:12","hourly_soc":{"4":0.0,"5":0.02,"6":0.28,"7":1.02,"8":2.1,"9":4.17,"10":7.07,"11":10.84,"12":14.95,"13":19.08,"14":23.21,"15":26.78,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-12","day_of_week":"Sunday","total_solar_kwh":34.64,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:22","hourly_soc":{"5":0.01,"6":0.12,"7":0.47,"8":1.37,"9":3.37,"10":6.43,"11":10.31,"12":14.44,"13":18.56,"14":22.69,"15":26.54,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-13","day_of_week":"Monday","total_solar_kwh":35.26,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:12","hourly_soc":{"4":0.0,"5":0.01,"6":0.14,"7":0.65,"8":1.72,"9":3.72,"10":6.84,"11":10.77,"12":14.9,"13":19.03,"14":23.15,"15":26.8,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-14","day_of_week":"Tuesday","total_solar_kwh":34.59,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:17","hourly_soc":{"4":0.0,"5":0.01,"6":0.19,"7":0.74,"8":1.84,"9":3.73,"10":6.86,"11":10.79,"12":14.78,"13":18.85,"14":22.98,"15":26.69,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-15","day_of_week":"Wednesday","total_solar_kwh":33.13,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:02","hourly_soc":{"5":0.0,"6":0.15,"7":0.58,"8":1.52,"9":3.15,"10":5.29,"11":8.2,"12":12.23,"13":16.36,"14":20.46,"15":24.43,"16":26.92,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-16","day_of_week":"Thursday","total_solar_kwh":28.22,"max_battery_soc_kwh":26.02,"battery_filled_pct":95.1,"time_to_full":"18:57","hourly_soc":{"4":0.0,"5":0.01,"6":0.18,"7":0.62,"8":1.15,"9":2.15,"10":4.38,"11":7.67,"12":10.86,"13":14.26,"14":17.93,"15":21.63,"16":24.12,"17":25.6,"18":25.95,"19":26.01,"20":26.02}},{"date":"2025-01-17","day_of_week":"Friday","total_solar_kwh":33.28,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:33","hourly_soc":{"4":0.0,"5":0.01,"6":0.12,"7":0.39,"8":1.26,"9":3.2,"10":6.48,"11":10.21,"12":13.82,"13":17.89,"14":22.02,"15":25.98,"16":27.36,"17":27.36,"18":27.36,"19":27.36,"20":27.36}},{"date":"2025-01-18","day_of_week":"Saturday","total_solar_kwh":34.03,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:23","hourly_soc":{"5":0.01,"6":0.14,"7":0.39,"8":1.22,"9":3.18,"10":6.22,"11":10.06,"12":14.18,"13":18.3,"14":22.43,"15":26.35,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-19","day_of_week":"Sunday","total_solar_kwh":30.19,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:33","hourly_soc":{"5":0.02,"6":0.12,"7":0.51,"8":1.41,"9":3.32,"10":6.12,"11":9.24,"12":12.92,"13":16.36,"14":19.94,"15":23.63,"16":25.93,"17":27.27,"18":27.36,"19":27.36}},{"date":"2025-01-20","day_of_week":"Monday","total_solar_kwh":29.12,"max_battery_soc_kwh":27.06,"battery_filled_pct":98.9,"time_to_full":"17:03","hourly_soc":{"5":0.01,"6":0.14,"7":0.68,"8":1.69,"9":3.42,"10":5.72,"11":8.77,"12":12.1,"13":15.57,"14":19.24,"15":22.76,"16":25.09,"17":26.52,"18":27.0,"19":27.05}},{"date":"2025-01-21","day_of_week":"Tuesday","total_solar_kwh":33.51,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:33","hourly_soc":{"5":0.01,"6":0.12,"7":0.38,"8":1.16,"9":3.04,"10":6.01,"11":9.75,"12":13.87,"13":18.0,"14":22.11,"15":25.9,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-22","day_of_week":"Wednesday","total_solar_kwh":33.56,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:28","hourly_soc":{"5":0.0,"6":0.1,"7":0.38,"8":1.2,"9":3.13,"10":6.21,"11":10.09,"12":14.22,"13":18.35,"14":22.3,"15":26.08,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-23","day_of_week":"Thursday","total_solar_kwh":21.61,"max_battery_soc_kwh":20.07,"battery_filled_pct":73.4,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.15,"7":0.64,"8":1.47,"9":3.04,"10":4.74,"11":6.7,"12":8.69,"13":10.31,"14":12.33,"15":15.91,"16":18.44,"17":19.78,"18":20.01,"19":20.07}},{"date":"2025-01-24","day_of_week":"Friday","total_solar_kwh":34.47,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:24","hourly_soc":{"5":0.01,"6":0.14,"7":0.45,"8":1.22,"9":3.13,"10":6.19,"11":10.11,"12":14.23,"13":18.36,"14":22.49,"15":26.39,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-25","day_of_week":"Saturday","total_solar_kwh":34.23,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:24","hourly_soc":{"5":0.01,"6":0.2,"7":0.74,"8":1.65,"9":3.47,"10":6.45,"11":10.24,"12":14.36,"13":18.49,"14":22.61,"15":26.48,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-26","day_of_week":"Sunday","total_solar_kwh":28.64,"max_battery_soc_kwh":26.66,"battery_filled_pct":97.5,"time_to_full":"16:59","hourly_soc":{"5":0.0,"6":0.17,"7":0.63,"8":1.53,"9":3.2,"10":6.04,"11":9.73,"12":13.36,"13":16.82,"14":19.5,"15":22.75,"16":25.21,"17":26.4,"18":26.58,"19":26.66}},{"date":"2025-01-27","day_of_week":"Monday","total_solar_kwh":31.52,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:14","hourly_soc":{"5":0.01,"6":0.1,"7":0.39,"8":1.2,"9":2.95,"10":5.78,"11":9.42,"12":13.13,"13":16.87,"14":20.88,"15":24.36,"16":26.61,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-28","day_of_week":"Tuesday","total_solar_kwh":32.6,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:54","hourly_soc":{"5":0.01,"6":0.12,"7":0.71,"8":1.83,"9":3.61,"10":5.73,"11":8.8,"12":12.73,"13":16.86,"14":20.98,"15":24.93,"16":27.13,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-29","day_of_week":"Wednesday","total_solar_kwh":33.45,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:29","hourly_soc":{"5":0.0,"6":0.1,"7":0.4,"8":1.12,"9":3.01,"10":6.02,"11":9.86,"12":13.98,"13":18.11,"14":22.24,"15":26.16,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-30","day_of_week":"Thursday","total_solar_kwh":33.41,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:29","hourly_soc":{"5":0.01,"6":0.13,"7":0.45,"8":1.18,"9":3.02,"10":6.04,"11":9.89,"12":14.02,"13":18.14,"14":22.27,"15":26.18,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-01-31","day_of_week":"Friday","total_solar_kwh":32.61,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:34","hourly_soc":{"5":0.0,"6":0.08,"7":0.31,"8":0.97,"9":2.75,"10":5.69,"11":9.46,"12":13.58,"13":17.71,"14":21.83,"15":25.72,"16":27.34,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-01","day_of_week":"Saturday","total_solar_kwh":32.16,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:39","hourly_soc":{"5":0.01,"6":0.1,"7":0.33,"8":0.99,"9":2.73,"10":5.57,"11":9.24,"12":13.34,"13":17.47,"14":21.6,"15":25.48,"16":27.28,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-02","day_of_week":"Sunday","total_solar_kwh":31.12,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:50","hourly_soc":{"5":0.0,"6":0.08,"7":0.38,"8":1.12,"9":2.72,"10":5.38,"11":8.78,"12":12.73,"13":16.85,"14":20.98,"15":24.93,"16":27.08,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-03","day_of_week":"Monday","total_solar_kwh":29.93,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:05","hourly_soc":{"5":0.0,"6":0.08,"7":0.32,"8":0.93,"9":2.41,"10":4.95,"11":8.3,"12":12.22,"13":16.35,"14":20.48,"15":24.4,"16":26.68,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-04","day_of_week":"Tuesday","total_solar_kwh":30.72,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:15","hourly_soc":{"5":0.0,"6":0.09,"7":0.43,"8":1.08,"9":2.61,"10":4.66,"11":8.02,"12":12.01,"13":16.14,"14":20.27,"15":24.22,"16":26.6,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-05","day_of_week":"Wednesday","total_solar_kwh":31.48,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:50","hourly_soc":{"5":0.0,"6":0.07,"7":0.28,"8":0.83,"9":2.42,"10":5.16,"11":8.77,"12":12.85,"13":16.98,"14":21.11,"15":25.03,"16":27.14,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-06","day_of_week":"Thursday","total_solar_kwh":29.98,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:05","hourly_soc":{"5":0.0,"6":0.08,"7":0.39,"8":1.04,"9":2.53,"10":5.06,"11":8.39,"12":12.29,"13":16.41,"14":20.54,"15":24.44,"16":26.72,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-07","day_of_week":"Friday","total_solar_kwh":32.83,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:31","hourly_soc":{"5":0.0,"6":0.1,"7":0.57,"8":1.56,"9":3.17,"10":5.84,"11":9.42,"12":13.5,"13":17.63,"14":21.76,"15":25.68,"16":27.34,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-08","day_of_week":"Saturday","total_solar_kwh":31.98,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:47","hourly_soc":{"5":0.0,"6":0.08,"7":0.29,"8":0.84,"9":2.43,"10":5.2,"11":8.87,"12":12.98,"13":17.1,"14":21.23,"15":25.12,"16":27.16,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-09","day_of_week":"Sunday","total_solar_kwh":31.16,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:57","hourly_soc":{"5":0.0,"6":0.07,"7":0.36,"8":0.94,"9":2.49,"10":5.18,"11":8.74,"12":12.8,"13":16.93,"14":21.06,"15":24.92,"16":27.04,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-10","day_of_week":"Monday","total_solar_kwh":30.43,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:02","hourly_soc":{"5":0.0,"6":0.05,"7":0.25,"8":0.79,"9":2.32,"10":4.98,"11":8.52,"12":12.58,"13":16.71,"14":20.83,"15":24.68,"16":26.86,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-11","day_of_week":"Tuesday","total_solar_kwh":29.36,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:22","hourly_soc":{"5":0.0,"6":0.08,"7":0.33,"8":0.85,"9":2.31,"10":4.85,"11":8.22,"12":12.12,"13":16.24,"14":20.37,"15":24.19,"16":26.33,"17":27.26,"18":27.36,"19":27.36}},{"date":"2025-02-12","day_of_week":"Wednesday","total_solar_kwh":28.52,"max_battery_soc_kwh":27.1,"battery_filled_pct":99.1,"time_to_full":"16:47","hourly_soc":{"5":0.0,"6":0.06,"7":0.25,"8":0.72,"9":2.12,"10":4.6,"11":7.92,"12":11.81,"13":15.93,"14":20.02,"15":23.78,"16":25.7,"17":26.78,"18":27.07,"19":27.1}},{"date":"2025-02-13","day_of_week":"Thursday","total_solar_kwh":26.3,"max_battery_soc_kwh":23.92,"battery_filled_pct":87.4,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.17,"8":0.52,"9":1.45,"10":2.91,"11":5.67,"12":9.11,"13":12.71,"14":16.6,"15":20.38,"16":22.71,"17":23.7,"18":23.89,"19":23.92}},{"date":"2025-02-14","day_of_week":"Friday","total_solar_kwh":26.61,"max_battery_soc_kwh":23.91,"battery_filled_pct":87.4,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.3,"8":1.08,"9":2.62,"10":4.62,"11":7.08,"12":10.46,"13":14.07,"14":17.49,"15":20.14,"16":22.51,"17":23.65,"18":23.87,"19":23.91}},{"date":"2025-02-15","day_of_week":"Saturday","total_solar_kwh":28.69,"max_battery_soc_kwh":25.85,"battery_filled_pct":94.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.37,"8":1.31,"9":2.98,"10":5.08,"11":7.84,"12":11.24,"13":14.3,"14":17.9,"15":21.64,"16":24.16,"17":25.43,"18":25.81,"19":25.85}},{"date":"2025-02-16","day_of_week":"Sunday","total_solar_kwh":31.09,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:13","hourly_soc":{"5":0.0,"6":0.08,"7":0.35,"8":1.16,"9":2.66,"10":5.0,"11":8.18,"12":12.3,"13":16.43,"14":20.56,"15":24.36,"16":26.64,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-17","day_of_week":"Monday","total_solar_kwh":29.86,"max_battery_soc_kwh":27.09,"battery_filled_pct":99.0,"time_to_full":"16:28","hourly_soc":{"5":0.0,"6":0.05,"7":0.24,"8":0.74,"9":2.27,"10":5.0,"11":8.29,"12":12.14,"13":16.16,"14":20.18,"15":23.91,"16":26.08,"17":26.89,"18":27.03,"19":27.09}},{"date":"2025-02-18","day_of_week":"Tuesday","total_solar_kwh":30.91,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:08","hourly_soc":{"5":0.0,"6":0.05,"7":0.31,"8":0.81,"9":2.29,"10":4.96,"11":8.57,"12":12.66,"13":16.79,"14":20.92,"15":24.67,"16":26.83,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-19","day_of_week":"Wednesday","total_solar_kwh":31.39,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:54","hourly_soc":{"5":0.0,"6":0.05,"7":0.29,"8":0.92,"9":2.55,"10":5.28,"11":8.93,"12":13.03,"13":17.16,"14":21.29,"15":25.04,"16":27.07,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-20","day_of_week":"Thursday","total_solar_kwh":30.28,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"16:09","hourly_soc":{"5":0.0,"6":0.04,"7":0.22,"8":0.69,"9":2.19,"10":4.92,"11":8.56,"12":12.65,"13":16.78,"14":20.91,"15":24.6,"16":26.68,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-02-21","day_of_week":"Friday","total_solar_kwh":29.71,"max_battery_soc_kwh":27.26,"battery_filled_pct":99.6,"time_to_full":"16:24","hourly_soc":{"5":0.0,"6":0.04,"7":0.23,"8":0.68,"9":2.11,"10":4.7,"11":8.2,"12":12.22,"13":16.35,"14":20.46,"15":24.03,"16":26.19,"17":26.97,"18":27.22,"19":27.25}},{"date":"2025-02-22","day_of_week":"Saturday","total_solar_kwh":22.17,"max_battery_soc_kwh":20.92,"battery_filled_pct":76.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.26,"8":0.71,"9":2.05,"10":4.55,"11":7.95,"12":11.93,"13":15.62,"14":17.62,"15":19.18,"16":20.22,"17":20.73,"18":20.91,"19":20.92}},{"date":"2025-02-23","day_of_week":"Sunday","total_solar_kwh":29.05,"max_battery_soc_kwh":26.21,"battery_filled_pct":95.8,"time_to_full":"17:32","hourly_soc":{"5":0.0,"6":0.05,"7":0.4,"8":1.1,"9":2.48,"10":5.07,"11":8.54,"12":12.22,"13":15.32,"14":19.35,"15":23.07,"16":25.21,"17":25.99,"18":26.18,"19":26.21}},{"date":"2025-02-24","day_of_week":"Monday","total_solar_kwh":28.13,"max_battery_soc_kwh":25.13,"battery_filled_pct":91.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.33,"8":1.1,"9":2.33,"10":4.59,"11":7.24,"12":10.52,"13":14.47,"14":18.6,"15":22.28,"16":24.36,"17":25.04,"18":25.11,"19":25.13}},{"date":"2025-02-25","day_of_week":"Tuesday","total_solar_kwh":28.36,"max_battery_soc_kwh":26.37,"battery_filled_pct":96.4,"time_to_full":"16:42","hourly_soc":{"5":0.0,"6":0.02,"7":0.18,"8":0.58,"9":1.89,"10":4.38,"11":7.77,"12":11.76,"13":15.89,"14":20.01,"15":23.66,"16":25.65,"17":26.29,"18":26.36,"19":26.37}},{"date":"2025-02-26","day_of_week":"Wednesday","total_solar_kwh":28.04,"max_battery_soc_kwh":26.02,"battery_filled_pct":95.1,"time_to_full":"18:07","hourly_soc":{"5":0.0,"6":0.03,"7":0.25,"8":0.68,"9":1.94,"10":4.35,"11":7.69,"12":11.58,"13":15.69,"14":19.82,"15":23.44,"16":25.29,"17":25.93,"18":26.0,"19":26.02}},{"date":"2025-02-27","day_of_week":"Thursday","total_solar_kwh":26.3,"max_battery_soc_kwh":24.86,"battery_filled_pct":90.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.27,"8":0.73,"9":1.96,"10":4.36,"11":7.59,"12":11.44,"13":15.55,"14":19.39,"15":22.38,"16":24.05,"17":24.66,"18":24.85,"19":24.86}},{"date":"2025-02-28","day_of_week":"Friday","total_solar_kwh":27.89,"max_battery_soc_kwh":26.13,"battery_filled_pct":95.5,"time_to_full":"16:58","hourly_soc":{"5":0.0,"6":0.02,"7":0.28,"8":1.04,"9":2.27,"10":4.63,"11":7.91,"12":11.82,"13":15.94,"14":20.07,"15":23.62,"16":25.52,"17":26.06,"18":26.12,"19":26.13}},{"date":"2025-03-01","day_of_week":"Saturday","total_solar_kwh":23.56,"max_battery_soc_kwh":22.19,"battery_filled_pct":81.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.03,"7":0.29,"8":1.05,"9":2.32,"10":4.02,"11":7.11,"12":10.59,"13":13.89,"14":17.09,"15":19.59,"16":21.53,"17":22.09,"18":22.17,"19":22.19}},{"date":"2025-03-02","day_of_week":"Sunday","total_solar_kwh":22.61,"max_battery_soc_kwh":20.83,"battery_filled_pct":76.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.33,"8":1.06,"9":2.45,"10":4.35,"11":6.51,"12":8.56,"13":11.23,"14":14.85,"15":18.25,"16":20.18,"17":20.73,"18":20.81,"19":20.83}},{"date":"2025-03-03","day_of_week":"Monday","total_solar_kwh":27.78,"max_battery_soc_kwh":25.58,"battery_filled_pct":93.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.18,"8":0.54,"9":1.79,"10":4.21,"11":7.56,"12":11.53,"13":15.66,"14":19.78,"15":23.28,"16":25.04,"17":25.54,"18":25.57,"19":25.58}},{"date":"2025-03-04","day_of_week":"Tuesday","total_solar_kwh":26.94,"max_battery_soc_kwh":25.27,"battery_filled_pct":92.4,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.17,"8":0.53,"9":1.74,"10":4.12,"11":7.38,"12":11.25,"13":15.37,"14":19.5,"15":22.95,"16":24.77,"17":25.21,"18":25.26,"19":25.27}},{"date":"2025-03-05","day_of_week":"Wednesday","total_solar_kwh":26.77,"max_battery_soc_kwh":25.06,"battery_filled_pct":91.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.17,"8":0.52,"9":1.7,"10":4.03,"11":7.24,"12":11.11,"13":15.23,"14":19.36,"15":22.77,"16":24.55,"17":25.0,"18":25.05,"19":25.06}},{"date":"2025-03-06","day_of_week":"Thursday","total_solar_kwh":26.77,"max_battery_soc_kwh":25.11,"battery_filled_pct":91.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.03,"7":0.23,"8":0.69,"9":1.91,"10":4.24,"11":7.18,"12":11.12,"13":15.24,"14":19.37,"15":22.77,"16":24.54,"17":25.01,"18":25.1,"19":25.11}},{"date":"2025-03-07","day_of_week":"Friday","total_solar_kwh":25.0,"max_battery_soc_kwh":23.87,"battery_filled_pct":87.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.17,"8":0.53,"9":1.65,"10":3.84,"11":6.94,"12":10.65,"13":14.7,"14":18.59,"15":21.6,"16":23.26,"17":23.77,"18":23.86,"19":23.87}},{"date":"2025-03-08","day_of_week":"Saturday","total_solar_kwh":22.78,"max_battery_soc_kwh":21.69,"battery_filled_pct":79.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.15,"8":0.48,"9":1.59,"10":3.85,"11":7.0,"12":10.5,"13":14.44,"14":17.3,"15":19.46,"16":21.22,"17":21.63,"18":21.69,"19":21.69}},{"date":"2025-03-09","day_of_week":"Sunday","total_solar_kwh":20.86,"max_battery_soc_kwh":20.0,"battery_filled_pct":73.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.19,"8":0.63,"9":1.56,"10":2.61,"11":4.01,"12":6.8,"13":10.81,"14":14.92,"15":18.1,"16":19.65,"17":19.95,"18":19.99,"19":20.0}},{"date":"2025-03-10","day_of_week":"Monday","total_solar_kwh":23.86,"max_battery_soc_kwh":22.89,"battery_filled_pct":83.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.15,"8":0.46,"9":1.47,"10":3.34,"11":6.27,"12":9.8,"13":13.59,"14":17.68,"15":20.83,"16":22.4,"17":22.8,"18":22.88,"19":22.89}},{"date":"2025-03-11","day_of_week":"Tuesday","total_solar_kwh":14.61,"max_battery_soc_kwh":14.02,"battery_filled_pct":51.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.2,"8":0.81,"9":2.03,"10":3.44,"11":4.85,"12":6.18,"13":8.27,"14":10.71,"15":12.82,"16":13.4,"17":13.84,"18":14.01,"19":14.02}},{"date":"2025-03-12","day_of_week":"Wednesday","total_solar_kwh":24.94,"max_battery_soc_kwh":23.89,"battery_filled_pct":87.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.33,"8":0.89,"9":1.94,"10":4.01,"11":6.99,"12":10.65,"13":14.7,"14":18.82,"15":21.98,"16":23.53,"17":23.84,"18":23.88,"19":23.89}},{"date":"2025-03-13","day_of_week":"Thursday","total_solar_kwh":25.29,"max_battery_soc_kwh":23.97,"battery_filled_pct":87.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.16,"8":0.52,"9":1.59,"10":3.81,"11":6.94,"12":10.71,"13":14.81,"14":18.94,"15":22.12,"16":23.68,"17":23.93,"18":23.96,"19":23.97}},{"date":"2025-03-14","day_of_week":"Friday","total_solar_kwh":24.19,"max_battery_soc_kwh":23.2,"battery_filled_pct":84.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.15,"8":0.47,"9":1.5,"10":3.59,"11":6.56,"12":10.15,"13":14.17,"14":18.27,"15":21.29,"16":22.74,"17":23.12,"18":23.19}},{"date":"2025-03-15","day_of_week":"Saturday","total_solar_kwh":22.54,"max_battery_soc_kwh":21.57,"battery_filled_pct":78.8,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.14,"8":0.49,"9":1.44,"10":3.44,"11":6.45,"12":9.82,"13":13.16,"14":16.72,"15":19.6,"16":21.14,"17":21.5,"18":21.56}},{"date":"2025-03-16","day_of_week":"Sunday","total_solar_kwh":19.97,"max_battery_soc_kwh":18.69,"battery_filled_pct":68.3,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.15,"8":0.75,"9":1.71,"10":3.51,"11":6.59,"12":9.68,"13":11.31,"14":14.24,"15":16.96,"16":18.28,"17":18.58,"18":18.68}},{"date":"2025-03-17","day_of_week":"Monday","total_solar_kwh":25.84,"max_battery_soc_kwh":24.12,"battery_filled_pct":88.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.22,"8":0.7,"9":1.93,"10":4.12,"11":7.36,"12":11.04,"13":15.12,"14":19.25,"15":22.29,"16":23.78,"17":24.06,"18":24.11}},{"date":"2025-03-18","day_of_week":"Tuesday","total_solar_kwh":24.85,"max_battery_soc_kwh":23.56,"battery_filled_pct":86.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.15,"8":0.5,"9":1.53,"10":3.74,"11":6.87,"12":10.62,"13":14.71,"14":18.84,"15":21.82,"16":23.27,"17":23.51,"18":23.56}},{"date":"2025-03-19","day_of_week":"Wednesday","total_solar_kwh":24.13,"max_battery_soc_kwh":23.11,"battery_filled_pct":84.5,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.13,"8":0.43,"9":1.45,"10":3.64,"11":6.77,"12":10.55,"13":14.65,"14":18.74,"15":21.57,"16":22.9,"17":23.07,"18":23.1}},{"date":"2025-03-20","day_of_week":"Thursday","total_solar_kwh":13.76,"max_battery_soc_kwh":13.14,"battery_filled_pct":48.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.08,"8":0.24,"9":0.4,"10":0.93,"11":2.63,"12":5.03,"13":7.34,"14":10.09,"15":11.72,"16":12.51,"17":13.0,"18":13.14}},{"date":"2025-03-21","day_of_week":"Friday","total_solar_kwh":24.12,"max_battery_soc_kwh":22.74,"battery_filled_pct":83.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.25,"8":0.79,"9":1.8,"10":3.84,"11":6.47,"12":9.68,"13":13.78,"14":17.91,"15":20.97,"16":22.46,"17":22.69,"18":22.73}},{"date":"2025-03-22","day_of_week":"Saturday","total_solar_kwh":22.33,"max_battery_soc_kwh":21.26,"battery_filled_pct":77.7,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.15,"8":0.54,"9":1.47,"10":3.4,"11":6.2,"12":9.54,"13":13.38,"14":17.08,"15":19.44,"16":20.76,"17":21.16,"18":21.26}},{"date":"2025-03-23","day_of_week":"Sunday","total_solar_kwh":24.31,"max_battery_soc_kwh":23.18,"battery_filled_pct":84.7,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.1,"8":0.37,"9":1.28,"10":3.32,"11":6.33,"12":10.0,"13":14.05,"14":18.18,"15":21.14,"16":22.64,"17":23.09,"18":23.17}},{"date":"2025-03-24","day_of_week":"Monday","total_solar_kwh":23.5,"max_battery_soc_kwh":22.49,"battery_filled_pct":82.2,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.1,"8":0.36,"9":1.25,"10":3.29,"11":6.26,"12":9.92,"13":13.98,"14":18.1,"15":20.97,"16":22.31,"17":22.45,"18":22.49}},{"date":"2025-03-25","day_of_week":"Tuesday","total_solar_kwh":23.44,"max_battery_soc_kwh":22.46,"battery_filled_pct":82.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.14,"8":0.46,"9":1.36,"10":3.38,"11":6.36,"12":10.03,"13":14.08,"14":18.19,"15":20.98,"16":22.28,"17":22.43,"18":22.46}},{"date":"2025-03-26","day_of_week":"Wednesday","total_solar_kwh":22.01,"max_battery_soc_kwh":21.13,"battery_filled_pct":77.2,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.1,"8":0.36,"9":1.21,"10":3.14,"11":5.97,"12":9.4,"13":13.21,"14":17.09,"15":19.73,"16":20.96,"17":21.1,"18":21.13}},{"date":"2025-03-27","day_of_week":"Thursday","total_solar_kwh":22.17,"max_battery_soc_kwh":21.28,"battery_filled_pct":77.8,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.09,"8":0.35,"9":1.18,"10":3.11,"11":6.0,"12":9.48,"13":13.32,"14":17.22,"15":19.83,"16":21.05,"17":21.24,"18":21.28}},{"date":"2025-03-28","day_of_week":"Friday","total_solar_kwh":20.97,"max_battery_soc_kwh":20.08,"battery_filled_pct":73.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.61,"9":1.6,"10":3.46,"11":6.21,"12":9.32,"13":12.1,"14":15.77,"15":18.35,"16":19.67,"17":20.05,"18":20.08}},{"date":"2025-03-29","day_of_week":"Saturday","total_solar_kwh":21.87,"max_battery_soc_kwh":21.0,"battery_filled_pct":76.7,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.09,"8":0.35,"9":1.17,"10":3.04,"11":5.83,"12":9.27,"13":13.06,"14":16.9,"15":19.45,"16":20.67,"17":20.93,"18":20.99}},{"date":"2025-03-30","day_of_week":"Sunday","total_solar_kwh":22.84,"max_battery_soc_kwh":21.93,"battery_filled_pct":80.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.17,"8":0.55,"9":1.43,"10":3.39,"11":6.33,"12":9.92,"13":13.89,"14":17.93,"15":20.57,"16":21.74,"17":21.9,"18":21.93}},{"date":"2025-03-31","day_of_week":"Monday","total_solar_kwh":18.07,"max_battery_soc_kwh":16.85,"battery_filled_pct":61.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.06,"8":0.43,"9":1.31,"10":2.93,"11":5.17,"12":7.9,"13":10.72,"14":13.7,"15":15.51,"16":16.62,"17":16.81,"18":16.84}},{"date":"2025-04-01","day_of_week":"Tuesday","total_solar_kwh":21.9,"max_battery_soc_kwh":21.03,"battery_filled_pct":76.9,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.13,"8":0.49,"9":1.32,"10":3.2,"11":6.05,"12":9.56,"13":13.43,"14":17.34,"15":19.82,"16":20.89,"17":21.0,"18":21.03}},{"date":"2025-04-02","day_of_week":"Wednesday","total_solar_kwh":20.89,"max_battery_soc_kwh":20.05,"battery_filled_pct":73.3,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.15,"8":0.42,"9":1.18,"10":3.0,"11":5.6,"12":8.61,"13":12.5,"14":16.39,"15":18.84,"16":19.92,"17":20.03,"18":20.05}},{"date":"2025-04-03","day_of_week":"Thursday","total_solar_kwh":17.74,"max_battery_soc_kwh":16.67,"battery_filled_pct":60.9,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.16,"8":0.78,"9":1.77,"10":3.39,"11":5.13,"12":7.67,"13":11.22,"14":13.84,"15":15.63,"16":16.5,"17":16.65,"18":16.67}},{"date":"2025-04-04","day_of_week":"Friday","total_solar_kwh":14.83,"max_battery_soc_kwh":14.23,"battery_filled_pct":52.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.14,"8":0.63,"9":1.67,"10":3.01,"11":4.64,"12":6.86,"13":8.83,"14":10.79,"15":12.94,"16":13.97,"17":14.21,"18":14.23}},{"date":"2025-04-05","day_of_week":"Saturday","total_solar_kwh":18.42,"max_battery_soc_kwh":17.51,"battery_filled_pct":64.0,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.13,"8":0.38,"9":1.17,"10":2.91,"11":4.33,"12":6.62,"13":10.11,"14":14.13,"15":16.49,"16":17.41,"17":17.49,"18":17.51}},{"date":"2025-04-06","day_of_week":"Sunday","total_solar_kwh":22.26,"max_battery_soc_kwh":21.34,"battery_filled_pct":78.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.45,"9":1.27,"10":3.22,"11":6.15,"12":9.63,"13":13.49,"14":17.28,"15":19.65,"16":20.92,"17":21.29,"18":21.34}},{"date":"2025-04-07","day_of_week":"Monday","total_solar_kwh":16.4,"max_battery_soc_kwh":15.47,"battery_filled_pct":56.5,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.17,"8":0.64,"9":1.41,"10":2.43,"11":3.5,"12":5.65,"13":8.43,"14":12.12,"15":14.45,"16":15.34,"17":15.45,"18":15.46}},{"date":"2025-04-08","day_of_week":"Tuesday","total_solar_kwh":21.57,"max_battery_soc_kwh":20.71,"battery_filled_pct":75.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.12,"8":0.69,"9":1.8,"10":3.6,"11":6.36,"12":9.79,"13":13.61,"14":17.42,"15":19.66,"16":20.49,"17":20.69,"18":20.71}},{"date":"2025-04-09","day_of_week":"Wednesday","total_solar_kwh":7.59,"max_battery_soc_kwh":7.29,"battery_filled_pct":26.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.3,"9":0.71,"10":1.31,"11":2.09,"12":3.13,"13":4.12,"14":5.0,"15":6.5,"16":7.21,"17":7.27,"18":7.29}},{"date":"2025-04-10","day_of_week":"Thursday","total_solar_kwh":20.43,"max_battery_soc_kwh":19.61,"battery_filled_pct":71.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.08,"8":0.51,"9":1.31,"10":3.11,"11":5.85,"12":9.12,"13":12.79,"14":16.45,"15":18.64,"16":19.47,"17":19.6,"18":19.61}},{"date":"2025-04-11","day_of_week":"Friday","total_solar_kwh":19.2,"max_battery_soc_kwh":18.43,"battery_filled_pct":67.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.08,"8":0.3,"9":0.96,"10":2.64,"11":5.26,"12":8.49,"13":12.1,"14":15.62,"15":17.66,"16":18.35,"17":18.42,"18":18.43}},{"date":"2025-04-12","day_of_week":"Saturday","total_solar_kwh":18.8,"max_battery_soc_kwh":18.04,"battery_filled_pct":65.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.07,"8":0.27,"9":0.95,"10":2.64,"11":5.2,"12":8.33,"13":11.85,"14":15.29,"15":17.29,"16":17.96,"17":18.03,"18":18.04}},{"date":"2025-04-13","day_of_week":"Sunday","total_solar_kwh":18.54,"max_battery_soc_kwh":17.8,"battery_filled_pct":65.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.07,"8":0.27,"9":0.89,"10":2.52,"11":5.07,"12":8.21,"13":11.7,"14":15.11,"15":17.04,"16":17.68,"17":17.78,"18":17.8}},{"date":"2025-04-14","day_of_week":"Monday","total_solar_kwh":17.93,"max_battery_soc_kwh":17.21,"battery_filled_pct":62.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.06,"8":0.26,"9":0.89,"10":2.49,"11":4.95,"12":7.91,"13":11.31,"14":14.62,"15":16.48,"16":17.1,"17":17.2,"18":17.21}},{"date":"2025-04-15","day_of_week":"Tuesday","total_solar_kwh":14.28,"max_battery_soc_kwh":13.71,"battery_filled_pct":50.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.07,"8":0.4,"9":1.22,"10":2.47,"11":4.05,"12":6.6,"13":8.98,"14":11.29,"15":12.89,"16":13.58,"17":13.69,"18":13.71}},{"date":"2025-04-16","day_of_week":"Wednesday","total_solar_kwh":17.79,"max_battery_soc_kwh":17.08,"battery_filled_pct":62.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.08,"8":0.29,"9":0.9,"10":2.43,"11":4.77,"12":8.04,"13":11.42,"14":14.71,"15":16.52,"16":17.02,"17":17.07,"18":17.08}},{"date":"2025-04-17","day_of_week":"Thursday","total_solar_kwh":16.98,"max_battery_soc_kwh":16.29,"battery_filled_pct":59.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.5,"9":1.19,"10":2.91,"11":5.29,"12":8.0,"13":10.94,"14":13.56,"15":15.24,"16":16.01,"17":16.27,"18":16.29}},{"date":"2025-04-18","day_of_week":"Friday","total_solar_kwh":14.61,"max_battery_soc_kwh":14.02,"battery_filled_pct":51.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.38,"9":1.15,"10":2.42,"11":4.36,"12":6.6,"13":8.59,"14":11.55,"15":13.3,"16":13.89,"17":14.01,"18":14.02}},{"date":"2025-04-19","day_of_week":"Saturday","total_solar_kwh":7.81,"max_battery_soc_kwh":7.49,"battery_filled_pct":27.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.36,"9":0.99,"10":1.99,"11":2.77,"12":3.62,"13":4.81,"14":5.9,"15":6.69,"16":7.23,"17":7.48,"18":7.49}},{"date":"2025-04-20","day_of_week":"Sunday","total_solar_kwh":14.51,"max_battery_soc_kwh":13.87,"battery_filled_pct":50.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.11,"8":0.58,"9":1.56,"10":3.01,"11":5.27,"12":7.77,"13":9.78,"14":11.71,"15":13.18,"16":13.72,"17":13.86,"18":13.87}},{"date":"2025-04-21","day_of_week":"Monday","total_solar_kwh":10.71,"max_battery_soc_kwh":10.27,"battery_filled_pct":37.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.05,"8":0.48,"9":1.38,"10":2.67,"11":3.91,"12":5.39,"13":7.01,"14":8.71,"15":9.65,"16":10.14,"17":10.27,"18":10.27}},{"date":"2025-04-22","day_of_week":"Tuesday","total_solar_kwh":17.74,"max_battery_soc_kwh":17.03,"battery_filled_pct":62.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.6,"9":1.59,"10":3.11,"11":4.83,"12":7.51,"13":11.08,"14":14.54,"15":16.44,"16":16.97,"17":17.02,"18":17.03}},{"date":"2025-04-23","day_of_week":"Wednesday","total_solar_kwh":17.62,"max_battery_soc_kwh":16.92,"battery_filled_pct":61.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.23,"9":0.77,"10":2.26,"11":4.67,"12":7.7,"13":11.1,"14":14.43,"15":16.26,"16":16.82,"17":16.91,"18":16.92}},{"date":"2025-04-24","day_of_week":"Thursday","total_solar_kwh":17.55,"max_battery_soc_kwh":16.85,"battery_filled_pct":61.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.05,"8":0.22,"9":0.72,"10":2.18,"11":4.58,"12":7.61,"13":10.97,"14":14.11,"15":15.76,"16":16.57,"17":16.84,"18":16.85}},{"date":"2025-04-25","day_of_week":"Friday","total_solar_kwh":5.98,"max_battery_soc_kwh":5.74,"battery_filled_pct":21.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.21,"9":0.84,"10":1.37,"11":2.0,"12":3.11,"13":4.14,"14":4.82,"15":5.39,"16":5.66,"17":5.73,"18":5.74}},{"date":"2025-04-26","day_of_week":"Saturday","total_solar_kwh":16.1,"max_battery_soc_kwh":15.46,"battery_filled_pct":56.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.2,"9":0.63,"10":2.04,"11":4.1,"12":6.61,"13":10.08,"14":13.17,"15":14.9,"16":15.39,"17":15.45,"18":15.46}},{"date":"2025-04-27","day_of_week":"Sunday","total_solar_kwh":12.37,"max_battery_soc_kwh":11.72,"battery_filled_pct":42.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.19,"9":0.71,"10":1.79,"11":3.36,"12":5.16,"13":6.92,"14":9.25,"15":10.81,"16":11.5,"17":11.71,"18":11.72}},{"date":"2025-04-28","day_of_week":"Monday","total_solar_kwh":16.23,"max_battery_soc_kwh":15.58,"battery_filled_pct":56.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.1,"8":0.66,"9":1.45,"10":2.56,"11":4.61,"12":6.8,"13":10.3,"14":13.46,"15":14.83,"16":15.5,"17":15.57,"18":15.58}},{"date":"2025-04-29","day_of_week":"Tuesday","total_solar_kwh":15.33,"max_battery_soc_kwh":14.67,"battery_filled_pct":53.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.19,"9":0.72,"10":2.1,"11":4.35,"12":7.09,"13":9.21,"14":11.85,"15":13.81,"16":14.54,"17":14.66,"18":14.67}},{"date":"2025-04-30","day_of_week":"Wednesday","total_solar_kwh":16.56,"max_battery_soc_kwh":15.89,"battery_filled_pct":58.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.22,"9":0.7,"10":2.05,"11":4.3,"12":7.31,"13":10.67,"14":13.82,"15":15.46,"16":15.84,"17":15.89,"18":15.89}},{"date":"2025-05-01","day_of_week":"Thursday","total_solar_kwh":16.31,"max_battery_soc_kwh":15.66,"battery_filled_pct":57.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.2,"9":0.67,"10":2.04,"11":4.42,"12":7.41,"13":10.67,"14":13.7,"15":15.26,"16":15.61,"17":15.65,"18":15.66}},{"date":"2025-05-02","day_of_week":"Friday","total_solar_kwh":16.02,"max_battery_soc_kwh":15.38,"battery_filled_pct":56.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.21,"9":0.65,"10":2.0,"11":4.31,"12":7.2,"13":10.43,"14":13.45,"15":15.0,"16":15.33,"17":15.37}},{"date":"2025-05-03","day_of_week":"Saturday","total_solar_kwh":16.57,"max_battery_soc_kwh":15.9,"battery_filled_pct":58.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.07,"8":0.4,"9":1.06,"10":2.39,"11":4.73,"12":7.54,"13":10.73,"14":13.67,"15":15.11,"16":15.73,"17":15.9}},{"date":"2025-05-04","day_of_week":"Sunday","total_solar_kwh":14.8,"max_battery_soc_kwh":14.21,"battery_filled_pct":51.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.06,"8":0.46,"9":1.39,"10":2.87,"11":4.65,"12":6.68,"13":9.46,"14":12.14,"15":13.66,"16":14.12,"17":14.21}},{"date":"2025-05-05","day_of_week":"Monday","total_solar_kwh":14.94,"max_battery_soc_kwh":14.34,"battery_filled_pct":52.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.17,"9":0.58,"10":1.81,"11":3.94,"12":6.68,"13":9.78,"14":12.59,"15":14.0,"16":14.29,"17":14.33}},{"date":"2025-05-06","day_of_week":"Tuesday","total_solar_kwh":14.88,"max_battery_soc_kwh":14.28,"battery_filled_pct":52.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.2,"9":0.66,"10":1.76,"11":3.79,"12":6.52,"13":9.58,"14":12.38,"15":13.64,"16":14.15,"17":14.28}},{"date":"2025-05-07","day_of_week":"Wednesday","total_solar_kwh":14.91,"max_battery_soc_kwh":14.32,"battery_filled_pct":52.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.35,"9":0.99,"10":1.95,"11":3.79,"12":6.33,"13":9.45,"14":12.32,"15":13.83,"16":14.25,"17":14.31}},{"date":"2025-05-08","day_of_week":"Thursday","total_solar_kwh":12.76,"max_battery_soc_kwh":12.24,"battery_filled_pct":44.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.05,"8":0.45,"9":1.36,"10":2.46,"11":3.41,"12":4.86,"13":7.66,"14":10.46,"15":11.86,"16":12.19,"17":12.24}},{"date":"2025-05-09","day_of_week":"Friday","total_solar_kwh":14.79,"max_battery_soc_kwh":14.2,"battery_filled_pct":51.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.19,"9":0.6,"10":1.84,"11":3.99,"12":6.72,"13":9.77,"14":12.53,"15":13.89,"16":14.16,"17":14.2}},{"date":"2025-05-10","day_of_week":"Saturday","total_solar_kwh":14.66,"max_battery_soc_kwh":14.08,"battery_filled_pct":51.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.2,"9":0.6,"10":1.83,"11":3.97,"12":6.71,"13":9.75,"14":12.47,"15":13.81,"16":14.04,"17":14.07}},{"date":"2025-05-11","day_of_week":"Sunday","total_solar_kwh":14.32,"max_battery_soc_kwh":13.75,"battery_filled_pct":50.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.2,"9":0.59,"10":1.78,"11":3.86,"12":6.52,"13":9.5,"14":12.19,"15":13.5,"16":13.71,"17":13.75}},{"date":"2025-05-12","day_of_week":"Monday","total_solar_kwh":14.0,"max_battery_soc_kwh":13.44,"battery_filled_pct":49.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.17,"9":0.55,"10":1.71,"11":3.74,"12":6.33,"13":9.3,"14":11.94,"15":13.2,"16":13.4,"17":13.43}},{"date":"2025-05-13","day_of_week":"Tuesday","total_solar_kwh":13.82,"max_battery_soc_kwh":13.27,"battery_filled_pct":48.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.19,"9":0.56,"10":1.7,"11":3.72,"12":6.3,"13":9.23,"14":11.82,"15":13.04,"16":13.23,"17":13.26}},{"date":"2025-05-14","day_of_week":"Wednesday","total_solar_kwh":11.93,"max_battery_soc_kwh":11.45,"battery_filled_pct":41.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.17,"9":0.53,"10":1.65,"11":3.46,"12":5.57,"13":8.11,"14":10.17,"15":11.08,"16":11.36,"17":11.45}},{"date":"2025-05-15","day_of_week":"Thursday","total_solar_kwh":8.11,"max_battery_soc_kwh":7.78,"battery_filled_pct":28.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.18,"9":0.75,"10":1.59,"11":2.54,"12":3.9,"13":5.3,"14":6.59,"15":7.36,"16":7.72,"17":7.78}},{"date":"2025-05-16","day_of_week":"Friday","total_solar_kwh":8.61,"max_battery_soc_kwh":8.27,"battery_filled_pct":30.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.27,"9":0.95,"10":1.97,"11":3.11,"12":4.55,"13":6.15,"14":6.95,"15":7.85,"16":8.19,"17":8.26}},{"date":"2025-05-17","day_of_week":"Saturday","total_solar_kwh":8.91,"max_battery_soc_kwh":8.55,"battery_filled_pct":31.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.2,"9":0.65,"10":1.48,"11":2.89,"12":4.45,"13":6.06,"14":7.38,"15":8.01,"16":8.47,"17":8.55}},{"date":"2025-05-18","day_of_week":"Sunday","total_solar_kwh":13.32,"max_battery_soc_kwh":12.78,"battery_filled_pct":46.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.16,"9":0.52,"10":1.65,"11":3.7,"12":6.38,"13":9.33,"14":11.34,"15":12.45,"16":12.75,"17":12.78}},{"date":"2025-05-19","day_of_week":"Monday","total_solar_kwh":13.67,"max_battery_soc_kwh":13.12,"battery_filled_pct":48.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.15,"9":0.49,"10":1.6,"11":3.61,"12":6.24,"13":9.22,"14":11.78,"15":12.95,"16":13.1,"17":13.12}},{"date":"2025-05-20","day_of_week":"Tuesday","total_solar_kwh":13.41,"max_battery_soc_kwh":12.88,"battery_filled_pct":47.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.17,"9":0.51,"10":1.59,"11":3.55,"12":6.11,"13":9.04,"14":11.56,"15":12.7,"16":12.85,"17":12.87}},{"date":"2025-05-21","day_of_week":"Wednesday","total_solar_kwh":9.68,"max_battery_soc_kwh":9.29,"battery_filled_pct":33.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.27,"9":0.78,"10":1.85,"11":3.2,"12":4.5,"13":6.73,"14":8.15,"15":8.92,"16":9.25,"17":9.29}},{"date":"2025-05-22","day_of_week":"Thursday","total_solar_kwh":12.98,"max_battery_soc_kwh":12.46,"battery_filled_pct":45.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.14,"9":0.48,"10":1.52,"11":3.45,"12":5.97,"13":8.81,"14":11.22,"15":12.29,"16":12.44,"17":12.46}},{"date":"2025-05-23","day_of_week":"Friday","total_solar_kwh":12.77,"max_battery_soc_kwh":12.26,"battery_filled_pct":44.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.14,"9":0.46,"10":1.49,"11":3.38,"12":5.82,"13":8.61,"14":10.99,"15":12.05,"16":12.23,"17":12.26}},{"date":"2025-05-24","day_of_week":"Saturday","total_solar_kwh":13.33,"max_battery_soc_kwh":12.79,"battery_filled_pct":46.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.18,"9":0.7,"10":1.81,"11":3.54,"12":6.01,"13":8.72,"14":11.1,"15":12.26,"16":12.69,"17":12.79}},{"date":"2025-05-25","day_of_week":"Sunday","total_solar_kwh":12.83,"max_battery_soc_kwh":12.31,"battery_filled_pct":45.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.23,"9":0.58,"10":1.48,"11":3.28,"12":5.71,"13":8.48,"14":10.96,"15":12.1,"16":12.28,"17":12.31}},{"date":"2025-05-26","day_of_week":"Monday","total_solar_kwh":7.64,"max_battery_soc_kwh":7.34,"battery_filled_pct":26.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.24,"9":0.9,"10":1.83,"11":2.25,"12":2.77,"13":4.22,"14":5.83,"15":6.93,"16":7.28,"17":7.33}},{"date":"2025-05-27","day_of_week":"Tuesday","total_solar_kwh":11.41,"max_battery_soc_kwh":10.95,"battery_filled_pct":40.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.19,"9":0.65,"10":1.49,"11":3.17,"12":5.2,"13":7.53,"14":9.49,"15":10.55,"16":10.85,"17":10.95}},{"date":"2025-05-28","day_of_week":"Wednesday","total_solar_kwh":10.82,"max_battery_soc_kwh":10.39,"battery_filled_pct":38.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.2,"9":0.76,"10":1.81,"11":3.38,"12":5.1,"13":7.07,"14":8.88,"15":9.95,"16":10.33,"17":10.38}},{"date":"2025-05-29","day_of_week":"Thursday","total_solar_kwh":12.42,"max_battery_soc_kwh":11.92,"battery_filled_pct":43.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.11,"9":0.49,"10":1.35,"11":3.06,"12":5.44,"13":8.18,"14":10.59,"15":11.71,"16":11.9,"17":11.92}},{"date":"2025-05-30","day_of_week":"Friday","total_solar_kwh":12.23,"max_battery_soc_kwh":11.74,"battery_filled_pct":42.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.12,"9":0.4,"10":1.31,"11":3.07,"12":5.4,"13":8.1,"14":10.47,"15":11.55,"16":11.72,"17":11.74}},{"date":"2025-05-31","day_of_week":"Saturday","total_solar_kwh":12.41,"max_battery_soc_kwh":11.92,"battery_filled_pct":43.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.49,"10":1.41,"11":3.19,"12":5.56,"13":8.28,"14":10.67,"15":11.74,"16":11.89,"17":11.91}},{"date":"2025-06-01","day_of_week":"Sunday","total_solar_kwh":10.69,"max_battery_soc_kwh":10.26,"battery_filled_pct":37.5,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.22,"9":0.81,"10":1.77,"11":3.05,"12":4.58,"13":6.93,"14":8.8,"15":9.73,"16":10.19,"17":10.26}},{"date":"2025-06-02","day_of_week":"Monday","total_solar_kwh":10.54,"max_battery_soc_kwh":10.12,"battery_filled_pct":37.0,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.08,"9":0.39,"10":1.05,"11":2.7,"12":4.82,"13":6.8,"14":8.94,"15":9.96,"16":10.09,"17":10.12}},{"date":"2025-06-03","day_of_week":"Tuesday","total_solar_kwh":10.61,"max_battery_soc_kwh":10.18,"battery_filled_pct":37.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.18,"9":0.6,"10":1.61,"11":3.0,"12":4.88,"13":7.23,"14":8.83,"15":9.84,"16":10.15,"17":10.18}},{"date":"2025-06-04","day_of_week":"Wednesday","total_solar_kwh":12.31,"max_battery_soc_kwh":11.82,"battery_filled_pct":43.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.11,"9":0.38,"10":1.25,"11":3.03,"12":5.46,"13":8.2,"14":10.6,"15":11.66,"16":11.79,"17":11.82}},{"date":"2025-06-05","day_of_week":"Thursday","total_solar_kwh":6.38,"max_battery_soc_kwh":6.12,"battery_filled_pct":22.4,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.2,"9":0.89,"10":1.89,"11":3.12,"12":4.31,"13":5.07,"14":5.46,"15":5.91,"16":6.1,"17":6.12}},{"date":"2025-06-06","day_of_week":"Friday","total_solar_kwh":8.75,"max_battery_soc_kwh":8.4,"battery_filled_pct":30.7,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.05,"9":0.29,"10":0.67,"11":1.46,"12":2.66,"13":4.48,"14":6.75,"15":7.86,"16":8.3,"17":8.4}},{"date":"2025-06-07","day_of_week":"Saturday","total_solar_kwh":4.59,"max_battery_soc_kwh":4.41,"battery_filled_pct":16.1,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.12,"9":0.32,"10":0.61,"11":1.18,"12":1.52,"13":2.32,"14":3.1,"15":4.01,"16":4.36,"17":4.41}},{"date":"2025-06-08","day_of_week":"Sunday","total_solar_kwh":10.56,"max_battery_soc_kwh":10.14,"battery_filled_pct":37.1,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.18,"9":0.62,"10":1.46,"11":2.83,"12":4.57,"13":6.81,"14":8.94,"15":9.88,"16":10.12,"17":10.14}},{"date":"2025-06-09","day_of_week":"Monday","total_solar_kwh":11.91,"max_battery_soc_kwh":11.43,"battery_filled_pct":41.8,"time_to_full":null,"hourly_soc":{"7":0.02,"8":0.27,"9":0.71,"10":1.65,"11":3.29,"12":5.01,"13":7.26,"14":9.62,"15":10.83,"16":11.34,"17":11.43}},{"date":"2025-06-10","day_of_week":"Tuesday","total_solar_kwh":11.2,"max_battery_soc_kwh":10.75,"battery_filled_pct":39.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.24,"9":0.79,"10":1.65,"11":2.83,"12":5.06,"13":7.58,"14":9.5,"15":10.55,"16":10.73,"17":10.75}},{"date":"2025-06-11","day_of_week":"Wednesday","total_solar_kwh":7.56,"max_battery_soc_kwh":7.26,"battery_filled_pct":26.5,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.15,"9":0.68,"10":1.73,"11":3.21,"12":4.52,"13":5.42,"14":6.21,"15":7.05,"16":7.24,"17":7.26}},{"date":"2025-06-12","day_of_week":"Thursday","total_solar_kwh":11.34,"max_battery_soc_kwh":10.89,"battery_filled_pct":39.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.06,"9":0.31,"10":1.1,"11":2.76,"12":4.99,"13":7.52,"14":9.69,"15":10.7,"16":10.86,"17":10.88}},{"date":"2025-06-13","day_of_week":"Friday","total_solar_kwh":11.4,"max_battery_soc_kwh":10.95,"battery_filled_pct":40.0,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.06,"9":0.26,"10":1.05,"11":2.68,"12":4.94,"13":7.55,"14":9.82,"15":10.8,"16":10.93,"17":10.94}},{"date":"2025-06-14","day_of_week":"Saturday","total_solar_kwh":4.06,"max_battery_soc_kwh":3.9,"battery_filled_pct":14.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.6,"10":1.28,"11":1.93,"12":2.34,"13":2.87,"14":3.3,"15":3.64,"16":3.82,"17":3.9}},{"date":"2025-06-15","day_of_week":"Sunday","total_solar_kwh":12.29,"max_battery_soc_kwh":11.8,"battery_filled_pct":43.1,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.2,"9":0.72,"10":1.81,"11":3.5,"12":5.78,"13":8.38,"14":10.56,"15":11.57,"16":11.77,"17":11.8}},{"date":"2025-06-16","day_of_week":"Monday","total_solar_kwh":11.2,"max_battery_soc_kwh":10.75,"battery_filled_pct":39.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.13,"9":0.56,"10":1.43,"11":3.17,"12":5.44,"13":7.5,"14":9.45,"15":10.43,"16":10.71,"17":10.75}},{"date":"2025-06-17","day_of_week":"Tuesday","total_solar_kwh":9.07,"max_battery_soc_kwh":8.7,"battery_filled_pct":31.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.12,"9":0.37,"10":1.12,"11":2.52,"12":4.61,"13":6.0,"14":7.53,"15":8.54,"16":8.68,"17":8.7}},{"date":"2025-06-18","day_of_week":"Wednesday","total_solar_kwh":8.96,"max_battery_soc_kwh":8.6,"battery_filled_pct":31.4,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.21,"9":0.71,"10":1.66,"11":3.17,"12":4.92,"13":6.29,"14":7.37,"15":8.19,"16":8.57,"17":8.6}},{"date":"2025-06-19","day_of_week":"Thursday","total_solar_kwh":9.92,"max_battery_soc_kwh":9.52,"battery_filled_pct":34.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.11,"9":0.46,"10":1.25,"11":2.58,"12":4.51,"13":6.35,"14":8.04,"15":9.2,"16":9.47,"17":9.52}},{"date":"2025-06-20","day_of_week":"Friday","total_solar_kwh":11.28,"max_battery_soc_kwh":10.83,"battery_filled_pct":39.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.11,"9":0.34,"10":1.09,"11":2.67,"12":4.87,"13":7.43,"14":9.67,"15":10.67,"16":10.81,"17":10.83}},{"date":"2025-06-21","day_of_week":"Saturday","total_solar_kwh":11.29,"max_battery_soc_kwh":10.84,"battery_filled_pct":39.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.09,"9":0.32,"10":1.08,"11":2.67,"12":4.89,"13":7.46,"14":9.71,"15":10.7,"16":10.82,"17":10.84}},{"date":"2025-06-22","day_of_week":"Sunday","total_solar_kwh":9.76,"max_battery_soc_kwh":9.37,"battery_filled_pct":34.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.12,"9":0.4,"10":1.14,"11":2.48,"12":3.79,"13":5.86,"14":8.28,"15":9.16,"16":9.36,"17":9.37}},{"date":"2025-06-23","day_of_week":"Monday","total_solar_kwh":11.67,"max_battery_soc_kwh":11.21,"battery_filled_pct":41.0,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.09,"9":0.32,"10":1.06,"11":2.65,"12":4.87,"13":7.48,"14":9.78,"15":10.83,"16":11.14,"17":11.2}},{"date":"2025-06-24","day_of_week":"Tuesday","total_solar_kwh":5.84,"max_battery_soc_kwh":5.61,"battery_filled_pct":20.5,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.11,"9":0.45,"10":1.21,"11":2.41,"12":3.08,"13":3.82,"14":4.61,"15":5.22,"16":5.52,"17":5.6}},{"date":"2025-06-25","day_of_week":"Wednesday","total_solar_kwh":10.78,"max_battery_soc_kwh":10.35,"battery_filled_pct":37.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.14,"9":0.5,"10":1.22,"11":2.65,"12":4.71,"13":6.69,"14":8.62,"15":9.93,"16":10.3,"17":10.34}},{"date":"2025-06-26","day_of_week":"Thursday","total_solar_kwh":6.65,"max_battery_soc_kwh":6.38,"battery_filled_pct":23.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.66,"10":1.68,"11":3.22,"12":4.38,"13":5.27,"14":5.6,"15":5.96,"16":6.32,"17":6.38}},{"date":"2025-06-27","day_of_week":"Friday","total_solar_kwh":7.33,"max_battery_soc_kwh":7.04,"battery_filled_pct":25.7,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.11,"9":0.59,"10":1.48,"11":2.89,"12":3.85,"13":4.64,"14":5.66,"15":6.5,"16":6.96,"17":7.03}},{"date":"2025-06-28","day_of_week":"Saturday","total_solar_kwh":8.26,"max_battery_soc_kwh":7.93,"battery_filled_pct":29.0,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.09,"9":0.51,"10":1.45,"11":2.58,"12":3.78,"13":5.12,"14":6.66,"15":7.56,"16":7.9,"17":7.93}},{"date":"2025-06-29","day_of_week":"Sunday","total_solar_kwh":11.18,"max_battery_soc_kwh":10.73,"battery_filled_pct":39.2,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.11,"9":0.59,"10":1.6,"11":3.17,"12":5.23,"13":7.83,"14":9.64,"15":10.35,"16":10.65,"17":10.73}},{"date":"2025-06-30","day_of_week":"Monday","total_solar_kwh":11.01,"max_battery_soc_kwh":10.57,"battery_filled_pct":38.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.14,"9":0.44,"10":1.23,"11":2.85,"12":5.13,"13":7.24,"14":9.3,"15":10.36,"16":10.54,"17":10.57}},{"date":"2025-07-01","day_of_week":"Tuesday","total_solar_kwh":10.1,"max_battery_soc_kwh":9.69,"battery_filled_pct":35.4,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.09,"9":0.33,"10":1.11,"11":2.7,"12":4.87,"13":7.52,"14":8.89,"15":9.34,"16":9.63,"17":9.69}},{"date":"2025-07-02","day_of_week":"Wednesday","total_solar_kwh":6.22,"max_battery_soc_kwh":5.98,"battery_filled_pct":21.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.15,"9":0.63,"10":1.21,"11":1.83,"12":2.56,"13":3.54,"14":4.84,"15":5.77,"16":5.95,"17":5.97}},{"date":"2025-07-03","day_of_week":"Thursday","total_solar_kwh":11.28,"max_battery_soc_kwh":10.83,"battery_filled_pct":39.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.15,"9":0.41,"10":1.16,"11":2.78,"12":4.95,"13":7.28,"14":9.42,"15":10.48,"16":10.78,"17":10.83}},{"date":"2025-07-04","day_of_week":"Friday","total_solar_kwh":8.85,"max_battery_soc_kwh":8.49,"battery_filled_pct":31.0,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.21,"9":0.78,"10":1.75,"11":3.24,"12":5.1,"13":6.24,"14":7.31,"15":8.0,"16":8.39,"17":8.49}},{"date":"2025-07-05","day_of_week":"Saturday","total_solar_kwh":9.68,"max_battery_soc_kwh":9.29,"battery_filled_pct":34.0,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.12,"9":0.62,"10":1.14,"11":1.83,"12":3.05,"13":5.08,"14":7.61,"15":8.86,"16":9.2,"17":9.29}},{"date":"2025-07-06","day_of_week":"Sunday","total_solar_kwh":9.39,"max_battery_soc_kwh":9.01,"battery_filled_pct":32.9,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.14,"9":0.44,"10":1.19,"11":2.52,"12":4.1,"13":6.03,"14":7.74,"15":8.82,"16":8.98,"17":9.01}},{"date":"2025-07-07","day_of_week":"Monday","total_solar_kwh":10.15,"max_battery_soc_kwh":9.74,"battery_filled_pct":35.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.14,"9":0.59,"10":1.36,"11":2.68,"12":4.2,"13":6.1,"14":7.83,"15":9.18,"16":9.68,"17":9.74}},{"date":"2025-07-08","day_of_week":"Tuesday","total_solar_kwh":7.95,"max_battery_soc_kwh":7.64,"battery_filled_pct":27.9,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.08,"9":0.46,"10":1.22,"11":2.24,"12":3.61,"13":5.2,"14":6.4,"15":7.26,"16":7.59,"17":7.63}},{"date":"2025-07-09","day_of_week":"Wednesday","total_solar_kwh":2.93,"max_battery_soc_kwh":2.82,"battery_filled_pct":10.3,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.07,"9":0.42,"10":0.9,"11":1.21,"12":1.43,"13":1.88,"14":2.32,"15":2.68,"16":2.8,"17":2.81}},{"date":"2025-07-10","day_of_week":"Thursday","total_solar_kwh":9.8,"max_battery_soc_kwh":9.41,"battery_filled_pct":34.4,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.14,"9":0.5,"10":1.4,"11":2.91,"12":5.08,"13":6.71,"14":7.85,"15":8.87,"16":9.33,"17":9.41}},{"date":"2025-07-11","day_of_week":"Friday","total_solar_kwh":12.34,"max_battery_soc_kwh":11.85,"battery_filled_pct":43.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.66,"10":1.63,"11":3.24,"12":5.44,"13":7.76,"14":9.89,"15":11.14,"16":11.72,"17":11.85}},{"date":"2025-07-12","day_of_week":"Saturday","total_solar_kwh":10.15,"max_battery_soc_kwh":9.74,"battery_filled_pct":35.6,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.07,"9":0.31,"10":1.1,"11":2.75,"12":4.98,"13":6.62,"14":8.09,"15":9.1,"16":9.6,"17":9.74}},{"date":"2025-07-13","day_of_week":"Sunday","total_solar_kwh":6.53,"max_battery_soc_kwh":6.27,"battery_filled_pct":22.9,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.17,"9":0.76,"10":1.72,"11":2.52,"12":3.19,"13":3.61,"14":4.6,"15":5.66,"16":6.18,"17":6.26}},{"date":"2025-07-14","day_of_week":"Monday","total_solar_kwh":9.96,"max_battery_soc_kwh":9.56,"battery_filled_pct":34.9,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.22,"9":0.69,"10":1.84,"11":3.33,"12":5.16,"13":7.26,"14":8.61,"15":9.3,"16":9.53,"17":9.56}},{"date":"2025-07-15","day_of_week":"Tuesday","total_solar_kwh":10.57,"max_battery_soc_kwh":10.14,"battery_filled_pct":37.1,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.14,"9":0.48,"10":1.3,"11":2.74,"12":4.68,"13":7.2,"14":8.8,"15":9.76,"16":10.1,"17":10.14}},{"date":"2025-07-16","day_of_week":"Wednesday","total_solar_kwh":12.92,"max_battery_soc_kwh":12.4,"battery_filled_pct":45.3,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.06,"9":0.39,"10":1.11,"11":2.82,"12":5.23,"13":8.06,"14":10.62,"15":11.89,"16":12.31,"17":12.4}},{"date":"2025-07-17","day_of_week":"Thursday","total_solar_kwh":12.49,"max_battery_soc_kwh":11.99,"battery_filled_pct":43.8,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.1,"9":0.52,"10":1.46,"11":2.75,"12":4.93,"13":7.69,"14":10.28,"15":11.6,"16":11.93,"17":11.98}},{"date":"2025-07-18","day_of_week":"Friday","total_solar_kwh":13.04,"max_battery_soc_kwh":12.51,"battery_filled_pct":45.7,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.15,"9":0.49,"10":1.42,"11":3.25,"12":5.63,"13":8.18,"14":10.77,"15":12.05,"16":12.41,"17":12.51}},{"date":"2025-07-19","day_of_week":"Saturday","total_solar_kwh":8.85,"max_battery_soc_kwh":8.5,"battery_filled_pct":31.1,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.74,"10":1.68,"11":2.93,"12":4.79,"13":6.49,"14":7.38,"15":8.02,"16":8.41,"17":8.5}},{"date":"2025-07-20","day_of_week":"Sunday","total_solar_kwh":12.21,"max_battery_soc_kwh":11.72,"battery_filled_pct":42.8,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.18,"9":0.69,"10":1.65,"11":3.41,"12":5.86,"13":8.68,"14":10.56,"15":11.27,"16":11.65,"17":11.72}},{"date":"2025-07-21","day_of_week":"Monday","total_solar_kwh":12.48,"max_battery_soc_kwh":11.98,"battery_filled_pct":43.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.11,"9":0.38,"10":1.28,"11":3.13,"12":5.65,"13":8.43,"14":10.78,"15":11.7,"16":11.95,"17":11.98}},{"date":"2025-07-22","day_of_week":"Tuesday","total_solar_kwh":12.04,"max_battery_soc_kwh":11.56,"battery_filled_pct":42.3,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.22,"9":0.78,"10":1.75,"11":3.53,"12":5.32,"13":7.83,"14":10.07,"15":11.04,"16":11.47,"17":11.56}},{"date":"2025-07-23","day_of_week":"Wednesday","total_solar_kwh":13.56,"max_battery_soc_kwh":13.02,"battery_filled_pct":47.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.15,"9":0.56,"10":1.55,"11":3.26,"12":5.66,"13":8.58,"14":11.31,"15":12.68,"16":12.98,"17":13.01}},{"date":"2025-07-24","day_of_week":"Thursday","total_solar_kwh":11.94,"max_battery_soc_kwh":11.46,"battery_filled_pct":41.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.12,"9":0.66,"10":1.74,"11":3.53,"12":5.78,"13":8.24,"14":9.72,"15":11.06,"16":11.43,"17":11.46}},{"date":"2025-07-25","day_of_week":"Friday","total_solar_kwh":1.98,"max_battery_soc_kwh":1.9,"battery_filled_pct":6.9,"time_to_full":null,"hourly_soc":{"7":0.0,"8":0.02,"9":0.06,"10":0.16,"11":0.28,"12":0.52,"13":0.97,"14":1.39,"15":1.72,"16":1.87,"17":1.89}},{"date":"2025-07-26","day_of_week":"Saturday","total_solar_kwh":10.34,"max_battery_soc_kwh":9.88,"battery_filled_pct":36.1,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.26,"9":0.83,"10":1.8,"11":3.19,"12":5.13,"13":7.67,"14":9.01,"15":9.53,"16":9.81,"17":9.88}},{"date":"2025-07-27","day_of_week":"Sunday","total_solar_kwh":11.89,"max_battery_soc_kwh":11.41,"battery_filled_pct":41.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.13,"9":0.69,"10":1.73,"11":3.22,"12":5.38,"13":7.43,"14":9.57,"15":10.62,"16":11.25,"17":11.4,"18":11.41}},{"date":"2025-07-28","day_of_week":"Monday","total_solar_kwh":13.8,"max_battery_soc_kwh":13.25,"battery_filled_pct":48.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.15,"9":0.8,"10":1.86,"11":3.79,"12":6.07,"13":8.2,"14":10.83,"15":12.34,"16":13.04,"17":13.25,"18":13.25}},{"date":"2025-07-29","day_of_week":"Tuesday","total_solar_kwh":5.62,"max_battery_soc_kwh":5.4,"battery_filled_pct":19.7,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.1,"9":0.34,"10":1.03,"11":2.0,"12":3.11,"13":4.12,"14":4.73,"15":5.04,"16":5.27,"17":5.39,"18":5.4}},{"date":"2025-07-30","day_of_week":"Wednesday","total_solar_kwh":11.79,"max_battery_soc_kwh":11.32,"battery_filled_pct":41.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.3,"9":0.93,"10":2.11,"11":3.94,"12":5.74,"13":7.56,"14":8.98,"15":10.44,"16":11.12,"17":11.31,"18":11.32}},{"date":"2025-07-31","day_of_week":"Thursday","total_solar_kwh":13.2,"max_battery_soc_kwh":12.68,"battery_filled_pct":46.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.12,"9":0.43,"10":1.44,"11":2.93,"12":5.23,"13":8.02,"14":10.91,"15":12.13,"16":12.55,"17":12.67,"18":12.68}},{"date":"2025-08-01","day_of_week":"Friday","total_solar_kwh":12.77,"max_battery_soc_kwh":12.25,"battery_filled_pct":44.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.13,"9":0.47,"10":1.73,"11":3.87,"12":6.17,"13":8.32,"14":10.44,"15":11.64,"16":12.14,"17":12.24,"18":12.25}},{"date":"2025-08-02","day_of_week":"Saturday","total_solar_kwh":10.89,"max_battery_soc_kwh":10.45,"battery_filled_pct":38.2,"time_to_full":null,"hourly_soc":{"7":0.01,"8":0.16,"9":0.79,"10":1.87,"11":3.2,"12":4.33,"13":5.91,"14":8.24,"15":9.9,"16":10.39,"17":10.45,"18":10.45}},{"date":"2025-08-03","day_of_week":"Sunday","total_solar_kwh":15.73,"max_battery_soc_kwh":15.1,"battery_filled_pct":55.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.14,"9":0.45,"10":1.51,"11":3.59,"12":6.36,"13":9.56,"14":12.69,"15":14.39,"16":14.98,"17":15.1,"18":15.1}},{"date":"2025-08-04","day_of_week":"Monday","total_solar_kwh":3.97,"max_battery_soc_kwh":3.81,"battery_filled_pct":13.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.1,"9":0.28,"10":0.68,"11":1.08,"12":1.76,"13":2.41,"14":2.9,"15":3.25,"16":3.64,"17":3.81,"18":3.81}},{"date":"2025-08-05","day_of_week":"Tuesday","total_solar_kwh":15.92,"max_battery_soc_kwh":15.28,"battery_filled_pct":55.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.31,"9":1.08,"10":2.21,"11":4.14,"12":6.95,"13":10.09,"14":13.11,"15":14.74,"16":15.2,"17":15.27,"18":15.28}},{"date":"2025-08-06","day_of_week":"Wednesday","total_solar_kwh":14.8,"max_battery_soc_kwh":14.21,"battery_filled_pct":51.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.01,"8":0.13,"9":0.65,"10":1.78,"11":3.64,"12":6.19,"13":9.08,"14":11.75,"15":13.36,"16":13.96,"17":14.2,"18":14.21}},{"date":"2025-08-07","day_of_week":"Thursday","total_solar_kwh":14.31,"max_battery_soc_kwh":13.74,"battery_filled_pct":50.2,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.26,"9":0.7,"10":1.88,"11":4.05,"12":6.69,"13":8.41,"14":10.86,"15":12.81,"16":13.6,"17":13.73,"18":13.74}},{"date":"2025-08-08","day_of_week":"Friday","total_solar_kwh":16.21,"max_battery_soc_kwh":15.56,"battery_filled_pct":56.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.16,"9":0.56,"10":1.8,"11":4.03,"12":6.93,"13":10.19,"14":13.33,"15":15.02,"16":15.49,"17":15.55,"18":15.56}},{"date":"2025-08-09","day_of_week":"Saturday","total_solar_kwh":12.86,"max_battery_soc_kwh":12.29,"battery_filled_pct":44.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.23,"9":0.8,"10":2.09,"11":3.91,"12":5.85,"13":7.98,"14":9.88,"15":11.48,"16":12.11,"17":12.28,"18":12.29}},{"date":"2025-08-10","day_of_week":"Sunday","total_solar_kwh":11.44,"max_battery_soc_kwh":10.95,"battery_filled_pct":40.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.14,"9":0.46,"10":1.2,"11":2.89,"12":4.63,"13":7.11,"14":8.76,"15":10.02,"16":10.75,"17":10.94,"18":10.95}},{"date":"2025-08-11","day_of_week":"Monday","total_solar_kwh":12.38,"max_battery_soc_kwh":11.88,"battery_filled_pct":43.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.27,"9":0.94,"10":2.05,"11":4.04,"12":6.23,"13":7.6,"14":9.36,"15":10.95,"16":11.62,"17":11.87,"18":11.88}},{"date":"2025-08-12","day_of_week":"Tuesday","total_solar_kwh":16.46,"max_battery_soc_kwh":15.8,"battery_filled_pct":57.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.3,"9":1.02,"10":2.45,"11":4.72,"12":7.46,"13":10.7,"14":13.46,"15":15.18,"16":15.72,"17":15.79,"18":15.8}},{"date":"2025-08-13","day_of_week":"Wednesday","total_solar_kwh":14.78,"max_battery_soc_kwh":14.17,"battery_filled_pct":51.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.27,"9":0.84,"10":2.13,"11":4.43,"12":6.16,"13":8.84,"14":11.74,"15":13.53,"16":14.08,"17":14.16,"18":14.17}},{"date":"2025-08-14","day_of_week":"Thursday","total_solar_kwh":17.18,"max_battery_soc_kwh":16.49,"battery_filled_pct":60.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.17,"9":0.58,"10":1.86,"11":4.18,"12":7.16,"13":10.28,"14":13.54,"15":15.42,"16":16.26,"17":16.48,"18":16.49}},{"date":"2025-08-15","day_of_week":"Friday","total_solar_kwh":14.78,"max_battery_soc_kwh":14.19,"battery_filled_pct":51.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.05,"8":0.31,"9":0.85,"10":2.23,"11":4.45,"12":6.59,"13":9.34,"14":11.62,"15":13.38,"16":14.0,"17":14.17,"18":14.19}},{"date":"2025-08-16","day_of_week":"Saturday","total_solar_kwh":13.85,"max_battery_soc_kwh":13.3,"battery_filled_pct":48.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.29,"9":0.77,"10":1.93,"11":3.79,"12":5.9,"13":8.31,"14":11.15,"15":12.54,"16":13.09,"17":13.29,"18":13.3}},{"date":"2025-08-17","day_of_week":"Sunday","total_solar_kwh":17.96,"max_battery_soc_kwh":17.18,"battery_filled_pct":62.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.3,"9":0.96,"10":2.45,"11":4.81,"12":7.83,"13":11.14,"14":14.18,"15":16.28,"16":16.93,"17":17.12,"18":17.18}},{"date":"2025-08-18","day_of_week":"Monday","total_solar_kwh":15.71,"max_battery_soc_kwh":14.94,"battery_filled_pct":54.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.18,"9":0.64,"10":2.05,"11":4.43,"12":6.99,"13":9.75,"14":12.55,"15":14.26,"16":14.85,"17":14.93,"18":14.94}},{"date":"2025-08-19","day_of_week":"Tuesday","total_solar_kwh":18.03,"max_battery_soc_kwh":17.31,"battery_filled_pct":63.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.21,"9":0.73,"10":2.19,"11":4.69,"12":7.71,"13":11.1,"14":14.63,"15":16.64,"16":17.24,"17":17.3,"18":17.31}},{"date":"2025-08-20","day_of_week":"Wednesday","total_solar_kwh":18.16,"max_battery_soc_kwh":17.43,"battery_filled_pct":63.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.2,"9":0.68,"10":2.11,"11":4.58,"12":7.72,"13":11.26,"14":14.77,"15":16.76,"16":17.37,"17":17.42,"18":17.43}},{"date":"2025-08-21","day_of_week":"Thursday","total_solar_kwh":12.75,"max_battery_soc_kwh":12.24,"battery_filled_pct":44.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.07,"8":0.61,"9":1.46,"10":2.5,"11":3.92,"12":5.63,"13":7.76,"14":9.97,"15":11.35,"16":12.01,"17":12.23,"18":12.24}},{"date":"2025-08-22","day_of_week":"Friday","total_solar_kwh":16.49,"max_battery_soc_kwh":15.81,"battery_filled_pct":57.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.02,"8":0.17,"9":0.77,"10":1.64,"11":3.22,"12":6.24,"13":9.49,"14":12.9,"15":14.97,"16":15.68,"17":15.8,"18":15.81}},{"date":"2025-08-23","day_of_week":"Saturday","total_solar_kwh":18.95,"max_battery_soc_kwh":18.2,"battery_filled_pct":66.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.05,"8":0.36,"9":1.01,"10":2.38,"11":5.05,"12":8.24,"13":11.87,"14":15.42,"15":17.45,"16":18.11,"17":18.18,"18":18.19}},{"date":"2025-08-24","day_of_week":"Sunday","total_solar_kwh":9.84,"max_battery_soc_kwh":9.44,"battery_filled_pct":34.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.28,"9":0.87,"10":2.35,"11":4.09,"12":5.51,"13":6.81,"14":8.13,"15":8.71,"16":9.24,"17":9.43,"18":9.44}},{"date":"2025-08-25","day_of_week":"Monday","total_solar_kwh":2.66,"max_battery_soc_kwh":2.55,"battery_filled_pct":9.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.12,"9":0.33,"10":0.72,"11":1.17,"12":1.7,"13":2.15,"14":2.36,"15":2.45,"16":2.52,"17":2.55,"18":2.55}},{"date":"2025-08-26","day_of_week":"Tuesday","total_solar_kwh":18.92,"max_battery_soc_kwh":18.17,"battery_filled_pct":66.4,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.32,"9":1.11,"10":2.42,"11":4.82,"12":8.11,"13":11.82,"14":15.21,"15":17.29,"16":18.03,"17":18.15,"18":18.16}},{"date":"2025-08-27","day_of_week":"Wednesday","total_solar_kwh":17.39,"max_battery_soc_kwh":16.6,"battery_filled_pct":60.7,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.06,"8":0.46,"9":1.43,"10":2.97,"11":4.77,"12":6.91,"13":9.69,"14":13.39,"15":15.57,"16":16.36,"17":16.58,"18":16.6}},{"date":"2025-08-28","day_of_week":"Thursday","total_solar_kwh":10.04,"max_battery_soc_kwh":9.53,"battery_filled_pct":34.8,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.3,"9":0.75,"10":1.33,"11":2.68,"12":3.51,"13":4.43,"14":6.62,"15":8.22,"16":9.19,"17":9.51,"18":9.53}},{"date":"2025-08-29","day_of_week":"Friday","total_solar_kwh":12.52,"max_battery_soc_kwh":12.02,"battery_filled_pct":43.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.03,"8":0.33,"9":1.15,"10":2.84,"11":5.01,"12":7.18,"13":8.01,"14":9.5,"15":11.03,"16":11.67,"17":12.0,"18":12.02}},{"date":"2025-08-30","day_of_week":"Saturday","total_solar_kwh":13.23,"max_battery_soc_kwh":12.58,"battery_filled_pct":46.0,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.11,"8":0.45,"9":1.23,"10":2.57,"11":4.17,"12":6.11,"13":7.98,"14":9.85,"15":11.39,"16":12.23,"17":12.54,"18":12.58}},{"date":"2025-08-31","day_of_week":"Sunday","total_solar_kwh":14.99,"max_battery_soc_kwh":14.19,"battery_filled_pct":51.9,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.11,"8":0.62,"9":1.52,"10":2.61,"11":4.33,"12":6.45,"13":9.0,"14":11.32,"15":12.88,"16":13.85,"17":14.17,"18":14.19}},{"date":"2025-09-01","day_of_week":"Monday","total_solar_kwh":17.57,"max_battery_soc_kwh":16.56,"battery_filled_pct":60.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.12,"8":0.64,"9":1.59,"10":2.53,"11":4.06,"12":6.69,"13":9.94,"14":13.36,"15":15.36,"16":16.29,"17":16.54,"18":16.56}},{"date":"2025-09-02","day_of_week":"Tuesday","total_solar_kwh":21.46,"max_battery_soc_kwh":20.6,"battery_filled_pct":75.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.09,"8":0.35,"9":1.13,"10":2.99,"11":5.84,"12":9.32,"13":13.13,"14":16.94,"15":19.15,"16":20.22,"17":20.57,"18":20.6}},{"date":"2025-09-03","day_of_week":"Wednesday","total_solar_kwh":20.64,"max_battery_soc_kwh":19.59,"battery_filled_pct":71.6,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.19,"8":0.9,"9":1.69,"10":3.32,"11":6.08,"12":8.88,"13":12.53,"14":15.9,"15":18.3,"16":19.33,"17":19.57,"18":19.59}},{"date":"2025-09-04","day_of_week":"Thursday","total_solar_kwh":20.69,"max_battery_soc_kwh":19.84,"battery_filled_pct":72.5,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.1,"8":0.7,"9":1.55,"10":3.13,"11":5.31,"12":8.56,"13":12.56,"14":16.54,"15":18.87,"16":19.72,"17":19.83,"18":19.84}},{"date":"2025-09-05","day_of_week":"Friday","total_solar_kwh":16.05,"max_battery_soc_kwh":15.39,"battery_filled_pct":56.3,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.14,"8":0.74,"9":1.84,"10":3.67,"11":5.51,"12":7.64,"13":9.62,"14":12.14,"15":14.38,"16":15.22,"17":15.37,"18":15.39}},{"date":"2025-09-06","day_of_week":"Saturday","total_solar_kwh":10.05,"max_battery_soc_kwh":9.65,"battery_filled_pct":35.3,"time_to_full":null,"hourly_soc":{"6":0.0,"7":0.04,"8":0.39,"9":1.0,"10":2.06,"11":3.66,"12":5.03,"13":6.28,"14":7.62,"15":8.72,"16":9.34,"17":9.63,"18":9.65}},{"date":"2025-09-07","day_of_week":"Sunday","total_solar_kwh":20.92,"max_battery_soc_kwh":20.08,"battery_filled_pct":73.4,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.16,"8":0.64,"9":1.56,"10":2.83,"11":5.3,"12":8.94,"13":12.94,"14":16.85,"15":19.13,"16":19.98,"17":20.07,"18":20.08}},{"date":"2025-09-08","day_of_week":"Monday","total_solar_kwh":22.85,"max_battery_soc_kwh":21.93,"battery_filled_pct":80.2,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.15,"8":0.71,"9":1.72,"10":3.86,"11":6.95,"12":10.64,"13":14.68,"14":18.63,"15":20.95,"16":21.82,"17":21.92,"18":21.93}},{"date":"2025-09-09","day_of_week":"Tuesday","total_solar_kwh":9.81,"max_battery_soc_kwh":9.41,"battery_filled_pct":34.4,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.14,"8":0.52,"9":1.31,"10":2.69,"11":4.24,"12":5.86,"13":6.68,"14":7.84,"15":8.67,"16":9.26,"17":9.39,"18":9.41}},{"date":"2025-09-10","day_of_week":"Wednesday","total_solar_kwh":20.5,"max_battery_soc_kwh":19.18,"battery_filled_pct":70.1,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.21,"8":0.64,"9":1.65,"10":3.22,"11":5.29,"12":8.63,"13":12.48,"14":15.64,"15":18.0,"16":19.03,"17":19.16,"18":19.18}},{"date":"2025-09-11","day_of_week":"Thursday","total_solar_kwh":22.22,"max_battery_soc_kwh":21.07,"battery_filled_pct":77.0,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.11,"8":0.44,"9":1.46,"10":3.16,"11":5.95,"12":9.61,"13":13.72,"14":17.73,"15":19.98,"16":20.91,"17":21.05,"18":21.07}},{"date":"2025-09-12","day_of_week":"Friday","total_solar_kwh":22.03,"max_battery_soc_kwh":20.5,"battery_filled_pct":74.9,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.21,"8":0.68,"9":1.79,"10":3.32,"11":5.86,"12":8.8,"13":12.66,"14":16.2,"15":18.85,"16":20.19,"17":20.47,"18":20.5}},{"date":"2025-09-13","day_of_week":"Saturday","total_solar_kwh":23.65,"max_battery_soc_kwh":22.41,"battery_filled_pct":81.9,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.13,"8":0.48,"9":1.56,"10":3.84,"11":6.95,"12":10.64,"13":14.67,"14":18.66,"15":21.09,"16":22.1,"17":22.35,"18":22.41}},{"date":"2025-09-14","day_of_week":"Sunday","total_solar_kwh":23.47,"max_battery_soc_kwh":22.09,"battery_filled_pct":80.7,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.13,"8":0.47,"9":1.56,"10":3.87,"11":7.15,"12":11.02,"13":15.14,"14":18.83,"15":21.05,"16":21.97,"17":22.06,"18":22.09}},{"date":"2025-09-15","day_of_week":"Monday","total_solar_kwh":15.63,"max_battery_soc_kwh":14.78,"battery_filled_pct":54.0,"time_to_full":null,"hourly_soc":{"6":0.02,"7":0.24,"8":0.85,"9":1.8,"10":3.17,"11":5.97,"12":7.97,"13":10.03,"14":12.94,"15":14.36,"16":14.67,"17":14.76,"18":14.78}},{"date":"2025-09-16","day_of_week":"Tuesday","total_solar_kwh":22.36,"max_battery_soc_kwh":20.92,"battery_filled_pct":76.5,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.2,"8":0.69,"9":1.88,"10":4.03,"11":6.96,"12":10.52,"13":14.12,"14":17.26,"15":19.59,"16":20.6,"17":20.89,"18":20.92}},{"date":"2025-09-17","day_of_week":"Wednesday","total_solar_kwh":21.88,"max_battery_soc_kwh":20.69,"battery_filled_pct":75.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.13,"8":0.56,"9":1.61,"10":3.1,"11":5.69,"12":9.51,"13":13.4,"14":16.86,"15":19.4,"16":20.51,"17":20.66,"18":20.69}},{"date":"2025-09-18","day_of_week":"Thursday","total_solar_kwh":24.48,"max_battery_soc_kwh":23.27,"battery_filled_pct":85.0,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.16,"8":0.55,"9":1.67,"10":3.98,"11":7.24,"12":11.1,"13":15.22,"14":19.27,"15":21.81,"16":22.91,"17":23.19,"18":23.27}},{"date":"2025-09-19","day_of_week":"Friday","total_solar_kwh":24.67,"max_battery_soc_kwh":23.05,"battery_filled_pct":84.2,"time_to_full":null,"hourly_soc":{"6":0.01,"7":0.19,"8":0.74,"9":1.98,"10":4.43,"11":7.61,"12":11.07,"13":14.87,"14":18.75,"15":21.45,"16":22.68,"17":23.0,"18":23.05}},{"date":"2025-09-20","day_of_week":"Saturday","total_solar_kwh":16.68,"max_battery_soc_kwh":16.0,"battery_filled_pct":58.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.22,"8":0.78,"9":2.12,"10":4.43,"11":6.98,"12":9.57,"13":11.65,"14":13.23,"15":14.55,"16":15.55,"17":15.95,"18":16.0}},{"date":"2025-09-21","day_of_week":"Sunday","total_solar_kwh":16.38,"max_battery_soc_kwh":15.54,"battery_filled_pct":56.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.14,"8":0.86,"9":1.9,"10":3.37,"11":5.21,"12":7.25,"13":9.91,"14":12.19,"15":13.88,"16":15.1,"17":15.5,"18":15.54}},{"date":"2025-09-22","day_of_week":"Monday","total_solar_kwh":22.25,"max_battery_soc_kwh":20.48,"battery_filled_pct":74.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.32,"8":1.12,"9":2.45,"10":4.4,"11":7.34,"12":10.65,"13":13.42,"14":16.24,"15":18.94,"16":20.2,"17":20.44,"18":20.48}},{"date":"2025-09-23","day_of_week":"Tuesday","total_solar_kwh":21.78,"max_battery_soc_kwh":20.19,"battery_filled_pct":73.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.36,"8":1.03,"9":2.45,"10":4.55,"11":6.84,"12":9.21,"13":12.5,"14":16.34,"15":18.59,"16":19.73,"17":20.14,"18":20.19}},{"date":"2025-09-24","day_of_week":"Wednesday","total_solar_kwh":23.47,"max_battery_soc_kwh":22.1,"battery_filled_pct":80.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.27,"8":0.98,"9":2.31,"10":4.45,"11":7.01,"12":9.94,"13":13.66,"14":17.63,"15":20.3,"16":21.63,"17":22.05,"18":22.1}},{"date":"2025-09-25","day_of_week":"Thursday","total_solar_kwh":25.39,"max_battery_soc_kwh":23.98,"battery_filled_pct":87.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.22,"8":0.88,"9":2.34,"10":4.69,"11":7.92,"12":11.77,"13":15.87,"14":19.89,"15":22.41,"16":23.67,"17":23.93,"18":23.98}},{"date":"2025-09-26","day_of_week":"Friday","total_solar_kwh":24.52,"max_battery_soc_kwh":23.14,"battery_filled_pct":84.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.03,"7":0.26,"8":0.71,"9":2.02,"10":4.47,"11":7.75,"12":11.66,"13":15.44,"14":18.84,"15":21.49,"16":22.82,"17":23.09,"18":23.13}},{"date":"2025-09-27","day_of_week":"Saturday","total_solar_kwh":24.02,"max_battery_soc_kwh":22.09,"battery_filled_pct":80.7,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.05,"7":0.43,"8":1.28,"9":2.86,"10":5.29,"11":8.67,"12":12.2,"13":15.41,"14":17.98,"15":20.28,"16":21.43,"17":22.0,"18":22.09}},{"date":"2025-09-28","day_of_week":"Sunday","total_solar_kwh":22.85,"max_battery_soc_kwh":21.05,"battery_filled_pct":76.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.27,"8":1.02,"9":2.28,"10":4.14,"11":6.66,"12":9.24,"13":13.04,"14":16.92,"15":19.27,"16":20.62,"17":20.97,"18":21.05}},{"date":"2025-09-29","day_of_week":"Monday","total_solar_kwh":13.2,"max_battery_soc_kwh":12.55,"battery_filled_pct":45.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.33,"8":1.04,"9":2.18,"10":3.45,"11":4.63,"12":6.34,"13":8.19,"14":10.36,"15":11.8,"16":12.33,"17":12.53,"18":12.55}},{"date":"2025-09-30","day_of_week":"Tuesday","total_solar_kwh":22.51,"max_battery_soc_kwh":20.52,"battery_filled_pct":75.0,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.29,"8":0.91,"9":2.42,"10":4.09,"11":6.65,"12":8.58,"13":11.71,"14":15.78,"15":18.6,"16":20.05,"17":20.45,"18":20.52}},{"date":"2025-10-01","day_of_week":"Wednesday","total_solar_kwh":19.48,"max_battery_soc_kwh":18.63,"battery_filled_pct":68.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.03,"7":0.34,"8":1.07,"9":2.64,"10":5.1,"11":7.92,"12":11.0,"13":13.47,"14":15.46,"15":16.9,"16":18.06,"17":18.57,"18":18.63}},{"date":"2025-10-02","day_of_week":"Thursday","total_solar_kwh":28.74,"max_battery_soc_kwh":25.73,"battery_filled_pct":94.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.05,"7":0.43,"8":1.24,"9":2.92,"10":5.86,"11":9.16,"12":13.12,"13":17.25,"14":21.33,"15":24.01,"16":25.36,"17":25.67,"18":25.73}},{"date":"2025-10-03","day_of_week":"Friday","total_solar_kwh":26.28,"max_battery_soc_kwh":23.61,"battery_filled_pct":86.3,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.04,"7":0.39,"8":1.3,"9":2.73,"10":4.83,"11":7.65,"12":11.31,"13":15.35,"14":19.42,"15":22.09,"16":23.4,"17":23.57,"18":23.6}},{"date":"2025-10-04","day_of_week":"Saturday","total_solar_kwh":27.71,"max_battery_soc_kwh":25.66,"battery_filled_pct":93.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.05,"7":0.27,"8":0.81,"9":2.4,"10":5.18,"11":8.83,"12":12.92,"13":17.05,"14":21.12,"15":23.8,"16":25.16,"17":25.59,"18":25.66}},{"date":"2025-10-05","day_of_week":"Sunday","total_solar_kwh":8.83,"max_battery_soc_kwh":8.48,"battery_filled_pct":31.0,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.07,"7":0.56,"8":1.57,"9":3.25,"10":5.13,"11":5.78,"12":6.38,"13":7.12,"14":7.83,"15":8.18,"16":8.33,"17":8.43,"18":8.47}},{"date":"2025-10-06","day_of_week":"Monday","total_solar_kwh":20.08,"max_battery_soc_kwh":19.12,"battery_filled_pct":69.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.03,"7":0.31,"8":1.26,"9":2.57,"10":4.26,"11":6.57,"12":9.02,"13":12.03,"14":14.72,"15":16.98,"16":18.44,"17":18.99,"18":19.11}},{"date":"2025-10-07","day_of_week":"Tuesday","total_solar_kwh":22.43,"max_battery_soc_kwh":20.96,"battery_filled_pct":76.6,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.02,"7":0.4,"8":1.46,"9":3.1,"10":4.91,"11":6.83,"12":9.97,"13":13.19,"14":16.67,"15":19.37,"16":20.72,"17":20.92,"18":20.96}},{"date":"2025-10-08","day_of_week":"Wednesday","total_solar_kwh":22.63,"max_battery_soc_kwh":20.72,"battery_filled_pct":75.7,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.08,"7":0.52,"8":1.4,"9":3.0,"10":4.5,"11":6.4,"12":8.96,"13":12.33,"14":16.36,"15":19.11,"16":20.51,"17":20.69,"18":20.72}},{"date":"2025-10-09","day_of_week":"Thursday","total_solar_kwh":29.1,"max_battery_soc_kwh":25.96,"battery_filled_pct":94.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.07,"7":0.44,"8":1.2,"9":2.75,"10":5.56,"11":9.03,"12":13.11,"13":17.24,"14":21.33,"15":24.11,"16":25.61,"17":25.9,"18":25.96}},{"date":"2025-10-10","day_of_week":"Friday","total_solar_kwh":27.73,"max_battery_soc_kwh":25.13,"battery_filled_pct":91.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.08,"7":0.44,"8":1.28,"9":3.31,"10":6.05,"11":9.26,"12":12.65,"13":16.5,"14":20.47,"15":23.31,"16":24.78,"17":25.06,"18":25.13}},{"date":"2025-10-11","day_of_week":"Saturday","total_solar_kwh":24.41,"max_battery_soc_kwh":22.73,"battery_filled_pct":83.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.09,"7":0.6,"8":1.51,"9":3.23,"10":5.61,"11":8.38,"12":11.59,"13":15.02,"14":18.37,"15":20.78,"16":22.24,"17":22.63,"18":22.72}},{"date":"2025-10-12","day_of_week":"Sunday","total_solar_kwh":28.84,"max_battery_soc_kwh":26.03,"battery_filled_pct":95.1,"time_to_full":"17:38","hourly_soc":{"5":0.0,"6":0.1,"7":0.54,"8":1.25,"9":3.04,"10":5.98,"11":9.81,"12":13.93,"13":18.06,"14":21.92,"15":24.17,"16":25.44,"17":25.97,"18":26.02}},{"date":"2025-10-13","day_of_week":"Monday","total_solar_kwh":29.17,"max_battery_soc_kwh":25.66,"battery_filled_pct":93.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.1,"7":0.62,"8":1.73,"9":3.24,"10":5.39,"11":8.88,"12":12.86,"13":16.99,"14":21.09,"15":23.91,"16":25.4,"17":25.61,"18":25.65}},{"date":"2025-10-14","day_of_week":"Tuesday","total_solar_kwh":29.88,"max_battery_soc_kwh":26.42,"battery_filled_pct":96.6,"time_to_full":"16:14","hourly_soc":{"5":0.0,"6":0.19,"7":0.73,"8":1.62,"9":3.69,"10":6.29,"11":9.63,"12":13.61,"13":17.74,"14":21.84,"15":24.66,"16":26.15,"17":26.38,"18":26.42}},{"date":"2025-10-15","day_of_week":"Wednesday","total_solar_kwh":29.33,"max_battery_soc_kwh":26.83,"battery_filled_pct":98.1,"time_to_full":"15:59","hourly_soc":{"5":0.0,"6":0.08,"7":0.37,"8":1.16,"9":3.12,"10":6.21,"11":10.08,"12":14.2,"13":18.33,"14":22.42,"15":25.17,"16":26.58,"17":26.79,"18":26.83}},{"date":"2025-10-16","day_of_week":"Thursday","total_solar_kwh":20.36,"max_battery_soc_kwh":19.0,"battery_filled_pct":69.4,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.1,"7":0.57,"8":1.62,"9":3.72,"10":6.37,"11":9.01,"12":10.52,"13":13.06,"14":16.16,"15":18.01,"16":18.66,"17":18.92,"18":19.0}},{"date":"2025-10-17","day_of_week":"Friday","total_solar_kwh":27.86,"max_battery_soc_kwh":25.95,"battery_filled_pct":94.9,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.07,"7":0.33,"8":1.15,"9":2.75,"10":5.23,"11":9.15,"12":13.11,"13":17.08,"14":20.89,"15":23.72,"16":25.29,"17":25.84,"18":25.95}},{"date":"2025-10-18","day_of_week":"Saturday","total_solar_kwh":29.59,"max_battery_soc_kwh":27.2,"battery_filled_pct":99.4,"time_to_full":"15:54","hourly_soc":{"5":0.01,"6":0.13,"7":0.46,"8":1.31,"9":3.35,"10":6.53,"11":10.32,"12":14.44,"13":18.57,"14":22.63,"15":25.37,"16":26.81,"17":27.11,"18":27.2}},{"date":"2025-10-19","day_of_week":"Sunday","total_solar_kwh":10.39,"max_battery_soc_kwh":9.97,"battery_filled_pct":36.5,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.17,"7":0.44,"8":1.22,"9":2.01,"10":2.97,"11":4.03,"12":5.97,"13":7.05,"14":7.97,"15":8.82,"16":9.48,"17":9.88,"18":9.97}},{"date":"2025-10-20","day_of_week":"Monday","total_solar_kwh":7.14,"max_battery_soc_kwh":6.86,"battery_filled_pct":25.1,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.07,"7":0.47,"8":1.05,"9":1.63,"10":1.99,"11":2.55,"12":3.21,"13":4.2,"14":4.8,"15":5.57,"16":6.52,"17":6.82,"18":6.85}},{"date":"2025-10-21","day_of_week":"Tuesday","total_solar_kwh":5.92,"max_battery_soc_kwh":5.68,"battery_filled_pct":20.8,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.01,"7":0.04,"8":0.09,"9":0.39,"10":0.86,"11":1.28,"12":2.07,"13":3.24,"14":4.19,"15":4.89,"16":5.5,"17":5.64,"18":5.68,"19":5.68}},{"date":"2025-10-22","day_of_week":"Wednesday","total_solar_kwh":26.26,"max_battery_soc_kwh":23.88,"battery_filled_pct":87.3,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.11,"7":0.6,"8":1.72,"9":3.69,"10":6.02,"11":8.77,"12":12.49,"13":16.26,"14":18.77,"15":21.22,"16":23.03,"17":23.72,"18":23.88,"19":23.88}},{"date":"2025-10-23","day_of_week":"Thursday","total_solar_kwh":28.06,"max_battery_soc_kwh":24.7,"battery_filled_pct":90.3,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.15,"7":0.72,"8":1.88,"9":3.4,"10":5.53,"11":7.74,"12":11.35,"13":15.48,"14":19.6,"15":22.63,"16":24.32,"17":24.64,"18":24.69,"19":24.7}},{"date":"2025-10-24","day_of_week":"Friday","total_solar_kwh":30.46,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:40","hourly_soc":{"5":0.01,"6":0.11,"7":0.43,"8":1.32,"9":3.43,"10":6.63,"11":10.58,"12":14.71,"13":18.73,"14":22.69,"15":25.62,"16":27.07,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-10-25","day_of_week":"Saturday","total_solar_kwh":10.98,"max_battery_soc_kwh":10.54,"battery_filled_pct":38.5,"time_to_full":null,"hourly_soc":{"5":0.0,"6":0.06,"7":0.37,"8":1.04,"9":2.1,"10":4.4,"11":6.58,"12":8.51,"13":9.38,"14":9.56,"15":9.89,"16":10.31,"17":10.5,"18":10.54,"19":10.54}},{"date":"2025-10-26","day_of_week":"Sunday","total_solar_kwh":26.28,"max_battery_soc_kwh":23.98,"battery_filled_pct":87.6,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.16,"7":0.7,"8":1.73,"9":3.47,"10":6.5,"11":10.17,"12":13.6,"13":16.49,"14":19.76,"15":22.12,"16":23.18,"17":23.84,"18":23.97,"19":23.98}},{"date":"2025-10-27","day_of_week":"Monday","total_solar_kwh":17.23,"max_battery_soc_kwh":16.35,"battery_filled_pct":59.8,"time_to_full":null,"hourly_soc":{"5":0.01,"6":0.27,"7":0.84,"8":1.76,"9":3.21,"10":5.5,"11":8.31,"12":9.51,"13":11.23,"14":12.99,"15":14.33,"16":15.43,"17":16.11,"18":16.34,"19":16.35}},{"date":"2025-10-28","day_of_week":"Tuesday","total_solar_kwh":32.8,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:10","hourly_soc":{"5":0.01,"6":0.12,"7":0.45,"8":1.44,"9":3.71,"10":7.12,"11":11.17,"12":15.3,"13":19.43,"14":23.56,"15":26.69,"16":27.36,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-10-29","day_of_week":"Wednesday","total_solar_kwh":31.08,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:26","hourly_soc":{"5":0.01,"6":0.17,"7":0.53,"8":1.52,"9":3.74,"10":7.06,"11":11.07,"12":15.19,"13":19.09,"14":22.97,"15":26.14,"16":27.35,"17":27.36,"18":27.36,"19":27.36}},{"date":"2025-10-30","day_of_week":"Thursday","total_solar_kwh":16.62,"max_battery_soc_kwh":15.95,"battery_filled_pct":58.3,"time_to_full":null,"hourly_soc":{"5":0.03,"6":0.36,"7":1.07,"8":2.35,"9":4.33,"10":6.23,"11":8.58,"12":10.3,"13":12.65,"14":14.07,"15":14.81,"16":15.48,"17":15.85,"18":15.95,"19":15.95}},{"date":"2025-10-31","day_of_week":"Friday","total_solar_kwh":32.11,"max_battery_soc_kwh":27.36,"battery_filled_pct":100.0,"time_to_full":"15:19","hourly_soc":{"5":0.01,"6":0.15,"7":0.49,"8":1.52,"9":3.76,"10":7.03,"11":11.03,"12":15.15,"13":19.28,"14":23.41,"15":26.45,"16":27.36,"17":27.36,"18":27.36,"19":27.36}}]};


// Normalize month format "YYYY-M" → "YYYY-MM" in historical data
if (HISTORICAL_ROI_DATA?.monthly_results) {
  HISTORICAL_ROI_DATA.monthly_results.forEach(m => {
    const [y, mo] = m.month.split('-');
    m.month = `${y}-${mo.padStart(2, '0')}`;
  });
}

// Derive default purchaseDate from first month of historical data
const HISTORICAL_FIRST_DATE = HISTORICAL_ROI_DATA?.monthly_results?.[0]?.month
  ? HISTORICAL_ROI_DATA.monthly_results[0].month + '-01'
  : '2024-10-01';

function predictSolarFromWeather(weatherDay, historicalAvgSolar) {
  const cloudCover = weatherDay.day.avgvis_km < 5 ? 90 : weatherDay.day.daily_will_it_rain ? 70 : weatherDay.hour[12].cloud || 30;
  const uvIndex = weatherDay.day.uv || 5;
  const multiplier = WEATHER_SOLAR_CORRELATION.getSolarMultiplier(cloudCover, uvIndex);

  // Get seasonal adjustment based on month
  const date = new Date(weatherDay.date);
  const month = date.getMonth(); // 0-11
  const seasonalMultipliers = [1.2, 1.1, 0.9, 0.7, 0.5, 0.4, 0.45, 0.6, 0.8, 1.0, 1.1, 1.2]; // Jan-Dec
  const seasonalAdj = seasonalMultipliers[month];

  return historicalAvgSolar * multiplier * seasonalAdj;
}

// Predict battery performance based on predicted solar
function predictBatteryPerformance(predictedSolarKwh, batteryCapacityKwh = 32, chargeRateKw = 8, efficiencyPct = 97.5) {
  // Simple model: assume linear charging from 0 to predicted solar over daylight hours
  const efficiency = efficiencyPct / 100;

  // Estimate charging hours (approximate)
  const chargingHours = Math.min(predictedSolarKwh / (chargeRateKw * efficiency), 8);
  const maxSOC = Math.min(predictedSolarKwh * efficiency, batteryCapacityKwh);
  const fillPct = (maxSOC / batteryCapacityKwh) * 100;

  // Estimate time to full (if possible)
  let timeToFull = null;
  if (fillPct >= 95) {
    // Assume charging starts at 8am and reaches 95% at:
    const hoursTo95 = (batteryCapacityKwh * 0.95) / (chargeRateKw * efficiency);
    const hour = 8 + Math.min(hoursTo95, 8);
    timeToFull = `${Math.floor(hour)}:${Math.floor((hour % 1) * 60).toString().padStart(2, '0')}`;
  }

  return {
    predictedSolarKwh: Math.round(predictedSolarKwh * 10) / 10,
    maxSOC: Math.round(maxSOC * 10) / 10,
    fillPct: Math.round(fillPct * 10) / 10,
    timeToFull,
    performance: fillPct >= 95 ? 'Excellent' : fillPct >= 75 ? 'Good' : fillPct >= 50 ? 'Fair' : 'Poor'
  };
}

/* ═══════════════════════════════════════════════════════════════════════
   OPEN-METEO WEATHER FORECAST CONFIGURATION
   16-day forecast with solar radiation data
   ═══════════════════════════════════════════════════════════════════════ */

// WMO Weather Code to condition label + icon mapping
const WMO_CODE_TO_CONDITION = {
  0:  { label: 'Clear sky',        icon: '\u2600\uFE0F' },
  1:  { label: 'Mainly clear',     icon: '\uD83C\uDF24\uFE0F' },
  2:  { label: 'Partly cloudy',    icon: '\u26C5' },
  3:  { label: 'Overcast',         icon: '\u2601\uFE0F' },
  45: { label: 'Fog',              icon: '\uD83C\uDF2B\uFE0F' },
  48: { label: 'Rime fog',         icon: '\uD83C\uDF2B\uFE0F' },
  51: { label: 'Light drizzle',    icon: '\uD83C\uDF26\uFE0F' },
  53: { label: 'Moderate drizzle', icon: '\uD83C\uDF26\uFE0F' },
  55: { label: 'Dense drizzle',    icon: '\uD83C\uDF27\uFE0F' },
  56: { label: 'Freezing drizzle', icon: '\uD83C\uDF28\uFE0F' },
  57: { label: 'Heavy freezing drizzle', icon: '\uD83C\uDF28\uFE0F' },
  61: { label: 'Slight rain',      icon: '\uD83C\uDF26\uFE0F' },
  63: { label: 'Moderate rain',    icon: '\uD83C\uDF27\uFE0F' },
  65: { label: 'Heavy rain',       icon: '\uD83C\uDF27\uFE0F' },
  66: { label: 'Light freezing rain', icon: '\uD83C\uDF28\uFE0F' },
  67: { label: 'Heavy freezing rain',  icon: '\uD83C\uDF28\uFE0F' },
  71: { label: 'Slight snow',      icon: '\uD83C\uDF28\uFE0F' },
  73: { label: 'Moderate snow',    icon: '\uD83C\uDF28\uFE0F' },
  75: { label: 'Heavy snow',       icon: '\uD83C\uDF28\uFE0F' },
  77: { label: 'Snow grains',      icon: '\uD83C\uDF28\uFE0F' },
  80: { label: 'Slight showers',   icon: '\uD83C\uDF26\uFE0F' },
  81: { label: 'Moderate showers', icon: '\uD83C\uDF27\uFE0F' },
  82: { label: 'Violent showers',  icon: '\uD83C\uDF27\uFE0F' },
  85: { label: 'Snow showers',     icon: '\uD83C\uDF28\uFE0F' },
  86: { label: 'Heavy snow showers', icon: '\uD83C\uDF28\uFE0F' },
  95: { label: 'Thunderstorm',     icon: '\u26C8\uFE0F' },
  96: { label: 'T-storm + hail',   icon: '\u26C8\uFE0F' },
  99: { label: 'T-storm + heavy hail', icon: '\u26C8\uFE0F' },
};

// Monthly clear-sky solar radiation benchmarks for Adelaide (MJ/m2/day)
// Source: BOM solar exposure data for Adelaide Airport
const ADELAIDE_CLEAR_SKY_MJ = [28.5, 25.5, 20.5, 14.5, 10.0, 8.0, 9.0, 12.5, 17.5, 22.5, 26.5, 29.0];

// Monthly peak sun hours for Adelaide (equivalent to kWh/m2/day for a 1kW system)
const ADELAIDE_PEAK_SUN_HOURS = [7.2, 6.4, 5.1, 3.6, 2.5, 2.0, 2.2, 3.1, 4.4, 5.6, 6.6, 7.3];

// Convert Open-Meteo radiation (MJ/m2/day) to predicted solar kWh
function radiationToSolarKwh(radiationMJ, month, systemCapacityKw) {
  if (!radiationMJ || radiationMJ <= 0) return 0;
  const clearSkyMJ = ADELAIDE_CLEAR_SKY_MJ[month] || 18;
  // Ratio of actual radiation to clear-sky benchmark
  const solarRatio = Math.min(radiationMJ / clearSkyMJ, 1.2);
  // Peak sun hours adjusted by actual conditions
  const peakHours = ADELAIDE_PEAK_SUN_HOURS[month] * solarRatio;
  // System output = capacity * peak hours * system losses (0.82 typical: inverter, wiring, temp, soiling)
  return Math.round(systemCapacityKw * peakHours * 0.82 * 10) / 10;
}

// Transform raw Open-Meteo forecast into prediction objects
function processOpenMeteoForecast(forecastDays, cfg) {
  if (!forecastDays || !forecastDays.length) return [];
  const bCap = cfg.usableCapacity || 32;
  const chargeRate = cfg.chargeRate || 8;
  const efficiency = cfg.inverterEfficiency || 97.5;
  const sysKw = cfg.solarCapacity || 5;

  return forecastDays.map(day => {
    const dateObj = new Date(day.date + 'T00:00:00');
    const month = dateObj.getMonth();
    const wmoInfo = WMO_CODE_TO_CONDITION[day.weather_code] || { label: 'Unknown', icon: '\uD83C\uDF24\uFE0F' };
    const predictedSolarKwh = radiationToSolarKwh(day.shortwave_radiation_sum, month, sysKw);
    const batteryPred = predictBatteryPerformance(predictedSolarKwh, bCap, chargeRate, efficiency);

    return {
      date: day.date,
      dateObj,
      dayName: dateObj.toLocaleDateString('en-AU', { weekday: 'short' }),
      condition: wmoInfo.label,
      conditionIcon: wmoInfo.icon,
      weatherCode: day.weather_code,
      tempMax: day.temp_max,
      tempMin: day.temp_min,
      cloudCover: day.cloud_cover_mean,
      precipChance: day.precipitation_probability,
      radiationMJ: day.shortwave_radiation_sum,
      sunshineHours: day.sunshine_duration_hours,
      ...batteryPred,
    };
  });
}

function makeRateSet(from, label, overrides = {}) {
  return {
    id: Date.now() + Math.random(),
    from, label,
    sponge: 0.2701, peak: 0.5658, offPk: 0.3882,
    feedIn: 0.055, supply: 1.2626, disc: 9, gst: 10,
    ...overrides,
  };
}

function calcBill(d, r) {
  const en = d.sponge * r.sponge + d.peak * r.peak + d.offPk * r.offPk;
  const fi = d.feedIn * r.feedIn;
  const su = d.days * r.supply;
  const enD = en * (r.disc / 100);
  const suD = su * (r.disc / 100);
  const taxable = (en - enD) + (su - suD);
  const gst = taxable * (r.gst / 100);
  return { en, fi, su, enD, suD, taxable, gst, total: taxable - fi + gst, spongeC: d.sponge * r.sponge, peakC: d.peak * r.peak, offPkC: d.offPk * r.offPk };
}

function calcPmt(p, ar, ty) {
  if (p <= 0) return 0;
  const n = ty * 12, r = ar / 100 / 12;
  if (ar === 0) return p / n;
  return p * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
}

/* ── Amortisation Schedule Generator ── */
function generateAmortSchedule(principal, annualRate, termYears, extraMonthly = 0) {
  if (principal <= 0 || termYears <= 0) return [];
  const n = termYears * 12;
  const r = annualRate / 100 / 12;
  const basePmt = annualRate === 0 ? principal / n : principal * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
  let balance = principal;
  let cumInterest = 0;
  let cumPrincipal = 0;
  const schedule = [];
  for (let i = 1; i <= n && balance > 0.01; i++) {
    const interest = balance * r;
    const totalPmt = Math.min(basePmt + extraMonthly, balance + interest);
    const principalPortion = totalPmt - interest;
    balance = Math.max(0, balance - principalPortion);
    cumInterest += interest;
    cumPrincipal += principalPortion;
    schedule.push({
      month: i,
      payment: Math.round(totalPmt * 100) / 100,
      principal: Math.round(principalPortion * 100) / 100,
      interest: Math.round(interest * 100) / 100,
      balance: Math.round(balance * 100) / 100,
      cumInterest: Math.round(cumInterest * 100) / 100,
      cumPrincipal: Math.round(cumPrincipal * 100) / 100,
    });
    if (balance <= 0.01) break;
  }
  return schedule;
}

/* ── Accelerated Repayment Calculator (battery savings applied as extra repayments) ── */
function generateAcceleratedSchedule(principal, annualRate, termYears, monthlySavings) {
  if (principal <= 0 || termYears <= 0 || monthlySavings <= 0) return { schedule: [], standardSchedule: [], summary: null };
  const standardSchedule = generateAmortSchedule(principal, annualRate, termYears, 0);
  const acceleratedSchedule = generateAmortSchedule(principal, annualRate, termYears, monthlySavings);
  const standardTotalInterest = standardSchedule.length > 0 ? standardSchedule[standardSchedule.length - 1].cumInterest : 0;
  const accelTotalInterest = acceleratedSchedule.length > 0 ? acceleratedSchedule[acceleratedSchedule.length - 1].cumInterest : 0;
  const monthsSaved = standardSchedule.length - acceleratedSchedule.length;
  return {
    schedule: acceleratedSchedule,
    standardSchedule,
    summary: {
      originalMonths: standardSchedule.length,
      acceleratedMonths: acceleratedSchedule.length,
      monthsSaved,
      yearsSaved: Math.round(monthsSaved / 12 * 10) / 10,
      totalInterestStandard: Math.round(standardTotalInterest * 100) / 100,
      totalInterestAccelerated: Math.round(accelTotalInterest * 100) / 100,
      interestSaved: Math.round((standardTotalInterest - accelTotalInterest) * 100) / 100,
    }
  };
}

/* ── Adelaide sunrise/sunset hours by month (0=Jan) for SOC curve generation ── */
const ADELAIDE_SUNRISE_HOUR = [6.1, 6.6, 7.0, 7.3, 7.1, 7.2, 7.1, 6.7, 6.1, 6.3, 5.9, 5.8];
const ADELAIDE_SUNSET_HOUR  = [20.4, 20.0, 19.3, 18.3, 17.5, 17.2, 17.4, 17.9, 18.5, 19.1, 19.8, 20.4];

/* ── Derive synthetic hourly SOC array from daily total solar ── */
function deriveHourlySoc(totalSolarKwh, dateStr, cfg) {
  const dateObj = new Date(dateStr + 'T00:00:00');
  const month = dateObj.getMonth();
  const sunrise = ADELAIDE_SUNRISE_HOUR[month];
  const sunset = ADELAIDE_SUNSET_HOUR[month];
  const batteryCapacity = cfg.usableCapacity || cfg.batteryCapacity || 32;
  const efficiency = (cfg.inverterEfficiency || 97.5) / 100;

  const soc = {};
  let cumSoc = 0;

  for (let h = 4; h <= 21; h++) {
    if (h < sunrise || h > sunset) {
      soc[String(h)] = Math.round(cumSoc * 100) / 100;
      continue;
    }
    // Sine-curve distribution: peak generation at solar noon
    const solarNoon = (sunrise + sunset) / 2;
    const halfWindow = (sunset - sunrise) / 2;
    const angle = ((h - solarNoon) / halfWindow) * (Math.PI / 2);
    const weight = Math.max(0, Math.cos(angle));

    // Distribute total solar across daylight hours proportionally
    const totalWeight = Array.from({length: Math.ceil(sunset - sunrise)}, (_, i) => {
      const hr = Math.floor(sunrise) + i;
      const a = ((hr - solarNoon) / halfWindow) * (Math.PI / 2);
      return Math.max(0, Math.cos(a));
    }).reduce((s, w) => s + w, 0);

    const hourKwh = totalWeight > 0 ? (totalSolarKwh * weight / totalWeight) : 0;
    cumSoc = Math.min(cumSoc + hourKwh * efficiency, batteryCapacity);
    soc[String(h)] = Math.round(cumSoc * 100) / 100;
  }
  return soc;
}

/* ── Transform live DB data to historicalData shape ── */
function transformLiveToHistorical(liveDaily, liveMonthly, cfg) {
  const dailyResults = liveDaily
    .filter(d => d.total_yield_kwh > 0)
    .map(d => {
      const dateStr = d.date;
      const solarKwh = d.total_yield_kwh || 0;
      const bCap = cfg.usableCapacity || cfg.batteryCapacity || 32;
      const chargeRate = cfg.chargeRate || 8;
      const eff = (cfg.inverterEfficiency || 97.5) / 100;

      const maxSoc = Math.min(solarKwh * eff, bCap);
      const fillPct = (maxSoc / bCap) * 100;

      let timeToFull = null;
      if (fillPct >= 95) {
        const hoursTo95 = (bCap * 0.95) / (chargeRate * eff);
        const hour = 8 + Math.min(hoursTo95, 8);
        timeToFull = `${Math.floor(hour)}:${Math.floor((hour % 1) * 60).toString().padStart(2, '0')}`;
      }

      const dateObj = new Date(dateStr + 'T00:00:00');
      const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

      return {
        date: dateStr,
        day_of_week: dayNames[dateObj.getDay()],
        total_solar_kwh: Math.round(solarKwh * 100) / 100,
        max_battery_soc_kwh: Math.round(maxSoc * 100) / 100,
        battery_filled_pct: Math.round(fillPct * 10) / 10,
        time_to_full: timeToFull,
        hourly_soc: deriveHourlySoc(solarKwh, dateStr, cfg)
      };
    });

  // Monthly: compute cost estimates from solar generation
  const buyRate = cfg.buyRate || 0.35;
  const sellRate = cfg.sellRate || 0.07;
  const dailySupply = cfg.dailySupply || 1.17;
  const dailyUsage = cfg.dailyUsage || 20;

  const monthlyResults = liveMonthly.map(m => {
    const daysInMonth = m.days_with_data || 30;
    const solarTotal = m.total_yield_kwh || 0;
    const bCap = cfg.usableCapacity || cfg.batteryCapacity || 32;

    // Estimate monthly consumption
    const consumption = dailyUsage * daysInMonth;
    // Cost without battery: all from grid
    const costNoBattery = (consumption * buyRate) + (dailySupply * daysInMonth);
    // With battery: self-consume up to battery capacity per day, export rest
    const avgDailySolar = solarTotal / Math.max(daysInMonth, 1);
    const dailySelfConsume = Math.min(avgDailySolar, Math.min(dailyUsage, bCap));
    const dailyExport = Math.max(0, avgDailySolar - dailySelfConsume);
    const dailyGridImport = Math.max(0, dailyUsage - dailySelfConsume);
    const costWithBattery = (dailyGridImport * daysInMonth * buyRate) + (dailySupply * daysInMonth) - (dailyExport * daysInMonth * sellRate);

    return {
      month: m.month,
      solar_total: Math.round(solarTotal * 100) / 100,
      consumption: Math.round(consumption * 100) / 100,
      cost_no_battery: Math.round(costNoBattery * 100) / 100,
      cost_with_battery: Math.round(costWithBattery * 100) / 100,
      savings: Math.round((costNoBattery - costWithBattery) * 100) / 100,
      savings_with_sharer: Math.round((costNoBattery - costWithBattery) * 100) / 100
    };
  });

  return { daily_results: dailyResults, monthly_results: monthlyResults };
}

/* ── Merge embedded historical data with live DB data ── */
function mergeHistoricalData(embedded, live) {
  if (!live || (!live.daily_results.length && !live.monthly_results.length)) return embedded;
  if (!embedded) return {
    battery_spec: { capacity_kwh: 33.28, usable_kwh: 32, cost: 10700, rebate: 1500, net_cost: 9200 },
    ...live,
    annual_no_sharer: { cost_no_battery: 0, cost_with_battery: 0, savings: 0, payback_years: 0 },
    annual_with_sharer: { cost_no_battery: 0, cost_with_battery: 0, savings: 0, payback_years: 0 },
    daily_charging: { total_days: 0, days_full: 0, pct_days_full: 0 }
  };

  // Merge daily_results — deduplicate by date, live wins on conflict
  const dailyMap = new Map();
  (embedded.daily_results || []).forEach(d => dailyMap.set(d.date, d));
  (live.daily_results || []).forEach(d => dailyMap.set(d.date, d));
  const mergedDaily = Array.from(dailyMap.values()).sort((a, b) => a.date.localeCompare(b.date));

  // Merge monthly_results — deduplicate by month, live wins on conflict
  const monthlyMap = new Map();
  (embedded.monthly_results || []).forEach(m => monthlyMap.set(m.month, m));
  (live.monthly_results || []).forEach(m => monthlyMap.set(m.month, m));
  const mergedMonthly = Array.from(monthlyMap.values()).sort((a, b) => a.month.localeCompare(b.month));

  // Recompute annual summaries from merged monthly data
  const totalCostNoBattery = mergedMonthly.reduce((s, m) => s + (m.cost_no_battery || 0), 0);
  const totalCostWithBattery = mergedMonthly.reduce((s, m) => s + (m.cost_with_battery || 0), 0);
  const totalSavings = totalCostNoBattery - totalCostWithBattery;
  const monthCount = mergedMonthly.length;
  const annualFactor = monthCount > 0 ? 12 / monthCount : 1;
  const annualSavings = totalSavings * annualFactor;
  const netCost = embedded.battery_spec?.net_cost || 9200;
  const paybackYears = annualSavings > 0 ? netCost / annualSavings : 99;

  const annual = {
    cost_no_battery: Math.round(totalCostNoBattery * annualFactor * 100) / 100,
    cost_with_battery: Math.round(totalCostWithBattery * annualFactor * 100) / 100,
    savings: Math.round(annualSavings * 100) / 100,
    payback_years: Math.round(paybackYears * 100) / 100
  };

  // Recompute daily_charging from merged daily data
  const daysFull = mergedDaily.filter(d => (d.battery_filled_pct || 0) >= 95).length;
  const fullDays = mergedDaily.filter(d => d.time_to_full);
  let avgTimeToFull = embedded.daily_charging?.avg_time_to_full || null;
  if (fullDays.length > 0) {
    const totalMinutes = fullDays.reduce((s, d) => {
      const [h, m] = d.time_to_full.split(':').map(Number);
      return s + h * 60 + m;
    }, 0);
    const avgMin = totalMinutes / fullDays.length;
    avgTimeToFull = `${Math.floor(avgMin / 60)}:${Math.floor(avgMin % 60).toString().padStart(2, '0')}`;
  }

  // Merge hourly_soc averages for daily_charging
  const hourlySocSums = {};
  const hourlySocCounts = {};
  mergedDaily.forEach(d => {
    if (!d.hourly_soc) return;
    Object.entries(d.hourly_soc).forEach(([h, val]) => {
      hourlySocSums[h] = (hourlySocSums[h] || 0) + val;
      hourlySocCounts[h] = (hourlySocCounts[h] || 0) + 1;
    });
  });
  const avgHourlySoc = {};
  Object.keys(hourlySocSums).sort((a, b) => Number(a) - Number(b)).forEach(h => {
    avgHourlySoc[h] = Math.round((hourlySocSums[h] / hourlySocCounts[h]) * 100) / 100;
  });

  return {
    battery_spec: embedded.battery_spec,
    annual_no_sharer: annual,
    annual_with_sharer: annual,
    monthly_results: mergedMonthly,
    daily_results: mergedDaily,
    daily_charging: {
      total_days: mergedDaily.length,
      days_full: daysFull,
      pct_days_full: mergedDaily.length > 0 ? Math.round((daysFull / mergedDaily.length) * 1000) / 10 : 0,
      avg_time_to_full: avgTimeToFull,
      earliest_full: embedded.daily_charging?.earliest_full || null,
      latest_full: embedded.daily_charging?.latest_full || null,
      hourly_soc: avgHourlySoc,
      seasons: embedded.daily_charging?.seasons || {}
    }
  };
}

/* ── Fresh Battery Baseline — models 100% capacity from day 1 ── */
/* Daily results have: date, total_solar_kwh, max_battery_soc_kwh, battery_filled_pct, time_to_full */
/* We estimate daily savings from battery fill % and solar, since daily_saving isn't in the data */
function computeIdealBaseline(dailyResults, usableCapacity, monthlyData) {
  if (!dailyResults || dailyResults.length === 0) return null;
  // Estimate avg daily saving from monthly totals
  let avgDailySaving = 3.5; // fallback $3.50/day
  if (monthlyData && monthlyData.length > 0) {
    const totalMonthlySavings = monthlyData.reduce((s, m) => s + (m.savings || 0), 0);
    const totalDays = monthlyData.length * 30; // approx
    avgDailySaving = totalMonthlySavings / totalDays;
  }
  // For each day, estimate savings proportional to battery fill
  // Full days = max savings, partial days = proportional
  const idealData = [];
  let cumActual = 0;
  let cumIdeal = 0;
  dailyResults.forEach((day, i) => {
    const filledPct = Math.min((day.battery_filled_pct || 0) / 100, 1.0);
    const solarKwh = day.total_solar_kwh || 0;
    // Actual savings scaled by how full the battery got
    const actualSaving = avgDailySaving * filledPct * (solarKwh > 5 ? 1.0 : 0.5);
    // Ideal savings: assume battery always reaches 100% if solar > threshold
    const idealFill = solarKwh >= usableCapacity * 0.8 ? 1.0 : Math.min(solarKwh / (usableCapacity * 0.8), 1.0);
    const idealSaving = avgDailySaving * idealFill * (solarKwh > 2 ? 1.0 : 0.3);
    cumActual += actualSaving;
    cumIdeal += idealSaving;
    idealData.push({
      date: day.date,
      dayIndex: i + 1,
      actualSaving: Math.round(actualSaving * 100) / 100,
      idealSaving: Math.round(idealSaving * 100) / 100,
      cumActual: Math.round(cumActual * 100) / 100,
      cumIdeal: Math.round(cumIdeal * 100) / 100,
      delta: Math.round((cumIdeal - cumActual) * 100) / 100,
    });
  });
  return {
    data: idealData,
    totalActual: Math.round(cumActual * 100) / 100,
    totalIdeal: Math.round(cumIdeal * 100) / 100,
    moneyLeftOnTable: Math.round((cumIdeal - cumActual) * 100) / 100,
  };
}

/* ── Lifetime Cost Comparison Data (4 scenarios over N years) ── */
function generateLifetimeCostData(annualBillNoBattery, annualSavingsBase, netCost, escalation, financeRate, financeTerm, years) {
  const data = [];
  let cumNoBattery = 0;
  let cumUpfront = netCost; // upfront starts with initial cost paid
  let cumFinanced = 0;
  let cumAccelerated = 0;
  const monthlyPmt = calcPmt(netCost, financeRate, financeTerm);
  // For accelerated: estimate monthly savings from year 1 data
  const avgMonthlySavings = annualSavingsBase / 12;
  const accelResult = generateAcceleratedSchedule(netCost, financeRate, financeTerm, avgMonthlySavings);
  const accelMonths = accelResult.summary ? accelResult.summary.acceleratedMonths : financeTerm * 12;
  for (let yr = 1; yr <= years; yr++) {
    const esc = Math.pow(1 + escalation / 100, yr);
    const yearBillNoBatt = annualBillNoBattery * esc;
    const yearSavings = annualSavingsBase * esc;
    const yearBillWithBatt = yearBillNoBatt - yearSavings;
    cumNoBattery += yearBillNoBatt;
    // Upfront: just energy costs (already paid the battery)
    cumUpfront += yearBillWithBatt;
    // Financed: energy + monthly payments during loan term
    const finPayments = yr <= financeTerm ? monthlyPmt * 12 : 0;
    cumFinanced += yearBillWithBatt + finPayments;
    // Accelerated: energy + (base payment + savings) during shortened term
    const accelYrs = Math.ceil(accelMonths / 12);
    if (yr <= accelYrs) {
      // During accelerated repayment: energy savings redirected to loan, so total outflow = full bill + payments
      cumAccelerated += yearBillNoBatt + (monthlyPmt * 12);
    } else {
      // After payoff: same as upfront (just energy with battery savings)
      cumAccelerated += yearBillWithBatt;
    }
    data.push({
      year: yr,
      label: `Year ${yr}`,
      'No Battery': Math.round(cumNoBattery),
      'Battery (Upfront)': Math.round(cumUpfront),
      'Battery (Financed)': Math.round(cumFinanced),
      'Battery (Accelerated)': Math.round(cumAccelerated),
    });
  }
  return data;
}

/* ── Styles ── */
const S = {
  page: { background: "linear-gradient(145deg,#0a0f1a 0%,#111827 50%,#0d1321 100%)", color: "#e2e8f0", minHeight: "100vh", fontFamily: "'Segoe UI',system-ui,sans-serif" },
  hdr: { background: "linear-gradient(90deg,rgba(245,158,11,0.12),rgba(16,185,129,0.08))", borderBottom: "1px solid #1e293b", padding: "20px clamp(12px, 2vw, 24px) 16px" },
  h1: { fontSize: "24px", fontWeight: 700, margin: "0 0 2px", background: "linear-gradient(90deg,#fbbf24,#34d399)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" },
  sub: { fontSize: "13px", color: "#64748b", margin: 0 },
  tabs: { display: "flex", borderBottom: "1px solid #1e293b", background: "#0c1222", overflowX: "auto" },
  tab: a => ({ flex: "1 0 auto", padding: "12px 14px", border: "none", cursor: "pointer", fontSize: "13px", fontWeight: a ? 600 : 400, color: a ? "#fbbf24" : "#64748b", background: a ? "rgba(245,158,11,0.06)" : "transparent", borderBottom: a ? "2px solid #fbbf24" : "2px solid transparent", whiteSpace: "nowrap" }),
  body: { padding: "20px clamp(12px, 2vw, 24px) 40px" },
  card: { background: "rgba(22,33,52,0.8)", border: "1px solid #1e293b", borderRadius: "10px", padding: "16px", marginBottom: "14px" },
  cT: { fontSize: "13px", fontWeight: 600, color: "#fbbf24", marginBottom: "12px", textTransform: "uppercase", letterSpacing: "0.5px" },
  lbl: { fontSize: "12px", color: "#64748b", marginBottom: "3px", display: "block" },
  inp: { width: "100%", padding: "8px 10px", background: "#0f172a", border: "1px solid #334155", borderRadius: "6px", color: "#e2e8f0", fontSize: "13px", outline: "none", boxSizing: "border-box" },
  inpSm: { width: "100%", padding: "8px 10px", background: "#0f172a", border: "1px solid #283548", borderRadius: "5px", color: "#e2e8f0", fontSize: "12px", outline: "none", textAlign: "right", boxSizing: "border-box" },
  btn: p => ({ padding: "8px 18px", border: "none", borderRadius: "6px", cursor: "pointer", fontSize: "12px", fontWeight: 600, color: p ? "#0f172a" : "#94a3b8", background: p ? "linear-gradient(135deg,#fbbf24,#f59e0b)" : "rgba(51,65,85,0.5)", whiteSpace: "nowrap" }),
  btnSm: (p, c) => ({ padding: "5px 10px", border: `1px solid ${p ? (c || "#fbbf24") : "#334155"}`, borderRadius: "5px", cursor: "pointer", fontSize: "11px", fontWeight: p ? 600 : 400, color: p ? (c || "#fbbf24") : "#64748b", background: p ? (c || "#fbbf24") + "15" : "transparent" }),
  tgl: a => ({ padding: "7px 14px", border: `1px solid ${a ? "#fbbf24" : "#334155"}`, borderRadius: "5px", cursor: "pointer", fontSize: "12px", fontWeight: a ? 600 : 400, color: a ? "#fbbf24" : "#64748b", background: a ? "rgba(245,158,11,0.1)" : "transparent" }),
  th: { padding: "10px 10px", textAlign: "right", color: "#64748b", fontWeight: 600, borderBottom: "1px solid #1e293b", fontSize: "11px", textTransform: "uppercase", letterSpacing: "0.3px" },
  td: { padding: "7px 10px", borderBottom: "1px solid #141e30" },
  stat: c => ({ background: "rgba(22,33,52,0.8)", border: `1px solid ${c}30`, borderRadius: "10px", padding: "14px 16px", flex: "1 1 130px", minWidth: "130px" }),
  sL: { fontSize: "11px", color: "#64748b", marginBottom: "3px", textTransform: "uppercase", letterSpacing: "0.4px" },
  sV: c => ({ fontSize: "22px", fontWeight: 700, color: c, margin: 0, lineHeight: 1.2 }),
  sS: { fontSize: "11px", color: "#475569", marginTop: "2px" },
  badge: c => ({ display: "inline-block", padding: "2px 7px", borderRadius: "4px", fontSize: "11px", fontWeight: 600, color: c, background: c + "15" }),
  slider: { width: "100%", accentColor: "#f59e0b", cursor: "pointer" },
  rateCard: (active) => ({ background: active ? "rgba(245,158,11,0.06)" : "rgba(15,23,42,0.4)", border: `1px solid ${active ? "#fbbf2440" : "#1e293b"}`, borderRadius: "8px", padding: "14px", marginBottom: "10px" }),
  dot: c => ({ width: 8, height: 8, borderRadius: "50%", background: c, display: "inline-block", marginRight: 6, flexShrink: 0 }),
};

const RATE_COLORS = ["#fbbf24", "#38bdf8", "#a78bfa", "#f87171", "#34d399", "#fb923c"];

const TT = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null;
  return (
    <div style={{ background: "#1e293b", border: "1px solid #334155", borderRadius: "8px", padding: "10px 14px", fontSize: "12px" }}>
      <div style={{ fontWeight: 600, marginBottom: 6, color: "#e2e8f0" }}>{label}</div>
      {payload.map((p, i) => <div key={i} style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
        <div style={{ width: 8, height: 8, borderRadius: 2, background: p.color, flexShrink: 0 }} />
        <span style={{ color: "#94a3b8" }}>{p.name}:</span>
        <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{fmt(p.value)}</span>
      </div>)}
    </div>
  );
};

/* ── LocalStorage persistence ── */
const STORAGE_KEY = "batteryROI_v2";
const loadSaved = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; } };
const saved = loadSaved() || {
  rateSets: [
    { id: 1, from: "2024-10-01", label: "Rate period 1", sponge: 0.2349, peak: 0.4920, offPk: 0.3376, feedIn: 0.055, supply: 1.0979, disc: 9, gst: 10 },
    { id: 2, from: "2025-07-01", label: "Rate period 2", sponge: 0.2701, peak: 0.5658, offPk: 0.3882, feedIn: 0.055, supply: 1.2626, disc: 9, gst: 10 },
  ],
  entries: [
    { id: 101, billFrom: "2024-10-10", days: "31", sponge: "6.77",  peak: "194.67", offPk: "55.93",  feedIn: "601.14", month: 9,  year: 2024 },
    { id: 102, billFrom: "2024-11-10", days: "30", sponge: "15.61", peak: "239.23", offPk: "44.44",  feedIn: "585.95", month: 10, year: 2024 },
    { id: 103, billFrom: "2024-12-10", days: "31", sponge: "20.08", peak: "276.29", offPk: "57.89",  feedIn: "595.11", month: 11, year: 2024 },
    { id: 104, billFrom: "2025-01-10", days: "31", sponge: "9.34",  peak: "368.69", offPk: "57.70",  feedIn: "455.95", month: 0,  year: 2025 },
    { id: 105, billFrom: "2025-02-10", days: "28", sponge: "15.72", peak: "319.99", offPk: "45.69",  feedIn: "385.60", month: 1,  year: 2025 },
    { id: 106, billFrom: "2025-03-10", days: "31", sponge: "16.04", peak: "329.14", offPk: "63.56",  feedIn: "389.52", month: 2,  year: 2025 },
    { id: 107, billFrom: "2025-04-10", days: "30", sponge: "22.34", peak: "301.30", offPk: "82.25",  feedIn: "245.71", month: 3,  year: 2025 },
    { id: 108, billFrom: "2025-05-10", days: "31", sponge: "37.88", peak: "564.18", offPk: "236.40", feedIn: "204.65", month: 4,  year: 2025 },
    { id: 109, billFrom: "2025-06-10", days: "21", sponge: "13.83", peak: "431.13", offPk: "171.43", feedIn: "161.51", month: 5,  year: 2025 },
    { id: 110, billFrom: "2025-06-30", days: "9",  sponge: "7.54",  peak: "191.69", offPk: "79.21",  feedIn: "0",      month: 5,  year: 2025 },
    { id: 111, billFrom: "2025-07-10", days: "31", sponge: "28.75", peak: "657.57", offPk: "269.27", feedIn: "218.55", month: 6,  year: 2025 },
    { id: 112, billFrom: "2025-08-10", days: "31", sponge: "18.20", peak: "529.54", offPk: "241.35", feedIn: "314.35", month: 7,  year: 2025 },
    { id: 113, billFrom: "2025-09-10", days: "30", sponge: "5.30",  peak: "375.96", offPk: "182.94", feedIn: "476.62", month: 8,  year: 2025 },
    { id: 114, billFrom: "2025-10-10", days: "31", sponge: "12.86", peak: "315.36", offPk: "137.03", feedIn: "486.26", month: 9,  year: 2025 },
    { id: 115, billFrom: "2025-11-10", days: "30", sponge: "10.11", peak: "329.87", offPk: "133.32", feedIn: "518.06", month: 10, year: 2025 },
    { id: 116, billFrom: "2025-12-10", days: "31", sponge: "7.12",  peak: "475.09", offPk: "132.98", feedIn: "411.76", month: 11, year: 2025 },
  ],
  cfg: {
    batteryCost: 25282, repsRebate: 9782,
    forecastYears: 10, escalation: 4,
    payType: "finance", financeTerm: 6, financeRate: 6.99,
    useAmber: true, amberFitAvg: 0.12, amberImportDisc: 0.25,
    amberSpikeMult: 1.0, amberFee: 25, scenario: 1.0,
  },
};


/* ══════════════════════════════════════════════════════════════
   Battery ROI Calculator — Tab 1: Finance Calculator
   ══════════════════════════════════════════════════════════════ */

/* ═══════════════════════════════════════════════════════════════════════
   FINANCE CALCULATOR - Flexible Lender Comparison
   ═══════════════════════════════════════════════════════════════════════ */

function calculateEffectiveAPR(principal, termYears, interestRate, feeAmount, feeFrequency, establishmentFee) {
  // Convert fee frequency to annual payments
  const frequencyMap = {
    'weekly': 52,
    'fortnightly': 26,
    'monthly': 12,
    'quarterly': 4,
    'annually': 1
  };

  const paymentsPerYear = frequencyMap[feeFrequency] || 12;
  const totalPayments = termYears * paymentsPerYear;

  // Calculate payment per period
  let paymentPerPeriod;

  if (interestRate === 0 && feeAmount > 0) {
    // Fee-based loan (like Brighte): principal/periods + flat fee
    paymentPerPeriod = (principal / totalPayments) + feeAmount;
  } else if (interestRate > 0 && feeAmount === 0) {
    // Traditional interest-only loan: calculate using amortization formula
    const r = (interestRate / 100) / paymentsPerYear;
    paymentPerPeriod = principal * (r * Math.pow(1 + r, totalPayments)) / (Math.pow(1 + r, totalPayments) - 1);
  } else if (interestRate > 0 && feeAmount > 0) {
    // Hybrid: interest calculation + flat fee
    const r = (interestRate / 100) / paymentsPerYear;
    const interestPayment = principal * (r * Math.pow(1 + r, totalPayments)) / (Math.pow(1 + r, totalPayments) - 1);
    paymentPerPeriod = interestPayment + feeAmount;
  } else {
    // No interest, no fees: just principal repayment
    return 0;
  }

  // Use Newton's method to find the effective rate (IRR)
  let r = 0.001 / paymentsPerYear; // initial guess

  for (let iter = 0; iter < 200; iter++) {
    let npv = 0;
    let dnpv = 0;

    for (let i = 1; i <= totalPayments; i++) {
      const payment = i === 1 ? paymentPerPeriod + establishmentFee : paymentPerPeriod;
      const discount = Math.pow(1 + r, i);
      npv += payment / discount;
      dnpv -= i * payment / (discount * (1 + r));
    }

    npv -= principal;
    const newR = r - npv / dnpv;

    if (Math.abs(newR - r) < 1e-12) {
      r = newR;
      break;
    }
    r = newR;
  }

  const annualRate = Math.pow(1 + r, paymentsPerYear) - 1;
  return annualRate * 100;
}

function calculateTotalCost(principal, termYears, interestRate, feeAmount, feeFrequency, establishmentFee) {
  const frequencyMap = { 'weekly': 52, 'fortnightly': 26, 'monthly': 12, 'quarterly': 4, 'annually': 1 };
  const paymentsPerYear = frequencyMap[feeFrequency] || 12;
  const totalPayments = termYears * paymentsPerYear;

  let paymentPerPeriod;
  let totalInterest = 0;

  if (interestRate === 0 && feeAmount > 0) {
    paymentPerPeriod = (principal / totalPayments) + feeAmount;
    totalInterest = 0;
  } else if (interestRate > 0 && feeAmount === 0) {
    const r = (interestRate / 100) / paymentsPerYear;
    paymentPerPeriod = principal * (r * Math.pow(1 + r, totalPayments)) / (Math.pow(1 + r, totalPayments) - 1);
    totalInterest = (paymentPerPeriod * totalPayments) - principal;
  } else if (interestRate > 0 && feeAmount > 0) {
    const r = (interestRate / 100) / paymentsPerYear;
    const interestPayment = principal * (r * Math.pow(1 + r, totalPayments)) / (Math.pow(1 + r, totalPayments) - 1);
    paymentPerPeriod = interestPayment + feeAmount;
    totalInterest = (interestPayment * totalPayments) - principal;
  } else {
    paymentPerPeriod = principal / totalPayments;
    totalInterest = 0;
  }

  const totalFees = (feeAmount * totalPayments) + establishmentFee;
  const totalCost = totalInterest + totalFees;

  return {
    paymentPerPeriod: paymentPerPeriod,
    totalPayments: totalPayments,
    totalInterest: totalInterest,
    totalFees: totalFees,
    totalCost: totalCost,
    totalRepaid: principal + totalCost
  };
}

function calculateOffsetCost(principal, termYears, mortgageRate) {
  // Pulling from offset means you lose the interest saved
  // With linear repayment, average balance = principal / 2
  const avgBalance = principal / 2;
  const totalOpportunityCost = avgBalance * (mortgageRate / 100) * termYears;
  return totalOpportunityCost;
}

function FinanceCalculator({ batteryNetCost, cfg, financeOverride, onSelectScenario, selectedScenarioName }) {
  const [numScenarios, setNumScenarios] = useState(2);
  const [mortgageRate, setMortgageRate] = useState(6.0);
  const [compareOffset, setCompareOffset] = useState(true);

  // Scenario configurations
  const [scenarios, setScenarios] = useState([
    {
      name: 'Brighte (Actual)',
      principal: batteryNetCost,
      termYears: 6,
      interestRate: 6.99,
      feeAmount: 0,
      feeFrequency: 'monthly',
      establishmentFee: 0,
      enabled: true
    },
    {
      name: 'Bank Loan',
      principal: batteryNetCost,
      termYears: 5,
      interestRate: 7.5,
      feeAmount: 0,
      feeFrequency: 'monthly',
      establishmentFee: 250,
      enabled: true
    },
    {
      name: 'Green Loan',
      principal: batteryNetCost,
      termYears: 7,
      interestRate: 5.5,
      feeAmount: 0,
      feeFrequency: 'monthly',
      establishmentFee: 0,
      enabled: false
    }
  ]);

  const updateScenario = (index, field, value) => {
    const newScenarios = [...scenarios];
    newScenarios[index] = { ...newScenarios[index], [field]: value };
    setScenarios(newScenarios);
  };

  // Calculate results for all scenarios
  const results = useMemo(() => {
    return scenarios.map(s => {
      if (!s.enabled) return null;

      const effectiveAPR = calculateEffectiveAPR(
        s.principal, s.termYears, s.interestRate,
        s.feeAmount, s.feeFrequency, s.establishmentFee
      );

      const costs = calculateTotalCost(
        s.principal, s.termYears, s.interestRate,
        s.feeAmount, s.feeFrequency, s.establishmentFee
      );

      return {
        ...s,
        effectiveAPR,
        ...costs
      };
    }).filter(r => r !== null);
  }, [scenarios]);

  const offsetCost = useMemo(() => {
    if (!compareOffset || results.length === 0) return null;
    return calculateOffsetCost(batteryNetCost, results[0].termYears, mortgageRate);
  }, [compareOffset, batteryNetCost, mortgageRate, results]);

  // Find best option
  const bestOption = useMemo(() => {
    if (results.length === 0) return null;

    const allOptions = [...results];
    if (offsetCost !== null) {
      allOptions.push({
        name: 'Mortgage Offset',
        totalCost: offsetCost,
        effectiveAPR: mortgageRate,
        isOffset: true
      });
    }

    return allOptions.reduce((best, current) =>
      current.totalCost < best.totalCost ? current : best
    );
  }, [results, offsetCost, mortgageRate]);

  const frequencyLabels = {
    'weekly': 'Week',
    'fortnightly': 'Fortnight',
    'monthly': 'Month',
    'quarterly': 'Quarter',
    'annually': 'Year'
  };

  return (
    <div style={{ fontFamily: 'system-ui, -apple-system, sans-serif', color: '#e2e8f0', padding: '0 0 60px 0' }}>
      <div style={{ background: 'linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%)', padding: '32px 32px 40px', borderRadius: '0 0 20px 20px', marginBottom: 32 }}>
        <h2 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8, color: '#fff' }}>
          💰 Finance Calculator
        </h2>
        <p style={{ fontSize: 14, color: '#cbd5e1', marginBottom: 0 }}>
          Compare financing options and find the best way to fund your battery system
        </p>
      </div>

      {/* Global Controls */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))', gap: 20, marginBottom: 32 }}>
        <div style={{ background: '#1e293b', padding: 20, borderRadius: 12, border: '1px solid #334155' }}>
          <label style={{ fontSize: 12, fontWeight: 600, color: '#94a3b8', textTransform: 'uppercase', letterSpacing: 0.5 }}>
            System Cost
          </label>
          <div style={{ fontSize: 24, fontWeight: 700, color: '#f59e0b', marginTop: 8 }}>
            {fmt(batteryNetCost)}
          </div>
          <div style={{ fontSize: 11, color: '#64748b', marginTop: 4 }}>
            After rebate
          </div>
        </div>

        <div style={{ background: '#1e293b', padding: 20, borderRadius: 12, border: '1px solid #334155' }}>
          <label style={{ fontSize: 12, fontWeight: 600, color: '#94a3b8', textTransform: 'uppercase', letterSpacing: 0.5 }}>
            Your Mortgage Rate
          </label>
          <div style={{ fontSize: 24, fontWeight: 700, color: '#10b981', marginTop: 8 }}>
            {mortgageRate.toFixed(1)}%
          </div>
          <input
            type="range"
            min={3}
            max={10}
            step={0.1}
            value={mortgageRate}
            onChange={e => setMortgageRate(Number(e.target.value))}
            style={{ width: '100%', marginTop: 8 }}
          />
          <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: '#64748b', marginTop: 4 }}>
            <span>3.0%</span><span>10.0%</span>
          </div>
        </div>

        <div style={{ background: '#1e293b', padding: 20, borderRadius: 12, border: '1px solid #334155' }}>
          <label style={{ fontSize: 12, fontWeight: 600, color: '#94a3b8', textTransform: 'uppercase', letterSpacing: 0.5 }}>
            Compare Options
          </label>
          <div style={{ marginTop: 12 }}>
            <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: 13 }}>
              <input
                type="checkbox"
                checked={compareOffset}
                onChange={e => setCompareOffset(e.target.checked)}
                style={{ marginRight: 8, width: 16, height: 16, accentColor: '#10b981' }}
              />
              Include Mortgage Offset
            </label>
          </div>
          <div style={{ fontSize: 11, color: '#64748b', marginTop: 8 }}>
            Compare against pulling from offset account
          </div>
        </div>
      </div>

      {/* Scenarios */}
      <div style={{ marginBottom: 32 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <h3 style={{ fontSize: 18, fontWeight: 600 }}>Financing Scenarios</h3>
          <div style={{ display: 'flex', gap: 8 }}>
            {[1, 2, 3].map(n => (
              <button
                key={n}
                onClick={() => {
                  setNumScenarios(n);
                  const newScenarios = [...scenarios];
                  newScenarios.forEach((s, i) => s.enabled = i < n);
                  setScenarios(newScenarios);
                }}
                style={{
                  padding: '6px 14px',
                  background: numScenarios === n ? '#7c3aed' : '#334155',
                  border: 'none',
                  borderRadius: 6,
                  color: '#fff',
                  fontSize: 12,
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {n} Option{n > 1 ? 's' : ''}
              </button>
            ))}
          </div>
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: numScenarios === 1 ? '1fr' : `repeat(auto-fit, minmax(300px, 1fr))`, gap: 20 }}>
          {scenarios.slice(0, numScenarios).map((scenario, idx) => (
            <div key={idx} style={{ background: '#1e293b', borderRadius: 12, padding: 20, border: '2px solid #334155' }}>
              <input
                type="text"
                value={scenario.name}
                onChange={e => updateScenario(idx, 'name', e.target.value)}
                style={{
                  width: '100%',
                  background: '#0f172a',
                  border: '1px solid #475569',
                  borderRadius: 6,
                  padding: '8px 12px',
                  color: '#f1f5f9',
                  fontSize: 16,
                  fontWeight: 600,
                  marginBottom: 16
                }}
                placeholder="Lender Name"
              />

              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  LOAN AMOUNT
                </label>
                <input
                  type="number"
                  value={scenario.principal}
                  onChange={e => updateScenario(idx, 'principal', Number(e.target.value))}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                />
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  TERM (YEARS)
                </label>
                <input
                  type="number"
                  value={scenario.termYears}
                  onChange={e => updateScenario(idx, 'termYears', Number(e.target.value))}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                />
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  INTEREST RATE (%)
                </label>
                <input
                  type="number"
                  step="0.1"
                  value={scenario.interestRate}
                  onChange={e => updateScenario(idx, 'interestRate', Number(e.target.value))}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                />
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  PERIODIC FEE ($)
                </label>
                <input
                  type="number"
                  step="0.1"
                  value={scenario.feeAmount}
                  onChange={e => updateScenario(idx, 'feeAmount', Number(e.target.value))}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                />
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  FEE FREQUENCY
                </label>
                <select
                  value={scenario.feeFrequency}
                  onChange={e => updateScenario(idx, 'feeFrequency', e.target.value)}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                >
                  <option value="weekly">Weekly</option>
                  <option value="fortnightly">Fortnightly</option>
                  <option value="monthly">Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="annually">Annually</option>
                </select>
              </div>

              <div style={{ marginBottom: 0 }}>
                <label style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, display: 'block', marginBottom: 6 }}>
                  ESTABLISHMENT FEE ($)
                </label>
                <input
                  type="number"
                  value={scenario.establishmentFee}
                  onChange={e => updateScenario(idx, 'establishmentFee', Number(e.target.value))}
                  style={{
                    width: '100%',
                    background: '#0f172a',
                    border: '1px solid #475569',
                    borderRadius: 6,
                    padding: '8px 12px',
                    color: '#f1f5f9',
                    fontSize: 14
                  }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Results Comparison */}
      {results.length > 0 && (
        <div>
          <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Comparison Results</h3>

          {/* Winner Banner */}
          {bestOption && (
            <div style={{
              background: bestOption.isOffset ? 'linear-gradient(135deg, #065f46 0%, #10b981 100%)' : 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)',
              borderRadius: 12,
              padding: 20,
              marginBottom: 24,
              textAlign: 'center'
            }}>
              <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', opacity: 0.9, marginBottom: 4 }}>
                🏆 BEST OPTION
              </div>
              <div style={{ fontSize: 28, fontWeight: 700, color: '#fff' }}>
                {bestOption.name}
              </div>
              <div style={{ fontSize: 16, color: '#fff', opacity: 0.9, marginTop: 4 }}>
                Total Cost: {fmt(bestOption.totalCost)}
                {!bestOption.isOffset && ` • ${fmt2(bestOption.paymentPerPeriod)}/${frequencyLabels[bestOption.feeFrequency].toLowerCase()}`}
              </div>
            </div>
          )}

          {/* Detailed Comparison Table */}
          <div style={{ background: '#1e293b', borderRadius: 12, padding: 24, overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 13 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid #475569' }}>
                  <th style={{ textAlign: 'left', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Option</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Effective APR</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Payment</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Total Interest</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Total Fees</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Total Cost</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: '#94a3b8', fontWeight: 600 }}>Total Repaid</th>
                  {onSelectScenario && <th style={{ textAlign: 'center', padding: '12px 8px', color: '#f59e0b', fontWeight: 600 }}>Use for ROI</th>}
                </tr>
              </thead>
              <tbody>
                {results.map((r, idx) => {
                  const isBest = bestOption && !bestOption.isOffset && r.name === bestOption.name;
                  return (
                    <tr
                      key={idx}
                      style={{
                        borderBottom: '1px solid #334155',
                        background: isBest ? 'rgba(124, 58, 237, 0.1)' : 'transparent'
                      }}
                    >
                      <td style={{ padding: '12px 8px', fontWeight: isBest ? 600 : 400 }}>
                        {isBest && '🏆 '}{r.name}
                      </td>
                      <td style={{
                        padding: '12px 8px',
                        textAlign: 'right',
                        color: r.effectiveAPR > mortgageRate ? '#ef4444' : '#10b981'
                      }}>
                        {r.effectiveAPR.toFixed(2)}%
                      </td>
                      <td style={{ padding: '12px 8px', textAlign: 'right' }}>
                        {fmt2(r.paymentPerPeriod)}/{frequencyLabels[r.feeFrequency].toLowerCase()}
                      </td>
                      <td style={{ padding: '12px 8px', textAlign: 'right', color: '#94a3b8' }}>
                        {fmt(r.totalInterest)}
                      </td>
                      <td style={{ padding: '12px 8px', textAlign: 'right', color: '#94a3b8' }}>
                        {fmt(r.totalFees)}
                      </td>
                      <td style={{ padding: '12px 8px', textAlign: 'right', fontWeight: 600, color: '#f59e0b' }}>
                        {fmt(r.totalCost)}
                      </td>
                      <td style={{ padding: '12px 8px', textAlign: 'right' }}>
                        {fmt(r.totalRepaid)}
                      </td>
                      {onSelectScenario && <td style={{ padding: '12px 8px', textAlign: 'center' }}>
                        <button onClick={() => onSelectScenario({
                          name: r.name,
                          monthlyPayment: r.totalRepaid / (r.termYears * 12),
                          termYears: r.termYears,
                          effectiveAPR: r.effectiveAPR,
                          totalCost: r.totalCost
                        })} style={{
                          padding: '5px 12px', borderRadius: 6, fontSize: 11, fontWeight: 600, cursor: 'pointer',
                          background: selectedScenarioName === r.name ? '#f59e0b' : 'transparent',
                          color: selectedScenarioName === r.name ? '#0f172a' : '#f59e0b',
                          border: '1px solid #f59e0b'
                        }}>
                          {selectedScenarioName === r.name ? '✓ Selected' : 'Select'}
                        </button>
                      </td>}
                    </tr>
                  );
                })}

                {offsetCost !== null && (
                  <tr style={{
                    borderBottom: '1px solid #334155',
                    background: bestOption?.isOffset ? 'rgba(16, 185, 129, 0.1)' : 'transparent'
                  }}>
                    <td style={{ padding: '12px 8px', fontWeight: bestOption?.isOffset ? 600 : 400 }}>
                      {bestOption?.isOffset && '🏆 '}Mortgage Offset
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right', color: '#10b981' }}>
                      {mortgageRate.toFixed(2)}%
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right', color: '#64748b' }}>
                      N/A
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right', color: '#94a3b8' }}>
                      {fmt(offsetCost)}
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right', color: '#94a3b8' }}>
                      $0
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right', fontWeight: 600, color: '#f59e0b' }}>
                      {fmt(offsetCost)}
                    </td>
                    <td style={{ padding: '12px 8px', textAlign: 'right' }}>
                      {fmt(batteryNetCost + offsetCost)}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>

          {/* Key Insights */}
          <div style={{ marginTop: 24, background: '#0f172a', borderRadius: 12, padding: 20, border: '1px solid #334155' }}>
            <h4 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12, color: '#f59e0b' }}>💡 Key Insights</h4>
            <ul style={{ fontSize: 13, lineHeight: 1.8, color: '#cbd5e1', paddingLeft: 20 }}>
              <li>
                <span style={{ color: '#ef4444' }}>Red APR</span> = More expensive than your mortgage offset ({mortgageRate.toFixed(1)}%)
              </li>
              <li>
                <span style={{ color: '#10b981' }}>Green APR</span> = Cheaper than pulling from offset
              </li>
              <li>
                Fee-based loans (like Brighte) work better for larger amounts over longer terms
              </li>
              <li>
                Total Cost includes ALL interest and fees over the life of the loan
              </li>
              <li>
                Offset comparison assumes linear repayment and average balance opportunity cost
              </li>
            </ul>
          </div>

          {/* Amortisation Schedule & Interest Waterfall */}
          {results.length > 0 && (() => {
            // Prefer a scenario with interest > 0 for a meaningful waterfall chart
            const selectedResult = results.find(r => r.interestRate > 0) || results[0];
            const schedule = generateAmortSchedule(selectedResult.principal, selectedResult.interestRate, selectedResult.termYears);
            if (schedule.length === 0) return null;

            // Build chart data — sample every Nth month for readability
            const step = schedule.length > 60 ? 6 : schedule.length > 24 ? 3 : 1;
            const chartData = schedule.filter((_, i) => i % step === 0 || i === schedule.length - 1).map(s => ({
              month: s.month,
              label: `M${s.month}`,
              Principal: s.principal,
              Interest: s.interest,
              Balance: s.balance,
              'Cumulative Interest': s.cumInterest,
            }));

            return (
              <div style={{ marginTop: 24 }}>
                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>
                  Amortisation Schedule — {selectedResult.name}
                </h3>

                {/* Interest Waterfall Chart */}
                <div style={{ background: '#1e293b', borderRadius: 12, padding: 20, marginBottom: 20 }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#fbbf24', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 0.5 }}>
                    Payment Breakdown Over Time
                  </div>
                  <ResponsiveContainer width="100%" height={300}>
                    <AreaChart data={chartData}>
                      <defs>
                        <linearGradient id="amortPrincipal" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#34d399" stopOpacity={0.8}/>
                          <stop offset="95%" stopColor="#34d399" stopOpacity={0.1}/>
                        </linearGradient>
                        <linearGradient id="amortInterest" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#f87171" stopOpacity={0.8}/>
                          <stop offset="95%" stopColor="#f87171" stopOpacity={0.1}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                      <XAxis dataKey="label" tick={{ fill: '#64748b', fontSize: 10 }} />
                      <YAxis tick={{ fill: '#64748b', fontSize: 11 }} tickFormatter={v => `$${v}`} />
                      <Tooltip content={<TT />} />
                      <Legend wrapperStyle={{ fontSize: '11px' }} />
                      <Area type="monotone" dataKey="Interest" stackId="1" stroke="#f87171" fill="url(#amortInterest)" />
                      <Area type="monotone" dataKey="Principal" stackId="1" stroke="#34d399" fill="url(#amortPrincipal)" />
                    </AreaChart>
                  </ResponsiveContainer>
                  <div style={{ fontSize: 11, color: '#475569', textAlign: 'center', marginTop: 6 }}>
                    Green = principal portion, Red = interest portion of each payment
                  </div>
                </div>

                {/* Cumulative Interest & Balance Chart */}
                <div style={{ background: '#1e293b', borderRadius: 12, padding: 20, marginBottom: 20 }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#fbbf24', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 0.5 }}>
                    Remaining Balance & Cumulative Interest
                  </div>
                  <ResponsiveContainer width="100%" height={280}>
                    <LineChart data={chartData}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                      <XAxis dataKey="label" tick={{ fill: '#64748b', fontSize: 10 }} />
                      <YAxis tick={{ fill: '#64748b', fontSize: 11 }} tickFormatter={v => `$${Math.round(v).toLocaleString()}`} />
                      <Tooltip content={({ active, payload, label }) => {
                        if (!active || !payload?.length) return null;
                        return <div style={{ background: '#1e293b', border: '1px solid #334155', borderRadius: 8, padding: 10, fontSize: 12 }}>
                          <div style={{ fontWeight: 600, color: '#e2e8f0', marginBottom: 4 }}>{label}</div>
                          {payload.map((p, i) => <div key={i} style={{ color: p.color, marginBottom: 2 }}>{p.name}: {fmt(p.value)}</div>)}
                        </div>;
                      }} />
                      <Legend wrapperStyle={{ fontSize: '11px' }} />
                      <Line type="monotone" dataKey="Balance" stroke="#38bdf8" strokeWidth={2} dot={false} />
                      <Line type="monotone" dataKey="Cumulative Interest" stroke="#f87171" strokeWidth={2} dot={false} strokeDasharray="5 3" />
                    </LineChart>
                  </ResponsiveContainer>
                </div>

                {/* Monthly Table */}
                <div style={{ background: '#1e293b', borderRadius: 12, padding: 20, overflowX: 'auto' }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#fbbf24', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 0.5 }}>
                    Month-by-Month Schedule
                  </div>
                  <table style={{ width: '100%', borderCollapse: 'separate', borderSpacing: 0, fontSize: 12, minWidth: 500 }}>
                    <thead>
                      <tr>
                        <th style={{ padding: '8px', textAlign: 'left', color: '#94a3b8', fontWeight: 600, borderBottom: '1px solid #334155' }}>#</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: '#94a3b8', fontWeight: 600, borderBottom: '1px solid #334155' }}>Payment</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: '#34d399', fontWeight: 600, borderBottom: '1px solid #334155' }}>Principal</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: '#f87171', fontWeight: 600, borderBottom: '1px solid #334155' }}>Interest</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: '#38bdf8', fontWeight: 600, borderBottom: '1px solid #334155' }}>Balance</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: '#fbbf24', fontWeight: 600, borderBottom: '1px solid #334155' }}>Cum. Interest</th>
                      </tr>
                    </thead>
                    <tbody>
                      {schedule.map((s, i) => (
                        <tr key={i} style={{ background: i % 2 ? 'rgba(10,15,26,0.3)' : 'transparent' }}>
                          <td style={{ padding: '6px 8px', color: '#94a3b8', borderBottom: '1px solid #141e30' }}>{s.month}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: '#e2e8f0', borderBottom: '1px solid #141e30' }}>{fmt2(s.payment)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: '#34d399', borderBottom: '1px solid #141e30' }}>{fmt2(s.principal)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: '#f87171', borderBottom: '1px solid #141e30' }}>{fmt2(s.interest)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: '#38bdf8', borderBottom: '1px solid #141e30' }}>{fmt(s.balance)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', color: '#fbbf24', borderBottom: '1px solid #141e30' }}>{fmt(s.cumInterest)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })()}
        </div>
      )}
    </div>
  );
}


/* Tab 0: Setup — Tariff Rates, Bill Entries, System Config */

function SetupTab({ cfg, upC, rateSets, editingRate, setEditingRate, addRateSet, removeRateSet, updateRate, rateFields, entries, entryBills, draft, upD, editingId, saveDraft, editEntry, cancelEdit, removeEntry, autoFill, loadSample, clearAll, totalBill, totalDays, totalImport, totalExport, monthsCovered, showProviderImport, setShowProviderImport, providerImportText, setProviderImportText, providerImportStatus, setProviderImportStatus, setEntries, MO, MD, SEA, rateForEntry, netCost }) {
  return (<>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "14px", flexWrap: "wrap", gap: "8px" }}>
            <div>
              <div style={{ fontSize: "14px", fontWeight: 600, color: "#e2e8f0" }}>Tariff Rate Periods</div>
              <div style={{ fontSize: "12px", color: "#475569" }}>Add rate sets for when your retailer changes pricing. Each period applies from its start date.</div>
            </div>
            <button style={S.btn(true)} onClick={addRateSet}>+ Add Rate Period</button>
          </div>

          <div style={{ display: "flex", gap: "6px", marginBottom: "16px", flexWrap: "wrap" }}>
            {rateSets.map((rs, i) => (
              <button key={rs.id} onClick={() => setEditingRate(i)}
                style={{ ...S.btnSm(editingRate === i, RATE_COLORS[i % RATE_COLORS.length]), display: "flex", alignItems: "center", gap: "4px" }}>
                <span style={S.dot(RATE_COLORS[i % RATE_COLORS.length])} />
                {rs.label || `Period ${i + 1}`}
                <span style={{ color: "#475569", fontSize: "10px", marginLeft: "2px" }}>
                  {rs.from ? new Date(rs.from + "T00:00").toLocaleDateString("en-AU", { month: "short", year: "2-digit" }) : "—"}
                </span>
              </button>
            ))}
          </div>

          {rateSets[editingRate] && (() => {
            const rs = rateSets[editingRate];
            const idx = editingRate;
            return (
              <div style={S.rateCard(true)}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: "14px", flexWrap: "wrap", gap: "8px" }}>
                  <div style={{ display: "flex", gap: "10px", alignItems: "flex-end", flexWrap: "wrap" }}>
                    <div>
                      <label style={S.lbl}>Period Label</label>
                      <input type="text" value={rs.label} onChange={e => updateRate(idx, "label", e.target.value)}
                        style={{ ...S.inp, width: "200px" }} placeholder="e.g. AGL Plan Jul 2025" />
                    </div>
                    <div>
                      <label style={S.lbl}>Effective From</label>
                      <input type="date" value={rs.from} onChange={e => updateRate(idx, "from", e.target.value)}
                        style={{ ...S.inp, width: "160px" }} />
                    </div>
                  </div>
                  {rateSets.length > 1 && (
                    <button onClick={() => removeRateSet(idx)}
                      style={{ ...S.btnSm(false), color: "#f87171", borderColor: "#f8717130", marginTop: "14px" }}>
                      Remove
                    </button>
                  )}
                </div>

                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill,minmax(150px,1fr))", gap: "10px" }}>
                  {rateFields.map(({ k, l, c, u }) => (
                    <div key={k}>
                      <label style={{ ...S.lbl, color: c }}>{l} <span style={{ color: "#475569" }}>({u})</span></label>
                      <input type="number" step={k === "disc" ? 1 : 0.0001} value={rs[k]}
                        onChange={e => updateRate(idx, k, parseFloat(e.target.value) || 0)}
                        style={S.inp} />
                    </div>
                  ))}
                  <div>
                    <label style={{ ...S.lbl }}>GST <span style={{ color: "#475569" }}>(%)</span></label>
                    <input type="number" step={1} value={rs.gst}
                      onChange={e => updateRate(idx, "gst", parseFloat(e.target.value) || 0)}
                      style={S.inp} />
                  </div>
                </div>

                <div style={{ marginTop: "14px", padding: "10px 14px", background: "rgba(15,23,42,0.5)", borderRadius: "6px" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Rate Summary (ex-GST per unit)</div>
                  <div style={{ display: "flex", gap: "16px", flexWrap: "wrap", fontSize: "13px" }}>
                    <span><span style={{ color: "#38bdf8" }}>Sponge:</span> <span style={{ color: "#e2e8f0" }}>{(rs.sponge * 100).toFixed(2)}¢</span></span>
                    <span><span style={{ color: "#f87171" }}>Peak:</span> <span style={{ color: "#e2e8f0" }}>{(rs.peak * 100).toFixed(2)}¢</span></span>
                    <span><span style={{ color: "#a78bfa" }}>Off-Pk:</span> <span style={{ color: "#e2e8f0" }}>{(rs.offPk * 100).toFixed(2)}¢</span></span>
                    <span><span style={{ color: "#34d399" }}>FiT:</span> <span style={{ color: "#e2e8f0" }}>{(rs.feedIn * 100).toFixed(1)}¢</span></span>
                    <span><span style={{ color: "#fbbf24" }}>Supply:</span> <span style={{ color: "#e2e8f0" }}>${rs.supply.toFixed(4)}/day</span></span>
                    <span><span style={{ color: "#94a3b8" }}>Disc:</span> <span style={{ color: "#e2e8f0" }}>{rs.disc}%</span></span>
                  </div>
                </div>
              </div>
            );
          })()}

          {rateSets.length > 1 && (
            <div style={{ ...S.card, overflowX: "auto" }}>
              <div style={S.cT}>Rate Comparison</div>
              <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "12px" }}>
                <thead>
                  <tr>
                    <th style={{ ...S.th, textAlign: "left" }}>Period</th>
                    <th style={{ ...S.th, textAlign: "left" }}>From</th>
                    {rateFields.map(f => <th key={f.k} style={{ ...S.th, color: f.c }}>{f.l}</th>)}
                  </tr>
                </thead>
                <tbody>
                  {rateSets.map((rs, i) => (
                    <tr key={rs.id} style={{ background: i % 2 ? "rgba(10,15,26,0.3)" : "transparent" }}>
                      <td style={{ ...S.td, textAlign: "left", fontWeight: 500 }}>
                        <span style={S.dot(RATE_COLORS[i % RATE_COLORS.length])} />
                        {rs.label}
                      </td>
                      <td style={{ ...S.td, textAlign: "left", color: "#94a3b8" }}>
                        {rs.from ? new Date(rs.from + "T00:00").toLocaleDateString("en-AU", { day: "numeric", month: "short", year: "numeric" }) : "—"}
                      </td>
                      {rateFields.map(f => {
                        const prev = i > 0 ? rateSets[i - 1][f.k] : null;
                        const val = rs[f.k];
                        const changed = prev !== null && val !== prev;
                        const up = prev !== null && val > prev;
                        return (
                          <td key={f.k} style={{ ...S.td, textAlign: "right", color: changed ? (up ? "#f87171" : "#34d399") : "#e2e8f0" }}>
                            {f.k === "disc" ? `${val}%` : val.toFixed(4)}
                            {changed && <span style={{ fontSize: "9px", marginLeft: "3px" }}>{up ? "▲" : "▼"}</span>}
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* ─── Section: Monthly Usage ─── */}
          <div style={{ borderTop: "1px solid #1e293b", margin: "20px 0 14px", paddingTop: "14px" }}>
            <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "4px" }}>Monthly Usage</div>
            <div style={{ fontSize: "11px", color: "#475569", marginBottom: "10px" }}>Enter your electricity bills to build a usage profile</div>
          </div>

          {(() => {
          /* Draft live preview */
          const draftDate = draft.billFrom ? new Date(draft.billFrom + "T00:00") : null;
          const draftMi = draftDate ? draftDate.getMonth() : null;
          const draftYr = draftDate ? draftDate.getFullYear() : null;
          const draftDays = parseInt(draft.days) || (draftMi !== null ? MD[draftMi] : 30);
          const draftD = { days: draftDays, sponge: parseFloat(draft.sponge) || 0, peak: parseFloat(draft.peak) || 0, offPk: parseFloat(draft.offPk) || 0, feedIn: parseFloat(draft.feedIn) || 0 };
          const draftHas = draftD.peak > 0 || draftD.sponge > 0 || draftD.offPk > 0;
          const draftRate = draft.billFrom ? rateForEntry({ ...draft, month: draftMi }) : rateSets[0];
          const draftBill = (draftHas && draftRate) ? calcBill(draftD, draftRate) : null;

          return (<>
            {/* ── Entry Form ── */}
            <div style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "14px", flexWrap: "wrap", gap: "8px" }}>
                <div>
                  <div style={S.cT}>{editingId !== null ? "Edit Entry" : "Add Bill Entry"}</div>
                  {draftDate && <div style={{ fontSize: "13px", color: "#e2e8f0", marginTop: "-6px", marginBottom: "4px" }}>
                    {MO[draftMi]} {draftYr}
                    {editingId !== null && <span style={{ ...S.badge("#f59e0b"), marginLeft: "8px", fontSize: "10px" }}>EDITING</span>}
                  </div>}
                </div>
                <div style={{ display: "flex", gap: "6px" }}>
                  <button style={S.btn(false)} onClick={loadSample}>Load Sample</button>
                  {entries.length > 0 && <button style={S.btn(false)} onClick={autoFill}>Auto-fill Gaps</button>}
                  {entries.length > 0 && <button style={S.btn(false)} onClick={clearAll}>Clear All</button>}
                </div>
              </div>

              <div style={{ display: "flex", gap: "24px", flexWrap: "wrap" }}>
                {/* Left: inputs */}
                <div style={{ flex: "1 1 360px" }}>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px", marginBottom: "12px" }}>
                    <div>
                      <label style={S.lbl}>Bill start date</label>
                      <input type="date" value={draft.billFrom}
                        onChange={e => {
                          const v = e.target.value;
                          const d = v ? new Date(v + "T00:00") : null;
                          setDraft(p => ({ ...p, billFrom: v, days: p.days || (d ? MD[d.getMonth()].toString() : "") }));
                        }} style={S.inp} />
                    </div>
                    <div>
                      <label style={S.lbl}>Days in billing period</label>
                      <input type="number" value={draft.days}
                        onChange={e => upD("days", e.target.value)}
                        placeholder={draftMi !== null ? MD[draftMi].toString() : "30"}
                        style={S.inp} />
                    </div>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px" }}>
                    <div>
                      <label style={{ ...S.lbl, color: "#38bdf8" }}>Solar Sponge (kWh)</label>
                      <input type="number" step="0.01" placeholder="0.00" value={draft.sponge}
                        onChange={e => upD("sponge", e.target.value)} style={S.inp} />
                    </div>
                    <div>
                      <label style={{ ...S.lbl, color: "#f87171" }}>Peak (kWh)</label>
                      <input type="number" step="0.01" placeholder="0.00" value={draft.peak}
                        onChange={e => upD("peak", e.target.value)} style={S.inp} />
                    </div>
                    <div>
                      <label style={{ ...S.lbl, color: "#a78bfa" }}>Off-Peak (kWh)</label>
                      <input type="number" step="0.01" placeholder="0.00" value={draft.offPk}
                        onChange={e => upD("offPk", e.target.value)} style={S.inp} />
                    </div>
                    <div>
                      <label style={{ ...S.lbl, color: "#34d399" }}>Feed-In Export (kWh)</label>
                      <input type="number" step="0.01" placeholder="0.00" value={draft.feedIn}
                        onChange={e => upD("feedIn", e.target.value)} style={S.inp} />
                    </div>
                  </div>

                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: "16px", gap: "8px" }}>
                    {editingId !== null && (
                      <button style={{ ...S.btnSm(false), color: "#94a3b8" }} onClick={cancelEdit}>Cancel</button>
                    )}
                    <div style={{ flex: 1 }} />
                    <button style={S.btn(draftHas && !!draft.billFrom)} onClick={saveDraft}>
                      {editingId !== null ? "Update Entry" : "Save & Next Month →"}
                    </button>
                  </div>
                </div>

                {/* Right: live bill preview */}
                <div style={{ flex: "1 1 300px" }}>
                  <div style={{ background: "rgba(15,23,42,0.6)", borderRadius: "8px", padding: "16px", border: "1px solid #1e293b", minHeight: "290px" }}>
                    <div style={{ fontSize: "13px", fontWeight: 600, color: "#fbbf24", marginBottom: "14px" }}>
                      {draftDate ? `${MO[draftMi]} ${draftYr}` : "Bill"} — Live Breakdown
                    </div>
                    {draftHas && draftBill ? (
                      <div style={{ display: "grid", gap: "7px", fontSize: "12px" }}>
                        {draftD.sponge > 0 && <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#38bdf8" }}>Sponge {draftD.sponge.toFixed(1)} kWh × {(draftRate.sponge * 100).toFixed(2)}¢</span>
                          <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{fmt2(draftBill.spongeC)}</span>
                        </div>}
                        {draftD.peak > 0 && <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#f87171" }}>Peak {draftD.peak.toFixed(1)} kWh × {(draftRate.peak * 100).toFixed(2)}¢</span>
                          <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{fmt2(draftBill.peakC)}</span>
                        </div>}
                        {draftD.offPk > 0 && <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#a78bfa" }}>Off-Pk {draftD.offPk.toFixed(1)} kWh × {(draftRate.offPk * 100).toFixed(2)}¢</span>
                          <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{fmt2(draftBill.offPkC)}</span>
                        </div>}

                        <div style={{ borderTop: "1px solid #283548", paddingTop: "5px", display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#94a3b8" }}>Energy subtotal</span>
                          <span style={{ color: "#e2e8f0" }}>{fmt2(draftBill.en)}</span>
                        </div>
                        <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#94a3b8" }}>Supply {draftDays}d × ${draftRate.supply.toFixed(4)}/d</span>
                          <span style={{ color: "#e2e8f0" }}>{fmt2(draftBill.su)}</span>
                        </div>

                        {draftRate.disc > 0 && <>
                          <div style={{ display: "flex", justifyContent: "space-between" }}>
                            <span style={{ color: "#34d399" }}>Energy discount ({draftRate.disc}%)</span>
                            <span style={{ color: "#34d399" }}>−{fmt2(draftBill.enD)}</span>
                          </div>
                          <div style={{ display: "flex", justifyContent: "space-between" }}>
                            <span style={{ color: "#34d399" }}>Supply discount ({draftRate.disc}%)</span>
                            <span style={{ color: "#34d399" }}>−{fmt2(draftBill.suD)}</span>
                          </div>
                        </>}

                        <div style={{ borderTop: "1px solid #283548", paddingTop: "5px", display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#94a3b8" }}>Taxable amount</span>
                          <span style={{ color: "#e2e8f0" }}>{fmt2(draftBill.taxable)}</span>
                        </div>
                        <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#94a3b8" }}>GST ({draftRate.gst}%)</span>
                          <span style={{ color: "#e2e8f0" }}>{fmt2(draftBill.gst)}</span>
                        </div>

                        {draftD.feedIn > 0 && <div style={{ display: "flex", justifyContent: "space-between" }}>
                          <span style={{ color: "#34d399" }}>Feed-In credit {draftD.feedIn.toFixed(1)} kWh × {(draftRate.feedIn * 100).toFixed(1)}¢</span>
                          <span style={{ color: "#34d399" }}>−{fmt2(draftBill.fi)}</span>
                        </div>}

                        <div style={{ borderTop: "2px solid rgba(251,191,36,0.25)", paddingTop: "10px", marginTop: "4px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                          <span style={{ color: "#fbbf24", fontWeight: 700, fontSize: "16px" }}>TOTAL</span>
                          <span style={{ color: "#fbbf24", fontWeight: 700, fontSize: "16px" }}>{fmt2(draftBill.total)}</span>
                        </div>
                        <div style={{ fontSize: "10px", color: "#475569", textAlign: "right", marginTop: "2px" }}>
                          Compare with your actual bill to validate
                        </div>
                      </div>
                    ) : (
                      <div style={{ color: "#475569", fontSize: "12px", padding: "40px 0", textAlign: "center" }}>
                        <div style={{ fontSize: "28px", marginBottom: "8px" }}>📊</div>
                        {!draft.billFrom ? "Set a bill start date, then enter kWh" : "Enter kWh values to see live bill breakdown"}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* ── Collected Entries Table ── */}
            {entries.length > 0 && (
              <div style={{ ...S.card, overflowX: "auto" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "12px", flexWrap: "wrap", gap: "6px" }}>
                  <div style={S.cT}>Collected Bills ({entries.length} entries, {monthsCovered}/12 calendar months)</div>
                </div>
                <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "12px", minWidth: "750px" }}>
                  <thead><tr>
                    <th style={{ ...S.th, textAlign: "left" }}>Bill Date</th>
                    <th style={{ ...S.th, textAlign: "left" }}>Month</th>
                    <th style={S.th}>Days</th>
                    <th style={{ ...S.th, color: "#38bdf8" }}>Sponge</th>
                    <th style={{ ...S.th, color: "#f87171" }}>Peak</th>
                    <th style={{ ...S.th, color: "#a78bfa" }}>Off-Peak</th>
                    <th style={{ ...S.th, color: "#34d399" }}>Feed-In</th>
                    <th style={S.th}>Calc Bill</th>
                    <th style={S.th}></th>
                  </tr></thead>
                  <tbody>
                    {entries.map((e, idx) => {
                      const bill = entryBills[idx];
                      const isEditing = editingId === e.id;
                      return (
                        <tr key={e.id}
                          style={{ background: isEditing ? "rgba(245,158,11,0.06)" : idx % 2 ? "rgba(10,15,26,0.3)" : "transparent", cursor: "pointer" }}
                          onClick={() => editEntry(e)}>
                          <td style={{ ...S.td, textAlign: "left", color: "#94a3b8", fontSize: "11px" }}>
                            {isEditing && <span style={{ color: "#fbbf24", marginRight: "4px" }}>▸</span>}
                            {new Date(e.billFrom + "T00:00").toLocaleDateString("en-AU", { day: "numeric", month: "short", year: "numeric" })}
                          </td>
                          <td style={{ ...S.td, textAlign: "left", fontWeight: 600, color: isEditing ? "#fbbf24" : "#e2e8f0" }}>
                            {MO[e.month]} {e.year}
                          </td>
                          <td style={{ ...S.td, textAlign: "right", color: "#94a3b8" }}>{e.days}</td>
                          <td style={{ ...S.td, textAlign: "right", color: "#38bdf8" }}>{parseFloat(e.sponge) ? parseFloat(e.sponge).toFixed(2) : "—"}</td>
                          <td style={{ ...S.td, textAlign: "right", color: "#f87171" }}>{parseFloat(e.peak) ? parseFloat(e.peak).toFixed(2) : "—"}</td>
                          <td style={{ ...S.td, textAlign: "right", color: "#a78bfa" }}>{parseFloat(e.offPk) ? parseFloat(e.offPk).toFixed(2) : "—"}</td>
                          <td style={{ ...S.td, textAlign: "right", color: "#34d399" }}>{parseFloat(e.feedIn) ? parseFloat(e.feedIn).toFixed(2) : "—"}</td>
                          <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#e2e8f0", fontSize: "13px" }}>{bill ? fmt2(bill.total) : "—"}</td>
                          <td style={{ ...S.td, textAlign: "center" }} onClick={ev => ev.stopPropagation()}>
                            <button onClick={() => removeEntry(e.id)}
                              style={{ border: "none", background: "transparent", color: "#f8717180", cursor: "pointer", fontSize: "14px", padding: "2px 6px" }}
                              title="Remove entry">✕</button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                  <tfoot><tr style={{ borderTop: "2px solid #334155" }}>
                    <td style={{ ...S.td, fontWeight: 700, color: "#fbbf24", textAlign: "left" }} colSpan={2}>
                      TOTALS
                    </td>
                    <td style={{ ...S.td, textAlign: "right", color: "#94a3b8", fontWeight: 600 }}>{totalDays}d</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#38bdf8", fontWeight: 600 }}>{entries.reduce((s, e) => s + (parseFloat(e.sponge) || 0), 0).toFixed(1)}</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#f87171", fontWeight: 600 }}>{entries.reduce((s, e) => s + (parseFloat(e.peak) || 0), 0).toFixed(1)}</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#a78bfa", fontWeight: 600 }}>{entries.reduce((s, e) => s + (parseFloat(e.offPk) || 0), 0).toFixed(1)}</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#34d399", fontWeight: 600 }}>{totalExport.toFixed(1)}</td>
                    <td style={{ ...S.td, textAlign: "right", fontWeight: 700, color: "#fbbf24", fontSize: "13px" }}>{fmt(totalBill)}</td>
                    <td style={S.td} />
                  </tr></tfoot>
                </table>
              </div>
            )}

            {/* Summary Stats */}
            {entries.length > 0 && totalBill > 0 && (
              <div style={{ ...S.card, display: "flex", gap: "24px", flexWrap: "wrap", alignItems: "flex-start" }}>
                <div>
                  <div style={S.sL}>Total Bills ({entries.length})</div>
                  <div style={{ fontSize: "20px", fontWeight: 700, color: "#f87171" }}>{fmt(totalBill)}</div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>{totalDays} days, {monthsCovered}/12 calendar months</div>
                </div>
                <div><div style={S.sL}>Avg per Entry</div><div style={{ fontSize: "20px", fontWeight: 700, color: "#e2e8f0" }}>{fmt(totalBill / entries.length)}</div></div>
                <div><div style={S.sL}>Daily Average</div><div style={{ fontSize: "20px", fontWeight: 700, color: "#e2e8f0" }}>{fmt2(totalBill / Math.max(1, totalDays))}/day</div></div>
                <div><div style={S.sL}>Daily Import</div><div style={{ fontSize: "20px", fontWeight: 700, color: "#94a3b8" }}>{(totalImport / Math.max(1, totalDays)).toFixed(1)} kWh</div></div>
                <div><div style={S.sL}>Daily Export</div><div style={{ fontSize: "20px", fontWeight: 700, color: "#34d399" }}>{(totalExport / Math.max(1, totalDays)).toFixed(1)} kWh</div></div>
                {monthsCovered < 12 && (
                  <div style={{ flex: "100%", fontSize: "11px", color: "#f59e0b", padding: "8px 12px", background: "rgba(245,158,11,0.06)", borderRadius: "6px", border: "1px solid rgba(245,158,11,0.15)" }}>
                    Forecast needs all 12 calendar months covered. You have {monthsCovered}/12 — use "Auto-fill Gaps" to estimate missing months, or keep adding bills.
                  </div>
                )}
              </div>
            )}

          </>);
        })()}

          {/* ─── Section: System Details ─── */}
          <div style={{ borderTop: "1px solid #1e293b", margin: "20px 0 14px", paddingTop: "14px" }}>
            <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "4px" }}>System Details</div>
            <div style={{ fontSize: "11px", color: "#475569", marginBottom: "10px" }}>Your battery installation and provider details</div>
          </div>

          <div style={{ display: "flex", gap: "14px", flexWrap: "wrap" }}>
            <div style={{ ...S.card, flex: "1 1 280px" }}>
              <div style={S.cT}>Battery System</div>
              <div style={{ display: "grid", gap: "10px" }}>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
                  <div><label style={S.lbl}>Installer</label>
                    <input type="text" value={cfg.installerName} onChange={e => upC("installerName", e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Battery Model</label>
                    <input type="text" value={cfg.batteryModel} onChange={e => upC("batteryModel", e.target.value)} style={S.inp} /></div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
                  <div><label style={S.lbl}>Capacity (kWh)</label>
                    <input type="number" step={0.1} value={cfg.batteryCapacity} onChange={e => upC("batteryCapacity", +e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Usable (kWh)</label>
                    <input type="number" step={0.1} value={cfg.usableCapacity} onChange={e => upC("usableCapacity", +e.target.value)} style={S.inp} /></div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: "8px" }}>
                  <div><label style={S.lbl}>Solar System (kW)</label>
                    <input type="number" step={0.1} value={cfg.solarCapacity} onChange={e => upC("solarCapacity", +e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Battery Inverter (kW)</label>
                    <input type="number" step={0.1} value={cfg.inverterPower} onChange={e => upC("inverterPower", +e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Charge Rate (kW)</label>
                    <input type="number" step={0.1} value={cfg.chargeRate} onChange={e => upC("chargeRate", +e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Efficiency (%)</label>
                    <input type="number" step={0.1} value={cfg.inverterEfficiency} onChange={e => upC("inverterEfficiency", +e.target.value)} style={S.inp} /></div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
                  <div><label style={S.lbl}>Location</label>
                    <input type="text" value={cfg.location} onChange={e => upC("location", e.target.value)} style={S.inp} /></div>
                  <div><label style={S.lbl}>Energy Provider</label>
                    <input type="text" value={cfg.provider} onChange={e => upC("provider", e.target.value)} style={S.inp} /></div>
                </div>
                <div><label style={S.lbl}>Battery cost (after federal STC rebate)</label>
                  <input type="number" value={cfg.batteryCost} onChange={e => upC("batteryCost", +e.target.value)} style={S.inp} /></div>
                <div><label style={S.lbl}>SA REPS VPP cashback</label>
                  <input type="number" value={cfg.repsRebate} onChange={e => upC("repsRebate", +e.target.value)} style={S.inp} /></div>
                <div style={{ padding: "10px", background: "rgba(16,185,129,0.08)", borderRadius: "8px", border: "1px solid rgba(16,185,129,0.15)" }}>
                  <div style={{ fontSize: "11px", color: "#64748b" }}>Net Battery Cost</div>
                  <div style={{ fontSize: "22px", fontWeight: 700, color: "#34d399" }}>{fmt(netCost)}</div>
                </div>
              </div>
            </div>

            <div style={{ ...S.card, flex: "1 1 280px" }}>
              <div style={S.cT}>Energy Provider Settings</div>
              <div style={{ display: "flex", gap: "6px", marginBottom: "12px" }}>
                <button style={S.tgl(!cfg.useAmber)} onClick={() => upC("useAmber", false)}>Current Retailer</button>
                <button style={S.tgl(cfg.useAmber)} onClick={() => upC("useAmber", true)}>Amber Electric</button>
              </div>
              <div style={{ display: "grid", gap: "10px" }}>
                <div>
                  <label style={S.lbl}>Electricity price escalation (%/yr)</label>
                  <input type="range" min={0} max={10} step={0.5} value={cfg.escalation} onChange={e => upC("escalation", +e.target.value)} style={S.slider} />
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}><span>0%</span><span style={{ color: "#e2e8f0", fontWeight: 600 }}>{cfg.escalation}%</span><span>10%</span></div>
                </div>
                {cfg.useAmber && <>
                  <div>
                    <label style={S.lbl}>Amber avg wholesale FiT ($/kWh)</label>
                    <input type="number" step={0.01} value={cfg.amberFitAvg} onChange={e => upC("amberFitAvg", +e.target.value)} style={S.inp} />
                  </div>
                  <div>
                    <label style={S.lbl}>Amber wholesale import discount</label>
                    <input type="range" min={0} max={0.5} step={0.05} value={cfg.amberImportDisc} onChange={e => upC("amberImportDisc", +e.target.value)} style={S.slider} />
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}><span>0%</span><span style={{ color: "#e2e8f0", fontWeight: 600 }}>{pct(cfg.amberImportDisc * 100)} cheaper</span><span>50%</span></div>
                  </div>
                  <div>
                    <label style={S.lbl}>Spike earnings multiplier</label>
                    <input type="range" min={0} max={2.5} step={0.1} value={cfg.amberSpikeMult} onChange={e => upC("amberSpikeMult", +e.target.value)} style={S.slider} />
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}><span>None</span><span style={{ color: "#e2e8f0", fontWeight: 600 }}>{cfg.amberSpikeMult.toFixed(1)}x</span><span>2.5x</span></div>
                  </div>
                  <div style={{ fontSize: "11px", color: "#475569", padding: "8px", background: "rgba(245,158,11,0.05)", borderRadius: "6px" }}>
                    Est. annual spike earnings: {fmt(BAT.amberSpike.reduce((s, v) => s + v * cfg.amberSpikeMult * Math.min(cfg.scenario, 1.2), 0))}
                  </div>
                </>}
              </div>
            </div>
          </div>
  </>);
}


/* Tab 3: Forecast — 4 sub-views: Daily (16-day weather), Weekly, Monthly, Yearly ROI */

function ForecastTab({ cfg, upC, forecast, viewYr, setViewYr, chartMode, setChartMode, netCost, monthlyPmt, hasData, scLabel, scColor, fmt, fmt2, pct, MO, BAT, financeOverride, setFinanceOverride, rateSets, setTab, accelerateRepay, setAccelerateRepay, annualBill, openMeteoForecast, openMeteoLoading, openMeteoError, setOpenMeteoForecast, setOpenMeteoLoading, setOpenMeteoError, forecastSubView, setForecastSubView }) {
  // Compute accelerated repayment data when toggle is on
  const avgMonthlySavings = forecast ? forecast.summary.avgMo : 0;
  const accelData = useMemo(() => {
    if (!accelerateRepay || cfg.payType !== "finance" || !forecast) return null;
    return generateAcceleratedSchedule(netCost, cfg.financeRate, cfg.financeTerm, avgMonthlySavings);
  }, [accelerateRepay, cfg.payType, cfg.financeRate, cfg.financeTerm, netCost, avgMonthlySavings, forecast]);

  // Compute lifetime cost comparison data
  const lifetimeCostData = useMemo(() => {
    if (!forecast) return null;
    const annualNoBatt = forecast.summary.totalNB / cfg.forecastYears;
    const annualSavings = (forecast.summary.totalEnergySav || forecast.summary.totalSav) / cfg.forecastYears;
    const years = Math.max(cfg.forecastYears, 15);
    return generateLifetimeCostData(annualNoBatt, annualSavings, netCost, cfg.escalation, cfg.financeRate, cfg.financeTerm, years);
  }, [forecast, cfg.forecastYears, cfg.escalation, cfg.financeRate, cfg.financeTerm, netCost]);

  // Financial calculations for daily forecast
  const avgDailyCostNoBattery = annualBill ? annualBill / 365 : 0;
  const dailyFinanceCost = monthlyPmt / 30;

  // Refresh Open-Meteo data
  const refreshOpenMeteo = async () => {
    setOpenMeteoLoading(true);
    setOpenMeteoError(null);
    try {
      const resp = await fetch(`${SOLAR_API_URL}/weather-forecast`);
      if (resp.ok) {
        const data = await resp.json();
        const processed = processOpenMeteoForecast(data.forecast_days || [], cfg);
        setOpenMeteoForecast(processed);
      } else {
        setOpenMeteoError('Failed to fetch forecast');
      }
    } catch (e) {
      setOpenMeteoError(e.message);
    } finally {
      setOpenMeteoLoading(false);
    }
  };

  // Enrich forecast days with financial data
  const forecastFinancials = useMemo(() => {
    if (!openMeteoForecast) return [];
    return openMeteoForecast.map(day => {
      const batteryReduction = Math.min(day.fillPct / 100, 1);
      const dailySaving = avgDailyCostNoBattery * batteryReduction * 0.5;
      const netSaving = dailySaving - dailyFinanceCost;
      return { ...day, dailySaving: Math.round(dailySaving * 100) / 100, dailyFinanceCost: Math.round(dailyFinanceCost * 100) / 100, netSaving: Math.round(netSaving * 100) / 100 };
    });
  }, [openMeteoForecast, avgDailyCostNoBattery, dailyFinanceCost]);

  // Sub-view pill style
  const pill = (active) => ({
    padding: "7px 18px", borderRadius: "20px",
    border: active ? "1px solid #3b82f6" : "1px solid #334155",
    background: active ? "rgba(59,130,246,0.15)" : "transparent",
    color: active ? "#60a5fa" : "#94a3b8",
    fontSize: "12px", fontWeight: 600, cursor: "pointer", transition: "all 0.2s"
  });

  return (<>
    {/* Sub-view navigation pills */}
    <div style={{ display: "flex", gap: "6px", marginBottom: "16px", flexWrap: "wrap" }}>
      {[
        { key: 'daily', label: 'Daily (16 days)' },
        { key: 'weekly', label: 'Weekly' },
        { key: 'monthly', label: 'Monthly' },
        { key: 'yearly', label: 'Yearly' },
      ].map(v => (
        <button key={v.key} onClick={() => setForecastSubView(v.key)} style={pill(forecastSubView === v.key)}>
          {v.label}
        </button>
      ))}
    </div>

    {/* ═══ DAILY SUB-VIEW: 16-day weather-driven forecast ═══ */}
    {forecastSubView === 'daily' && (<>
      {openMeteoLoading && (
        <div style={{ ...S.card, textAlign: "center", padding: "40px" }}>
          <div style={{ fontSize: "14px", color: "#94a3b8" }}>Loading 16-day forecast...</div>
        </div>
      )}

      {openMeteoError && (
        <div style={{ ...S.card, textAlign: "center", padding: "24px" }}>
          <div style={{ fontSize: "48px", marginBottom: "12px" }}>&#x26A0;&#xFE0F;</div>
          <div style={{ fontSize: "14px", color: "#f87171", marginBottom: "8px", fontWeight: 600 }}>Weather Forecast Not Available</div>
          <div style={{ fontSize: "12px", color: "#94a3b8", marginBottom: "16px" }}>{openMeteoError}</div>
          <button onClick={refreshOpenMeteo} style={{ padding: "8px 20px", background: "#3b82f6", color: "#fff", border: "none", borderRadius: "6px", fontSize: "12px", fontWeight: 600, cursor: "pointer" }}>Retry</button>
        </div>
      )}

      {!openMeteoLoading && !openMeteoError && openMeteoForecast && openMeteoForecast.length > 0 && (() => {
        const avgPredictedSolar = openMeteoForecast.reduce((sum, d) => sum + d.predictedSolarKwh, 0) / openMeteoForecast.length;
        const daysReachingFull = openMeteoForecast.filter(d => d.fillPct >= 95).length;
        const avgFillPct = openMeteoForecast.reduce((sum, d) => sum + d.fillPct, 0) / openMeteoForecast.length;
        const totalSavings = forecastFinancials.reduce((sum, d) => sum + d.dailySaving, 0);
        const needsSolarSharer = openMeteoForecast.filter(d => d.fillPct < 75);

        return <>
          {/* Summary Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: "12px", marginBottom: "24px" }}>
            <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
              <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Avg Predicted Solar</div>
              <div style={{ fontSize: "24px", fontWeight: 700, color: "#38bdf8" }}>{avgPredictedSolar.toFixed(1)} kWh/day</div>
              <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>across {openMeteoForecast.length} days</div>
            </div>
            <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
              <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Days Reaching Full</div>
              <div style={{ fontSize: "24px", fontWeight: 700, color: "#34d399" }}>{daysReachingFull} / {openMeteoForecast.length}</div>
              <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>{((daysReachingFull / openMeteoForecast.length) * 100).toFixed(0)}% of forecast</div>
            </div>
            <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
              <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Avg Battery Fill</div>
              <div style={{ fontSize: "24px", fontWeight: 700, color: "#a78bfa" }}>{avgFillPct.toFixed(0)}%</div>
              <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>{avgFillPct >= 90 ? 'Excellent' : avgFillPct >= 70 ? 'Good' : 'Fair'} outlook</div>
            </div>
            <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
              <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Est. Total Savings</div>
              <div style={{ fontSize: "24px", fontWeight: 700, color: "#34d399" }}>{fmt(totalSavings)}</div>
              <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>~{fmt(totalSavings / openMeteoForecast.length * 365)}/year at this rate</div>
            </div>
            <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
              <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Data Source</div>
              <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0" }}>Open-Meteo</div>
              <button onClick={refreshOpenMeteo} style={{ marginTop: "6px", padding: "4px 12px", background: "transparent", color: "#3b82f6", border: "1px solid #3b82f6", borderRadius: "4px", fontSize: "10px", cursor: "pointer" }}>Refresh</button>
            </div>
          </div>

          {/* 16-Day Bar Chart */}
          <div style={{ ...S.card, marginBottom: "24px" }}>
            <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>Predicted Battery Performance (16 days)</div>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={openMeteoForecast.map(d => ({
                date: `${d.dayName} ${d.dateObj.getDate()}/${d.dateObj.getMonth() + 1}`,
                'Predicted Solar': d.predictedSolarKwh,
                'Max SOC': d.maxSOC,
              }))} barGap={2}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis dataKey="date" stroke="#64748b" fontSize={10} interval={1} angle={-35} textAnchor="end" height={60} />
                <YAxis stroke="#64748b" fontSize={11} />
                <Tooltip contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '6px', fontSize: '12px' }} labelStyle={{ color: '#e2e8f0', fontWeight: 600 }} />
                <Legend wrapperStyle={{ fontSize: '11px' }} />
                <Bar dataKey="Predicted Solar" fill="#38bdf8" radius={[2, 2, 0, 0]} />
                <Bar dataKey="Max SOC" fill="#a78bfa" radius={[2, 2, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Day-by-Day Detail Cards */}
          <div style={{ ...S.card, marginBottom: "24px" }}>
            <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>Day-by-Day Forecast</div>
            <div style={{ display: "grid", gap: "12px" }}>
              {forecastFinancials.map((day, i) => (
                <div key={i} style={{ background: "#0f172a", padding: "16px", borderRadius: "6px", border: "1px solid #334155" }}>
                  <div style={{ display: "flex", gap: "16px", alignItems: "start", flexWrap: "wrap" }}>
                    {/* Date & Weather */}
                    <div style={{ flex: "0 0 200px" }}>
                      <div style={{ fontSize: "13px", fontWeight: 700, color: "#e2e8f0", marginBottom: "4px" }}>
                        {day.dayName}, {day.dateObj.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' })}
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "4px" }}>
                        <span style={{ fontSize: "28px" }}>{day.conditionIcon}</span>
                        <div>
                          <div style={{ fontSize: "11px", color: "#94a3b8" }}>{day.condition}</div>
                          <div style={{ fontSize: "12px", color: "#e2e8f0", fontWeight: 600 }}>{day.tempMax}°C / {day.tempMin}°C</div>
                        </div>
                      </div>
                      <div style={{ fontSize: "10px", color: "#64748b" }}>
                        {day.cloudCover != null && <span>&#x2601;&#xFE0F; {Math.round(day.cloudCover)}% cloud</span>}
                        {day.precipChance != null && <span> · &#x1F327;&#xFE0F; {day.precipChance}% rain</span>}
                      </div>
                      {day.radiationMJ != null && <div style={{ fontSize: "9px", color: "#475569" }}>
                        Radiation: {day.radiationMJ.toFixed(1)} MJ/m² · Sunshine: {day.sunshineHours}h
                      </div>}
                    </div>

                    {/* Battery Predictions */}
                    <div style={{ flex: "1", minWidth: "300px" }}>
                      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(100px, 1fr))", gap: "12px" }}>
                        <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Predicted Solar</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: "#38bdf8" }}>{day.predictedSolarKwh} kWh</div>
                        </div>
                        <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Max Battery SOC</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: "#a78bfa" }}>{day.maxSOC} kWh</div>
                        </div>
                        <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Fill Percentage</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: day.fillPct >= 95 ? "#34d399" : day.fillPct >= 75 ? "#fbbf24" : "#f87171" }}>{day.fillPct}%</div>
                        </div>
                        <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Time to Full</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: day.timeToFull ? "#34d399" : "#64748b" }}>{day.timeToFull || "\u2014"}</div>
                        </div>
                        <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Est. Saving</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: "#34d399" }}>${day.dailySaving.toFixed(2)}</div>
                        </div>
                        {cfg.payType === "finance" && <div>
                          <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Net (After Finance)</div>
                          <div style={{ fontSize: "16px", fontWeight: 700, color: day.netSaving >= 0 ? "#34d399" : "#f87171" }}>${day.netSaving.toFixed(2)}</div>
                        </div>}
                      </div>
                      <div style={{ marginTop: "12px", padding: "8px 12px", background: "#1e293b", borderRadius: "4px", fontSize: "11px", color: "#94a3b8" }}>
                        {day.fillPct >= 95 ? (
                          <><strong style={{ color: "#34d399" }}>Excellent day!</strong> Battery will reach full. Good day for high consumption activities.</>
                        ) : day.fillPct >= 75 ? (
                          <><strong style={{ color: "#fbbf24" }}>Good day.</strong> Battery will reach {day.fillPct}%. Consider moderate usage.</>
                        ) : (
                          <><strong style={{ color: "#f87171" }}>Low solar day.</strong> Battery only {day.fillPct}%. Consider pre-charging overnight at off-peak rates.</>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Smart Recommendations */}
          {needsSolarSharer.length > 0 && (
            <div style={{ background: "#1e293b", padding: "20px", borderRadius: "8px", border: "1px solid #f59e0b", marginBottom: "16px" }}>
              <div style={{ fontSize: "14px", fontWeight: 700, color: "#fbbf24", marginBottom: "12px" }}>Smart Recommendations</div>
              <div style={{ fontSize: "12px", color: "#94a3b8", lineHeight: "1.6" }}>
                <p style={{ margin: "0 0 8px" }}><strong>{needsSolarSharer.length} day{needsSolarSharer.length > 1 ? 's' : ''}</strong> may not fully charge the battery:</p>
                <ul style={{ margin: "0 0 12px 20px", padding: 0 }}>
                  {needsSolarSharer.slice(0, 5).map((day, i) => (
                    <li key={i} style={{ margin: "4px 0" }}>
                      <strong>{day.dayName} {day.dateObj.getDate()}/{day.dateObj.getMonth() + 1}</strong> - Predicted {day.fillPct}% fill ({day.condition.toLowerCase()})
                    </li>
                  ))}
                  {needsSolarSharer.length > 5 && <li style={{ margin: "4px 0", color: "#64748b" }}>...and {needsSolarSharer.length - 5} more</li>}
                </ul>
                <p style={{ margin: 0 }}><strong>Tip:</strong> Consider pre-charging battery overnight at off-peak rates before very cloudy days to ensure full capacity.</p>
              </div>
            </div>
          )}
        </>;
      })()}

      {!openMeteoLoading && !openMeteoError && (!openMeteoForecast || openMeteoForecast.length === 0) && (
        <div style={{ ...S.card, textAlign: "center", padding: "24px" }}>
          <div style={{ fontSize: "48px", marginBottom: "12px" }}>&#x1F324;&#xFE0F;</div>
          <div style={{ fontSize: "14px", color: "#e2e8f0", marginBottom: "8px", fontWeight: 600 }}>16-Day Weather Forecast</div>
          <div style={{ fontSize: "12px", color: "#94a3b8", marginBottom: "16px" }}>Get radiation-based predictions for battery performance using Open-Meteo data</div>
          <button onClick={refreshOpenMeteo} style={{ padding: "10px 24px", background: "#3b82f6", color: "#fff", border: "none", borderRadius: "6px", fontSize: "13px", fontWeight: 600, cursor: "pointer" }}>Load 16-Day Forecast</button>
        </div>
      )}
    </>)}

    {/* ═══ WEEKLY SUB-VIEW: Group into Week 1 and Week 2 ═══ */}
    {forecastSubView === 'weekly' && (<>
      {openMeteoLoading && <div style={{ ...S.card, textAlign: "center", padding: "40px" }}><div style={{ fontSize: "14px", color: "#94a3b8" }}>Loading forecast...</div></div>}
      {openMeteoError && <div style={{ ...S.card, textAlign: "center", padding: "24px" }}><div style={{ color: "#f87171" }}>{openMeteoError}</div><button onClick={refreshOpenMeteo} style={{ marginTop: "8px", padding: "6px 16px", background: "#3b82f6", color: "#fff", border: "none", borderRadius: "6px", fontSize: "12px", cursor: "pointer" }}>Retry</button></div>}

      {!openMeteoLoading && !openMeteoError && forecastFinancials.length > 0 && (() => {
        const week1 = forecastFinancials.slice(0, 7);
        const week2 = forecastFinancials.slice(7, 14);
        const weeks = [
          { label: 'Week 1 (Days 1-7)', data: week1 },
          { label: `Week 2 (Days 8-${Math.min(14, forecastFinancials.length)})`, data: week2 },
        ].filter(w => w.data.length > 0);

        const weekStats = weeks.map(w => ({
          label: w.label,
          totalSolar: w.data.reduce((s, d) => s + d.predictedSolarKwh, 0),
          avgFill: w.data.reduce((s, d) => s + d.fillPct, 0) / w.data.length,
          daysAtFull: w.data.filter(d => d.fillPct >= 95).length,
          totalSavings: w.data.reduce((s, d) => s + d.dailySaving, 0),
          days: w.data.length,
        }));

        return <>
          {/* Week Comparison Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: "16px", marginBottom: "24px" }}>
            {weekStats.map((ws, i) => (
              <div key={i} style={{ ...S.card, background: i === 0 ? "linear-gradient(135deg, rgba(59,130,246,0.08), rgba(96,165,250,0.04))" : "linear-gradient(135deg, rgba(168,85,247,0.08), rgba(192,112,232,0.04))" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>{ws.label}</div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "12px" }}>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Total Solar</div>
                    <div style={{ fontSize: "20px", fontWeight: 700, color: "#38bdf8" }}>{ws.totalSolar.toFixed(1)} kWh</div>
                  </div>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Avg Fill %</div>
                    <div style={{ fontSize: "20px", fontWeight: 700, color: "#a78bfa" }}>{ws.avgFill.toFixed(0)}%</div>
                  </div>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Days at Full</div>
                    <div style={{ fontSize: "20px", fontWeight: 700, color: "#34d399" }}>{ws.daysAtFull} / {ws.days}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Total Savings</div>
                    <div style={{ fontSize: "20px", fontWeight: 700, color: "#34d399" }}>{fmt(ws.totalSavings)}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* Weekly Comparison Bar Chart */}
          <div style={S.card}>
            <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>Weekly Comparison</div>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={weekStats} barGap={4} barCategoryGap="30%">
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis dataKey="label" stroke="#64748b" fontSize={11} />
                <YAxis stroke="#64748b" fontSize={11} />
                <Tooltip contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '6px', fontSize: '12px' }} />
                <Legend wrapperStyle={{ fontSize: '11px' }} />
                <Bar dataKey="totalSolar" name="Total Solar (kWh)" fill="#38bdf8" radius={[3, 3, 0, 0]} />
                <Bar dataKey="avgFill" name="Avg Fill (%)" fill="#a78bfa" radius={[3, 3, 0, 0]} />
                <Bar dataKey="totalSavings" name="Savings ($)" fill="#34d399" radius={[3, 3, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </>;
      })()}

      {!openMeteoLoading && !openMeteoError && forecastFinancials.length === 0 && (
        <div style={{ ...S.card, textAlign: "center", padding: "24px" }}>
          <div style={{ fontSize: "14px", color: "#94a3b8", marginBottom: "12px" }}>No forecast data available</div>
          <button onClick={refreshOpenMeteo} style={{ padding: "8px 20px", background: "#3b82f6", color: "#fff", border: "none", borderRadius: "6px", fontSize: "12px", fontWeight: 600, cursor: "pointer" }}>Load Forecast</button>
        </div>
      )}
    </>)}

    {/* ═══ MONTHLY SUB-VIEW: Rolling 12-month view ═══ */}
    {forecastSubView === 'monthly' && (<>
      {(() => {
        if (!forecast) return (
          <div style={{ ...S.card, textAlign: "center", padding: "40px" }}>
            <div style={{ fontSize: "40px", marginBottom: "10px" }}>&#x1F4CB;</div>
            <div style={{ fontSize: "14px", color: "#94a3b8" }}>Enter usage data in the Setup tab first</div>
            <button style={{ ...S.btn(true), marginTop: "12px" }} onClick={() => setTab(0)}>Go to Setup</button>
          </div>
        );

        // Build 12-month rolling view from forecast model
        const now = new Date();
        const currentMonth = now.getMonth();
        const monthlyData = [];

        for (let i = 0; i < 12; i++) {
          const monthIdx = (currentMonth + i) % 12;
          const yearOffset = Math.floor((currentMonth + i) / 12);
          const label = MO[monthIdx] + (yearOffset > 0 ? ` '${String(now.getFullYear() + yearOffset).slice(2)}` : '');

          // Use year 1 forecast data for this month
          const forecastMonth = forecast.monthly.find(m => m.monthIdx === monthIdx && m.year === 1) ||
                                forecast.monthly.find(m => m.label === MO[monthIdx] && m.year === 1);

          if (forecastMonth) {
            monthlyData.push({
              label,
              month: MO[monthIdx],
              noBattery: forecastMonth.noBattery,
              withBattery: forecastMonth.energyOnly,
              saving: forecastMonth.saving,
              energySaving: forecastMonth.energySaving || forecastMonth.noBattery - forecastMonth.energyOnly,
            });
          } else {
            // Fallback: use annual averages
            const avgMonthlyNB = forecast.summary.totalNB / (cfg.forecastYears * 12);
            const avgMonthlySav = (forecast.summary.totalEnergySav || forecast.summary.totalSav) / (cfg.forecastYears * 12);
            monthlyData.push({
              label,
              month: MO[monthIdx],
              noBattery: avgMonthlyNB,
              withBattery: avgMonthlyNB - avgMonthlySav,
              saving: avgMonthlySav - (cfg.payType === 'finance' ? monthlyPmt : 0),
              energySaving: avgMonthlySav,
            });
          }
        }

        // Add Open-Meteo current month enhancement
        const currentMonthWeather = openMeteoForecast && openMeteoForecast.length > 0
          ? { avgSolar: openMeteoForecast.reduce((s, d) => s + d.predictedSolarKwh, 0) / openMeteoForecast.length, avgFill: openMeteoForecast.reduce((s, d) => s + d.fillPct, 0) / openMeteoForecast.length }
          : null;

        return <>
          {/* Forecast settings for Monthly view */}
          <div style={{ display: "flex", gap: "14px", flexWrap: "wrap", marginBottom: "16px" }}>
            <div style={{ ...S.card, flex: "1 1 280px" }}>
              <div style={S.cT}>Forecast Settings</div>
              <div style={{ display: "grid", gap: "10px" }}>
                <div>
                  <label style={S.lbl}>Battery effectiveness</label>
                  <input type="range" min={0.5} max={1.4} step={0.05} value={cfg.scenario} onChange={e => upC("scenario", +e.target.value)} style={S.slider} />
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}>
                    <span>Conservative</span><span style={{ color: scColor, fontWeight: 600 }}>{scLabel} ({pct(cfg.scenario * 100)})</span><span>Optimistic</span>
                  </div>
                </div>
              </div>
            </div>
            {currentMonthWeather && (
              <div style={{ ...S.card, flex: "1 1 280px" }}>
                <div style={S.cT}>Current Weather Outlook</div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px" }}>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Avg Predicted Solar</div>
                    <div style={{ fontSize: "18px", fontWeight: 700, color: "#38bdf8" }}>{currentMonthWeather.avgSolar.toFixed(1)} kWh/day</div>
                  </div>
                  <div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Avg Battery Fill</div>
                    <div style={{ fontSize: "18px", fontWeight: 700, color: "#a78bfa" }}>{currentMonthWeather.avgFill.toFixed(0)}%</div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* 12-Month Bar Chart */}
          <div style={S.card}>
            <div style={S.cT}>Rolling 12-Month Cost Comparison</div>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={monthlyData} barGap={2} barCategoryGap="18%">
                <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                <XAxis dataKey="label" tick={{ fill: "#64748b", fontSize: 11 }} />
                <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${v}`} />
                <Tooltip content={<TT />} />
                <Legend wrapperStyle={{ fontSize: "11px" }} />
                <Bar dataKey="noBattery" name="Without Battery" fill="#f87171" radius={[3, 3, 0, 0]} />
                <Bar dataKey="withBattery" name="With Battery" fill="#34d399" radius={[3, 3, 0, 0]} />
                <Bar dataKey="energySaving" name="Energy Saving" fill="#fbbf24" radius={[3, 3, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Monthly Summary Table */}
          <div style={{ ...S.card, overflowX: "auto" }}>
            <div style={S.cT}>Monthly Detail</div>
            <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "12px", minWidth: "500px" }}>
              <thead><tr>
                <th style={{ ...S.th, textAlign: "left" }}>Month</th>
                <th style={S.th}>Without Battery</th>
                <th style={S.th}>With Battery</th>
                <th style={S.th}>Energy Saving</th>
                <th style={S.th}>Net Saving</th>
              </tr></thead>
              <tbody>
                {monthlyData.map((d, i) => (
                  <tr key={i} style={{ background: i % 2 ? "rgba(10,15,26,0.3)" : "transparent" }}>
                    <td style={{ ...S.td, fontWeight: 500, textAlign: "left" }}>{d.label}</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#f87171" }}>{fmt(d.noBattery)}</td>
                    <td style={{ ...S.td, textAlign: "right", color: "#34d399" }}>{fmt(d.withBattery)}</td>
                    <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge("#34d399")}>+{fmt(d.energySaving)}</span></td>
                    <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge(d.saving >= 0 ? "#34d399" : "#f87171")}>{d.saving >= 0 ? "+" : ""}{fmt(d.saving)}</span></td>
                  </tr>
                ))}
              </tbody>
              <tfoot><tr style={{ borderTop: "2px solid #1e293b" }}>
                <td style={{ ...S.td, fontWeight: 700, color: "#fbbf24", textAlign: "left" }}>TOTAL</td>
                <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#f87171" }}>{fmt(monthlyData.reduce((s, d) => s + d.noBattery, 0))}</td>
                <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#34d399" }}>{fmt(monthlyData.reduce((s, d) => s + d.withBattery, 0))}</td>
                <td style={{ ...S.td, textAlign: "right", fontWeight: 600 }}><span style={S.badge("#34d399")}>+{fmt(monthlyData.reduce((s, d) => s + d.energySaving, 0))}</span></td>
                <td style={{ ...S.td, textAlign: "right", fontWeight: 600 }}><span style={S.badge(monthlyData.reduce((s, d) => s + d.saving, 0) >= 0 ? "#34d399" : "#f87171")}>{fmt(monthlyData.reduce((s, d) => s + d.saving, 0))}</span></td>
              </tr></tfoot>
            </table>
          </div>
        </>;
      })()}
    </>)}

    {/* ═══ YEARLY SUB-VIEW: Direct migration of existing forecast content ═══ */}
    {forecastSubView === 'yearly' && (<>
          {/* Forecast Settings */}
          <div style={{ display: "flex", gap: "14px", flexWrap: "wrap", marginBottom: "16px" }}>
            <div style={{ ...S.card, flex: "1 1 280px" }}>
              <div style={S.cT}>Forecast Settings</div>
              <div style={{ display: "grid", gap: "10px" }}>
                <div>
                  <label style={S.lbl}>Forecast period</label>
                  <input type="range" min={2} max={20} step={1} value={cfg.forecastYears} onChange={e => upC("forecastYears", +e.target.value)} style={S.slider} />
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}><span>2yr</span><span style={{ color: "#e2e8f0", fontWeight: 600 }}>{cfg.forecastYears} years</span><span>20yr</span></div>
                </div>
                <div>
                  <label style={S.lbl}>Battery effectiveness</label>
                  <input type="range" min={0.5} max={1.4} step={0.05} value={cfg.scenario} onChange={e => upC("scenario", +e.target.value)} style={S.slider} />
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", color: "#64748b" }}>
                    <span>Conservative</span><span style={{ color: scColor, fontWeight: 600 }}>{scLabel} ({pct(cfg.scenario * 100)})</span><span>Optimistic</span>
                  </div>
                </div>
              </div>
            </div>
            <div style={{ ...S.card, flex: "1 1 280px" }}>
              <div style={S.cT}>Payment Method</div>
              <div style={{ display: "flex", gap: "6px", marginBottom: "12px" }}>
                <button style={S.tgl(cfg.payType === "upfront")} onClick={() => upC("payType", "upfront")}>Pay Upfront</button>
                <button style={S.tgl(cfg.payType === "finance")} onClick={() => upC("payType", "finance")}>Finance</button>
              </div>
              {cfg.payType === "finance" ? <div style={{ display: "grid", gap: "10px" }}>
                {financeOverride ? (
                  <div style={{ padding: "10px", background: "rgba(124,58,237,0.1)", borderRadius: "8px", border: "1px solid rgba(124,58,237,0.3)" }}>
                    <div style={{ fontSize: "11px", color: "#a78bfa", marginBottom: "4px" }}>Using Finance Calculator scenario</div>
                    <div style={{ fontSize: "18px", fontWeight: 700, color: "#f59e0b" }}>{financeOverride.name}</div>
                    <div style={{ fontSize: "12px", color: "#94a3b8" }}>{fmt(monthlyPmt)}/mo · {financeOverride.effectiveAPR.toFixed(1)}% APR · {financeOverride.termYears}yr</div>
                    <button onClick={() => setFinanceOverride(null)} style={{ marginTop: "6px", fontSize: "10px", color: "#94a3b8", background: "transparent", border: "1px solid #475569", borderRadius: "4px", padding: "3px 8px", cursor: "pointer" }}>Clear override</button>
                  </div>
                ) : <>
                <div><label style={S.lbl}>Loan term (years)</label><input type="number" value={cfg.financeTerm} min={1} max={15} onChange={e => upC("financeTerm", +e.target.value)} style={S.inp} /></div>
                <div><label style={S.lbl}>Interest rate (%)</label><input type="number" step={0.1} value={cfg.financeRate} onChange={e => upC("financeRate", +e.target.value)} style={S.inp} /></div>
                </>}
                <div style={{ padding: "10px", background: "rgba(245,158,11,0.08)", borderRadius: "8px", border: "1px solid rgba(245,158,11,0.15)" }}>
                  <div style={{ fontSize: "11px", color: "#64748b" }}>Monthly Repayment</div>
                  <div style={{ fontSize: "22px", fontWeight: 700, color: "#fbbf24" }}>{fmt(monthlyPmt)}/mo</div>
                  <div style={{ fontSize: "11px", color: "#475569" }}>Total repaid: {fmt(monthlyPmt * cfg.financeTerm * 12)}</div>
                </div>
                {/* Accelerated Repayment Toggle */}
                <label style={{ display: "flex", alignItems: "center", gap: "8px", cursor: "pointer", padding: "8px 10px", background: accelerateRepay ? "rgba(16,185,129,0.1)" : "transparent", borderRadius: "6px", border: `1px solid ${accelerateRepay ? "#10b981" : "#334155"}`, transition: "all 0.2s" }}>
                  <input type="checkbox" checked={accelerateRepay} onChange={e => setAccelerateRepay(e.target.checked)}
                    style={{ width: 16, height: 16, accentColor: "#10b981" }} />
                  <div>
                    <div style={{ fontSize: "12px", fontWeight: 600, color: accelerateRepay ? "#10b981" : "#94a3b8" }}>Apply savings to repayments</div>
                    <div style={{ fontSize: "10px", color: "#64748b" }}>Battery savings reduce loan principal faster</div>
                  </div>
                </label>
              </div> : <div style={{ padding: "10px", background: "rgba(245,158,11,0.08)", borderRadius: "8px", border: "1px solid rgba(245,158,11,0.15)" }}>
                <div style={{ fontSize: "11px", color: "#64748b" }}>Upfront Payment</div>
                <div style={{ fontSize: "22px", fontWeight: 700, color: "#fbbf24" }}>{fmt(netCost)}</div>
                <div style={{ fontSize: "11px", color: "#475569" }}>No ongoing battery payments</div>
              </div>}
            </div>
          </div>

          {!forecast ? (
            <div style={{ ...S.card, textAlign: "center", padding: "40px" }}>
              <div style={{ fontSize: "40px", marginBottom: "10px" }}>&#x1F4CB;</div>
              <div style={{ fontSize: "14px", color: "#94a3b8" }}>Enter usage data in the Setup tab first</div>
              <button style={{ ...S.btn(true), marginTop: "12px" }} onClick={() => setTab(0)}>Go to Setup</button>
            </div>
          ) : <>
            {/* Summary Stats — Energy ROI + True ROI side by side */}
            <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "16px" }}>
              <div style={S.stat("#34d399")}><div style={S.sL}>Energy Savings ({cfg.forecastYears}yr)</div><div style={S.sV("#34d399")}>{fmt(forecast.summary.totalEnergySav || forecast.summary.totalSav)}</div><div style={S.sS}>reduced electricity costs</div></div>
              {cfg.payType === "finance" && (
                <div style={S.stat(forecast.summary.totalSav >= 0 ? "#38bdf8" : "#f87171")}><div style={S.sL}>Net After Finance</div><div style={S.sV(forecast.summary.totalSav >= 0 ? "#38bdf8" : "#f87171")}>{fmt(forecast.summary.totalSav)}</div><div style={S.sS}>savings minus {fmt(forecast.summary.totalPmts || 0)} repayments</div></div>
              )}
              <div style={S.stat("#fbbf24")}><div style={S.sL}>Payback</div><div style={S.sV("#fbbf24")}>{forecast.summary.breakeven ? `${(forecast.summary.breakeven / 12).toFixed(1)} yrs` : `>${cfg.forecastYears}yr`}</div><div style={S.sS}>{forecast.summary.breakeven ? `Month ${forecast.summary.breakeven}` : "Not in forecast"}</div></div>
              <div style={S.stat("#a78bfa")}><div style={S.sL}>Energy ROI ({cfg.forecastYears}yr)</div><div style={S.sV("#a78bfa")}>{pct(forecast.summary.energyROI)}</div><div style={S.sS}>energy savings vs battery cost</div></div>
              {cfg.payType === "finance" && forecast.summary.totalFinanceCost > 0 && (
                <div style={S.stat(forecast.summary.trueROI >= 0 ? "#10b981" : "#f87171")}><div style={S.sL}>True ROI ({cfg.forecastYears}yr)</div><div style={S.sV(forecast.summary.trueROI >= 0 ? "#10b981" : "#f87171")}>{pct(forecast.summary.trueROI)}</div><div style={S.sS}>after {fmt(forecast.summary.totalFinanceCost)} interest</div></div>
              )}
            </div>

            {/* Accelerated Repayment Results */}
            {accelerateRepay && accelData && accelData.summary && (
              <div style={{ ...S.card, background: "linear-gradient(135deg, rgba(16,185,129,0.08), rgba(52,211,153,0.05))", borderColor: "#10b98140" }}>
                <div style={S.cT}>Accelerated Repayment Impact</div>
                <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "16px" }}>
                  <div style={S.stat("#10b981")}><div style={S.sL}>New Payoff</div><div style={S.sV("#10b981")}>{(accelData.summary.acceleratedMonths / 12).toFixed(1)} yrs</div><div style={S.sS}>was {(accelData.summary.originalMonths / 12).toFixed(1)} yrs</div></div>
                  <div style={S.stat("#34d399")}><div style={S.sL}>Months Saved</div><div style={S.sV("#34d399")}>{accelData.summary.monthsSaved}</div><div style={S.sS}>{accelData.summary.yearsSaved} years earlier</div></div>
                  <div style={S.stat("#fbbf24")}><div style={S.sL}>Interest Saved</div><div style={S.sV("#fbbf24")}>{fmt(accelData.summary.interestSaved)}</div><div style={S.sS}>of {fmt(accelData.summary.totalInterestStandard)} total</div></div>
                  <div style={S.stat("#38bdf8")}><div style={S.sL}>Extra/month</div><div style={S.sV("#38bdf8")}>{fmt(avgMonthlySavings)}</div><div style={S.sS}>avg savings applied</div></div>
                </div>
                <ResponsiveContainer width="100%" height={250}>
                  <AreaChart data={(() => {
                    const maxLen = Math.max(accelData.standardSchedule.length, accelData.schedule.length);
                    return Array.from({ length: maxLen }, (_, i) => ({
                      month: i + 1,
                      'Standard': accelData.standardSchedule[i]?.balance || 0,
                      'Accelerated': accelData.schedule[i]?.balance || 0,
                    }));
                  })()}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                    <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} tickFormatter={v => v % 12 === 0 ? `Y${v / 12}` : ""} interval={11} />
                    <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} />
                    <Tooltip content={<TT />} />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <Area type="monotone" dataKey="Standard" stroke="#f87171" fill="#f8717120" strokeWidth={2} />
                    <Area type="monotone" dataKey="Accelerated" stroke="#10b981" fill="#10b98120" strokeWidth={2} />
                  </AreaChart>
                </ResponsiveContainer>
                <div style={{ fontSize: "11px", color: "#475569", textAlign: "center", marginTop: "4px" }}>
                  Remaining loan balance: Standard repayment vs Accelerated (with {fmt(avgMonthlySavings)}/mo extra)
                </div>
              </div>
            )}

            <div style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "8px", marginBottom: "12px" }}>
                <div style={S.cT}>Monthly Comparison</div>
                <div style={{ display: "flex", gap: "6px", alignItems: "center" }}>
                  <button style={S.tgl(chartMode === "total")} onClick={() => setChartMode("total")}>Total Cost</button>
                  <button style={S.tgl(chartMode === "energy")} onClick={() => setChartMode("energy")}>Energy Only</button>
                  <select value={viewYr} onChange={e => setViewYr(+e.target.value)}
                    style={{ ...S.inpSm, width: "auto", padding: "5px 8px", textAlign: "left" }}>
                    {Array.from({ length: cfg.forecastYears }, (_, i) => <option key={i} value={i + 1}>Year {i + 1}</option>)}
                  </select>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={forecast.monthly.filter(d => d.year === viewYr)} barGap={2} barCategoryGap="18%">
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="label" tick={{ fill: "#64748b", fontSize: 11 }} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${v}`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="noBattery" name="Current Bill" fill="#f87171" radius={[3, 3, 0, 0]} />
                  <Bar dataKey={chartMode === "total" ? "totalCost" : "energyOnly"}
                    name={chartMode === "total" ? "Total (energy + battery)" : "Energy Bill (w/ battery)"}
                    fill="#34d399" radius={[3, 3, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
              <div style={{ fontSize: "11px", color: "#475569", textAlign: "center", marginTop: "6px" }}>
                {chartMode === "total"
                  ? `Total includes energy bill${cfg.payType === "finance" ? " + finance" : ""}${cfg.useAmber ? " \u2212 Amber earnings + $25/mo" : ""}`
                  : "Energy Only = power bill with battery, excluding battery purchase/finance"}
              </div>
            </div>

            <div style={S.card}>
              <div style={S.cT}>Annual Summary</div>
              <ResponsiveContainer width="100%" height={260}>
                <BarChart data={forecast.annual} barGap={2} barCategoryGap="22%">
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="year" tick={{ fill: "#64748b", fontSize: 11 }} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${(v / 1000).toFixed(1)}k`} />
                  <Tooltip content={<TT />} /><Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="noBattery" name="Without Battery" fill="#f87171" radius={[3, 3, 0, 0]} />
                  <Bar dataKey="energyOnly" name="Energy (w/ battery)" fill="#34d399" radius={[3, 3, 0, 0]} />
                  <Bar dataKey="saving" name="Net Saving" fill="#fbbf24" radius={[3, 3, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div style={S.card}>
              <div style={S.cT}>Cumulative Savings {cfg.payType === "upfront" ? "(after upfront cost)" : "(incl. finance)"}</div>
              <ResponsiveContainer width="100%" height={260}>
                <AreaChart data={forecast.cumData}>
                  <defs><linearGradient id="gn" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stopColor="#34d399" stopOpacity={0.25} /><stop offset="100%" stopColor="#34d399" stopOpacity={0.02} />
                  </linearGradient></defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} tickFormatter={v => v % 12 === 0 ? `Y${v / 12}` : ""} interval={0} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${(v / 1000).toFixed(1)}k`} />
                  <Tooltip content={({ active, payload }) => {
                    if (!active || !payload?.length) return null;
                    const d = payload[0].payload;
                    return <div style={{ background: "#1e293b", border: "1px solid #334155", borderRadius: "8px", padding: "10px", fontSize: "12px" }}>
                      <div style={{ fontWeight: 600, color: "#e2e8f0", marginBottom: 3 }}>{d.label}</div>
                      <div style={{ color: d.cumSav >= 0 ? "#34d399" : "#f87171", fontWeight: 500 }}>{d.cumSav >= 0 ? "+" : ""}{fmt(d.cumSav)}</div>
                    </div>;
                  }} />
                  <ReferenceLine y={0} stroke="#fbbf24" strokeDasharray="6 4" strokeWidth={2}
                    label={{ value: "Break Even", fill: "#fbbf24", fontSize: 11, position: "right" }} />
                  <Area type="monotone" dataKey="cumSav" stroke="#34d399" strokeWidth={2} fill="url(#gn)" />
                </AreaChart>
              </ResponsiveContainer>
              {cfg.payType === "upfront" && <div style={{ fontSize: "11px", color: "#475569", textAlign: "center", marginTop: "4px" }}>
                Starts at \u2212{fmt(netCost)}, accumulates monthly savings until breakeven
              </div>}
            </div>

            {/* Lifetime Cost Comparison Chart */}
            {lifetimeCostData && lifetimeCostData.length > 0 && (
              <div style={S.card}>
                <div style={S.cT}>Lifetime Cost Comparison ({lifetimeCostData.length} years)</div>
                <ResponsiveContainer width="100%" height={320}>
                  <LineChart data={lifetimeCostData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                    <XAxis dataKey="label" tick={{ fill: "#64748b", fontSize: 10 }} interval={Math.max(0, Math.floor(lifetimeCostData.length / 10) - 1)} />
                    <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} />
                    <Tooltip content={({ active, payload, label }) => {
                      if (!active || !payload?.length) return null;
                      return <div style={{ background: "#1e293b", border: "1px solid #334155", borderRadius: "8px", padding: "10px 14px", fontSize: "12px" }}>
                        <div style={{ fontWeight: 600, marginBottom: 6, color: "#e2e8f0" }}>{label}</div>
                        {payload.map((p, i) => <div key={i} style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                          <div style={{ width: 8, height: 8, borderRadius: 2, background: p.color, flexShrink: 0 }} />
                          <span style={{ color: "#94a3b8" }}>{p.name}:</span>
                          <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{fmt(p.value)}</span>
                        </div>)}
                      </div>;
                    }} />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <Line type="monotone" dataKey="No Battery" stroke="#f87171" strokeWidth={2} dot={false} />
                    <Line type="monotone" dataKey="Battery (Upfront)" stroke="#34d399" strokeWidth={2} dot={false} />
                    <Line type="monotone" dataKey="Battery (Financed)" stroke="#a78bfa" strokeWidth={2} dot={false} />
                    <Line type="monotone" dataKey="Battery (Accelerated)" stroke="#10b981" strokeWidth={2} dot={false} strokeDasharray="5 3" />
                  </LineChart>
                </ResponsiveContainer>
                <div style={{ fontSize: "11px", color: "#475569", textAlign: "center", marginTop: "6px" }}>
                  Crossover points show when battery options become cheaper than no battery. Lower is better.
                </div>
              </div>
            )}

            {/* Annual Breakdown Table with Degradation column */}
            <div style={{ ...S.card, overflowX: "auto" }}>
              <div style={S.cT}>Annual Breakdown</div>
              <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "12px", minWidth: "600px" }}>
                <thead><tr>
                  <th style={{ ...S.th, textAlign: "left" }}>Year</th>
                  <th style={S.th}>No Battery</th>
                  <th style={S.th}>Energy Only</th>
                  {cfg.payType === "finance" && <th style={S.th}>Battery Pmt</th>}
                  <th style={S.th}>Total w/ Battery</th>
                  {cfg.payType === "finance" && <th style={S.th}>Energy Saving</th>}
                  <th style={S.th}>{cfg.payType === "finance" ? "Net Saving" : "Annual Saving"}</th>
                  <th style={{ ...S.th, color: "#fb923c" }}>Capacity</th>
                </tr></thead>
                <tbody>
                  {forecast.annual.map((a, i) => {
                    const degradPct = Math.round((1 - 0.02 * i) * 100);
                    return (
                    <tr key={i} style={{ background: i % 2 ? "rgba(10,15,26,0.3)" : "transparent" }}>
                      <td style={{ ...S.td, fontWeight: 500, textAlign: "left" }}>{a.year}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#f87171" }}>{fmt(a.noBattery)}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#34d399" }}>{fmt(a.energyOnly)}</td>
                      {cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right", color: "#fbbf24" }}>{fmt(a.batteryPmt)}</td>}
                      <td style={{ ...S.td, textAlign: "right", color: "#e2e8f0", fontWeight: 500 }}>{fmt(a.totalCost)}</td>
                      {cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge("#34d399")}>+{fmt(a.energySaving)}</span></td>}
                      <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge(a.saving > 0 ? "#34d399" : "#f87171")}>{a.saving > 0 ? "+" : ""}{fmt(a.saving)}</span></td>
                      <td style={{ ...S.td, textAlign: "right", color: degradPct >= 90 ? "#34d399" : degradPct >= 80 ? "#fbbf24" : "#fb923c", fontSize: "11px" }}>{degradPct}%</td>
                    </tr>
                    );
                  })}
                </tbody>
                <tfoot><tr style={{ borderTop: "2px solid #1e293b" }}>
                  <td style={{ ...S.td, fontWeight: 700, color: "#fbbf24", textAlign: "left" }}>TOTAL</td>
                  <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#f87171" }}>{fmt(forecast.summary.totalNB)}</td>
                  <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#34d399" }}>{fmt(forecast.annual.reduce((s, a) => s + a.energyOnly, 0))}</td>
                  {cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#fbbf24" }}>{fmt(forecast.annual.reduce((s, a) => s + a.batteryPmt, 0))}</td>}
                  <td style={{ ...S.td, textAlign: "right", fontWeight: 600, color: "#e2e8f0" }}>{fmt(forecast.annual.reduce((s, a) => s + a.totalCost, 0))}</td>
                  {cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right", fontWeight: 600 }}><span style={S.badge("#34d399")}>+{fmt(forecast.summary.totalEnergySav || forecast.summary.totalSav)}</span></td>}
                  <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge(forecast.summary.totalSav >= 0 ? "#34d399" : "#f87171")}>{forecast.summary.totalSav >= 0 ? "+" : ""}{fmt(forecast.summary.totalSav)}</span></td>
                  <td style={{ ...S.td, textAlign: "right", color: "#64748b", fontSize: "10px" }}>\u22122%/yr</td>
                </tr></tfoot>
              </table>
            </div>

            <div style={{ ...S.card, overflowX: "auto" }}>
              <div style={S.cT}>Monthly Detail \u2014 Year {viewYr}</div>
              <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "11px", minWidth: "550px" }}>
                <thead><tr>
                  <th style={{ ...S.th, textAlign: "left" }}>Month</th>
                  <th style={{ ...S.th, color: "#f87171" }}>Current</th>
                  <th style={{ ...S.th, color: "#34d399" }}>w/ Battery</th>
                  {cfg.payType === "finance" && <th style={{ ...S.th, color: "#fbbf24" }}>Batt Pmt</th>}
                  <th style={S.th}>Total</th>
                  {cfg.useAmber && <th style={{ ...S.th, color: "#f59e0b" }}>Amber $</th>}
                  <th style={S.th}>Saving</th>
                  <th style={{ ...S.th, color: "#fb923c" }}>Cap %</th>
                </tr></thead>
                <tbody>
                  {forecast.monthly.filter(d => d.year === viewYr).map((d, i) => (
                    <tr key={i} style={{ background: i % 2 ? "rgba(10,15,26,0.3)" : "transparent" }}>
                      <td style={{ ...S.td, fontWeight: 500, textAlign: "left" }}>{d.label}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#f87171" }}>{fmt(d.noBattery)}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#34d399" }}>{fmt(d.energyOnly)}</td>
                      {cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right", color: "#fbbf24" }}>{fmt(d.batteryPmt)}</td>}
                      <td style={{ ...S.td, textAlign: "right", fontWeight: 500 }}>{fmt(d.totalCost)}</td>
                      {cfg.useAmber && <td style={{ ...S.td, textAlign: "right", color: "#f59e0b" }}>{d.amberBonus > 0 ? fmt(d.amberBonus) : "\u2014"}</td>}
                      <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge(d.saving > 0 ? "#34d399" : "#f87171")}>{d.saving > 0 ? "+" : ""}{fmt(d.saving)}</span></td>
                      <td style={{ ...S.td, textAlign: "right", color: "#fb923c", fontSize: "10px" }}>{d.degradation}%</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div style={{ ...S.card, borderColor: "#141e30" }}>
              <div style={{ ...S.cT, color: "#475569", fontSize: "11px" }}>Assumptions</div>
              <div style={{ fontSize: "11px", color: "#475569", lineHeight: 1.6 }}>
                <p style={{ margin: "0 0 4px" }}>Battery reduction per tariff: Peak (25-80%), Off-Peak (15-55%), Solar Sponge (variable), Feed-In export (25-65%) \u2014 seasonally adjusted for Adelaide</p>
                <p style={{ margin: "0 0 4px" }}>Battery degradation: 2% per year capacity loss applied to all savings calculations</p>
                <p style={{ margin: "0 0 4px" }}>Forecast uses your latest rate period as base, with {cfg.escalation}% annual escalation on import rates and supply charges</p>
                {rateSets.length > 1 && <p style={{ margin: "0 0 4px" }}>{rateSets.length} rate periods defined \u2014 forecast escalation starts from the most recent period's rates</p>}
                {cfg.useAmber && <>
                  <p style={{ margin: "0 0 4px" }}>Amber: wholesale FiT avg {(cfg.amberFitAvg * 100).toFixed(0)}\u00A2/kWh, {pct(cfg.amberImportDisc * 100)} import discount, $25/mo subscription included</p>
                  <p style={{ margin: "0 0 4px" }}>Amber spike earnings are estimates \u2014 actual results depend on weather, demand, and market conditions</p>
                </>}
                {cfg.payType === "finance" && <p style={{ margin: "0 0 4px" }}>True ROI accounts for total finance interest of {fmt(forecast.summary.totalFinanceCost || 0)}</p>}
                <p style={{ margin: 0 }}>This is an estimate only \u2014 not financial advice. Actual results depend on usage patterns, weather, and tariff changes.</p>
              </div>
            </div>
          </>}
    </>)}
  </>);
}


/* Tab 2: Performance — Historical ROI data, charts, daily explorer */

function AnalysisTab({ historicalData, historicalLoading, historicalError, analysisSubView, setAnalysisSubView, selectedDate, setSelectedDate, viewMode, setViewMode, roiMode, purchaseDate, cfg, netCost, monthlyPmt, forecast, financeOverride, annualBill, blendedRates, fmt, fmt2, pct, MO, liveDataLoaded, liveMonthCount }) {
  const [dateRange, setDateRange] = React.useState('all');
  return (<>
          {/* Sub-navigation pills */}
          <div style={{ display: "flex", gap: "6px", marginBottom: "16px", flexWrap: "wrap" }}>
            {[
              { key: 'monthly', label: 'Monthly Overview' },
              { key: 'daily', label: 'Daily Explorer' },
            ].map(v => (
              <button key={v.key} onClick={() => setAnalysisSubView(v.key)}
                style={{ padding: "7px 16px", borderRadius: "20px", border: analysisSubView === v.key ? "1px solid #f59e0b" : "1px solid #334155",
                  background: analysisSubView === v.key ? "rgba(245,158,11,0.15)" : "transparent",
                  color: analysisSubView === v.key ? "#fbbf24" : "#94a3b8", fontSize: "12px", fontWeight: 600, cursor: "pointer", transition: "all 0.2s" }}>
                {v.label}
              </button>
            ))}
          </div>

          {analysisSubView === 'monthly' && <>
          {historicalLoading && (
            <div style={{ ...S.card, textAlign: "center", padding: "40px" }}>
              <div style={{ fontSize: "40px", marginBottom: "10px" }}>⏳</div>
              <div style={{ fontSize: "14px", color: "#94a3b8" }}>Loading historical analysis...</div>
            </div>
          )}

          {historicalError && (
            <div style={{ ...S.card, textAlign: "center", padding: "40px" }}>
              <div style={{ fontSize: "40px", marginBottom: "10px" }}>📊</div>
              <div style={{ fontSize: "14px", color: "#94a3b8", marginBottom: "8px" }}>Historical ROI analysis data not found</div>
              <div style={{ fontSize: "12px", color: "#64748b" }}>Run battery_roi_analysis_v2.py to generate the analysis</div>
            </div>
          )}

          {!historicalLoading && !historicalError && historicalData && (() => {

          const allMonthly = historicalData.monthly_results;
          const annual = historicalData.annual_no_sharer;
          const batterySpec = { ...historicalData.battery_spec, usable_kwh: cfg.usableCapacity };

          // Actual purchase mode uses cfg from Battery tab
          const isActual = roiMode === 'actual';
          const effectiveNetCost = isActual ? netCost : batterySpec.net_cost;
          const effectiveMonthlyPmt = isActual && cfg.payType === "finance" ? monthlyPmt : 0;
          const totalFinanceCost = isActual && cfg.payType === "finance" ? (effectiveMonthlyPmt * cfg.financeTerm * 12) : 0;
          const totalInterest = totalFinanceCost - effectiveNetCost;

          // Filter monthly data from purchase date in actual mode
          // Normalize "YYYY-M" to "YYYY-MM" for reliable comparison
          const padMonth = (ym) => { const [y, m] = ym.split('-'); return `${y}-${m.padStart(2, '0')}`; };
          const purchaseYM = purchaseDate ? purchaseDate.slice(0, 7) : HISTORICAL_FIRST_DATE.slice(0, 7);
          const filteredMonthly = isActual
            ? allMonthly.filter(m => padMonth(m.month) >= purchaseYM)
            : allMonthly;
          const preRangeMonthly = filteredMonthly.length > 0 ? filteredMonthly : allMonthly;

          // Apply date range filter
          const rangeFilteredMonthly = (() => {
            if (dateRange === 'all') return preRangeMonthly;
            const now = new Date();
            const months = dateRange === '6mo' ? 6 : 12;
            const cutoff = new Date(now.getFullYear(), now.getMonth() - months + 1, 1);
            const cutoffStr = cutoff.toISOString().slice(0, 7);
            return preRangeMonthly.filter(m => {
              const pm = m.month.length === 6 ? m.month.slice(0, 5) + '0' + m.month.slice(5) : m.month;
              return pm >= cutoffStr;
            });
          })();
          const monthly = rangeFilteredMonthly.length > 0 ? rangeFilteredMonthly : preRangeMonthly;

          // Date range label
          const firstMonth = monthly[0]?.month || '';
          const lastMonth = monthly[monthly.length - 1]?.month || '';
          const formatRangeMonth = (ym) => {
            if (!ym) return '';
            const [y, m] = ym.split('-');
            const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            return `${names[parseInt(m) - 1]} ${y}`;
          };
          const rangeLabel = `${formatRangeMonth(firstMonth)} – ${formatRangeMonth(lastMonth)} (${monthly.length} months)`;

          // Format month labels
          const monthLabels = monthly.map(m => {
            const [year, month] = m.month.split('-');
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${monthNames[parseInt(month) - 1]} ${year.slice(2)}`;
          });

          // Prepare data for charts
          const costComparisonData = monthly.map((m, i) => ({
            month: monthLabels[i],
            'Without Battery': Math.round(m.cost_no_battery),
            'With Battery': Math.round(m.cost_with_battery + effectiveMonthlyPmt),
            savings: Math.round(m.savings - effectiveMonthlyPmt)
          }));

          const savingsData = monthly.map((m, i) => ({
            month: monthLabels[i],
            'Monthly Savings': Math.round(m.savings - effectiveMonthlyPmt)
          }));

          const solarConsumptionData = monthly.map((m, i) => ({
            month: monthLabels[i],
            'Solar Generation': Math.round(m.solar_total),
            'Consumption': Math.round(m.consumption)
          }));

          // Calculate cumulative savings for payback chart
          const startingCum = (isActual && cfg.payType === "finance") ? 0 : -effectiveNetCost;
          let cumSavings = startingCum;
          const cumulativeData = monthly.map((m, i) => {
            cumSavings += (m.savings - effectiveMonthlyPmt);
            return {
              month: i + 1,
              label: monthLabels[i],
              'Cumulative Savings': Math.round(cumSavings)
            };
          });

          // Ideal baseline comparison (Deliverable 4)
          const idealBaseline = historicalData.daily_results
            ? computeIdealBaseline(historicalData.daily_results, batterySpec.usable_kwh, monthly)
            : null;

          const monthCount = monthly.length || 1;
          const totalSavings = monthly.reduce((sum, m) => sum + m.savings, 0);
          const annualizedSavings = (totalSavings / monthCount) * 12;
          const effectiveAnnualSavings = annualizedSavings - (effectiveMonthlyPmt * 12);
          const avgSavings = effectiveAnnualSavings / 12;
          const effectivePaybackYears = effectiveAnnualSavings > 0 ? effectiveNetCost / effectiveAnnualSavings : Infinity;
          const paybackMonths = effectivePaybackYears * 12;
          const monthsSincePurchase = monthly.length;
          const totalSavedSoFar = totalSavings - (effectiveMonthlyPmt * monthsSincePurchase);

          return <>
            {/* Analysis Mode Info */}
            <div style={{ marginBottom: "16px", fontSize: "11px", color: "#64748b", padding: "8px 12px", background: "rgba(15,23,42,0.4)", borderRadius: "8px", border: "1px solid #1e293b" }}>
              {isActual
                ? `Real payback tracking from ${new Date(purchaseDate).toLocaleDateString('en-AU', { month: 'short', year: 'numeric' })} — ${cfg.payType === "finance" ? `${fmt(monthlyPmt)}/mo${financeOverride ? ` (${financeOverride.name})` : ` over ${cfg.financeTerm}yr at ${cfg.financeRate}%`}` : `${fmt(effectiveNetCost)} paid upfront`} — ${monthsSincePurchase} months of data`
                : `What-if analysis from ${new Date(purchaseDate).toLocaleDateString('en-AU', { month: 'short', year: 'numeric' })} — change install date in header`
              }
            </div>

            {/* Date Range Filter + Live Data Indicator */}
            <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "12px", flexWrap: "wrap" }}>
              <div style={{ display: "flex", gap: "4px" }}>
                {[
                  { key: '6mo', label: 'Last 6mo' },
                  { key: '12mo', label: 'Last 12mo' },
                  { key: 'all', label: 'All Time' },
                ].map(r => (
                  <button key={r.key} onClick={() => setDateRange(r.key)}
                    style={{ padding: "4px 12px", borderRadius: "14px", border: dateRange === r.key ? "1px solid #38bdf8" : "1px solid #334155",
                      background: dateRange === r.key ? "rgba(56,189,248,0.15)" : "transparent",
                      color: dateRange === r.key ? "#38bdf8" : "#64748b", fontSize: "11px", fontWeight: 600, cursor: "pointer", transition: "all 0.2s" }}>
                    {r.label}
                  </button>
                ))}
              </div>
              <div style={{ fontSize: "11px", color: "#475569", marginLeft: "auto" }}>
                {rangeLabel}
              </div>
              {liveDataLoaded && (
                <div style={{ fontSize: "10px", color: "#34d399", padding: "3px 8px", borderRadius: "10px", background: "rgba(52,211,153,0.1)", border: "1px solid rgba(52,211,153,0.2)" }}>
                  Live data merged — {liveMonthCount} months total
                </div>
              )}
            </div>

            {/* Summary Stats */}
            <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "16px" }}>
              <div style={S.stat("#34d399")}>
                <div style={S.sL}>{isActual ? "Net Annual Savings" : "Annual Savings"}</div>
                <div style={S.sV("#34d399")}>{fmt(effectiveAnnualSavings)}</div>
                <div style={S.sS}>{isActual && cfg.payType === "finance" ? "after finance repayments" : `${Math.round((annual.savings / annual.cost_no_battery) * 100)}% cost reduction`}</div>
              </div>
              <div style={S.stat("#fbbf24")}>
                <div style={S.sL}>{isActual ? "True Payback" : "Payback Period"}</div>
                <div style={S.sV("#fbbf24")}>{effectivePaybackYears === Infinity ? "N/A" : `${effectivePaybackYears.toFixed(1)} yrs`}</div>
                <div style={S.sS}>{effectivePaybackYears === Infinity ? "Costs exceed savings" : `${Math.round(paybackMonths)} months`}</div>
              </div>
              <div style={S.stat("#38bdf8")}>
                <div style={S.sL}>Monthly Average</div>
                <div style={S.sV("#38bdf8")}>{fmt(avgSavings)}</div>
                <div style={S.sS}>{isActual && cfg.payType === "finance" ? "net of repayments" : "consistent savings"}</div>
              </div>
              <div style={S.stat("#a78bfa")}>
                <div style={S.sL}>{isActual ? "Your Battery Cost" : "Battery Investment"}</div>
                <div style={S.sV("#a78bfa")}>{fmt(effectiveNetCost)}</div>
                <div style={S.sS}>{isActual ? `${fmt(cfg.batteryCost)} - ${fmt(cfg.repsRebate)} rebate` : `${batterySpec.capacity_kwh} kWh system`}</div>
              </div>
              {isActual && cfg.payType === "finance" && <>
                <div style={S.stat("#f87171")}>
                  <div style={S.sL}>Monthly Payment</div>
                  <div style={S.sV("#f87171")}>{fmt(effectiveMonthlyPmt)}</div>
                  <div style={S.sS}>{cfg.financeTerm}yr at {cfg.financeRate}%</div>
                </div>
                <div style={S.stat("#fb923c")}>
                  <div style={S.sL}>Total Interest</div>
                  <div style={S.sV("#fb923c")}>{fmt(totalInterest)}</div>
                  <div style={S.sS}>total repaid: {fmt(totalFinanceCost)}</div>
                </div>
              </>}
              {isActual && <>
                <div style={S.stat("#10b981")}>
                  <div style={S.sL}>Saved So Far</div>
                  <div style={S.sV(totalSavedSoFar >= 0 ? "#10b981" : "#f87171")}>{fmt(totalSavedSoFar)}</div>
                  <div style={S.sS}>{monthsSincePurchase} months since purchase</div>
                </div>
                <div style={S.stat("#e879f9")}>
                  <div style={S.sL}>Remaining to Break Even</div>
                  <div style={S.sV("#e879f9")}>{(startingCum + totalSavedSoFar) >= 0 ? "Paid off!" : fmt(Math.abs(startingCum + totalSavedSoFar))}</div>
                  <div style={S.sS}>{(startingCum + totalSavedSoFar) >= 0 ? "Investment recovered" : `of ${fmt(effectiveNetCost)} investment`}</div>
                </div>
              </>}
            </div>

            {/* Monthly Cost Comparison Chart */}
            <div style={S.card}>
              <div style={S.cT}>Monthly Cost Comparison{isActual && cfg.payType === "finance" ? " (incl. finance)" : ""}</div>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={costComparisonData} barGap={4} barCategoryGap="15%">
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} angle={-45} textAnchor="end" height={80} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${v}`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="Without Battery" fill="#f87171" radius={[3, 3, 0, 0]} />
                  <Bar dataKey="With Battery" fill="#34d399" radius={[3, 3, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Monthly Savings Chart */}
            <div style={S.card}>
              <div style={S.cT}>{isActual ? "Monthly Net Savings (after finance)" : "Monthly Savings with Battery"}</div>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={savingsData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} angle={-45} textAnchor="end" height={80} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${v}`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="Monthly Savings" fill="#fbbf24" radius={[3, 3, 0, 0]} />
                  <ReferenceLine y={avgSavings} stroke="#f87171" strokeDasharray="3 3" label={{ value: `Avg: $${Math.round(avgSavings)}`, fill: "#f87171", fontSize: 11 }} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Cumulative Savings & Payback */}
            <div style={S.card}>
              <div style={S.cT}>Cumulative Savings & Payback Timeline{isActual ? ` (${cfg.payType === "finance" ? "financed" : "upfront"})` : ""}</div>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={cumulativeData}>
                  <defs>
                    <linearGradient id="savingsGradient" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#34d399" stopOpacity={0.8}/>
                      <stop offset="95%" stopColor="#34d399" stopOpacity={0.1}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="label" tick={{ fill: "#64748b", fontSize: 10 }} angle={-45} textAnchor="end" height={80} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${v}`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <ReferenceLine y={0} stroke="#f87171" strokeWidth={2} strokeDasharray="5 5" label={{ value: 'Break-even', fill: "#f87171", fontSize: 11 }} />
                  <Area type="monotone" dataKey="Cumulative Savings" stroke="#34d399" strokeWidth={2} fillOpacity={1} fill="url(#savingsGradient)" />
                </AreaChart>
              </ResponsiveContainer>
              <div style={{ marginTop: "12px", fontSize: "12px", color: "#94a3b8", textAlign: "center" }}>
                {cumulativeData.length === 0
                  ? "No data available for selected date range"
                  : cumulativeData[cumulativeData.length - 1]['Cumulative Savings'] >= 0
                    ? `✓ Investment recovered! Currently ${fmt(cumulativeData[cumulativeData.length - 1]['Cumulative Savings'])} in profit`
                    : `${fmt(Math.abs(cumulativeData[cumulativeData.length - 1]['Cumulative Savings']))} remaining to break even`}
              </div>
            </div>

            {/* Fresh Battery Baseline Comparison (Deliverable 4) */}
            {idealBaseline && idealBaseline.data.length > 0 && (
              <div style={S.card}>
                <div style={S.cT}>Actual vs Ideal Battery Performance (100% Capacity from Day 1)</div>
                <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "12px" }}>
                  <div style={S.stat("#34d399")}><div style={S.sL}>Actual Savings</div><div style={S.sV("#34d399")}>{fmt(idealBaseline.totalActual)}</div><div style={S.sS}>{idealBaseline.data.length} days</div></div>
                  <div style={S.stat("#38bdf8")}><div style={S.sL}>Ideal Savings</div><div style={S.sV("#38bdf8")}>{fmt(idealBaseline.totalIdeal)}</div><div style={S.sS}>100% capacity from day 1</div></div>
                  <div style={S.stat("#fb923c")}><div style={S.sL}>Left on Table</div><div style={S.sV("#fb923c")}>{fmt(idealBaseline.moneyLeftOnTable)}</div><div style={S.sS}>ramp-up + seasonal loss</div></div>
                </div>
                <ResponsiveContainer width="100%" height={300}>
                  <AreaChart data={(() => {
                    // Sample every Nth point for readability
                    const d = idealBaseline.data;
                    const step = d.length > 200 ? Math.floor(d.length / 100) : d.length > 60 ? 3 : 1;
                    return d.filter((_, i) => i % step === 0 || i === d.length - 1).map(p => ({
                      day: p.dayIndex,
                      label: p.date,
                      'Actual': p.cumActual,
                      'Ideal (100%)': p.cumIdeal,
                    }));
                  })()}>
                    <defs>
                      <linearGradient id="idealGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#38bdf8" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#38bdf8" stopOpacity={0.02}/>
                      </linearGradient>
                      <linearGradient id="actualGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#34d399" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#34d399" stopOpacity={0.02}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                    <XAxis dataKey="day" tick={{ fill: "#64748b", fontSize: 10 }} tickFormatter={v => v % 30 === 0 ? `D${v}` : ""} interval={0} />
                    <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `$${Math.round(v)}`} />
                    <Tooltip content={({ active, payload }) => {
                      if (!active || !payload?.length) return null;
                      const d = payload[0].payload;
                      return <div style={{ background: "#1e293b", border: "1px solid #334155", borderRadius: "8px", padding: "10px", fontSize: "12px" }}>
                        <div style={{ fontWeight: 600, color: "#e2e8f0", marginBottom: 4 }}>{d.label}</div>
                        {payload.map((p, i) => <div key={i} style={{ color: p.color, marginBottom: 2 }}>{p.name}: {fmt(p.value)}</div>)}
                        <div style={{ color: "#fb923c", marginTop: 4, fontWeight: 500 }}>Gap: {fmt(d['Ideal (100%)'] - d['Actual'])}</div>
                      </div>;
                    }} />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <Area type="monotone" dataKey="Ideal (100%)" stroke="#38bdf8" strokeWidth={2} fill="url(#idealGrad)" strokeDasharray="5 3" />
                    <Area type="monotone" dataKey="Actual" stroke="#34d399" strokeWidth={2} fill="url(#actualGrad)" />
                  </AreaChart>
                </ResponsiveContainer>
                <div style={{ fontSize: "11px", color: "#475569", textAlign: "center", marginTop: "6px" }}>
                  Gap between lines = money lost to ramp-up period, partial charging, and seasonal variation. Solid = actual, dashed = ideal.
                </div>
              </div>
            )}

            {/* Solar vs Consumption */}
            <div style={S.card}>
              <div style={S.cT}>Solar Generation vs Consumption</div>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={solarConsumptionData} barGap={4}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} angle={-45} textAnchor="end" height={80} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v} kWh`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="Solar Generation" fill="#38bdf8" radius={[3, 3, 0, 0]} />
                  <Bar dataKey="Consumption" fill="#a78bfa" radius={[3, 3, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Self-Sufficiency & Cost Reduction */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(400px, 1fr))", gap: "14px" }}>
              {/* Self-Sufficiency Ratio */}
              <div style={S.card}>
                <div style={S.cT}>Solar Self-Sufficiency Ratio</div>
                <ResponsiveContainer width="100%" height={250}>
                  <AreaChart data={(() => {
                    return monthly.map((m, i) => ({
                      month: monthLabels[i],
                      'Self-Sufficiency': Math.min(100, (m.solar_total / m.consumption * 100))
                    }));
                  })()}>
                    <defs>
                      <linearGradient id="sufficiencyGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#38bdf8" stopOpacity={0.8}/>
                        <stop offset="95%" stopColor="#38bdf8" stopOpacity={0.1}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                    <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 9 }} angle={-45} textAnchor="end" height={70} />
                    <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v}%`} domain={[0, 100]} />
                    <Tooltip content={<TT />} />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <ReferenceLine y={100} stroke="#34d399" strokeDasharray="3 3" label={{ value: '100% Self-Sufficient', fill: "#34d399", fontSize: 10 }} />
                    <Area type="monotone" dataKey="Self-Sufficiency" stroke="#38bdf8" strokeWidth={2} fillOpacity={1} fill="url(#sufficiencyGradient)" />
                  </AreaChart>
                </ResponsiveContainer>
                <div style={{ marginTop: "8px", fontSize: "11px", color: "#64748b", textAlign: "center" }}>
                  Higher = more solar covering your consumption
                </div>
              </div>

              {/* Cost Reduction % */}
              <div style={S.card}>
                <div style={S.cT}>Cost Reduction with Battery</div>
                <ResponsiveContainer width="100%" height={250}>
                  <BarChart data={(() => {
                    return monthly.map((m, i) => ({
                      month: monthLabels[i],
                      'Reduction %': m.cost_no_battery > 0 ? ((m.savings / m.cost_no_battery) * 100) : 0
                    }));
                  })()}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                    <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 9 }} angle={-45} textAnchor="end" height={70} />
                    <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v}%`} />
                    <Tooltip content={<TT />} />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <Bar dataKey="Reduction %" fill="#34d399" radius={[3, 3, 0, 0]} />
                    <ReferenceLine y={50} stroke="#fbbf24" strokeDasharray="3 3" label={{ value: '50%', fill: "#fbbf24", fontSize: 10 }} />
                  </BarChart>
                </ResponsiveContainer>
                <div style={{ marginTop: "8px", fontSize: "11px", color: "#64748b", textAlign: "center" }}>
                  Average reduction: {Math.round((annual.savings / annual.cost_no_battery) * 100)}%
                </div>
              </div>
            </div>

            {/* Energy Flow Breakdown */}
            <div style={S.card}>
              <div style={S.cT}>Monthly Energy Flow Patterns</div>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={(() => {
                  return monthly.map((m, i) => {
                    const solarSelfConsumed = Math.min(m.solar_total, m.consumption);
                    const solarExported = Math.max(0, m.solar_total - m.consumption);
                    const gridImport = Math.max(0, m.consumption - m.solar_total);
                    return {
                      month: monthLabels[i],
                      'Solar Self-Consumed': Math.round(solarSelfConsumed),
                      'Solar Exported': Math.round(solarExported),
                      'Grid Import': Math.round(gridImport)
                    };
                  });
                })()}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                  <XAxis dataKey="month" tick={{ fill: "#64748b", fontSize: 10 }} angle={-45} textAnchor="end" height={80} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v} kWh`} />
                  <Tooltip content={<TT />} />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="Solar Self-Consumed" stackId="a" fill="#34d399" radius={[0, 0, 0, 0]} />
                  <Bar dataKey="Solar Exported" stackId="a" fill="#38bdf8" radius={[0, 0, 0, 0]} />
                  <Bar dataKey="Grid Import" stackId="a" fill="#f87171" radius={[3, 3, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
              <div style={{ marginTop: "12px", fontSize: "11px", color: "#64748b", padding: "0 16px" }}>
                <div style={{ display: "flex", gap: "24px", flexWrap: "wrap", justifyContent: "center" }}>
                  <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                    <div style={{ width: 12, height: 12, background: "#34d399", borderRadius: "2px" }}></div>
                    <span>Solar used directly (reduces import)</span>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                    <div style={{ width: 12, height: 12, background: "#38bdf8", borderRadius: "2px" }}></div>
                    <span>Solar exported (low feed-in rate)</span>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                    <div style={{ width: 12, height: 12, background: "#f87171", borderRadius: "2px" }}></div>
                    <span>Grid import (expensive peak/sponge)</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Seasonal Patterns Grid */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: "12px" }}>
              {(() => {
                const seasons = [
                  { name: "Summer", monthIndices: [11, 0, 1], color: "#f59e0b", emoji: "☀️" },
                  { name: "Autumn", monthIndices: [2, 3, 4], color: "#a78bfa", emoji: "🍂" },
                  { name: "Winter", monthIndices: [5, 6, 7], color: "#38bdf8", emoji: "❄️" },
                  { name: "Spring", monthIndices: [8, 9, 10], color: "#34d399", emoji: "🌸" }
                ];

                return seasons.map(season => {
                  const seasonData = monthly.filter(m => {
                    const mi = parseInt(m.month.split('-')[1]) - 1;
                    return season.monthIndices.includes(mi);
                  });
                  if (seasonData.length === 0) return null;

                  const avgSolar = seasonData.reduce((sum, m) => sum + m.solar_total, 0) / seasonData.length;
                  const avgConsumption = seasonData.reduce((sum, m) => sum + m.consumption, 0) / seasonData.length;
                  const avgSavings = seasonData.reduce((sum, m) => sum + m.savings, 0) / seasonData.length;
                  const avgSufficiency = (avgSolar / avgConsumption * 100);

                  return (
                    <div key={season.name} style={{ ...S.card, borderColor: season.color + "40" }}>
                      <div style={{ fontSize: "24px", marginBottom: "4px" }}>{season.emoji}</div>
                      <div style={{ fontSize: "13px", fontWeight: 600, color: season.color, marginBottom: "8px" }}>{season.name}</div>
                      <div style={{ fontSize: "11px", color: "#94a3b8", lineHeight: 1.6 }}>
                        <div style={{ marginBottom: "4px" }}><strong style={{ color: "#e2e8f0" }}>{Math.round(avgSolar)} kWh</strong> solar/mo</div>
                        <div style={{ marginBottom: "4px" }}><strong style={{ color: "#e2e8f0" }}>{Math.round(avgConsumption)} kWh</strong> usage/mo</div>
                        <div style={{ marginBottom: "4px" }}><strong style={{ color: "#34d399" }}>{fmt(avgSavings)}</strong> savings/mo</div>
                        <div><strong style={{ color: season.color }}>{Math.round(avgSufficiency)}%</strong> self-sufficient</div>
                      </div>
                    </div>
                  );
                });
              })()}
            </div>

            {/* Daily Charging Analysis */}
            {historicalData.daily_charging && <>
              <div style={{ ...S.card, background: "linear-gradient(135deg,rgba(245,158,11,0.08),rgba(16,185,129,0.05))", borderColor: "#fbbf2440" }}>
                <div style={{ fontSize: "16px", fontWeight: 600, color: "#fbbf24", marginBottom: "16px", display: "flex", alignItems: "center", gap: "8px" }}>
                  <span style={{ fontSize: "24px" }}>⚡</span>
                  Daily Battery Charging Analysis
                </div>

                {/* Daily Charging Stats */}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(150px, 1fr))", gap: "12px", marginBottom: "20px" }}>
                  <div style={{ ...S.card, padding: "12px", background: "rgba(15,23,42,0.6)" }}>
                    <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px", textTransform: "uppercase" }}>Days Analyzed</div>
                    <div style={{ fontSize: "24px", fontWeight: 700, color: "#e2e8f0" }}>{historicalData.daily_charging.total_days}</div>
                  </div>
                  <div style={{ ...S.card, padding: "12px", background: "rgba(15,23,42,0.6)" }}>
                    <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px", textTransform: "uppercase" }}>Days Reached Full</div>
                    <div style={{ fontSize: "24px", fontWeight: 700, color: "#34d399" }}>{historicalData.daily_charging.days_full}</div>
                    <div style={{ fontSize: "11px", color: "#64748b" }}>({historicalData.daily_charging.pct_days_full}%)</div>
                  </div>
                  <div style={{ ...S.card, padding: "12px", background: "rgba(15,23,42,0.6)" }}>
                    <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px", textTransform: "uppercase" }}>Avg Time to Full</div>
                    <div style={{ fontSize: "24px", fontWeight: 700, color: "#fbbf24" }}>{historicalData.daily_charging.avg_time_to_full}</div>
                    <div style={{ fontSize: "11px", color: "#64748b" }}>~3:46 PM</div>
                  </div>
                  <div style={{ ...S.card, padding: "12px", background: "rgba(15,23,42,0.6)" }}>
                    <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px", textTransform: "uppercase" }}>Full Charge Range</div>
                    <div style={{ fontSize: "16px", fontWeight: 700, color: "#38bdf8" }}>{historicalData.daily_charging.earliest_full}</div>
                    <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "2px" }}>to</div>
                    <div style={{ fontSize: "16px", fontWeight: 700, color: "#a78bfa" }}>{historicalData.daily_charging.latest_full}</div>
                  </div>
                </div>

                {/* Typical Daily Charging Curve */}
                <div style={S.card}>
                  <div style={S.cT}>Typical Daily Charging Curve (All Seasons Average)</div>
                  <ResponsiveContainer width="100%" height={350}>
                    <AreaChart data={(() => {
                      const hours = Object.keys(historicalData.daily_charging.hourly_soc).map(Number).sort((a,b) => a-b);
                      return hours.map(hour => ({
                        hour: `${hour}:00`,
                        'Battery SOC (kWh)': historicalData.daily_charging.hourly_soc[hour],
                        'SOC %': (historicalData.daily_charging.hourly_soc[hour] / batterySpec.usable_kwh * 100)
                      }));
                    })()}>
                      <defs>
                        <linearGradient id="dailyChargeGradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#fbbf24" stopOpacity={0.8}/>
                          <stop offset="95%" stopColor="#fbbf24" stopOpacity={0.1}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="#141e30" />
                      <XAxis dataKey="hour" tick={{ fill: "#64748b", fontSize: 11 }} />
                      <YAxis yAxisId="left" tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v.toFixed(0)} kWh`} />
                      <YAxis yAxisId="right" orientation="right" tick={{ fill: "#64748b", fontSize: 11 }} tickFormatter={v => `${v.toFixed(0)}%`} />
                      <Tooltip content={<TT />} />
                      <Legend wrapperStyle={{ fontSize: "11px" }} />
                      <ReferenceLine yAxisId="left" y={batterySpec.usable_kwh} stroke="#34d399" strokeDasharray="3 3" label={{ value: `Full (${batterySpec.usable_kwh} kWh)`, fill: "#34d399", fontSize: 10 }} />
                      <Area yAxisId="left" type="monotone" dataKey="Battery SOC (kWh)" stroke="#fbbf24" strokeWidth={3} fillOpacity={1} fill="url(#dailyChargeGradient)" />
                    </AreaChart>
                  </ResponsiveContainer>
                  <div style={{ marginTop: "12px", fontSize: "11px", color: "#64748b", textAlign: "center", lineHeight: 1.6 }}>
                    <div>Battery charging typically begins around 7-8 AM as sun rises</div>
                    <div>Peak charging occurs mid-day (10 AM - 2 PM)</div>
                    <div>On good days (Summer), battery reaches full by 3-4 PM</div>
                  </div>
                </div>

                {/* Seasonal Charging Comparison */}
                <div style={S.card}>
                  <div style={S.cT}>Seasonal Daily Charging Performance</div>
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(250px, 1fr))", gap: "14px" }}>
                    {Object.entries(historicalData.daily_charging.seasons).map(([season, data]) => {
                      const seasonEmoji = {"Summer":"☀️","Autumn":"🍂","Winter":"❄️","Spring":"🌸"}[season];
                      const seasonColor = {"Summer":"#f59e0b","Autumn":"#a78bfa","Winter":"#38bdf8","Spring":"#34d399"}[season];
                      return (
                        <div key={season} style={{ ...S.card, borderColor: seasonColor + "40", background: seasonColor + "08" }}>
                          <div style={{ fontSize: "32px", marginBottom: "8px" }}>{seasonEmoji}</div>
                          <div style={{ fontSize: "14px", fontWeight: 600, color: seasonColor, marginBottom: "12px" }}>{season}</div>
                          <div style={{ fontSize: "11px", color: "#94a3b8", lineHeight: 1.8 }}>
                            <div style={{ marginBottom: "6px", padding: "8px", background: "rgba(15,23,42,0.4)", borderRadius: "4px" }}>
                              <div style={{ fontWeight: 600, color: "#e2e8f0", marginBottom: "2px" }}>Days Reaching Full</div>
                              <div style={{ fontSize: "20px", color: data.days_full > 0 ? "#34d399" : "#f87171", fontWeight: 700 }}>
                                {data.days_full}/{data.total_days} <span style={{ fontSize: "14px" }}>({data.pct_days_full}%)</span>
                              </div>
                            </div>
                            {data.avg_time_to_full && (
                              <div style={{ marginBottom: "4px" }}>
                                <span style={{ color: "#fbbf24", fontWeight: 600 }}>⏰ {data.avg_time_to_full}</span> avg time to full
                              </div>
                            )}
                            <div style={{ marginBottom: "4px" }}>☀️ {data.avg_solar.toFixed(1)} kWh/day solar</div>
                            <div>🔋 {data.avg_max_soc.toFixed(1)} kWh max SOC ({(data.avg_max_soc/batterySpec.usable_kwh*100).toFixed(0)}%)</div>
                          </div>
                          {data.days_full === 0 && (
                            <div style={{ marginTop: "8px", padding: "6px", background: "rgba(251,191,36,0.1)", borderRadius: "4px", fontSize: "10px", color: "#fbbf24" }}>
                              💡 Solar Sharer (3 free hrs from July 2026) will help in {season.toLowerCase()}!
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Key Insights */}
                <div style={{ ...S.card, borderColor: "#141e30", background: "rgba(251,191,36,0.05)" }}>
                  <div style={{ ...S.cT, color: "#fbbf24" }}>💡 Key Daily Charging Insights</div>
                  <div style={{ fontSize: "12px", color: "#e2e8f0", lineHeight: 1.8 }}>
                    <div style={{ marginBottom: "8px" }}>• <strong style={{ color: "#34d399" }}>Summer Performance:</strong> Battery reaches full charge on 82% of days, typically by mid-afternoon (3:46 PM)</div>
                    <div style={{ marginBottom: "8px" }}>• <strong style={{ color: "#38bdf8" }}>Winter Challenge:</strong> Lower solar generation means battery only reaches 40% capacity - Solar Sharer program (from July 2026) will help offset this</div>
                    <div style={{ marginBottom: "8px" }}>• <strong style={{ color: "#a78bfa" }}>Spring/Autumn:</strong> Transitional periods with moderate charging - Spring sees 27% of days reaching full</div>
                    <div style={{ marginBottom: "8px" }}>• <strong style={{ color: "#fbbf24" }}>Charging Pattern:</strong> Most charging happens between 10 AM - 3 PM during sponge rate period (optimal timing!)</div>
                    <div>• <strong style={{ color: "#f87171" }}>Strategic Insight:</strong> From July 2026, Solar Sharer's 3 free hours (11 AM-2 PM) could help winter days reach 50-60% charge</div>
                  </div>
                </div>
              </div>
            </>}

            {/* Data Table */}
            <div style={{ ...S.card, overflowX: "auto" }}>
              <div style={S.cT}>Monthly Breakdown</div>
              <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: "12px" }}>
                <thead>
                  <tr>
                    <th style={{ ...S.th, textAlign: "left" }}>Month</th>
                    <th style={S.th}>Solar (kWh)</th>
                    <th style={S.th}>Usage (kWh)</th>
                    <th style={{ ...S.th, color: "#f87171" }}>Cost (No Batt)</th>
                    <th style={{ ...S.th, color: "#34d399" }}>Cost (w/ Batt)</th>
                    {isActual && cfg.payType === "finance" && <th style={{ ...S.th, color: "#fb923c" }}>Finance</th>}
                    <th style={{ ...S.th, color: "#fbbf24" }}>{isActual ? "Net Savings" : "Savings"}</th>
                  </tr>
                </thead>
                <tbody>
                  {monthly.map((m, i) => (
                    <tr key={i} style={{ background: i % 2 ? "rgba(10,15,26,0.3)" : "transparent" }}>
                      <td style={{ ...S.td, textAlign: "left", fontWeight: 500 }}>{monthLabels[i]}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#38bdf8" }}>{Math.round(m.solar_total)}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#a78bfa" }}>{Math.round(m.consumption)}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#f87171" }}>{fmt2(m.cost_no_battery)}</td>
                      <td style={{ ...S.td, textAlign: "right", color: "#34d399" }}>{fmt2(m.cost_with_battery)}</td>
                      {isActual && cfg.payType === "finance" && <td style={{ ...S.td, textAlign: "right", color: "#fb923c" }}>{fmt2(effectiveMonthlyPmt)}</td>}
                      <td style={{ ...S.td, textAlign: "right" }}><span style={S.badge(m.savings - effectiveMonthlyPmt >= 0 ? "#fbbf24" : "#f87171")}>{fmt2(m.savings - effectiveMonthlyPmt)}</span></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Notes */}
            <div style={{ ...S.card, borderColor: "#141e30" }}>
              <div style={{ ...S.cT, color: "#475569", fontSize: "11px" }}>Analysis Notes</div>
              <div style={{ fontSize: "11px", color: "#475569", lineHeight: 1.6 }}>
                <p style={{ margin: "0 0 4px" }}>• Based on actual solar generation data from {monthly[0].month} to {monthly[monthly.length - 1].month}</p>
                <p style={{ margin: "0 0 4px" }}>• Battery simulation assumes optimal charge/discharge timing during peak and sponge rate periods</p>
                <p style={{ margin: "0 0 4px" }}>• Solar Sharer benefit (3 free hours daily) starts July 1st 2026 - not yet reflected in historical data</p>
                <p style={{ margin: "0 0 4px" }}>• Consumption patterns estimated from billing data and distributed across time periods</p>
                <p style={{ margin: 0 }}>• Actual results may vary based on usage patterns, weather, and tariff changes</p>
              </div>
            </div>
          </>;
          })()}
          </>}

          {/* ─── Sub-view: Daily Explorer ─── */}
          {analysisSubView === 'daily' && <>
          {!historicalData || !historicalData.daily_results ? (
            <div style={{ padding: "20px", textAlign: "center", color: "#64748b" }}>
              Loading daily data...
            </div>
          ) : (() => {
            const dailyResults = historicalData.daily_results;
            const batterySpec = { ...historicalData.battery_spec, usable_kwh: cfg.usableCapacity };

          // Find the selected day's data
          const selectedDay = dailyResults.find(d => d.date === selectedDate);

          // Get week data (7 days starting from selected date)
          const getWeekData = () => {
            const startIdx = dailyResults.findIndex(d => d.date === selectedDate);
            if (startIdx === -1) return [];
            return dailyResults.slice(startIdx, startIdx + 7);
          };

          const weekData = viewMode === 'week' ? getWeekData() : [];

          // Calculate stats
          const avgSolarAllDays = dailyResults.reduce((sum, d) => sum + d.total_solar_kwh, 0) / dailyResults.length;
          const avgMaxSOC = dailyResults.reduce((sum, d) => sum + d.max_battery_soc_kwh, 0) / dailyResults.length;

          return <>
            <div style={{ marginBottom: "20px" }}>
              <div style={{ fontSize: "18px", fontWeight: 700, color: "#e2e8f0", marginBottom: "6px" }}>
                📅 Daily Battery Performance Details
              </div>
              <div style={{ fontSize: "12px", color: "#64748b" }}>
                Explore detailed charging patterns for any day or week from your historical solar data
              </div>
            </div>

            {/* Date Selector & View Mode */}
            <div style={{ display: "flex", gap: "12px", marginBottom: "24px", flexWrap: "wrap", alignItems: "center" }}>
              <div>
                <label style={{ fontSize: "11px", color: "#94a3b8", marginBottom: "4px", display: "block" }}>Select Date</label>
                <div style={{ display: "flex", gap: "6px", alignItems: "center" }}>
                  <input
                    type="date"
                    value={selectedDate || ''}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    style={{
                      padding: "8px 12px",
                      border: "1px solid #334155",
                      borderRadius: "6px",
                      background: "#0f172a",
                      color: "#e2e8f0",
                      fontSize: "13px"
                    }}
                  />
                  <button
                    onClick={() => {
                      const today = new Date().toISOString().split('T')[0];
                      const dr = historicalData?.daily_results;
                      if (dr && dr.length > 0) {
                        const lastDate = dr[dr.length - 1].date;
                        setSelectedDate(today <= lastDate ? today : lastDate);
                      } else {
                        setSelectedDate(today);
                      }
                    }}
                    style={{
                      padding: "8px 14px",
                      border: "1px solid #334155",
                      borderRadius: "6px",
                      background: "#1e293b",
                      color: "#94a3b8",
                      fontSize: "12px",
                      fontWeight: 600,
                      cursor: "pointer",
                      whiteSpace: "nowrap"
                    }}
                  >
                    Today
                  </button>
                </div>
              </div>

              <div>
                <label style={{ fontSize: "11px", color: "#94a3b8", marginBottom: "4px", display: "block" }}>View Mode</label>
                <div style={{ display: "flex", gap: "4px", background: "#0f172a", padding: "4px", borderRadius: "6px", border: "1px solid #334155" }}>
                  <button
                    onClick={() => setViewMode('day')}
                    style={{
                      padding: "6px 16px",
                      border: "none",
                      borderRadius: "4px",
                      background: viewMode === 'day' ? '#3b82f6' : 'transparent',
                      color: viewMode === 'day' ? '#fff' : '#94a3b8',
                      fontSize: "12px",
                      fontWeight: 600,
                      cursor: "pointer"
                    }}
                  >
                    Single Day
                  </button>
                  <button
                    onClick={() => setViewMode('week')}
                    style={{
                      padding: "6px 16px",
                      border: "none",
                      borderRadius: "4px",
                      background: viewMode === 'week' ? '#3b82f6' : 'transparent',
                      color: viewMode === 'week' ? '#fff' : '#94a3b8',
                      fontSize: "12px",
                      fontWeight: 600,
                      cursor: "pointer"
                    }}
                  >
                    7-Day Week
                  </button>
                </div>
              </div>

              {selectedDay && <div style={{ marginLeft: "auto", display: "flex", gap: "16px", alignItems: "center" }}>
                <div style={{ background: "#1e293b", padding: "8px 16px", borderRadius: "6px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "2px" }}>Selected Date</div>
                  <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0" }}>
                    {new Date(selectedDate).toLocaleDateString('en-AU', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                  </div>
                </div>
              </div>}
            </div>

            {/* No data for selected date fallback */}
            {selectedDate && !selectedDay && viewMode === 'day' && (
              <div style={{ background: "linear-gradient(135deg, rgba(59,130,246,0.08), rgba(148,163,184,0.08))", border: "1px solid #1e3a5f", borderRadius: "10px", padding: "20px", marginBottom: "24px" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "8px" }}>
                  📊 Seasonal Estimate for {new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-AU', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                </div>
                <div style={{ fontSize: "12px", color: "#94a3b8", marginBottom: "12px" }}>
                  No recorded data for this date. Showing seasonal estimate based on historical patterns.
                </div>
                {(() => {
                  const m = new Date(selectedDate + 'T00:00:00').getMonth();
                  const seasonalSolar = avgSolarAllDays * (SEA.feedIn[m] || 1.0);
                  const seasonName = m >= 11 || m <= 1 ? "Summer" : m >= 2 && m <= 4 ? "Autumn" : m >= 5 && m <= 7 ? "Winter" : "Spring";
                  const seasonEmoji = m >= 11 || m <= 1 ? "☀️" : m >= 2 && m <= 4 ? "🍂" : m >= 5 && m <= 7 ? "❄️" : "🌸";
                  const estBatteryPct = Math.min(100, (seasonalSolar / batterySpec.usable_kwh * 100));
                  const batteryFillR = BAT.peakR[m] || 0.5;
                  return (
                    <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(160px, 1fr))", gap: "12px" }}>
                      <div style={{ background: "#0f172a", padding: "14px", borderRadius: "8px", border: "1px solid #1e293b", textAlign: "center" }}>
                        <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px" }}>Season</div>
                        <div style={{ fontSize: "20px", fontWeight: 700, color: "#e2e8f0" }}>{seasonEmoji} {seasonName}</div>
                        <div style={{ fontSize: "10px", color: "#475569" }}>{MO[m]}</div>
                      </div>
                      <div style={{ background: "#0f172a", padding: "14px", borderRadius: "8px", border: "1px solid #1e293b", textAlign: "center" }}>
                        <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px" }}>Est. Solar Generation</div>
                        <div style={{ fontSize: "20px", fontWeight: 700, color: "#38bdf8" }}>{seasonalSolar.toFixed(1)} kWh</div>
                        <div style={{ fontSize: "10px", color: "#475569" }}>Avg base: {avgSolarAllDays.toFixed(1)} kWh</div>
                      </div>
                      <div style={{ background: "#0f172a", padding: "14px", borderRadius: "8px", border: "1px solid #1e293b", textAlign: "center" }}>
                        <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px" }}>Est. Battery Fill</div>
                        <div style={{ fontSize: "20px", fontWeight: 700, color: estBatteryPct >= 80 ? "#34d399" : estBatteryPct >= 50 ? "#fbbf24" : "#f87171" }}>{estBatteryPct.toFixed(0)}%</div>
                        <div style={{ fontSize: "10px", color: "#475569" }}>Peak coverage: {(batteryFillR * 100).toFixed(0)}%</div>
                      </div>
                      <div style={{ background: "#0f172a", padding: "14px", borderRadius: "8px", border: "1px solid #1e293b", textAlign: "center" }}>
                        <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "4px" }}>Data Range</div>
                        <div style={{ fontSize: "14px", fontWeight: 600, color: "#94a3b8" }}>{dailyResults[0]?.date || '?'}</div>
                        <div style={{ fontSize: "10px", color: "#475569" }}>to {dailyResults[dailyResults.length - 1]?.date || '?'}</div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}

            {/* Single Day View */}
            {viewMode === 'day' && selectedDay && <>
              {/* Day Stats Cards */}
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: "12px", marginBottom: "24px" }}>
                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Solar Generation</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: "#38bdf8" }}>{selectedDay.total_solar_kwh.toFixed(1)} kWh</div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    Avg: {avgSolarAllDays.toFixed(1)} kWh
                    {selectedDay.total_solar_kwh > avgSolarAllDays ?
                      <span style={{ color: "#34d399", marginLeft: "4px" }}>↑ {((selectedDay.total_solar_kwh / avgSolarAllDays - 1) * 100).toFixed(0)}%</span> :
                      <span style={{ color: "#f87171", marginLeft: "4px" }}>↓ {((1 - selectedDay.total_solar_kwh / avgSolarAllDays) * 100).toFixed(0)}%</span>
                    }
                  </div>
                </div>

                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Max Battery SOC</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: "#a78bfa" }}>{selectedDay.max_battery_soc_kwh.toFixed(1)} kWh</div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    {selectedDay.battery_filled_pct.toFixed(0)}% of capacity
                  </div>
                </div>

                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Time to Full</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: selectedDay.time_to_full ? "#34d399" : "#f87171" }}>
                    {selectedDay.time_to_full || "N/A"}
                  </div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    {selectedDay.time_to_full ? "Reached 95% SOC" : "Did not reach full"}
                  </div>
                </div>

                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Day Performance</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: selectedDay.battery_filled_pct >= 95 ? "#34d399" : selectedDay.battery_filled_pct >= 75 ? "#fbbf24" : "#f87171" }}>
                    {selectedDay.battery_filled_pct >= 95 ? "Excellent" : selectedDay.battery_filled_pct >= 75 ? "Good" : selectedDay.battery_filled_pct >= 50 ? "Fair" : "Poor"}
                  </div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    {selectedDay.day_of_week}
                  </div>
                </div>
              </div>

              {/* Hourly Charging Curve */}
              <div style={{ background: "#1e293b", padding: "20px", borderRadius: "8px", border: "1px solid #334155", marginBottom: "24px" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>
                  Hourly Battery Charging Curve
                </div>
                <ResponsiveContainer width="100%" height={320}>
                  <AreaChart data={Object.keys(selectedDay.hourly_soc).sort((a, b) => parseInt(a) - parseInt(b)).map(hour => ({
                    hour: `${hour}:00`,
                    'Battery SOC (kWh)': selectedDay.hourly_soc[hour],
                    'SOC %': (selectedDay.hourly_soc[hour] / batterySpec.usable_kwh * 100).toFixed(1)
                  }))}>
                    <defs>
                      <linearGradient id="socGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#a78bfa" stopOpacity={0.8}/>
                        <stop offset="95%" stopColor="#a78bfa" stopOpacity={0.1}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                    <XAxis dataKey="hour" stroke="#64748b" fontSize={11} />
                    <YAxis stroke="#64748b" fontSize={11} label={{ value: 'Battery SOC (kWh)', angle: -90, position: 'insideLeft', fill: '#94a3b8', fontSize: 11 }} />
                    <Tooltip
                      contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '6px', fontSize: '12px' }}
                      labelStyle={{ color: '#e2e8f0', fontWeight: 600 }}
                    />
                    <ReferenceLine y={batterySpec.usable_kwh} stroke="#34d399" strokeDasharray="3 3" label={{ value: `Full (${batterySpec.usable_kwh} kWh)`, fill: '#34d399', fontSize: 10 }} />
                    <ReferenceLine y={batterySpec.usable_kwh * 0.5} stroke="#fbbf24" strokeDasharray="3 3" label={{ value: '50%', fill: '#fbbf24', fontSize: 10 }} />
                    <Area type="monotone" dataKey="Battery SOC (kWh)" stroke="#a78bfa" strokeWidth={2} fill="url(#socGradient)" />
                  </AreaChart>
                </ResponsiveContainer>
              </div>

              {/* Insights & Recommendations */}
              <div style={{ background: "#1e293b", padding: "20px", borderRadius: "8px", border: "1px solid #334155" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "12px" }}>
                  💡 Insights for {selectedDate}
                </div>
                <div style={{ fontSize: "12px", color: "#94a3b8", lineHeight: "1.6" }}>
                  {selectedDay.battery_filled_pct >= 95 ? (
                    <>
                      <p style={{ margin: "0 0 8px" }}>✓ <strong style={{ color: "#34d399" }}>Excellent day!</strong> Battery reached full charge at {selectedDay.time_to_full}.</p>
                      <p style={{ margin: "0 0 8px" }}>• Solar generation was {selectedDay.total_solar_kwh > avgSolarAllDays ? "above" : "at"} average, providing {selectedDay.total_solar_kwh.toFixed(1)} kWh.</p>
                      <p style={{ margin: "0 0 8px" }}>• With full battery, you maximized self-consumption and minimized grid imports during peak rates.</p>
                      {selectedDay.total_solar_kwh > 28 && <p style={{ margin: 0 }}>• Excess solar after battery full was exported to grid at feed-in rate (5.5¢/kWh).</p>}
                    </>
                  ) : selectedDay.battery_filled_pct >= 75 ? (
                    <>
                      <p style={{ margin: "0 0 8px" }}>✓ <strong style={{ color: "#fbbf24" }}>Good day.</strong> Battery reached {selectedDay.battery_filled_pct.toFixed(0)}% capacity.</p>
                      <p style={{ margin: "0 0 8px" }}>• Solar generation: {selectedDay.total_solar_kwh.toFixed(1)} kWh ({selectedDay.total_solar_kwh < avgSolarAllDays ? "below average" : "average"}).</p>
                      <p style={{ margin: "0 0 8px" }}>• Battery provided {((selectedDay.max_battery_soc_kwh / batterySpec.usable_kwh) * 100).toFixed(0)}% coverage for evening peak demand.</p>
                      <p style={{ margin: 0 }}>💡 From July 1st 2026, Solar Sharer program (11am-2pm free power) will help top up battery on days like this.</p>
                    </>
                  ) : (
                    <>
                      <p style={{ margin: "0 0 8px" }}>⚠ <strong style={{ color: "#f87171" }}>Below average day.</strong> Battery only reached {selectedDay.battery_filled_pct.toFixed(0)}% ({selectedDay.max_battery_soc_kwh.toFixed(1)} kWh).</p>
                      <p style={{ margin: "0 0 8px" }}>• Solar generation: {selectedDay.total_solar_kwh.toFixed(1)} kWh (well below {avgSolarAllDays.toFixed(1)} kWh average).</p>
                      <p style={{ margin: "0 0 8px" }}>• Likely overcast/rainy day with limited solar production.</p>
                      <p style={{ margin: 0 }}>💡 <strong>Solar Sharer (from July 1st 2026):</strong> Once active, the 3 free hours (11am-2pm) would provide ~13 kWh to top up battery on days like this.</p>
                    </>
                  )}
                </div>
              </div>
            </>}

            {/* Week View */}
            {viewMode === 'week' && weekData.length > 0 && <>
              {/* Week Summary Stats */}
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: "12px", marginBottom: "24px" }}>
                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Week Total Solar</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: "#38bdf8" }}>
                    {weekData.reduce((sum, d) => sum + d.total_solar_kwh, 0).toFixed(1)} kWh
                  </div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    Avg: {(weekData.reduce((sum, d) => sum + d.total_solar_kwh, 0) / weekData.length).toFixed(1)} kWh/day
                  </div>
                </div>

                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Days Reaching Full</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: "#34d399" }}>
                    {weekData.filter(d => d.time_to_full).length} / {weekData.length}
                  </div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    {((weekData.filter(d => d.time_to_full).length / weekData.length) * 100).toFixed(0)}% of week
                  </div>
                </div>

                <div style={{ background: "#1e293b", padding: "16px", borderRadius: "8px", border: "1px solid #334155" }}>
                  <div style={{ fontSize: "11px", color: "#64748b", marginBottom: "6px" }}>Avg Battery Fill</div>
                  <div style={{ fontSize: "24px", fontWeight: 700, color: "#a78bfa" }}>
                    {(weekData.reduce((sum, d) => sum + d.battery_filled_pct, 0) / weekData.length).toFixed(0)}%
                  </div>
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "4px" }}>
                    {(weekData.reduce((sum, d) => sum + d.max_battery_soc_kwh, 0) / weekData.length).toFixed(1)} kWh avg
                  </div>
                </div>
              </div>

              {/* Week Daily Breakdown */}
              <div style={{ background: "#1e293b", padding: "20px", borderRadius: "8px", border: "1px solid #334155", marginBottom: "24px" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>
                  7-Day Battery Performance Comparison
                </div>
                <ResponsiveContainer width="100%" height={320}>
                  <BarChart data={weekData.map(d => ({
                    date: new Date(d.date).toLocaleDateString('en-AU', { month: 'short', day: 'numeric' }),
                    day: d.day_of_week.substr(0, 3),
                    'Solar (kWh)': d.total_solar_kwh,
                    'Max SOC (kWh)': d.max_battery_soc_kwh,
                    'Fill %': d.battery_filled_pct
                  }))}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                    <XAxis dataKey="date" stroke="#64748b" fontSize={11} />
                    <YAxis stroke="#64748b" fontSize={11} />
                    <Tooltip
                      contentStyle={{ background: '#0f172a', border: '1px solid #334155', borderRadius: '6px', fontSize: '12px' }}
                      labelStyle={{ color: '#e2e8f0', fontWeight: 600 }}
                    />
                    <Legend wrapperStyle={{ fontSize: '11px' }} />
                    <Bar dataKey="Solar (kWh)" fill="#38bdf8" />
                    <Bar dataKey="Max SOC (kWh)" fill="#a78bfa" />
                  </BarChart>
                </ResponsiveContainer>
              </div>

              {/* Week Details Table */}
              <div style={{ background: "#1e293b", padding: "20px", borderRadius: "8px", border: "1px solid #334155" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0", marginBottom: "16px" }}>
                  Daily Breakdown
                </div>
                <div style={{ overflowX: "auto" }}>
                  <table style={{ width: "100%", fontSize: "12px", borderCollapse: "collapse" }}>
                    <thead>
                      <tr style={{ borderBottom: "1px solid #334155" }}>
                        <th style={{ textAlign: "left", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Date</th>
                        <th style={{ textAlign: "left", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Day</th>
                        <th style={{ textAlign: "right", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Solar</th>
                        <th style={{ textAlign: "right", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Max SOC</th>
                        <th style={{ textAlign: "right", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Fill %</th>
                        <th style={{ textAlign: "right", padding: "8px", color: "#94a3b8", fontWeight: 600 }}>Time to Full</th>
                      </tr>
                    </thead>
                    <tbody>
                      {weekData.map((day, i) => (
                        <tr key={i} style={{ borderBottom: "1px solid #1e293b" }}>
                          <td style={{ padding: "8px", color: "#e2e8f0" }}>{day.date}</td>
                          <td style={{ padding: "8px", color: "#94a3b8" }}>{day.day_of_week}</td>
                          <td style={{ padding: "8px", color: "#38bdf8", textAlign: "right" }}>{day.total_solar_kwh.toFixed(1)} kWh</td>
                          <td style={{ padding: "8px", color: "#a78bfa", textAlign: "right" }}>{day.max_battery_soc_kwh.toFixed(1)} kWh</td>
                          <td style={{ padding: "8px", textAlign: "right", color: day.battery_filled_pct >= 95 ? "#34d399" : day.battery_filled_pct >= 75 ? "#fbbf24" : "#f87171" }}>
                            {day.battery_filled_pct.toFixed(0)}%
                          </td>
                          <td style={{ padding: "8px", color: day.time_to_full ? "#34d399" : "#64748b", textAlign: "right" }}>
                            {day.time_to_full || "—"}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </>}


            {!selectedDay && viewMode === 'day' && (
              <div style={{ padding: "40px", textAlign: "center", color: "#64748b" }}>
                No data available for selected date. Please choose a date within the available range.
              </div>
            )}
          </>;
        })()}
          </>}
  </>);
}


/* Tab 4: Live Solar — Real-time inverter data, weather, daily costs */

function LiveSolarTab({ solarLive, solarStats, solarDaily, setSolarDaily, solarMonthly, solarHourly, solarToday, solarConnected, weatherToday, forecastData, openMeteoForecast, cfg, blendedRates, rateSets, netCost, showProviderImport, setShowProviderImport, providerImportText, setProviderImportText, providerImportStatus, setProviderImportStatus, fmt, fmt2, pct, MO, S }) {
  return (<>
        <div style={{ fontSize: "14px", fontWeight: 600, color: "#e2e8f0", marginBottom: "4px" }}>Live Solar Dashboard</div>
        <div style={{ fontSize: "12px", color: "#475569", marginBottom: "16px" }}>
          Real-time data from Solax {solarLive?.type || 'AL_SI4'} inverter {solarStats ? `· Collecting since ${solarStats.first_date}` : ''}
        </div>

        {!solarConnected ? (
          <div style={S.card}>
            <div style={{ textAlign: "center", padding: "40px", color: "#64748b" }}>
              <div style={{ fontSize: "40px", marginBottom: "12px" }}>📡</div>
              <div style={{ fontSize: "16px", fontWeight: 600, marginBottom: "6px" }}>Connecting to Inverter...</div>
              <div style={{ fontSize: "12px" }}>Make sure the Solax collector service is running and the Nexus server is accessible.</div>
            </div>
          </div>
        ) : <>
          {/* Real-time Stats Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: "10px", marginBottom: "16px" }}>
            {[
              { label: "Total PV Power", value: `${(solarLive?.total_pv_power || 0).toLocaleString()}W`, color: "#fbbf24", icon: "☀️" },
              { label: "PV1 Power", value: `${(solarLive?.pv1_power || 0).toLocaleString()}W`, color: "#fb923c", icon: "⚡" },
              { label: "PV2 Power", value: `${(solarLive?.pv2_power || 0).toLocaleString()}W`, color: "#f97316", icon: "⚡" },
              { label: "PV1 String", value: `${solarLive?.pv1_voltage || 0}V · ${solarLive?.pv1_current || 0}A`, color: "#fb923c", icon: "🔗" },
              { label: "PV2 String", value: `${solarLive?.pv2_voltage || 0}V · ${solarLive?.pv2_current || 0}A`, color: "#f97316", icon: "🔗" },
              { label: "Grid Power", value: `${(solarLive?.grid_power || 0).toLocaleString()}W`, color: "#38bdf8", icon: "🔌" },
              { label: "Grid AC", value: `${solarLive?.grid_voltage || 0}V · ${solarLive?.grid_current || 0}A`, color: "#a78bfa", icon: "⚡" },
              { label: "Exported Power", value: `${(solarLive?.exported_power || 0).toLocaleString()}W`, color: "#34d399", icon: "📤" },
              { label: "Today's Yield", value: `${solarLive?.today_yield?.toFixed(1) || '0.0'} kWh`, color: "#38bdf8", icon: "📊" },
              { label: "Total Yield", value: `${(solarLive?.total_yield || 0).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})} kWh`, color: "#818cf8", icon: "🔋" },
              { label: "Inverter Temp", value: `${solarLive?.inverter_temp || 0}°C`, color: solarLive?.inverter_temp > 60 ? "#f87171" : "#34d399", icon: "🌡️" },
              { label: "Status", value: solarLive?.status == 2 ? "Generating" : solarLive?.status == 0 ? "Standby" : `Code ${solarLive?.status}`, color: solarLive?.status == 2 ? "#34d399" : "#fbbf24", icon: "✅" },
            ].map((s, i) => (
              <div key={i} style={{ background: "#0f172a", border: "1px solid #1e293b", borderRadius: "8px", padding: "12px", textAlign: "center" }}>
                <div style={{ fontSize: "16px", marginBottom: "4px" }}>{s.icon}</div>
                <div style={{ fontSize: "18px", fontWeight: 700, color: s.color }}>{s.value}</div>
                <div style={{ fontSize: "10px", color: "#64748b", marginTop: "2px" }}>{s.label}</div>
              </div>
            ))}
          </div>

          {/* Today's ROI Estimate */}
          {(() => {
            const todayKwh = solarLive?.today_yield || 0;
            const latestRate = rateSets.length > 0 ? rateSets[rateSets.length - 1] : null;
            const feedInRate = latestRate ? latestRate.feedIn : 0.055;
            const peakRate = latestRate ? latestRate.peak : 0.49;
            const offPkRate = latestRate ? latestRate.offPk : 0.34;
            const avgImportRate = (peakRate + offPkRate) / 2;
            const selfConsumptionPct = 0.6; // estimate 60% self-consumed
            const selfConsumedValue = todayKwh * selfConsumptionPct * avgImportRate;
            const exportedValue = todayKwh * (1 - selfConsumptionPct) * feedInRate;
            const todayValue = selfConsumedValue + exportedValue;
            const dailyCostTarget = netCost / (cfg.forecastYears * 365); // payback target per day based on forecast period
            return (
              <div style={{ background: "linear-gradient(135deg, rgba(16,185,129,0.08), rgba(245,158,11,0.08))", border: "1px solid #1e3a5f", borderRadius: "10px", padding: "16px", marginBottom: "16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "12px" }}>
                <div>
                  <div style={{ fontSize: "12px", color: "#64748b", marginBottom: "4px" }}>Today's Estimated Value</div>
                  <div style={{ fontSize: "28px", fontWeight: 700, color: "#34d399" }}>{fmt2(todayValue)}</div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>{todayKwh.toFixed(1)} kWh × est. rates</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: "12px", color: "#64748b", marginBottom: "4px" }}>Self-Consumed</div>
                  <div style={{ fontSize: "20px", fontWeight: 700, color: "#fbbf24" }}>{fmt2(selfConsumedValue)}</div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>{(todayKwh * selfConsumptionPct).toFixed(1)} kWh @ avg {fmt2(avgImportRate)}/kWh</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: "12px", color: "#64748b", marginBottom: "4px" }}>Exported</div>
                  <div style={{ fontSize: "20px", fontWeight: 700, color: "#38bdf8" }}>{fmt2(exportedValue)}</div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>{(todayKwh * (1 - selfConsumptionPct)).toFixed(1)} kWh @ {fmt2(feedInRate)}/kWh</div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontSize: "12px", color: "#64748b", marginBottom: "4px" }}>Payback Progress</div>
                  <div style={{ fontSize: "20px", fontWeight: 700, color: todayValue >= dailyCostTarget ? "#34d399" : "#fb923c" }}>
                    {todayValue >= dailyCostTarget ? "On Track" : "Below Target"}
                  </div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>Need {fmt2(dailyCostTarget)}/day for {cfg.forecastYears}yr payback</div>
                </div>
              </div>
            );
          })()}

          {/* PV Power Gauge */}
          {(() => {
            const maxPV = (cfg.solarCapacity || 5) * 1000; // Actual solar system capacity
            const currentPV = solarLive?.total_pv_power || 0;
            const pct = Math.min((currentPV / maxPV) * 100, 100);
            const barColor = pct > 80 ? "#34d399" : pct > 50 ? "#fbbf24" : pct > 20 ? "#fb923c" : "#64748b";
            return (
              <div style={S.card}>
                <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0", marginBottom: "8px" }}>System Output</div>
                <div style={{ display: "flex", alignItems: "center", gap: "12px" }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ background: "#1e293b", borderRadius: "8px", height: "24px", overflow: "hidden" }}>
                      <div style={{ width: `${pct}%`, height: "100%", background: `linear-gradient(90deg, ${barColor}88, ${barColor})`, borderRadius: "8px", transition: "width 1s ease" }}></div>
                    </div>
                  </div>
                  <div style={{ fontSize: "14px", fontWeight: 700, color: barColor, minWidth: "80px", textAlign: "right" }}>{pct.toFixed(0)}% capacity</div>
                </div>
                <div style={{ display: "flex", justifyContent: "space-between", marginTop: "4px", fontSize: "10px", color: "#475569" }}>
                  <span>0W</span>
                  <span>{(maxPV / 2).toLocaleString()}W</span>
                  <span>{maxPV.toLocaleString()}W</span>
                </div>
              </div>
            );
          })()}

          {/* Forecast vs Actual Rating — prefers Open-Meteo, falls back to BOM */}
          {(() => {
            // Prefer Open-Meteo data, fall back to legacy forecastData
            const todayStr = new Date().toISOString().split('T')[0];
            const meteoToday = openMeteoForecast?.find(d => d.date === todayStr);
            const legacyToday = forecastData?.find(d => d.date === todayStr) || forecastData?.[0];
            const todayPred = meteoToday || legacyToday;
            if (!todayPred && !weatherToday) return null;
            if (!todayPred) return null;

            const isOpenMeteo = !!meteoToday;
            const condition = todayPred.condition || weatherToday?.current?.condition || 'unknown';
            const currentCondition = weatherToday?.current?.condition || null;
            const multiplier = todayPred.solarMultiplier || BOM_CONDITION_TO_SOLAR[condition] || 0.5;
            const weatherMult = todayPred.weatherMultiplier || BOM_CONDITION_TO_SOLAR[condition] || 0.5;
            const seasonalMult = todayPred.seasonalMultiplier || (SEA.feedIn[new Date().getMonth()] || 1.0);
            const predictedFullDay = todayPred.predictedSolarKwh || 0;
            const predictedFillPct = todayPred.fillPct || 0;
            const predictedPerformance = todayPred.performance || 'Unknown';
            const actualYield = solarLive?.today_yield || 0;

            // Time-of-day adjustment using sine curve
            const now = new Date();
            const hour = now.getHours() + now.getMinutes() / 60;
            const month = now.getMonth();
            const sunrise = [6.0, 6.5, 7.0, 6.5, 7.0, 7.2, 7.0, 6.5, 6.0, 5.5, 5.5, 5.8][month];
            const sunset = [20.5, 20.0, 19.0, 17.5, 17.0, 17.0, 17.2, 17.8, 18.5, 19.2, 20.0, 20.5][month];
            let expectedFraction = 0;
            if (hour >= sunset) expectedFraction = 1.0;
            else if (hour > sunrise) {
              const progress = (hour - sunrise) / (sunset - sunrise);
              expectedFraction = (1 - Math.cos(Math.PI * progress)) / 2;
            }

            const predictedByNow = predictedFullDay * expectedFraction;
            const accuracy = predictedByNow > 0.5 ? (actualYield / predictedByNow) * 100 : 0;
            const isBefore6am = hour < sunrise;

            let ratingLabel, ratingColor, ratingIcon;
            if (isBefore6am) {
              ratingLabel = "Pre-Dawn"; ratingColor = "#475569"; ratingIcon = "🌙";
            } else if (accuracy >= 110) {
              ratingLabel = "Exceeding"; ratingColor = "#34d399"; ratingIcon = "🚀";
            } else if (accuracy >= 90) {
              ratingLabel = "On Track"; ratingColor = "#34d399"; ratingIcon = "✅";
            } else if (accuracy >= 70) {
              ratingLabel = "Slightly Below"; ratingColor = "#fbbf24"; ratingIcon = "⚠️";
            } else if (accuracy >= 50) {
              ratingLabel = "Below Forecast"; ratingColor = "#fb923c"; ratingIcon = "📉";
            } else {
              ratingLabel = "Well Below"; ratingColor = "#f87171"; ratingIcon = "❌";
            }

            let modelNote = "";
            if (!isBefore6am && expectedFraction > 0.3) {
              const source = isOpenMeteo ? 'Open-Meteo radiation' : 'BOM condition';
              if (accuracy > 130) modelNote = source + " model underestimating — actual generation exceeding predictions for '" + condition + "'.";
              else if (accuracy > 110) modelNote = source + " model slightly conservative for '" + condition + "' conditions.";
              else if (accuracy >= 85) modelNote = source + " model well calibrated for '" + condition + "'" + (isOpenMeteo && todayPred.radiationMJ ? " (" + todayPred.radiationMJ.toFixed(1) + " MJ/m²)" : "") + ".";
              else if (accuracy >= 60) modelNote = source + " model overestimating for '" + condition + "' conditions.";
              else modelNote = "Significant deviation — check for shading, panel issues, or intermittent cloud.";
            }

            return (
            <div style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "12px" }}>
                <div style={{ fontSize: "14px", fontWeight: 700, color: "#e2e8f0" }}>Forecast vs Actual</div>
                <div style={{ fontSize: "11px", color: "#64748b" }}>{isOpenMeteo ? 'Open-Meteo Radiation Model' : 'BOM Weather Model'}</div>
              </div>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "12px", marginBottom: "14px" }}>
                {/* Weather condition */}
                <div style={{ background: "#0a0f1a", borderRadius: "8px", padding: "12px", textAlign: "center", border: "1px solid #1e293b" }}>
                  <div style={{ fontSize: "28px", marginBottom: "4px" }}>{getConditionIcon(condition)}</div>
                  <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0" }}>{condition.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                  {currentCondition && currentCondition !== condition && (
                    <div style={{ fontSize: "10px", color: "#94a3b8", marginTop: "2px" }}>Now: {currentCondition.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                  )}
                  <div style={{ fontSize: "10px", color: "#64748b", marginTop: "2px" }}>Weather: {(weatherMult * 100).toFixed(0)}% · Season: {(seasonalMult * 100).toFixed(0)}%</div>
                  {todayPred.tempMax && <div style={{ fontSize: "10px", color: "#64748b" }}>{todayPred.tempMax}°/{todayPred.tempMin}° · {todayPred.rainChance || 0}% rain</div>}
                </div>

                {/* Predicted vs Actual kWh */}
                <div style={{ background: "#0a0f1a", borderRadius: "8px", padding: "12px", textAlign: "center", border: "1px solid #1e293b" }}>
                  <div style={{ fontSize: "10px", color: "#64748b", marginBottom: "6px" }}>Predicted by now</div>
                  <div style={{ fontSize: "22px", fontWeight: 700, color: "#94a3b8" }}>{predictedByNow.toFixed(1)} kWh</div>
                  <div style={{ fontSize: "10px", color: "#475569", marginTop: "2px" }}>of {predictedFullDay} kWh full day</div>
                  <div style={{ fontSize: "10px", color: "#475569" }}>({(expectedFraction * 100).toFixed(0)}% of solar window)</div>
                </div>

                {/* Accuracy rating */}
                <div style={{ background: "#0a0f1a", borderRadius: "8px", padding: "12px", textAlign: "center", border: `1px solid ${ratingColor}33` }}>
                  <div style={{ fontSize: "22px", marginBottom: "2px" }}>{ratingIcon}</div>
                  <div style={{ fontSize: "18px", fontWeight: 700, color: ratingColor }}>{ratingLabel}</div>
                  {!isBefore6am && <div style={{ fontSize: "22px", fontWeight: 700, color: ratingColor, marginTop: "2px" }}>{accuracy.toFixed(0)}%</div>}
                  <div style={{ fontSize: "10px", color: "#475569" }}>accuracy score</div>
                </div>
              </div>

              {/* Battery prediction from model */}
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px", marginBottom: "14px" }}>
                <div style={{ background: "#0a0f1a", borderRadius: "6px", padding: "8px", textAlign: "center", border: "1px solid #1e293b" }}>
                  <div style={{ fontSize: "9px", color: "#64748b" }}>Predicted Battery Fill</div>
                  <div style={{ fontSize: "16px", fontWeight: 700, color: predictedFillPct >= 95 ? "#34d399" : predictedFillPct >= 75 ? "#fbbf24" : "#fb923c" }}>{predictedFillPct}%</div>
                </div>
                <div style={{ background: "#0a0f1a", borderRadius: "6px", padding: "8px", textAlign: "center", border: "1px solid #1e293b" }}>
                  <div style={{ fontSize: "9px", color: "#64748b" }}>Model Rating</div>
                  <div style={{ fontSize: "16px", fontWeight: 700, color: predictedPerformance === 'Excellent' ? "#34d399" : predictedPerformance === 'Good' ? "#fbbf24" : "#fb923c" }}>{predictedPerformance}</div>
                </div>
                <div style={{ background: "#0a0f1a", borderRadius: "6px", padding: "8px", textAlign: "center", border: "1px solid #1e293b" }}>
                  <div style={{ fontSize: "9px", color: "#64748b" }}>Actual Yield</div>
                  <div style={{ fontSize: "16px", fontWeight: 700, color: "#fb923c" }}>{actualYield.toFixed(1)} kWh</div>
                </div>
              </div>

              {/* Progress bar: Actual vs Predicted */}
              <div style={{ marginBottom: "10px" }}>
                <div style={{ display: "flex", justifyContent: "space-between", fontSize: "11px", marginBottom: "4px" }}>
                  <span style={{ color: "#fb923c" }}>Actual: {actualYield.toFixed(1)} kWh</span>
                  <span style={{ color: "#94a3b8" }}>Predicted: {predictedByNow.toFixed(1)} kWh</span>
                </div>
                <div style={{ position: "relative", background: "#1e293b", borderRadius: "8px", height: "20px", overflow: "hidden" }}>
                  <div style={{ position: "absolute", left: `${Math.min((predictedByNow / Math.max(predictedFullDay, 0.1)) * 100, 100)}%`, top: 0, bottom: 0, width: "2px", background: "#94a3b8", zIndex: 2 }}></div>
                  <div style={{
                    width: `${Math.min((actualYield / Math.max(predictedFullDay, 0.1)) * 100, 100)}%`,
                    height: "100%",
                    background: `linear-gradient(90deg, ${ratingColor}88, ${ratingColor})`,
                    borderRadius: "8px",
                    transition: "width 1s ease"
                  }}></div>
                </div>
                <div style={{ display: "flex", justifyContent: "space-between", fontSize: "9px", color: "#475569", marginTop: "2px" }}>
                  <span>0 kWh</span>
                  <span>Full day: {predictedFullDay} kWh</span>
                </div>
              </div>

              {/* Model calibration note */}
              {modelNote && (
                <div style={{ fontSize: "11px", color: "#94a3b8", padding: "8px 10px", background: "#0a0f1a", borderRadius: "6px", borderLeft: `3px solid ${ratingColor}` }}>
                  {modelNote}
                </div>
              )}
            </div>
            );
          })()}

          {/* Today's Power Curve (Solax-style) with Forecast overlay */}
          {(() => {
            // Use raw 5-min readings for smooth curve, fall back to hourly aggregates
            const hasRaw = solarToday.length > 0;
            const chartData = hasRaw
              ? solarToday.map(r => ({
                  time: r.timestamp?.slice(11, 16) || '',
                  solar: r.total_pv_power || 0,
                  grid: r.grid_power || 0,
                  exported: r.exported_power || 0,
                }))
              : solarHourly.map(h => ({
                  time: `${String(h.hour).padStart(2, '0')}:00`,
                  solar: Math.round(h.avg_power || 0),
                  grid: Math.round(h.avg_grid || 0),
                  exported: Math.round(h.avg_export || 0),
                }));
            if (chartData.length === 0) return null;

            // Build forecast power curve using sine model + BOM weather
            const _month = new Date().getMonth();
            const _sunrise = [6.0, 6.5, 7.0, 6.5, 7.0, 7.2, 7.0, 6.5, 6.0, 5.5, 5.5, 5.8][_month];
            const _sunset = [20.5, 20.0, 19.0, 17.5, 17.0, 17.0, 17.2, 17.8, 18.5, 19.2, 20.0, 20.5][_month];
            const _todayStr = new Date().toISOString().split('T')[0];
            // Prefer Open-Meteo, fall back to legacy BOM forecastData
            const _meteoToday = openMeteoForecast?.find(d => d.date === _todayStr);
            const _todayPred = _meteoToday || forecastData?.find(d => d.date === _todayStr) || forecastData?.[0];
            const _predictedKwh = parseFloat(_todayPred?.predictedSolarKwh || 0);
            const _solarWindow = _sunset - _sunrise;
            // P_peak such that integral of sine curve = predicted kWh: P_peak = kWh * 1000 * π / (2 * hours)
            const _peakW = _predictedKwh > 0 ? Math.min((_predictedKwh * 1000 * Math.PI) / (2 * _solarWindow), (cfg.solarCapacity || 5) * 1000) : 0;
            const hasForecast = _peakW > 0;

            const forecastAt = (timeStr) => {
              const p = timeStr.split(':');
              const hr = parseInt(p[0]) + parseInt(p[1]) / 60;
              if (hr < _sunrise || hr > _sunset) return 0;
              return Math.round(_peakW * Math.sin(Math.PI * (hr - _sunrise) / _solarWindow));
            };

            // Add forecast value to each actual data point
            if (hasForecast) {
              chartData.forEach(d => { d.forecast = forecastAt(d.time); });
              // Append future forecast-only points (5-min intervals from last reading to sunset)
              const lastTime = chartData[chartData.length - 1]?.time;
              if (lastTime) {
                const lp = lastTime.split(':');
                let nextMin = parseInt(lp[0]) * 60 + parseInt(lp[1]) + 5;
                const endMin = Math.ceil(_sunset * 60);
                while (nextMin <= endMin) {
                  const hh = Math.floor(nextMin / 60);
                  const mm = nextMin % 60;
                  const ts = `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
                  chartData.push({ time: ts, solar: null, grid: null, exported: null, forecast: forecastAt(ts) });
                  nextMin += 5;
                }
              }
            }

            const maxPower = Math.max(...chartData.map(d => Math.max(d.solar || 0, d.grid || 0, d.forecast || 0)), 1000);
            const yMax = Math.ceil(maxPower / 1000) * 1000;
            return (
            <div style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "10px" }}>
                <div>
                  <div style={{ fontSize: "14px", fontWeight: 700, color: "#fb923c" }}>Power</div>
                </div>
                <div style={{ display: "flex", gap: "16px", fontSize: "11px", alignItems: "center", flexWrap: "wrap" }}>
                  <span style={{ display: "flex", alignItems: "center", gap: "4px" }}><span style={{ width: "10px", height: "10px", background: "#fb923c", borderRadius: "2px", display: "inline-block" }}></span> Solar Power</span>
                  <span style={{ display: "flex", alignItems: "center", gap: "4px" }}><span style={{ width: "10px", height: "10px", background: "#34d399", borderRadius: "2px", display: "inline-block" }}></span> Grid Power</span>
                  <span style={{ display: "flex", alignItems: "center", gap: "4px" }}><span style={{ width: "10px", height: "10px", background: "#38bdf8", borderRadius: "2px", display: "inline-block" }}></span> Exported</span>
                  {hasForecast && <span style={{ display: "flex", alignItems: "center", gap: "4px" }}><span style={{ width: "10px", height: "3px", background: "#f59e0b", borderTop: "2px dashed #f59e0b", display: "inline-block" }}></span> Forecast ({_predictedKwh} kWh)</span>}
                </div>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={chartData} margin={{ top: 5, right: 10, left: 0, bottom: 5 }}>
                  <defs>
                    <linearGradient id="gradSolar" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#fb923c" stopOpacity={0.45} />
                      <stop offset="95%" stopColor="#fb923c" stopOpacity={0.05} />
                    </linearGradient>
                    <linearGradient id="gradGrid" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#34d399" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#34d399" stopOpacity={0.02} />
                    </linearGradient>
                    <linearGradient id="gradExport" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#38bdf8" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#38bdf8" stopOpacity={0.02} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />
                  <XAxis
                    dataKey="time"
                    stroke="#475569"
                    fontSize={10}
                    interval={Math.max(Math.floor(chartData.length / 12), 1)}
                  />
                  <YAxis
                    stroke="#475569"
                    fontSize={10}
                    domain={[0, yMax]}
                    tickFormatter={v => `${v.toLocaleString()}W`}
                    width={65}
                  />
                  <Tooltip
                    contentStyle={{ background: "#0f172a", border: "1px solid #334155", borderRadius: "8px", fontSize: "12px", color: "#e2e8f0" }}
                    labelStyle={{ color: "#94a3b8", fontWeight: 600 }}
                    formatter={(value, name) => {
                      if (value === null || value === undefined) return ['-', name];
                      return [`${Number(value).toLocaleString()}W`, name];
                    }}
                  />
                  {hasForecast && <Area type="monotone" dataKey="forecast" name="Forecast" stroke="#f59e0b" fill="none" strokeWidth={2} strokeDasharray="6 3" dot={false} connectNulls={false} />}
                  <Area type="monotone" dataKey="solar" name="Solar Power" stroke="#fb923c" fill="url(#gradSolar)" strokeWidth={2} dot={false} connectNulls={false} />
                  <Area type="monotone" dataKey="grid" name="Grid Power" stroke="#34d399" fill="url(#gradGrid)" strokeWidth={1.5} dot={false} connectNulls={false} />
                  <Area type="monotone" dataKey="exported" name="Exported" stroke="#38bdf8" fill="url(#gradExport)" strokeWidth={1.5} dot={false} connectNulls={false} />
                </AreaChart>
              </ResponsiveContainer>
            </div>
            );
          })()}

          {/* Daily Energy Overview */}
          {solarDaily.length > 0 && (
            <div style={S.card}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "8px" }}>
                <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0" }}>Daily Energy Overview</div>
                <button onClick={() => setShowProviderImport(true)} style={{
                  background: "#1e293b", color: "#94a3b8", border: "1px solid #334155", borderRadius: "6px",
                  padding: "4px 10px", fontSize: "11px", cursor: "pointer", fontWeight: 500
                }}>Import Provider Data</button>
              </div>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={solarDaily.map(d => {
                  const consumed = parseFloat(d.grid_consumed_kwh || 0);
                  const feedin = parseFloat(d.feed_in_kwh || 0);
                  const hasProvider = consumed > 0 || feedin > 0;
                  const importCost = hasProvider ? consumed * blendedRates.blendedImport : null;
                  const feedinCredit = hasProvider ? feedin * blendedRates.feedInRate : null;
                  const netCostDay = hasProvider ? importCost - feedinCredit + blendedRates.supplyDaily : null;
                  return {
                    date: d.date?.slice(5) || '',
                    fullDate: d.date || '',
                    yield: parseFloat(d.total_yield_kwh || 0),
                    consumed, feedin,
                    selfUsed: parseFloat(d.self_consumed_kwh || 0),
                    importCost, feedinCredit, netCostDay,
                  };
                })}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />
                  <XAxis dataKey="date" stroke="#475569" fontSize={10} />
                  <YAxis stroke="#475569" fontSize={10} />
                  <Tooltip
                    contentStyle={{ background: "#0f172a", border: "1px solid #334155", borderRadius: "8px", fontSize: "12px", color: "#e2e8f0" }}
                    content={({ active, payload, label }) => {
                      if (!active || !payload?.length) return null;
                      const d = payload[0]?.payload;
                      return (
                        <div style={{ background: "#0f172a", border: "1px solid #334155", borderRadius: "8px", padding: "10px", fontSize: "12px", color: "#e2e8f0" }}>
                          <div style={{ fontWeight: 600, color: "#94a3b8", marginBottom: "6px" }}>{d?.fullDate || label}</div>
                          {payload.filter(p => p.value > 0).map((p, i) => (
                            <div key={i} style={{ display: "flex", justifyContent: "space-between", gap: "16px", marginBottom: "2px" }}>
                              <span style={{ color: p.color }}>{p.name}</span>
                              <span>{parseFloat(p.value || 0).toFixed(1)} kWh</span>
                            </div>
                          ))}
                          {d?.selfUsed > 0 && (
                            <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", marginBottom: "2px" }}>
                              <span style={{ color: "#a78bfa" }}>Self-Consumed</span>
                              <span>{d.selfUsed.toFixed(1)} kWh</span>
                            </div>
                          )}
                          {d?.netCostDay != null && (
                            <div style={{ borderTop: "1px solid #334155", marginTop: "6px", paddingTop: "6px" }}>
                              <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", color: "#f87171" }}>
                                <span>Import Cost</span><span>${d.importCost?.toFixed(2)}</span>
                              </div>
                              <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", color: "#34d399" }}>
                                <span>Feed-in Credit</span><span>-${d.feedinCredit?.toFixed(2)}</span>
                              </div>
                              <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", color: "#64748b", fontSize: "10px" }}>
                                <span>Supply</span><span>${blendedRates.supplyDaily.toFixed(2)}</span>
                              </div>
                              <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", fontWeight: 700, color: d.netCostDay >= 0 ? "#f87171" : "#34d399", marginTop: "4px" }}>
                                <span>Net Daily Cost</span><span>{d.netCostDay >= 0 ? '' : '-'}${Math.abs(d.netCostDay).toFixed(2)}</span>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    }}
                  />
                  <Legend wrapperStyle={{ fontSize: "11px" }} />
                  <Bar dataKey="yield" name="Solar Generated" fill="#fbbf24" radius={[4, 4, 0, 0]} />
                  <Bar dataKey="consumed" name="Grid Import" fill="#f87171" radius={[4, 4, 0, 0]} />
                  <Bar dataKey="feedin" name="Feed-in Export" fill="#34d399" radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
              {/* Cost Summary Row */}
              {(() => {
                const withCosts = solarDaily.filter(d => parseFloat(d.grid_consumed_kwh || 0) > 0);
                if (withCosts.length === 0) return null;
                const totalImport = withCosts.reduce((s, d) => s + parseFloat(d.grid_consumed_kwh || 0) * blendedRates.blendedImport, 0);
                const totalFeedin = withCosts.reduce((s, d) => s + parseFloat(d.feed_in_kwh || 0) * blendedRates.feedInRate, 0);
                const totalSupply = withCosts.length * blendedRates.supplyDaily;
                const totalNet = totalImport - totalFeedin + totalSupply;
                const avgDaily = totalNet / withCosts.length;
                return (
                  <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginTop: "10px", fontSize: "12px" }}>
                    {[
                      { label: `Import Cost (${withCosts.length}d)`, value: `$${totalImport.toFixed(2)}`, color: "#f87171" },
                      { label: "Feed-in Credit", value: `-$${totalFeedin.toFixed(2)}`, color: "#34d399" },
                      { label: `Supply (${withCosts.length}d)`, value: `$${totalSupply.toFixed(2)}`, color: "#94a3b8" },
                      { label: "Net Cost", value: `$${totalNet.toFixed(2)}`, color: totalNet >= 0 ? "#f87171" : "#34d399" },
                      { label: "Avg Daily", value: `$${avgDaily.toFixed(2)}/day`, color: "#fbbf24" },
                    ].map((s, i) => (
                      <div key={i} style={{ flex: "1 1 100px", background: "#1e293b", borderRadius: "6px", padding: "8px", textAlign: "center" }}>
                        <div style={{ color: "#64748b", fontSize: "10px" }}>{s.label}</div>
                        <div style={{ color: s.color, fontWeight: 700 }}>{s.value}</div>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
          )}

          {/* Provider Data Import Modal */}
          {showProviderImport && (
            <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center" }}
              onClick={e => { if (e.target === e.currentTarget) setShowProviderImport(false); }}>
              <div style={{ background: "#0f172a", border: "1px solid #334155", borderRadius: "12px", padding: "24px", width: "min(560px, 90vw)", maxHeight: "80vh", overflow: "auto" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "16px" }}>
                  <div style={{ fontSize: "16px", fontWeight: 700, color: "#e2e8f0" }}>Import Provider Data</div>
                  <button onClick={() => setShowProviderImport(false)} style={{ background: "none", border: "none", color: "#64748b", fontSize: "20px", cursor: "pointer" }}>x</button>
                </div>
                <div style={{ fontSize: "12px", color: "#64748b", marginBottom: "12px" }}>
                  Paste your energy provider data below. One day per line.<br/>
                  Format: <span style={{ color: "#94a3b8", fontFamily: "monospace" }}>date consumed feedin</span> (separated by spaces, tabs, or commas)<br/>
                  Date formats: <span style={{ color: "#94a3b8", fontFamily: "monospace" }}>2026-02-01</span> or <span style={{ color: "#94a3b8", fontFamily: "monospace" }}>1/2/2026</span> or <span style={{ color: "#94a3b8", fontFamily: "monospace" }}>1st Feb</span> etc.
                </div>
                <div style={{ fontSize: "11px", color: "#475569", marginBottom: "12px", background: "#1e293b", borderRadius: "6px", padding: "8px", fontFamily: "monospace" }}>
                  Example:<br/>
                  2026-02-01 27.918 23.05<br/>
                  2026-02-02 34.032 17.719<br/>
                  2026-02-03, 37.386, 16.477
                </div>
                <textarea
                  value={providerImportText}
                  onChange={e => setProviderImportText(e.target.value)}
                  placeholder="Paste provider data here..."
                  style={{
                    width: "100%", height: "200px", background: "#1e293b", color: "#e2e8f0", border: "1px solid #334155",
                    borderRadius: "8px", padding: "12px", fontSize: "12px", fontFamily: "monospace", resize: "vertical",
                    boxSizing: "border-box"
                  }}
                />
                {providerImportStatus && (
                  <div style={{ marginTop: "8px", fontSize: "12px", color: providerImportStatus.error ? "#f87171" : "#34d399" }}>
                    {providerImportStatus.error || providerImportStatus.message}
                  </div>
                )}
                <div style={{ display: "flex", gap: "8px", marginTop: "12px", justifyContent: "flex-end" }}>
                  <button onClick={() => { setShowProviderImport(false); setProviderImportStatus(null); }} style={{
                    background: "#1e293b", color: "#94a3b8", border: "1px solid #334155", borderRadius: "6px",
                    padding: "8px 16px", fontSize: "12px", cursor: "pointer"
                  }}>Cancel</button>
                  <button onClick={async () => {
                    setProviderImportStatus(null);
                    const lines = providerImportText.trim().split('\n').filter(l => l.trim());
                    if (!lines.length) { setProviderImportStatus({ error: 'No data to import' }); return; }

                    const currentYear = new Date().getFullYear();
                    const monthNames = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

                    const rows = [];
                    const errors = [];
                    lines.forEach((line, i) => {
                      // Normalize separators: replace tabs and commas with spaces, collapse multiple spaces
                      const clean = line.replace(/[,\t]+/g, ' ').replace(/\s+/g, ' ').trim();
                      // Try to extract: flexible date + two numbers
                      // Remove ordinal suffixes (1st, 2nd, 3rd, 4th etc)
                      const noOrd = clean.replace(/(\d+)(st|nd|rd|th)\b/gi, '$1');
                      const parts = noOrd.split(' ');

                      // Find the two numbers (consumed, feedin) - they'll be the last two numeric parts
                      const nums = [];
                      const dateParts = [];
                      parts.forEach(p => {
                        const n = parseFloat(p);
                        if (!isNaN(n) && p.match(/^\d+\.?\d*$/)) nums.push(n);
                        else dateParts.push(p);
                      });

                      if (nums.length < 2) { errors.push(`Line ${i+1}: need at least 2 numbers (consumed, feedin)`); return; }

                      // Last two numbers are consumed and feedin; any leading number might be a day
                      let consumed, feedin, dayNum;
                      if (nums.length >= 3) {
                        dayNum = nums[0]; consumed = nums[1]; feedin = nums[2];
                      } else {
                        consumed = nums[0]; feedin = nums[1];
                      }

                      // Parse date from dateParts + optional dayNum
                      let dateStr = '';
                      const dateJoined = dateParts.join(' ').toLowerCase().trim();

                      if (dateJoined.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                        // ISO format: 2026-02-01
                        const [y, m, d] = dateJoined.split('-');
                        dateStr = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                      } else if (dateJoined.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        // D/M/YYYY
                        const [d, m, y] = dateJoined.split('/');
                        dateStr = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                      } else if (dateJoined.match(/^\d{1,2}\/\d{1,2}$/)) {
                        // D/M (assume current year)
                        const [d, m] = dateJoined.split('/');
                        dateStr = `${currentYear}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                      } else {
                        // Try month name: "Feb" or "February" with a day number
                        const monthMatch = monthNames.findIndex(mn => dateJoined.includes(mn));
                        if (monthMatch >= 0 && dayNum) {
                          dateStr = `${currentYear}-${String(monthMatch+1).padStart(2,'0')}-${String(Math.round(dayNum)).padStart(2,'0')}`;
                        } else if (monthMatch >= 0) {
                          // Try to find a day number in dateParts
                          const dayInDate = dateJoined.match(/\d+/);
                          if (dayInDate) {
                            dateStr = `${currentYear}-${String(monthMatch+1).padStart(2,'0')}-${String(dayInDate[0]).padStart(2,'0')}`;
                          }
                        }
                      }

                      if (!dateStr) { errors.push(`Line ${i+1}: couldn't parse date from "${line.trim()}"`); return; }
                      rows.push({ date: dateStr, consumed, feedin });
                    });

                    if (rows.length === 0) {
                      setProviderImportStatus({ error: errors.length ? errors.join('; ') : 'No valid rows found' });
                      return;
                    }

                    try {
                      const resp = await fetch(`${SOLAR_API_URL}/provider-import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rows })
                      });
                      const result = await resp.json();
                      if (result.success) {
                        const msg = `Imported ${result.total} days (${result.imported} new, ${result.updated} updated)`;
                        setProviderImportStatus({ message: msg + (errors.length ? `. Warnings: ${errors.join('; ')}` : '') });
                        // Refresh solar daily data
                        const dailyResp = await fetch(`${SOLAR_API_URL}/daily?days=90`);
                        if (dailyResp.ok) { const d = await dailyResp.json(); setSolarDaily(d.data || []); }
                      } else {
                        setProviderImportStatus({ error: result.error || 'Import failed' });
                      }
                    } catch (e) {
                      setProviderImportStatus({ error: `Request failed: ${e.message}` });
                    }
                  }} style={{
                    background: "#2563eb", color: "#fff", border: "none", borderRadius: "6px",
                    padding: "8px 20px", fontSize: "12px", cursor: "pointer", fontWeight: 600
                  }}>Import</button>
                </div>
              </div>
            </div>
          )}

          {/* Battery Savings Simulation */}
          {(() => {
            const daysWithProvider = solarDaily.filter(d => parseFloat(d.grid_consumed_kwh || 0) > 0);
            if (daysWithProvider.length < 2) return null;

            const bCap = cfg.usableCapacity;
            const bEff = (cfg.inverterEfficiency || 97.5) / 100;

            const simData = daysWithProvider.map(d => {
              const consumed = parseFloat(d.grid_consumed_kwh || 0);
              const feedin = parseFloat(d.feed_in_kwh || 0);

              // Without battery
              const costWithout = consumed * blendedRates.blendedImport - feedin * blendedRates.feedInRate + blendedRates.supplyDaily;

              // With battery: charge from excess solar (what would have been exported)
              const batteryCharge = Math.min(feedin, bCap);
              const batteryDischarge = batteryCharge * bEff;
              const newGridImport = Math.max(0, consumed - batteryDischarge);
              const newFeedin = Math.max(0, feedin - batteryCharge);

              const costWith = newGridImport * blendedRates.blendedImport - newFeedin * blendedRates.feedInRate + blendedRates.supplyDaily;

              return {
                date: d.date?.slice(5) || '',
                fullDate: d.date || '',
                costWithout: Math.round(costWithout * 100) / 100,
                costWith: Math.round(costWith * 100) / 100,
                savings: Math.round((costWithout - costWith) * 100) / 100,
                consumed, feedin,
                batteryCharge: Math.round(batteryCharge * 10) / 10,
                batteryDischarge: Math.round(batteryDischarge * 10) / 10,
                newGridImport: Math.round(newGridImport * 10) / 10,
                newFeedin: Math.round(newFeedin * 10) / 10,
              };
            });

            const totalSavings = simData.reduce((s, d) => s + d.savings, 0);
            const avgDailySavings = totalSavings / simData.length;
            const projectedAnnual = avgDailySavings * 365;
            const paybackYears = projectedAnnual > 0 ? netCost / projectedAnnual : Infinity;
            const totalWithout = simData.reduce((s, d) => s + d.costWithout, 0);
            const savingsPct = totalWithout > 0 ? (totalSavings / totalWithout) * 100 : 0;

            return (
              <div style={S.card}>
                <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0", marginBottom: "4px" }}>Battery Savings Simulation</div>
                <div style={{ fontSize: "11px", color: "#475569", marginBottom: "12px" }}>
                  Simulated impact of {cfg.batteryModel || 'battery'} ({bCap} kWh usable, {(bEff * 100).toFixed(1)}% eff.) on your actual energy costs
                </div>

                {/* Summary Stats */}
                <div style={{ display: "flex", gap: "10px", flexWrap: "wrap", marginBottom: "14px" }}>
                  <div style={S.stat("#34d399")}><div style={S.sL}>Total Savings ({simData.length}d)</div><div style={S.sV("#34d399")}>${totalSavings.toFixed(2)}</div><div style={S.sS}>{savingsPct.toFixed(0)}% cost reduction</div></div>
                  <div style={S.stat("#fbbf24")}><div style={S.sL}>Avg Daily Savings</div><div style={S.sV("#fbbf24")}>${avgDailySavings.toFixed(2)}</div><div style={S.sS}>per day</div></div>
                  <div style={S.stat("#38bdf8")}><div style={S.sL}>Projected Annual</div><div style={S.sV("#38bdf8")}>${Math.round(projectedAnnual).toLocaleString()}</div><div style={S.sS}>estimated yearly savings</div></div>
                  <div style={S.stat("#f59e0b")}><div style={S.sL}>Simple Payback</div><div style={S.sV("#f59e0b")}>{paybackYears < 100 ? `${paybackYears.toFixed(1)} yrs` : 'N/A'}</div><div style={S.sS}>at {fmt(netCost)} net cost</div></div>
                </div>

                {/* Grouped Bar Chart: Without vs With Battery */}
                <ResponsiveContainer width="100%" height={280}>
                  <BarChart data={simData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" />
                    <XAxis dataKey="date" stroke="#475569" fontSize={10} />
                    <YAxis stroke="#475569" fontSize={10} tickFormatter={v => `$${v}`} />
                    <Tooltip
                      content={({ active, payload, label }) => {
                        if (!active || !payload?.length) return null;
                        const d = payload[0]?.payload;
                        return (
                          <div style={{ background: "#0f172a", border: "1px solid #334155", borderRadius: "8px", padding: "10px", fontSize: "12px", color: "#e2e8f0" }}>
                            <div style={{ fontWeight: 600, color: "#94a3b8", marginBottom: "6px" }}>{d?.fullDate || label}</div>
                            <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", marginBottom: "2px" }}>
                              <span style={{ color: "#f87171" }}>Without Battery</span><span>${d?.costWithout?.toFixed(2)}</span>
                            </div>
                            <div style={{ display: "flex", justifyContent: "space-between", gap: "16px", marginBottom: "2px" }}>
                              <span style={{ color: "#38bdf8" }}>With Battery</span><span>${d?.costWith?.toFixed(2)}</span>
                            </div>
                            <div style={{ borderTop: "1px solid #334155", marginTop: "4px", paddingTop: "4px", display: "flex", justifyContent: "space-between", gap: "16px", fontWeight: 700, color: "#34d399" }}>
                              <span>Daily Savings</span><span>${d?.savings?.toFixed(2)}</span>
                            </div>
                            <div style={{ fontSize: "10px", color: "#475569", marginTop: "6px" }}>
                              Battery: stored {d?.batteryCharge} kWh, discharged {d?.batteryDischarge} kWh
                            </div>
                            <div style={{ fontSize: "10px", color: "#475569" }}>
                              Grid: {d?.consumed?.toFixed(1)} → {d?.newGridImport} kWh | Export: {d?.feedin?.toFixed(1)} → {d?.newFeedin} kWh
                            </div>
                          </div>
                        );
                      }}
                    />
                    <Legend wrapperStyle={{ fontSize: "11px" }} />
                    <Bar dataKey="costWithout" name="Without Battery" fill="#f87171" radius={[4, 4, 0, 0]} />
                    <Bar dataKey="costWith" name="With Battery" fill="#38bdf8" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>

                <div style={{ fontSize: "10px", color: "#475569", marginTop: "6px", textAlign: "center" }}>
                  Blended import rate: ${blendedRates.blendedImport.toFixed(4)}/kWh (40% peak + 45% off-peak + 15% CL, incl. {rateSets[rateSets.length-1].disc}% discount + GST) | Feed-in: ${blendedRates.feedInRate.toFixed(3)}/kWh
                </div>
              </div>
            );
          })()}

          {/* Monthly Summary */}
          {solarMonthly.length > 0 && (
            <div style={S.card}>
              <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0", marginBottom: "8px" }}>Monthly Summary</div>
              <div style={{ overflowX: "auto" }}>
                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "12px" }}>
                  <thead>
                    <tr style={{ borderBottom: "1px solid #334155" }}>
                      {["Month", "Total kWh", "Avg Daily", "Best Day", "Peak Day", "Days", "Avg Peak W"].map(h => (
                        <th key={h} style={{ padding: "8px 6px", color: "#94a3b8", fontWeight: 600, textAlign: "left" }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {solarMonthly.map((m, i) => (
                      <tr key={i} style={{ borderBottom: "1px solid #1e293b" }}>
                        <td style={{ padding: "6px", color: "#e2e8f0", fontWeight: 500 }}>{m.month}</td>
                        <td style={{ padding: "6px", color: "#38bdf8" }}>{(m.total_yield_kwh || 0).toFixed(1)}</td>
                        <td style={{ padding: "6px", color: "#34d399" }}>{(m.avg_daily_kwh || 0).toFixed(1)}</td>
                        <td style={{ padding: "6px", color: "#fbbf24" }}>{(m.peak_day_kwh || 0).toFixed(1)}</td>
                        <td style={{ padding: "6px", color: "#94a3b8" }}>{m.peak_day_date || '-'}</td>
                        <td style={{ padding: "6px", color: "#94a3b8" }}>{m.days_with_data || 0}</td>
                        <td style={{ padding: "6px", color: "#fb923c" }}>{(m.avg_peak_power_w || 0).toFixed(0)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* System Info */}
          {solarStats && (
            <div style={S.card}>
              <div style={{ fontSize: "13px", fontWeight: 600, color: "#e2e8f0", marginBottom: "8px" }}>System Information</div>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: "8px", fontSize: "12px" }}>
                {[
                  { label: "Inverter Model", value: solarLive?.type || "Solax AL_SI4" },
                  { label: "Serial Number", value: solarLive?.sn || "N/A" },
                  { label: "Inverter IP", value: solarStats.inverter_ip || "192.168.68.55" },
                  { label: "Collector Status", value: solarStats.collector_status || "unknown" },
                  { label: "Total Readings", value: (solarStats.total_readings || 0).toLocaleString() },
                  { label: "Days Collected", value: solarStats.days_collected || 0 },
                  { label: "Lifetime Yield", value: `${(solarLive?.total_yield || 0).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})} kWh` },
                  { label: "Last Update", value: solarLive?.timestamp || "N/A" },
                ].map((info, i) => (
                  <div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "6px 0", borderBottom: "1px solid #1e293b" }}>
                    <span style={{ color: "#64748b" }}>{info.label}</span>
                    <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{info.value}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>}
  </>);
}


/* ══════════════════════════════════════════════════════════════
   Battery ROI Calculator — Main App Component
   ══════════════════════════════════════════════════════════════ */

const { useState, useMemo, useCallback, useEffect } = React;

function BatteryROI() {
  const [tab, setTab] = useState(0);
  const [viewYr, setViewYr] = useState(1);
  const [chartMode, setChartMode] = useState("total");

  const [rateSets, setRateSets] = useState(
    saved?.rateSets || [makeRateSet("2025-01-01", "Rate period 1", {})]
  );
  const [editingRate, setEditingRate] = useState(0);

  /* Dynamic bill entries — no fixed month grid */
  const [entries, setEntries] = useState(saved?.entries || []);
  const [draft, setDraft] = useState({ billFrom: "", days: "", sponge: "", peak: "", offPk: "", feedIn: "" });
  const [editingId, setEditingId] = useState(null);

  const [cfg, setCfg] = useState(saved?.cfg || {
    batteryCost: 25282, repsRebate: 9782,
    forecastYears: 10, escalation: 4,
    payType: "finance", financeTerm: 6, financeRate: 6.99,
    useAmber: true, amberFitAvg: 0.12, amberImportDisc: 0.25,
    amberSpikeMult: 1.0, amberFee: 25, scenario: 1.0,
    installerName: "MLEC", batteryModel: "GoodWe GW8.3-BAT-D-G21", batteryCapacity: 33.28,
    usableCapacity: 32, inverterPower: 9.99, chargeRate: 8, inverterEfficiency: 97.5, solarCapacity: 5,
    location: "Adelaide", provider: "Amber Electric",
  });

  // Analysis sub-view state
  const [analysisSubView, setAnalysisSubView] = useState('monthly');

  /* Historical ROI data state */
  const [historicalData, setHistoricalData] = useState(null);
  const [historicalLoading, setHistoricalLoading] = useState(false);
  const [historicalError, setHistoricalError] = useState(false);

  // Tab 5: Daily Details state
  const [selectedDate, setSelectedDate] = useState(null);
  const [viewMode, setViewMode] = useState('day'); // 'day' or 'week'
  const [roiMode, setRoiMode] = useState('hypothetical'); // 'hypothetical' or 'actual'
  const [purchaseDate, setPurchaseDate] = useState(saved?.purchaseDate || HISTORICAL_FIRST_DATE);
  const [forecastData, setForecastData] = useState(null);
  const [forecastLoading, setForecastLoading] = useState(false);
  const [forecastError, setForecastError] = useState(null);

  // Open-Meteo 16-day forecast state
  const [openMeteoForecast, setOpenMeteoForecast] = useState(null);
  const [openMeteoLoading, setOpenMeteoLoading] = useState(false);
  const [openMeteoError, setOpenMeteoError] = useState(null);
  const [forecastSubView, setForecastSubView] = useState('daily');

  // Live DB merge state
  const [liveDataLoaded, setLiveDataLoaded] = useState(false);
  const [liveMonthCount, setLiveMonthCount] = useState(0);

  // Finance scenario override (from FinanceCalculator)
  const [financeOverride, setFinanceOverride] = useState(null);

  // Accelerated repayment toggle (Deliverable 2)
  const [accelerateRepay, setAccelerateRepay] = useState(false);

  // Live Solar state
  const [solarLive, setSolarLive] = useState(null);
  const [solarStats, setSolarStats] = useState(null);
  const [solarDaily, setSolarDaily] = useState([]);
  const [solarMonthly, setSolarMonthly] = useState([]);
  const [solarHourly, setSolarHourly] = useState([]);
  const [solarToday, setSolarToday] = useState([]);
  const [solarConnected, setSolarConnected] = useState(false);
  const [weatherToday, setWeatherToday] = useState(null);
  const [showProviderImport, setShowProviderImport] = useState(false);
  const [providerImportText, setProviderImportText] = useState('');
  const [providerImportStatus, setProviderImportStatus] = useState(null);

  /* Auto-save to localStorage on changes */
  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ entries, rateSets, cfg, purchaseDate, _saved: new Date().toISOString() }));
    } catch {}
  }, [entries, rateSets, cfg, purchaseDate]);

  /* Load historical ROI data when tab 2 is accessed — embedded first, then merge live */
  useEffect(() => {
    if (tab === 2 && !historicalData && !historicalLoading) {
      setHistoricalLoading(true);
      // Instant render from embedded data
      if (HISTORICAL_ROI_DATA && HISTORICAL_ROI_DATA.monthly_results) {
        setHistoricalData(HISTORICAL_ROI_DATA);
        if (!selectedDate && HISTORICAL_ROI_DATA.daily_results && HISTORICAL_ROI_DATA.daily_results.length > 0) {
          const today = new Date().toISOString().split('T')[0];
          const dr = HISTORICAL_ROI_DATA.daily_results;
          const lastDate = dr[dr.length - 1].date;
          setSelectedDate(today <= lastDate ? today : lastDate);
        }
        setHistoricalLoading(false);

        // Async fetch live data and merge
        (async () => {
          try {
            const resp = await fetch(`${SOLAR_API_URL}/roi-daily`);
            if (!resp.ok) return;
            const liveRaw = await resp.json();
            if (!liveRaw.daily || liveRaw.daily.length === 0) return;
            const liveTransformed = transformLiveToHistorical(liveRaw.daily, liveRaw.monthly, cfg);
            const merged = mergeHistoricalData(HISTORICAL_ROI_DATA, liveTransformed);
            setHistoricalData(merged);
            setLiveDataLoaded(true);
            setLiveMonthCount(merged.monthly_results.length);
            // Update selectedDate to most recent if current is beyond embedded range
            const dr = merged.daily_results;
            if (dr.length > 0) {
              const today = new Date().toISOString().split('T')[0];
              const lastDate = dr[dr.length - 1].date;
              setSelectedDate(prev => {
                if (!prev || prev > lastDate) return lastDate;
                if (prev <= lastDate && today <= lastDate) return today;
                return prev;
              });
            }
          } catch (e) {
            console.warn('Live solar data merge failed:', e);
          }
        })();
      } else {
        setHistoricalError(true);
        setHistoricalLoading(false);
      }
    }
  }, [tab, historicalData, historicalLoading]);

  /* Live Solar Data Polling */
  useEffect(() => {
    const fetchSolarLive = async () => {
      try {
        const resp = await fetch(`${SOLAR_API_URL}/realtime?live=true`);
        if (resp.ok) {
          const data = await resp.json();
          setSolarLive(data);
          setSolarConnected(true);
          // Also refresh today's power curve when on the solar tab
          if (tab === 4) {
            try {
              const todayResp = await fetch(`${SOLAR_API_URL}/today?date=${new Date().toISOString().split('T')[0]}`);
              if (todayResp.ok) { const t = await todayResp.json(); setSolarToday(t.readings || []); }
            } catch {}
          }
        } else {
          setSolarConnected(false);
        }
      } catch (e) {
        setSolarConnected(false);
      }
    };
    fetchSolarLive();
    const interval = setInterval(fetchSolarLive, SOLAR_POLL_INTERVAL);
    return () => clearInterval(interval);
  }, [tab]);

  /* Load solar stats & history when solar tab is accessed */
  useEffect(() => {
    if (tab === 4) {
      const loadSolarData = async () => {
        try {
          const today = new Date().toISOString().split('T')[0];
          const [statsResp, dailyResp, monthlyResp, hourlyResp, todayResp] = await Promise.all([
            fetch(`${SOLAR_API_URL}/stats`),
            fetch(`${SOLAR_API_URL}/daily?days=90`),
            fetch(`${SOLAR_API_URL}/monthly`),
            fetch(`${SOLAR_API_URL}/hourly?date=${today}`),
            fetch(`${SOLAR_API_URL}/today?date=${today}`)
          ]);
          if (statsResp.ok) setSolarStats(await statsResp.json());
          if (dailyResp.ok) { const d = await dailyResp.json(); setSolarDaily(d.data || []); }
          if (monthlyResp.ok) { const m = await monthlyResp.json(); setSolarMonthly(m.data || []); }
          if (hourlyResp.ok) { const h = await hourlyResp.json(); setSolarHourly(h.hours || []); }
          if (todayResp.ok) { const t = await todayResp.json(); setSolarToday(t.readings || []); }
          // Fetch weather via server-side proxy and build 7-day forecast
          try {
            const wxResp = await fetch(`${SOLAR_API_URL}/weather`);
            if (wxResp.ok) {
              const wxData = await wxResp.json();
              const todayStr = new Date().toISOString().split('T')[0];
              const todayForecast = wxData.forecast?.find(d => d.date === todayStr);
              setWeatherToday({
                current: wxData.current,
                forecast: todayForecast || wxData.forecast?.[0],
                location: wxData.location
              });
              // Also populate forecastData if not already loaded (same model as Analysis tab)
              if (!forecastData && HISTORICAL_ROI_DATA?.daily_results) {
                const dr = HISTORICAL_ROI_DATA.daily_results;
                const avgSolar = dr.reduce((s, d) => s + d.total_solar_kwh, 0) / dr.length;
                const bCap = cfg.usableCapacity;
                const preds = wxData.forecast.slice(0, 7).map(day => {
                  const weatherMult = BOM_CONDITION_TO_SOLAR[day.condition] || 0.5;
                  const forecastDate = new Date(day.date + 'T00:00:00');
                  const seasonalMult = SEA.feedIn[forecastDate.getMonth()] || 1.0;
                  const combinedMult = weatherMult * seasonalMult;
                  const predKwh = avgSolar * combinedMult;
                  const batteryPred = predictBatteryPerformance(predKwh, bCap, cfg.chargeRate || 8, cfg.inverterEfficiency || 97.5);
                  return {
                    date: day.date,
                    dayName: forecastDate.toLocaleDateString('en-AU', { weekday: 'short' }),
                    condition: day.condition || 'Unknown',
                    conditionIcon: getConditionIcon(day.condition),
                    tempMax: day.temperature,
                    tempMin: day.templow,
                    rainChance: day.precipitation_probability || 0,
                    solarMultiplier: combinedMult,
                    weatherMultiplier: weatherMult,
                    seasonalMultiplier: seasonalMult,
                    ...batteryPred
                  };
                });
                setForecastData(preds);
              }
            }
          } catch (e) {
            console.warn('Weather forecast unavailable:', e.message);
          }
        } catch (e) {
          console.error('Failed to load solar data:', e);
        }
      };
      loadSolarData();
    }
  }, [tab]);

  /* Auto-fetch Open-Meteo 16-day forecast when Forecast or Live Solar tab is accessed */
  useEffect(() => {
    if ((tab === 3 || tab === 4) && !openMeteoForecast && !openMeteoLoading) {
      setOpenMeteoLoading(true);
      setOpenMeteoError(null);
      (async () => {
        try {
          const resp = await fetch(`${SOLAR_API_URL}/weather-forecast`);
          if (resp.ok) {
            const data = await resp.json();
            const processed = processOpenMeteoForecast(data.forecast_days || [], cfg);
            setOpenMeteoForecast(processed);
          } else {
            setOpenMeteoError('Failed to fetch Open-Meteo forecast');
          }
        } catch (e) {
          setOpenMeteoError(e.message);
        } finally {
          setOpenMeteoLoading(false);
        }
      })();
    }
  }, [tab]);

  /* Export/Import helpers */
  const exportData = () => {
    const data = { entries, rateSets, cfg, _exported: new Date().toISOString(), _version: 2 };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `battery-roi-data-${new Date().toISOString().split("T")[0]}.json`;
    a.click(); URL.revokeObjectURL(url);
  };

  const importData = () => {
    const input = document.createElement("input");
    input.type = "file"; input.accept = ".json";
    input.onchange = (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.entries) setEntries(data.entries);
          if (data.rateSets) setRateSets(data.rateSets);
          if (data.cfg) setCfg(prev => ({ ...prev, ...data.cfg }));
        } catch { alert("Invalid JSON file"); }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const netCost = Math.max(0, cfg.batteryCost - cfg.repsRebate);
  const effectiveFinanceTerm = financeOverride ? financeOverride.termYears : cfg.financeTerm;
  const monthlyPmt = cfg.payType === "finance"
    ? (financeOverride ? financeOverride.monthlyPayment : calcPmt(netCost, cfg.financeRate, cfg.financeTerm))
    : 0;
  const financeTermMonths = effectiveFinanceTerm * 12;

  const upC = (k, v) => setCfg(p => ({ ...p, [k]: v }));
  const upD = (k, v) => setDraft(p => ({ ...p, [k]: v }));

  // Blended import rate for daily cost estimates (provider data has no TOU breakdown)
  const blendedRates = useMemo(() => {
    const rs = rateSets[rateSets.length - 1];
    const blendedImport = rs.peak * 0.40 + rs.offPk * 0.45 + rs.sponge * 0.15;
    const discounted = blendedImport * (1 - rs.disc / 100);
    const withGST = discounted * (1 + rs.gst / 100);
    const supplyDaily = rs.supply * (1 - rs.disc / 100) * (1 + rs.gst / 100);
    return { blendedImport: withGST, feedInRate: rs.feedIn, supplyDaily };
  }, [rateSets]);

  /* Derive 12-month pattern from entries (averages per calendar month) — feeds the forecast */
  const mo = useMemo(() => {
    const pattern = MO.map((m, i) => ({ m, days: MD[i], sponge: "", peak: "", offPk: "", feedIn: "", billFrom: "" }));
    const counts = new Array(12).fill(0);
    const sums = Array.from({ length: 12 }, () => ({ sponge: 0, peak: 0, offPk: 0, feedIn: 0, days: 0 }));
    for (const e of entries) {
      const mi = e.month;
      sums[mi].sponge += parseFloat(e.sponge) || 0;
      sums[mi].peak += parseFloat(e.peak) || 0;
      sums[mi].offPk += parseFloat(e.offPk) || 0;
      sums[mi].feedIn += parseFloat(e.feedIn) || 0;
      sums[mi].days += parseInt(e.days) || MD[mi];
      counts[mi]++;
    }
    for (let i = 0; i < 12; i++) {
      if (counts[i] > 0) {
        pattern[i].sponge = (sums[i].sponge / counts[i]).toFixed(2);
        pattern[i].peak = (sums[i].peak / counts[i]).toFixed(2);
        pattern[i].offPk = (sums[i].offPk / counts[i]).toFixed(2);
        pattern[i].feedIn = (sums[i].feedIn / counts[i]).toFixed(2);
        pattern[i].days = Math.round(sums[i].days / counts[i]);
        const latest = entries.filter(e => e.month === i).sort((a, b) => b.billFrom.localeCompare(a.billFrom))[0];
        if (latest) pattern[i].billFrom = latest.billFrom;
      }
    }
    return pattern;
  }, [entries]);

  const hasData = entries.length > 0 && entries.some(e =>
    (parseFloat(e.peak) || 0) > 0 || (parseFloat(e.sponge) || 0) > 0 || (parseFloat(e.offPk) || 0) > 0);

  const addRateSet = () => {
    const last = rateSets[rateSets.length - 1];
    const d = new Date(last.from);
    d.setMonth(d.getMonth() + 6);
    const ds = d.toISOString().split("T")[0];
    setRateSets(p => [...p, makeRateSet(ds, `Rate period ${p.length + 1}`, {
      sponge: last.sponge, peak: last.peak, offPk: last.offPk,
      feedIn: last.feedIn, supply: last.supply, disc: last.disc, gst: last.gst,
    })]);
    setEditingRate(rateSets.length);
  };

  const removeRateSet = (idx) => {
    if (rateSets.length <= 1) return;
    setRateSets(p => p.filter((_, i) => i !== idx));
    setEditingRate(Math.max(0, editingRate >= idx ? editingRate - 1 : editingRate));
  };

  const updateRate = (idx, k, v) => {
    setRateSets(p => { const n = [...p]; n[idx] = { ...n[idx], [k]: v }; return n; });
  };

  /* Rate lookup for derived mo pattern (forecast) */
  const rateForMonth = useMemo(() => {
    return mo.map((m, i) => {
      const target = m.billFrom ? new Date(m.billFrom) : new Date(2025, i, 15);
      const sorted = [...rateSets].sort((a, b) => new Date(b.from) - new Date(a.from));
      for (const rs of sorted) {
        if (new Date(rs.from) <= target) return rs;
      }
      return sorted[sorted.length - 1];
    });
  }, [mo, rateSets]);

  /* Rate lookup for a specific entry */
  const rateForEntry = useCallback((entry) => {
    const target = entry.billFrom ? new Date(entry.billFrom) : new Date(2025, entry.month || 0, 15);
    const sorted = [...rateSets].sort((a, b) => new Date(b.from) - new Date(a.from));
    for (const rs of sorted) {
      if (new Date(rs.from) <= target) return rs;
    }
    return sorted[sorted.length - 1];
  }, [rateSets]);

  /* ── Entry CRUD ── */
  const saveDraft = () => {
    if (!draft.billFrom) return;
    const d = new Date(draft.billFrom + "T00:00");
    const month = d.getMonth();
    const year = d.getFullYear();
    const days = draft.days || MD[month].toString();
    const hasKwh = (parseFloat(draft.sponge) || 0) > 0 || (parseFloat(draft.peak) || 0) > 0 || (parseFloat(draft.offPk) || 0) > 0;
    if (!hasKwh) return;

    if (editingId !== null) {
      setEntries(prev => prev.map(e => e.id === editingId
        ? { ...e, billFrom: draft.billFrom, days, sponge: draft.sponge, peak: draft.peak, offPk: draft.offPk, feedIn: draft.feedIn, month, year }
        : e).sort((a, b) => a.billFrom.localeCompare(b.billFrom)));
    } else {
      setEntries(prev => [...prev,
        { id: Date.now() + Math.random(), billFrom: draft.billFrom, days, sponge: draft.sponge, peak: draft.peak, offPk: draft.offPk, feedIn: draft.feedIn, month, year }
      ].sort((a, b) => a.billFrom.localeCompare(b.billFrom)));
    }
    /* Auto-advance to next month */
    const next = new Date(d);
    next.setMonth(next.getMonth() + 1);
    setDraft({ billFrom: next.toISOString().split("T")[0], days: MD[next.getMonth()].toString(), sponge: "", peak: "", offPk: "", feedIn: "" });
    setEditingId(null);
  };

  const editEntry = (entry) => {
    setDraft({ billFrom: entry.billFrom, days: entry.days, sponge: entry.sponge, peak: entry.peak, offPk: entry.offPk, feedIn: entry.feedIn });
    setEditingId(entry.id);
  };

  const cancelEdit = () => {
    setDraft({ billFrom: "", days: "", sponge: "", peak: "", offPk: "", feedIn: "" });
    setEditingId(null);
  };

  const removeEntry = (id) => {
    setEntries(prev => prev.filter(e => e.id !== id));
    if (editingId === id) cancelEdit();
  };

  const autoFill = () => {
    if (entries.length === 0) return;
    const src = entries[0];
    const srcMi = src.month;
    const base = { sponge: parseFloat(src.sponge) || 0, peak: parseFloat(src.peak) || 0, offPk: parseFloat(src.offPk) || 0, feedIn: parseFloat(src.feedIn) || 0 };
    const filled = new Set(entries.map(e => e.month));
    const newEntries = [];
    for (let i = 0; i < 12; i++) {
      if (filled.has(i)) continue;
      const d = new Date(src.billFrom + "T00:00");
      d.setMonth(i);
      if (d.getMonth() !== i) d.setDate(0);
      newEntries.push({
        id: Date.now() + Math.random() + i,
        billFrom: d.toISOString().split("T")[0], month: i, year: d.getFullYear(),
        days: MD[i].toString(),
        sponge: (Math.round(base.sponge * (SEA.sponge[i] / SEA.sponge[srcMi]) * 10) / 10).toString(),
        peak: (Math.round(base.peak * (SEA.peak[i] / SEA.peak[srcMi]) * 10) / 10).toString(),
        offPk: (Math.round(base.offPk * (SEA.offPk[i] / SEA.offPk[srcMi]) * 10) / 10).toString(),
        feedIn: (Math.round(base.feedIn * (SEA.feedIn[i] / SEA.feedIn[srcMi]) * 10) / 10).toString(),
      });
    }
    setEntries(prev => [...prev, ...newEntries].sort((a, b) => a.billFrom.localeCompare(b.billFrom)));
  };

  const loadSample = () => {
    const base = { sponge: 10.11, peak: 329.87, offPk: 133.32, feedIn: 518.06 };
    setEntries(MO.map((m, i) => ({
      id: Date.now() + Math.random() + i,
      billFrom: `2024-${String(i + 1).padStart(2, "0")}-01`, month: i, year: 2024,
      days: MD[i].toString(),
      sponge: (Math.round(base.sponge * SEA.sponge[i] * 10) / 10).toString(),
      peak: (Math.round(base.peak * SEA.peak[i] * 10) / 10).toString(),
      offPk: (Math.round(base.offPk * SEA.offPk[i] * 10) / 10).toString(),
      feedIn: (Math.round(base.feedIn * SEA.feedIn[i] * 10) / 10).toString(),
    })));
  };

  const clearAll = () => { setEntries([]); cancelEdit(); };

  /* Per-entry bill calculations (for collected table) */
  const entryBills = useMemo(() => {
    return entries.map(e => {
      const d = { days: parseInt(e.days) || MD[e.month], sponge: parseFloat(e.sponge) || 0, peak: parseFloat(e.peak) || 0, offPk: parseFloat(e.offPk) || 0, feedIn: parseFloat(e.feedIn) || 0 };
      if (d.peak === 0 && d.sponge === 0 && d.offPk === 0) return null;
      const rate = rateForEntry(e);
      return { ...calcBill(d, rate), rateLabel: rate.label };
    });
  }, [entries, rateForEntry]);

  /* Totals across all entries */
  const totalBill = entryBills.reduce((s, b) => s + (b ? b.total : 0), 0);
  const totalDays = entries.reduce((s, e) => s + (parseInt(e.days) || 0), 0);
  const totalImport = entries.reduce((s, e) => s + (parseFloat(e.sponge) || 0) + (parseFloat(e.peak) || 0) + (parseFloat(e.offPk) || 0), 0);
  const totalExport = entries.reduce((s, e) => s + (parseFloat(e.feedIn) || 0), 0);
  const monthsCovered = new Set(entries.map(e => e.month)).size;

  /* Forecast-compatible totals from derived 12-month pattern */
  const curBills = useMemo(() => mo.map((m, i) => {
    const d = { days: parseInt(m.days) || MD[i], sponge: parseFloat(m.sponge) || 0, peak: parseFloat(m.peak) || 0, offPk: parseFloat(m.offPk) || 0, feedIn: parseFloat(m.feedIn) || 0 };
    if (d.peak === 0 && d.sponge === 0 && d.offPk === 0) return null;
    return { ...calcBill(d, rateForMonth[i]), rateLabel: rateForMonth[i].label };
  }), [mo, rateForMonth]);
  const annualBill = curBills.reduce((s, b) => s + (b ? b.total : 0), 0);
  const annualImport = mo.reduce((s, m) => s + (parseFloat(m.sponge) || 0) + (parseFloat(m.peak) || 0) + (parseFloat(m.offPk) || 0), 0);
  const annualExport = mo.reduce((s, m) => s + (parseFloat(m.feedIn) || 0), 0);

  /* ── FORECAST ── */
  const forecast = useMemo(() => {
    if (!hasData) return null;
    const monthly = [];
    let cumSav = cfg.payType === "upfront" ? -netCost : 0;
    const cumData = [];
    const sortedRates = [...rateSets].sort((a, b) => new Date(a.from) - new Date(b.from));

    for (let month = 0; month < cfg.forecastYears * 12; month++) {
      const mi = month % 12;
      const yr = Math.floor(month / 12);
      const esc = Math.pow(1 + cfg.escalation / 100, yr + 1);
      const sc = cfg.scenario;
      // 2% annual battery degradation — effective capacity decreases each year
      const degradation = 1 - 0.02 * yr;

      const d = { days: parseInt(mo[mi].days) || MD[mi], sponge: parseFloat(mo[mi].sponge) || 0, peak: parseFloat(mo[mi].peak) || 0, offPk: parseFloat(mo[mi].offPk) || 0, feedIn: parseFloat(mo[mi].feedIn) || 0 };
      if (d.peak === 0 && d.sponge === 0 && d.offPk === 0) continue;

      const baseRate = sortedRates[sortedRates.length - 1];
      const escR = { ...baseRate, sponge: baseRate.sponge * esc, peak: baseRate.peak * esc, offPk: baseRate.offPk * esc, supply: baseRate.supply * esc, feedIn: baseRate.feedIn };
      const noBatt = calcBill(d, escR);

      // Apply degradation to battery effectiveness
      const bd = {
        days: d.days,
        sponge: Math.max(0, d.sponge * (1 - BAT.spongeR[mi] * sc * degradation)),
        peak: Math.max(0, d.peak * (1 - BAT.peakR[mi] * sc * degradation)),
        offPk: Math.max(0, d.offPk * (1 - BAT.offPkR[mi] * sc * degradation)),
        feedIn: Math.max(0, d.feedIn * (1 - BAT.feedInR[mi] * sc * degradation)),
      };

      let battBill, amberBonus = 0;
      if (cfg.useAmber) {
        const aR = {
          sponge: escR.sponge * (1 - cfg.amberImportDisc), peak: escR.peak * (1 - cfg.amberImportDisc),
          offPk: escR.offPk * (1 - cfg.amberImportDisc), feedIn: cfg.amberFitAvg,
          supply: escR.supply, disc: 0, gst: baseRate.gst,
        };
        battBill = calcBill(bd, aR);
        amberBonus = BAT.amberSpike[mi] * cfg.amberSpikeMult * Math.min(sc, 1.2);
        battBill = { ...battBill, total: Math.max(d.days * escR.supply * 0.2, battBill.total - amberBonus + cfg.amberFee) };
      } else {
        battBill = calcBill(bd, escR);
      }

      // Only charge finance payments within the loan term
      const pmt = (cfg.payType === "finance" && month < financeTermMonths) ? monthlyPmt : 0;
      const totalWithBatt = battBill.total + pmt;
      const energySaving = noBatt.total - battBill.total; // pure energy benefit
      const saving = noBatt.total - totalWithBatt;         // net after finance
      cumSav += saving;

      monthly.push({
        label: MO[mi], mi, year: yr + 1,
        noBattery: Math.round(noBatt.total),
        energyOnly: Math.round(battBill.total),
        batteryPmt: Math.round(pmt),
        totalCost: Math.round(totalWithBatt),
        saving: Math.round(saving),
        energySaving: Math.round(energySaving),
        amberBonus: Math.round(amberBonus),
        degradation: Math.round(degradation * 100),
      });
      cumData.push({ month: month + 1, label: `${MO[mi]} Y${yr + 1}`, cumSav: Math.round(cumSav) });
    }

    const annual = [];
    for (let y = 0; y < cfg.forecastYears; y++) {
      const yd = monthly.filter(d => d.year === y + 1);
      if (!yd.length) continue;
      annual.push({
        year: `Year ${y + 1}`,
        noBattery: yd.reduce((s, d) => s + d.noBattery, 0),
        energyOnly: yd.reduce((s, d) => s + d.energyOnly, 0),
        batteryPmt: yd.reduce((s, d) => s + d.batteryPmt, 0),
        totalCost: yd.reduce((s, d) => s + d.totalCost, 0),
        saving: yd.reduce((s, d) => s + d.saving, 0),
        energySaving: yd.reduce((s, d) => s + d.energySaving, 0),
      });
    }

    const totalEnergySav = monthly.reduce((s, d) => s + d.energySaving, 0);
    const totalSav = monthly.reduce((s, d) => s + d.saving, 0);
    const totalNB = monthly.reduce((s, d) => s + d.noBattery, 0);
    const totalPmts = monthly.reduce((s, d) => s + d.batteryPmt, 0);
    // Breakeven: for upfront, first month cumSav reaches 0 from negative start
    // For finance, skip initial 0 — find first month cumSav returns to 0 after going negative
    const beIdx = cumData.findIndex((d, i) => {
      if (d.cumSav >= 0 && i > 0) {
        // Must have been negative at some earlier point
        return cumData.slice(0, i).some(p => p.cumSav < 0);
      }
      return false;
    });
    const be = beIdx >= 0 ? beIdx : cumData.findIndex(d => d.cumSav >= 0);
    const totalFinanceCost = cfg.payType === "finance" ? totalPmts - netCost : 0; // interest + fees only
    const energyROI = (totalEnergySav / netCost) * 100;
    const trueROI = cfg.payType === "finance"
      ? ((totalEnergySav - totalFinanceCost) / netCost) * 100
      : energyROI;

    return {
      monthly, annual, cumData, summary: {
        totalSav, totalEnergySav, totalNB, avgMo: totalSav / monthly.length,
        breakeven: be >= 0 ? be + 1 : null,
        roi: trueROI,
        energyROI,
        trueROI,
        totalFinanceCost,
        totalPmts,
        annAvg: totalEnergySav / cfg.forecastYears,
      }
    };
  }, [mo, rateSets, cfg, hasData, netCost, monthlyPmt, financeOverride]);

  const scLabel = cfg.scenario <= 0.75 ? "Conservative" : cfg.scenario <= 1.05 ? "Moderate" : "Optimistic";
  const scColor = cfg.scenario <= 0.75 ? "#f87171" : cfg.scenario <= 1.05 ? "#fbbf24" : "#34d399";

  const rateFields = [
    { k: "sponge", l: "Solar Sponge", c: "#38bdf8", u: "$/kWh" },
    { k: "peak", l: "Peak", c: "#f87171", u: "$/kWh" },
    { k: "offPk", l: "Off-Peak", c: "#a78bfa", u: "$/kWh" },
    { k: "feedIn", l: "Feed-In", c: "#34d399", u: "$/kWh" },
    { k: "supply", l: "Supply", c: "#fbbf24", u: "$/day" },
    { k: "disc", l: "Discount", c: "#94a3b8", u: "%" },
  ];

  /* ═══ RENDER ═══ */
  return (
    <div style={S.page}>
      <div style={S.hdr}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap", gap: "8px" }}>
          <div>
            <h1 style={S.h1}>⚡ Battery ROI Calculator</h1>
            <p style={S.sub}>{cfg.installerName} {cfg.batteryModel} {cfg.batteryCapacity}kWh · {cfg.location} TOU Tariff · {cfg.provider}</p>
          </div>
          <div style={{ display: "flex", gap: "10px", alignItems: "center", flexWrap: "wrap" }}>
            <div style={{ display: "flex", gap: "4px", background: "#0f172a", padding: "3px", borderRadius: "7px", border: "1px solid #334155" }}>
              <button style={{ ...S.tgl(roiMode === 'hypothetical'), fontSize: "10px", padding: "4px 8px" }} onClick={() => setRoiMode('hypothetical')}>Hypothetical</button>
              <button style={{ ...S.tgl(roiMode === 'actual'), fontSize: "10px", padding: "4px 8px" }} onClick={() => setRoiMode('actual')}>Actual</button>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
              <label style={{ fontSize: "10px", color: "#94a3b8", fontWeight: 600 }}>Install Date</label>
              <input type="date" value={purchaseDate} onChange={(e) => setPurchaseDate(e.target.value)}
                style={{ padding: "4px 8px", border: "1px solid #334155", borderRadius: "6px", background: "#0f172a", color: "#e2e8f0", fontSize: "11px" }} />
            </div>
            <div style={{ display: "flex", gap: "4px", alignItems: "center" }}>
              {entries.length > 0 && <span style={{ fontSize: "10px", color: "#34d399", marginRight: "2px" }}>● Saved</span>}
              <button onClick={exportData} style={{ padding: "4px 8px", border: "1px solid #334155", borderRadius: "5px", cursor: "pointer", fontSize: "10px", color: "#94a3b8", background: "transparent" }} title="Download all data as JSON">📥</button>
              <button onClick={importData} style={{ padding: "4px 8px", border: "1px solid #334155", borderRadius: "5px", cursor: "pointer", fontSize: "10px", color: "#94a3b8", background: "transparent" }} title="Load data from JSON file">📤</button>
            </div>
          </div>
        </div>
      </div>

      {/* ═══ LIVE SOLAR STATUS BAR ═══ */}
      {solarConnected && solarLive && (
        <div style={{ background: "linear-gradient(135deg, #0f172a 0%, #1a2332 100%)", border: "1px solid #1e3a5f", borderRadius: "10px", padding: "10px 16px", margin: "0 0 8px 0", display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "8px", cursor: "pointer" }} onClick={() => setTab(4)}>
          <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
            <span style={{ fontSize: "18px" }}>{solarLive.total_pv_power > 100 ? "☀️" : "🌙"}</span>
            <div>
              <div style={{ fontSize: "13px", fontWeight: 700, color: solarLive.total_pv_power > 100 ? "#fbbf24" : "#64748b" }}>
                {typeof solarLive.total_pv_power === 'number' ? solarLive.total_pv_power.toLocaleString() : '0'}W
              </div>
              <div style={{ fontSize: "10px", color: "#64748b" }}>PV Power</div>
            </div>
          </div>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "13px", fontWeight: 600, color: "#38bdf8" }}>{solarLive.today_yield?.toFixed(1) || '0.0'} kWh</div>
            <div style={{ fontSize: "10px", color: "#64748b" }}>Today</div>
          </div>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "13px", fontWeight: 600, color: "#a78bfa" }}>{solarLive.grid_power?.toLocaleString() || '0'}W</div>
            <div style={{ fontSize: "10px", color: "#64748b" }}>Grid</div>
          </div>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "13px", fontWeight: 600, color: "#34d399" }}>{solarLive.exported_power?.toLocaleString() || '0'}W</div>
            <div style={{ fontSize: "10px", color: "#64748b" }}>Export</div>
          </div>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "13px", fontWeight: 600, color: "#fb923c" }}>{solarLive.inverter_temp || '0'}°C</div>
            <div style={{ fontSize: "10px", color: "#64748b" }}>Temp</div>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
            <span style={{ width: "6px", height: "6px", borderRadius: "50%", background: "#34d399", animation: "pulse 2s infinite" }}></span>
            <span style={{ fontSize: "10px", color: "#34d399" }}>LIVE</span>
          </div>
        </div>
      )}

      <div style={S.tabs}>
        {["⚙️ Setup", "💰 Finance", "📊 Performance", "📈 Forecast", "☀️ Live Solar"].map((t, i) =>
          <button key={i} style={S.tab(tab === i)} onClick={() => setTab(i)}>{t}</button>
        )}
      </div>

      <div style={S.body}>

        {/* ═══ TAB 0: SETUP ═══ */}
        {tab === 0 && <SetupTab
          cfg={cfg} upC={upC} rateSets={rateSets} editingRate={editingRate} setEditingRate={setEditingRate}
          addRateSet={addRateSet} removeRateSet={removeRateSet} updateRate={updateRate} rateFields={rateFields}
          entries={entries} entryBills={entryBills} draft={draft} upD={upD} editingId={editingId}
          saveDraft={saveDraft} editEntry={editEntry} cancelEdit={cancelEdit} removeEntry={removeEntry}
          autoFill={autoFill} loadSample={loadSample} clearAll={clearAll}
          totalBill={totalBill} totalDays={totalDays} totalImport={totalImport} totalExport={totalExport}
          monthsCovered={monthsCovered} showProviderImport={showProviderImport} setShowProviderImport={setShowProviderImport}
          providerImportText={providerImportText} setProviderImportText={setProviderImportText}
          providerImportStatus={providerImportStatus} setProviderImportStatus={setProviderImportStatus}
          setEntries={setEntries} MO={MO} MD={MD} SEA={SEA}
          rateForEntry={rateForEntry} netCost={netCost} scColor={scColor} scLabel={scLabel}
        />}

        {/* ═══ TAB 1: FINANCE ═══ */}
        {tab === 1 && (
          <FinanceCalculator
            batteryNetCost={netCost}
            cfg={cfg}
            financeOverride={financeOverride}
            onSelectScenario={(scenario) => {
              setFinanceOverride(scenario);
              upC("payType", "finance");
            }}
            selectedScenarioName={financeOverride?.name}
          />
        )}

        {/* ═══ TAB 2: PERFORMANCE ═══ */}
        {tab === 2 && <AnalysisTab
          historicalData={historicalData} historicalLoading={historicalLoading} historicalError={historicalError}
          analysisSubView={analysisSubView} setAnalysisSubView={setAnalysisSubView}
          selectedDate={selectedDate} setSelectedDate={setSelectedDate}
          viewMode={viewMode} setViewMode={setViewMode}
          roiMode={roiMode} purchaseDate={purchaseDate}
          cfg={cfg} netCost={netCost} monthlyPmt={monthlyPmt}
          forecast={forecast}
          financeOverride={financeOverride} annualBill={annualBill}
          blendedRates={blendedRates} fmt={fmt} fmt2={fmt2} pct={pct} MO={MO}
          liveDataLoaded={liveDataLoaded} liveMonthCount={liveMonthCount}
        />}

        {/* ═══ TAB 3: FORECAST ═══ */}
        {tab === 3 && <ForecastTab
          cfg={cfg} upC={upC} forecast={forecast} viewYr={viewYr} setViewYr={setViewYr}
          chartMode={chartMode} setChartMode={setChartMode}
          netCost={netCost} monthlyPmt={monthlyPmt} hasData={hasData}
          scLabel={scLabel} scColor={scColor}
          fmt={fmt} fmt2={fmt2} pct={pct} MO={MO} BAT={BAT}
          financeOverride={financeOverride} setFinanceOverride={setFinanceOverride}
          rateSets={rateSets} setTab={setTab}
          accelerateRepay={accelerateRepay} setAccelerateRepay={setAccelerateRepay}
          annualBill={annualBill}
          openMeteoForecast={openMeteoForecast} openMeteoLoading={openMeteoLoading} openMeteoError={openMeteoError}
          setOpenMeteoForecast={setOpenMeteoForecast} setOpenMeteoLoading={setOpenMeteoLoading} setOpenMeteoError={setOpenMeteoError}
          forecastSubView={forecastSubView} setForecastSubView={setForecastSubView}
        />}

        {/* ═══ TAB 4: LIVE SOLAR ═══ */}
        {tab === 4 && <LiveSolarTab
          solarLive={solarLive} solarStats={solarStats} solarDaily={solarDaily} setSolarDaily={setSolarDaily}
          solarMonthly={solarMonthly} solarHourly={solarHourly} solarToday={solarToday}
          solarConnected={solarConnected} weatherToday={weatherToday}
          forecastData={forecastData} openMeteoForecast={openMeteoForecast}
          cfg={cfg} blendedRates={blendedRates} rateSets={rateSets} netCost={netCost}
          showProviderImport={showProviderImport} setShowProviderImport={setShowProviderImport}
          providerImportText={providerImportText} setProviderImportText={setProviderImportText}
          providerImportStatus={providerImportStatus} setProviderImportStatus={setProviderImportStatus}
          fmt={fmt} fmt2={fmt2} pct={pct} MO={MO} S={S}
        />}

      </div>
    </div>
  );
}

ReactDOM.render(<BatteryROI />, document.getElementById('root'));

</script>
</body>
</html>